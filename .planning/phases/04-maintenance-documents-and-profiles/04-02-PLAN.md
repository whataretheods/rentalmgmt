---
phase: 04-maintenance-documents-and-profiles
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/app/api/maintenance/route.ts
  - src/app/api/maintenance/[id]/route.ts
  - src/app/api/maintenance/[id]/comments/route.ts
  - src/app/(tenant)/tenant/maintenance/page.tsx
  - src/app/(tenant)/tenant/maintenance/new/page.tsx
  - src/app/(tenant)/tenant/maintenance/[id]/page.tsx
  - src/components/tenant/MaintenanceRequestForm.tsx
  - src/components/tenant/MaintenanceRequestList.tsx
  - src/components/tenant/MaintenanceRequestDetail.tsx
autonomous: true
requirements:
  - MAINT-01
  - MAINT-02

must_haves:
  truths:
    - "Tenant can submit a maintenance request with category, description, and up to 5 photos"
    - "Tenant can view list of their maintenance requests with status badges"
    - "Tenant can view a single request's details with status history and threaded comments"
    - "Tenant can add comments to their own requests"
    - "Photos show as thumbnail previews before submission and in request detail view"
  artifacts:
    - path: "src/app/api/maintenance/route.ts"
      provides: "GET (list tenant requests) and POST (create request with photos)"
      exports: ["GET", "POST"]
    - path: "src/app/api/maintenance/[id]/route.ts"
      provides: "GET (request detail with photos and comments)"
      exports: ["GET"]
    - path: "src/app/api/maintenance/[id]/comments/route.ts"
      provides: "POST (add comment to request)"
      exports: ["POST"]
    - path: "src/components/tenant/MaintenanceRequestForm.tsx"
      provides: "Multi-photo upload form with category select, description, and preview"
    - path: "src/components/tenant/MaintenanceRequestList.tsx"
      provides: "Request list with status badges and category labels"
    - path: "src/components/tenant/MaintenanceRequestDetail.tsx"
      provides: "Request detail view with photo gallery, status, and comment thread"
  key_links:
    - from: "src/components/tenant/MaintenanceRequestForm.tsx"
      to: "/api/maintenance"
      via: "fetch POST with FormData"
      pattern: "fetch.*api/maintenance"
    - from: "src/components/tenant/MaintenanceRequestList.tsx"
      to: "/api/maintenance"
      via: "fetch GET for request list"
      pattern: "fetch.*api/maintenance"
    - from: "src/components/tenant/MaintenanceRequestDetail.tsx"
      to: "/api/maintenance/[id]/comments"
      via: "fetch POST for new comment"
      pattern: "fetch.*comments"
---

<objective>
Create the tenant-facing maintenance request system: API routes for CRUD operations, submission form with multi-photo upload and preview, request list with status display, and request detail view with threaded comments.

Purpose: This delivers MAINT-01 (submit requests with photos) and MAINT-02 (track request status) — the tenant side of the maintenance workflow.

Output: 3 API routes (list/create, detail, comments), 3 tenant pages (list, new, detail), 3 components (form, list, detail).
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-maintenance-documents-and-profiles/04-RESEARCH.md
@.planning/phases/04-maintenance-documents-and-profiles/04-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From src/db/schema/domain.ts (Phase 4 tables from Plan 01):
```typescript
export const maintenanceRequests = pgTable("maintenance_requests", {
  id: uuid("id").primaryKey().defaultRandom(),
  tenantUserId: text("tenant_user_id").notNull(),
  unitId: uuid("unit_id").references(() => units.id, { onDelete: "cascade" }).notNull(),
  category: text("category", { enum: ["plumbing","electrical","hvac","appliance","pest_control","structural","general"] }).notNull(),
  description: text("description").notNull(),
  status: text("status", { enum: ["submitted","acknowledged","in_progress","resolved"] }).default("submitted").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
  resolvedAt: timestamp("resolved_at"),
})

export const maintenancePhotos = pgTable("maintenance_photos", {
  id: uuid("id").primaryKey().defaultRandom(),
  requestId: uuid("request_id").references(() => maintenanceRequests.id, { onDelete: "cascade" }).notNull(),
  filePath: text("file_path").notNull(),
  fileName: text("file_name").notNull(),
  fileSize: integer("file_size").notNull(),
  mimeType: text("mime_type").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
})

export const maintenanceComments = pgTable("maintenance_comments", {
  id: uuid("id").primaryKey().defaultRandom(),
  requestId: uuid("request_id").references(() => maintenanceRequests.id, { onDelete: "cascade" }).notNull(),
  userId: text("user_id").notNull(),
  content: text("content").notNull(),
  isStatusChange: boolean("is_status_change").default(false).notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
})
```

From src/lib/uploads.ts:
```typescript
export async function saveUploadedFile(file: File, subdirectory: string): Promise<{ filePath: string; fileName: string; fileSize: number; mimeType: string }>
export const MAX_FILE_SIZE: number  // 25MB
export const ALLOWED_MIME_TYPES: Set<string>
```

From src/db/schema/domain.ts (existing):
```typescript
export const tenantUnits = pgTable("tenant_units", {
  userId: text("user_id").notNull(),
  unitId: uuid("unit_id").references(() => units.id, { onDelete: "cascade" }).notNull(),
  isActive: boolean("is_active").default(true).notNull(),
})
```

From src/lib/auth.ts:
```typescript
export const auth: { api: { getSession(opts: { headers: Headers }): Promise<Session | null> } }
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create maintenance API routes (list/create, detail, comments)</name>
  <files>
    src/app/api/maintenance/route.ts
    src/app/api/maintenance/[id]/route.ts
    src/app/api/maintenance/[id]/comments/route.ts
  </files>
  <action>
Step 1 — Create src/app/api/maintenance/route.ts:

**GET handler:** Returns all maintenance requests for the authenticated tenant user. Query the maintenanceRequests table where tenantUserId = session.user.id. Order by createdAt desc. Include a count of photos for each request using a subquery or separate query. Return JSON array.

**POST handler:** Creates a new maintenance request with photo uploads.
1. Auth check — get session, return 401 if not authenticated
2. Parse formData: get "category" (string), "description" (string), and "photos" (File[])
3. Look up the tenant's active unit from tenantUnits where userId = session.user.id AND isActive = true. If no active unit, return 400 "No active unit"
4. Validate category is one of the enum values. Validate description is non-empty
5. Insert into maintenanceRequests with tenantUserId, unitId, category, description, status "submitted"
6. For each photo file (max 5): call saveUploadedFile(file, "maintenance") from @/lib/uploads. Insert into maintenancePhotos with requestId, filePath, fileName, fileSize, mimeType
7. Return 201 with the created request

Step 2 — Create src/app/api/maintenance/[id]/route.ts:

**GET handler:** Returns a single maintenance request with its photos and comments.
1. Auth check
2. Query maintenanceRequests where id = params.id
3. Verify the request belongs to the authenticated user (tenantUserId = session.user.id) OR user is admin (session.user.role === "admin"). Return 403 if unauthorized.
4. Query maintenancePhotos where requestId = params.id
5. Query maintenanceComments where requestId = params.id, ordered by createdAt asc
6. Return JSON with request, photos array, and comments array

**PATCH handler:** Updates request status (admin only).
1. Auth check — verify admin role
2. Parse JSON body: { status, note? }
3. Validate status is valid enum value
4. Update maintenanceRequests set status, updatedAt. If status is "resolved", also set resolvedAt
5. If note provided, insert a maintenanceComments entry with isStatusChange = true
6. Return updated request

Step 3 — Create src/app/api/maintenance/[id]/comments/route.ts:

**POST handler:** Adds a comment to a maintenance request.
1. Auth check
2. Verify the request exists and user has access (is the tenant OR is admin)
3. Parse JSON body: { content }
4. Validate content is non-empty
5. Insert into maintenanceComments with requestId, userId = session.user.id, content, isStatusChange = false
6. Return 201 with the created comment
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    POST /api/maintenance creates a request with photo uploads via FormData. GET /api/maintenance returns tenant's requests ordered by date. GET /api/maintenance/[id] returns request detail with photos and comments. PATCH /api/maintenance/[id] updates status (admin only) with optional note. POST /api/maintenance/[id]/comments adds threaded comment. All routes have auth checks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tenant maintenance pages and components</name>
  <files>
    src/app/(tenant)/tenant/maintenance/page.tsx
    src/app/(tenant)/tenant/maintenance/new/page.tsx
    src/app/(tenant)/tenant/maintenance/[id]/page.tsx
    src/components/tenant/MaintenanceRequestForm.tsx
    src/components/tenant/MaintenanceRequestList.tsx
    src/components/tenant/MaintenanceRequestDetail.tsx
  </files>
  <action>
Step 1 — Create src/components/tenant/MaintenanceRequestForm.tsx:
- "use client" component
- Form with: category select dropdown (Plumbing, Electrical, HVAC, Appliance, Pest Control, Structural, General/Other), description textarea, multi-photo upload area
- Photo upload: input type="file" accept="image/jpeg,image/png,image/heic" multiple, max 5 files
- Thumbnail preview: use URL.createObjectURL() for each selected file, display as grid of small preview images with remove buttons
- If user selects more than 5, only keep first 5 and show warning
- On submit: build FormData with category, description, and all photo files. POST to /api/maintenance
- On success: show toast and redirect to /tenant/maintenance
- Use existing UI components: Button, Input, Label from @/components/ui/
- Import lucide-react icons: Camera, Upload, X (for remove photo), Wrench

Step 2 — Create src/components/tenant/MaintenanceRequestList.tsx:
- "use client" component
- Fetches GET /api/maintenance on mount
- Displays list of requests as cards showing: category label, description preview (truncated to 2 lines), status badge (color-coded: submitted=yellow, acknowledged=blue, in_progress=orange, resolved=green), created date, photo count
- Each card is a link to /tenant/maintenance/[id]
- Empty state: "No maintenance requests yet" with link to submit new one
- Use lucide-react icons for categories (Droplets for plumbing, Zap for electrical, Thermometer for HVAC, etc.)

Step 3 — Create src/components/tenant/MaintenanceRequestDetail.tsx:
- "use client" component that takes requestId prop
- Fetches GET /api/maintenance/[id] on mount
- Shows: category, description, current status badge, created date
- Photo gallery: grid of thumbnails from /api/uploads/{filePath}, click to view full size
- Threaded comments section: list of comments with user name (or "System" for status changes), content, timestamp
- Comment input: textarea + submit button, POSTs to /api/maintenance/[id]/comments
- On comment submit: optimistically add to list, refetch on success

Step 4 — Create the three page files:

src/app/(tenant)/tenant/maintenance/page.tsx — Server Component that renders MaintenanceRequestList with a "New Request" button linking to /tenant/maintenance/new

src/app/(tenant)/tenant/maintenance/new/page.tsx — Server Component that renders MaintenanceRequestForm

src/app/(tenant)/tenant/maintenance/[id]/page.tsx — Server Component that extracts params.id and passes it to MaintenanceRequestDetail
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    Tenant can navigate to /tenant/maintenance to see request list. Tenant can click "New Request" to reach /tenant/maintenance/new with form showing category dropdown, description field, and multi-photo upload with thumbnail previews. Submitting creates a request via API. Tenant can click a request to view details with photo gallery, status badge, and threaded comments. Comments can be added inline.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes
2. POST /api/maintenance accepts FormData with category, description, photos
3. GET /api/maintenance returns tenant's requests
4. GET /api/maintenance/[id] returns detail with photos and comments
5. PATCH /api/maintenance/[id] updates status (admin only)
6. POST /api/maintenance/[id]/comments adds a comment
7. /tenant/maintenance shows request list
8. /tenant/maintenance/new shows form with photo upload and previews
9. /tenant/maintenance/[id] shows request detail with comments
</verification>

<success_criteria>
- Tenant can submit maintenance request with category, description, and up to 5 photos
- Photos have thumbnail previews before submission
- Request list shows status badges and category labels
- Request detail shows photo gallery and threaded comments
- Tenant can add comments to their requests
- All routes have proper auth checks
- npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-maintenance-documents-and-profiles/04-02-SUMMARY.md`
</output>
