---
phase: 04-maintenance-documents-and-profiles
plan: 05
type: execute
wave: 3
depends_on: ["02"]
files_modified:
  - src/app/(admin)/admin/maintenance/page.tsx
  - src/app/(admin)/admin/maintenance/[id]/page.tsx
  - src/app/api/admin/maintenance/route.ts
  - src/components/admin/MaintenanceKanban.tsx
  - src/components/admin/MaintenanceCard.tsx
autonomous: true
requirements:
  - MAINT-03

must_haves:
  truths:
    - "Admin can view all maintenance requests organized in a kanban board with 4 status columns"
    - "Admin can drag cards between columns to update request status"
    - "Admin can filter requests by status, unit, and date"
    - "Status changes from drag create a comment in the request thread"
    - "Admin can click a card to view request detail with photos and comments"
  artifacts:
    - path: "src/components/admin/MaintenanceKanban.tsx"
      provides: "Drag-and-drop kanban board with 4 status columns using @hello-pangea/dnd"
    - path: "src/components/admin/MaintenanceCard.tsx"
      provides: "Kanban card showing request summary"
    - path: "src/app/api/admin/maintenance/route.ts"
      provides: "GET all requests with filters (admin only)"
      exports: ["GET"]
    - path: "src/app/(admin)/admin/maintenance/page.tsx"
      provides: "Admin maintenance queue page"
    - path: "src/app/(admin)/admin/maintenance/[id]/page.tsx"
      provides: "Admin request detail page"
  key_links:
    - from: "src/components/admin/MaintenanceKanban.tsx"
      to: "/api/maintenance/[id]"
      via: "PATCH on drag end to update status"
      pattern: "fetch.*api/maintenance.*PATCH"
    - from: "src/components/admin/MaintenanceKanban.tsx"
      to: "@hello-pangea/dnd"
      via: "DragDropContext, Droppable, Draggable imports"
      pattern: "@hello-pangea/dnd"
    - from: "src/app/api/admin/maintenance/route.ts"
      to: "maintenanceRequests table"
      via: "Drizzle query with filters"
      pattern: "maintenanceRequests"
---

<objective>
Create the admin maintenance management interface: kanban board with drag-and-drop status updates, request filtering, and detail view. Uses @hello-pangea/dnd for the drag-and-drop kanban.

Purpose: This delivers MAINT-03 (admin can manage maintenance queue with filters) — the admin side of the maintenance workflow.

Output: 1 admin API route (list with filters), 2 pages (kanban board, detail), 2 components (kanban, card).
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-maintenance-documents-and-profiles/04-RESEARCH.md
@.planning/phases/04-maintenance-documents-and-profiles/04-01-SUMMARY.md
@.planning/phases/04-maintenance-documents-and-profiles/04-02-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From src/db/schema/domain.ts:
```typescript
export const maintenanceRequests = pgTable("maintenance_requests", {
  id: uuid("id").primaryKey().defaultRandom(),
  tenantUserId: text("tenant_user_id").notNull(),
  unitId: uuid("unit_id").references(() => units.id, { onDelete: "cascade" }).notNull(),
  category: text("category", { enum: ["plumbing","electrical","hvac","appliance","pest_control","structural","general"] }).notNull(),
  description: text("description").notNull(),
  status: text("status", { enum: ["submitted","acknowledged","in_progress","resolved"] }).default("submitted").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
  resolvedAt: timestamp("resolved_at"),
})

export const maintenancePhotos = pgTable("maintenance_photos", { ... })
export const maintenanceComments = pgTable("maintenance_comments", { ... })
```

From src/app/api/maintenance/[id]/route.ts (created in Plan 02):
```typescript
// PATCH handler updates status (admin only) and creates status change comment
export async function PATCH(request: Request, { params }: { params: Promise<{ id: string }> })
// Body: { status: string, note?: string }
```

From src/db/schema/domain.ts (existing):
```typescript
export const units = pgTable("units", {
  id: uuid("id").primaryKey().defaultRandom(),
  unitNumber: text("unit_number").notNull(),
  // ...
})
```

@hello-pangea/dnd exports:
```typescript
import { DragDropContext, Droppable, Draggable, DropResult } from "@hello-pangea/dnd"
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin maintenance API route and kanban components</name>
  <files>
    src/app/api/admin/maintenance/route.ts
    src/components/admin/MaintenanceCard.tsx
    src/components/admin/MaintenanceKanban.tsx
  </files>
  <action>
Step 1 — Create src/app/api/admin/maintenance/route.ts:

**GET handler (admin only):** Returns all maintenance requests with optional filters.
1. Auth check — verify admin role, return 403 if not admin
2. Parse URL search params: `?status=X`, `?unitId=X`, `?dateFrom=YYYY-MM-DD`, `?dateTo=YYYY-MM-DD`
3. Build Drizzle query with dynamic where conditions:
   - If status param: filter by status
   - If unitId param: filter by unitId
   - If dateFrom param: filter createdAt >= dateFrom
   - If dateTo param: filter createdAt <= dateTo
4. Join with units table to get unitNumber for display
5. Include photo count for each request (subquery or join)
6. Include tenant user info (name/email) — join with Better Auth user table
7. Order by: submitted first (status priority), then by createdAt desc
8. Return JSON array with enriched request data

Step 2 — Create src/components/admin/MaintenanceCard.tsx:
- "use client" component
- Props: request object (id, category, description, status, unitNumber, tenantName, createdAt, photoCount)
- Compact card layout for kanban:
  - Category icon + label at top (use same icon mapping as tenant list)
  - Unit number badge
  - Description preview (1-2 lines, truncated)
  - Tenant name
  - Photo count indicator (camera icon + number, only if > 0)
  - Created date (relative: "2 hours ago", "3 days ago")
- Card is a link to /admin/maintenance/[id]
- Tailwind styling: bg-white, rounded, shadow-sm, border, hover:shadow-md transition

Step 3 — Create src/components/admin/MaintenanceKanban.tsx:
- "use client" component — CRITICAL: must have "use client" directive because @hello-pangea/dnd uses browser APIs
- Fetches GET /api/admin/maintenance on mount (no status filter — gets all)
- Accepts optional filter props: unitId, dateFrom, dateTo
- Groups requests into 4 columns by status: Submitted, Acknowledged, In Progress, Resolved
- Column headers show count of requests
- Column styling: fixed-width columns in a horizontal scroll container, each column has colored header (submitted=yellow-100, acknowledged=blue-100, in_progress=orange-100, resolved=green-100)

Drag-and-drop implementation:
```typescript
import { DragDropContext, Droppable, Draggable, DropResult } from "@hello-pangea/dnd"

async function onDragEnd(result: DropResult) {
  if (!result.destination) return
  const newStatus = result.destination.droppableId
  const oldStatus = result.source.droppableId
  if (newStatus === oldStatus) return

  // Optimistic update: move card in local state immediately
  // Then PATCH the API
  const requestId = result.draggableId
  try {
    const res = await fetch(`/api/maintenance/${requestId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: newStatus }),
    })
    if (!res.ok) throw new Error("Failed to update status")
    // Refetch to get updated data
  } catch {
    // Revert optimistic update on failure
    toast.error("Failed to update status")
  }
}
```

Each column is a `<Droppable>` with droppableId = status value.
Each card is a `<Draggable>` with draggableId = request.id.

- Add filter bar above the kanban: unit dropdown (fetch units list), date range inputs, "Clear filters" button
- Filters update the API query params and refetch
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    GET /api/admin/maintenance returns all requests with optional filters for status, unit, date. MaintenanceKanban renders 4 status columns with drag-and-drop using @hello-pangea/dnd. Dragging a card between columns PATCHes the request status. Filter bar allows filtering by unit and date range. MaintenanceCard shows compact request summary with category icon, unit, tenant, photo count.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin maintenance pages</name>
  <files>
    src/app/(admin)/admin/maintenance/page.tsx
    src/app/(admin)/admin/maintenance/[id]/page.tsx
  </files>
  <action>
Step 1 — Create src/app/(admin)/admin/maintenance/page.tsx:
- Server Component wrapper
- Renders page title "Maintenance Requests" and the MaintenanceKanban component
- Import MaintenanceKanban dynamically with ssr: false to prevent hydration issues:
```typescript
import dynamic from "next/dynamic"
const MaintenanceKanban = dynamic(
  () => import("@/components/admin/MaintenanceKanban"),
  { ssr: false, loading: () => <div className="p-8 text-center text-gray-400">Loading kanban board...</div> }
)
```

Step 2 — Create src/app/(admin)/admin/maintenance/[id]/page.tsx:
- Server Component that extracts params.id
- Reuses MaintenanceRequestDetail component from Plan 02 (src/components/tenant/MaintenanceRequestDetail.tsx)
- Since that component already handles admin access (the API route checks admin role), it will work for both tenant and admin views
- Add a "Back to Queue" link at the top pointing to /admin/maintenance
- If the MaintenanceRequestDetail component from Plan 02 doesn't handle admin-specific UI (like inline status change), add a separate status change control:
  - Dropdown select with all 4 statuses + optional note textarea
  - "Update Status" button that PATCHes /api/maintenance/[id]
  - On success: toast and refresh the detail view
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    /admin/maintenance shows kanban board with 4 columns and drag-and-drop status updates. Board loads with dynamic import (ssr: false) to avoid hydration issues. /admin/maintenance/[id] shows request detail with photos, comments, and status change control. Admin can update status with optional note from the detail page.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes
2. /admin/maintenance shows kanban board with 4 status columns
3. Drag-and-drop updates request status via PATCH
4. Filter bar filters by unit and date range
5. Cards show category, unit, tenant, photo count, date
6. /admin/maintenance/[id] shows full request detail
7. Admin can update status with optional note from detail page
8. Status changes appear as comments in the request thread
</verification>

<success_criteria>
- Kanban board renders 4 columns with drag-and-drop
- Dragging between columns updates status via API
- Filter bar works for unit and date range
- Cards link to detail view
- Detail page shows photos, comments, status controls
- Dynamic import prevents SSR issues with @hello-pangea/dnd
- npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-maintenance-documents-and-profiles/04-05-SUMMARY.md`
</output>
