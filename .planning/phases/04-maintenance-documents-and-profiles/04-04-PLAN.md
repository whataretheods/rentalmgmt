---
phase: 04-maintenance-documents-and-profiles
plan: 04
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/app/api/profile/route.ts
  - src/app/(tenant)/tenant/profile/page.tsx
  - src/components/tenant/ProfileForm.tsx
  - src/lib/auth.ts
autonomous: true
requirements:
  - TMGMT-01

must_haves:
  truths:
    - "Tenant can view their current profile info (name, email, phone, emergency contact)"
    - "Tenant can update their name and phone number immediately"
    - "Tenant can update their emergency contact (name + phone)"
    - "Email changes trigger a verification email to the new address before updating"
    - "Profile form shows current values pre-populated"
  artifacts:
    - path: "src/app/api/profile/route.ts"
      provides: "GET (current profile) and PATCH (update profile fields)"
      exports: ["GET", "PATCH"]
    - path: "src/components/tenant/ProfileForm.tsx"
      provides: "Profile editing form with name, phone, email, emergency contact fields"
    - path: "src/lib/auth.ts"
      provides: "Updated Better Auth config with sendChangeEmailVerification callback"
  key_links:
    - from: "src/components/tenant/ProfileForm.tsx"
      to: "/api/profile"
      via: "fetch GET for current data, fetch PATCH for updates"
      pattern: "fetch.*api/profile"
    - from: "src/app/api/profile/route.ts"
      to: "emergencyContacts table"
      via: "Drizzle upsert for emergency contact"
      pattern: "emergencyContacts"
    - from: "src/lib/auth.ts"
      to: "resend"
      via: "sendChangeEmailVerification callback sends email via Resend"
      pattern: "sendChangeEmailVerification"
---

<objective>
Create the tenant profile editing feature: API route for reading/updating profile data, profile page with form for name, phone, email, and emergency contact, and configure Better Auth email change verification.

Purpose: This delivers TMGMT-01 (tenant can manage own contact info) — enabling tenants to keep their information current.

Output: 1 API route (profile GET/PATCH), 1 page (tenant profile), 1 component (profile form), updated auth config.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-maintenance-documents-and-profiles/04-RESEARCH.md
@.planning/phases/04-maintenance-documents-and-profiles/04-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From src/db/schema/domain.ts (Phase 4 tables from Plan 01):
```typescript
export const emergencyContacts = pgTable("emergency_contacts", {
  id: uuid("id").primaryKey().defaultRandom(),
  userId: text("user_id").notNull().unique(),
  contactName: text("contact_name").notNull(),
  contactPhone: text("contact_phone").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
})
```

From src/lib/auth.ts (current config):
```typescript
export const auth = betterAuth({
  database: drizzleAdapter(db, { provider: "pg", schema }),
  emailAndPassword: {
    enabled: true,
    minPasswordLength: 8,
    sendResetPassword: async ({ user, url }) => { ... },
    resetPasswordTokenExpiresIn: 3600,
  },
  plugins: [
    admin({ defaultRole: "user", adminRoles: ["admin"] }),
    nextCookies(),
  ],
  user: {
    additionalFields: {
      smsOptIn: { type: "boolean", required: false, defaultValue: false, input: false },
      smsOptInAt: { type: "string", required: false, defaultValue: null, input: false },
    },
  },
  // ... hooks
})
```

From src/lib/auth-client.ts:
```typescript
// Client-side auth functions
```

From src/lib/resend.ts:
```typescript
export const resend  // Lazy Proxy for Resend client
```

Better Auth user table schema (from Better Auth internals, available via session):
- id: text (primary key)
- email: text
- name: text
- phone: text (if added as additional field, or via user.additionalFields)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add phone field to Better Auth user, configure email change verification, create profile API route</name>
  <files>
    src/lib/auth.ts
    src/app/api/profile/route.ts
  </files>
  <action>
Step 1 — Update src/lib/auth.ts to add phone as a user additional field and configure email change verification.

Add `phone` to user.additionalFields:
```typescript
user: {
  additionalFields: {
    phone: {
      type: "string",
      required: false,
      defaultValue: null,
      input: true,  // Allow users to set/update their phone
    },
    smsOptIn: { ... },  // existing
    smsOptInAt: { ... }, // existing
  },
},
```

Add `sendChangeEmailVerification` callback to `emailAndPassword` config:
```typescript
emailAndPassword: {
  enabled: true,
  minPasswordLength: 8,
  sendResetPassword: async ({ user, url }) => { ... },  // existing
  resetPasswordTokenExpiresIn: 3600,  // existing
  sendChangeEmailVerification: async ({ user, newEmail, url }) => {
    void resend.emails.send({
      from: "RentalMgmt <noreply@rentalmgmt.com>",
      to: newEmail,
      subject: "Verify your new email address",
      html: `<p>Hi ${user.name || "there"},</p><p>Please verify your new email address by clicking the link below:</p><p><a href="${url}">${url}</a></p><p>This link expires in 1 hour. If you didn't request this change, you can ignore this email.</p>`,
    })
  },
},
```

IMPORTANT: Do NOT await the resend call — use `void` to prevent timing attacks, matching the existing sendResetPassword pattern.

After modifying auth.ts, run database generation to add the phone column:
```bash
cd /Users/odesantos/Documents/rentalmgmt
npm run db:generate
npm run db:push
```

Step 2 — Create src/app/api/profile/route.ts:

**GET handler:** Returns current user profile + emergency contact.
1. Auth check — get session, return 401 if not
2. Query the user from session (session.user already has id, email, name)
3. Query emergencyContacts where userId = session.user.id
4. Return JSON: { name, email, phone, emergencyContact: { contactName, contactPhone } | null }

Note: For the phone field, the session.user may need to include it. Check if Better Auth session includes additionalFields. If not, query the user table directly using Drizzle:
```typescript
import { user as userTable } from "@/db/schema/auth"
```
Or use the Better Auth admin API to get full user data.

**PATCH handler:** Updates profile fields.
1. Auth check
2. Parse JSON body: { name?, phone?, email?, emergencyContact?: { contactName, contactPhone } }
3. Validate inputs: name non-empty if provided, phone format basic check, email format check
4. For name and phone updates: use Better Auth's updateUser API or direct Drizzle update on user table
5. For email change: use Better Auth's changeEmail API which will trigger sendChangeEmailVerification. The client should call this through the auth client, not the profile API. So the profile API handles name, phone, and emergency contact only. Email change goes through Better Auth client directly.
6. For emergency contact: upsert into emergencyContacts — if record exists for userId, update it; if not, insert new record. Use Drizzle's onConflictDoUpdate:
```typescript
await db.insert(emergencyContacts).values({
  userId: session.user.id,
  contactName: body.emergencyContact.contactName,
  contactPhone: body.emergencyContact.contactPhone,
}).onConflictDoUpdate({
  target: emergencyContacts.userId,
  set: {
    contactName: body.emergencyContact.contactName,
    contactPhone: body.emergencyContact.contactPhone,
    updatedAt: new Date(),
  },
})
```
7. Return updated profile data

IMPORTANT: Email changes should be handled via the Better Auth client's `changeEmail` method on the frontend, NOT through this PATCH endpoint. The profile API handles name, phone, and emergency contact only.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    Better Auth config has phone as additional user field and sendChangeEmailVerification callback. GET /api/profile returns user info + emergency contact. PATCH /api/profile updates name, phone, and emergency contact (upsert). Email changes configured through Better Auth changeEmail flow with verification email via Resend.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tenant profile page and form component</name>
  <files>
    src/app/(tenant)/tenant/profile/page.tsx
    src/components/tenant/ProfileForm.tsx
  </files>
  <action>
Step 1 — Create src/components/tenant/ProfileForm.tsx:
- "use client" component
- Fetches GET /api/profile on mount to pre-populate form
- Form sections:
  A. **Personal Information**: name (text input, required), phone (tel input, optional)
  B. **Email Address**: email (text input, read-only display of current email + "Change Email" button that opens an inline form or dialog)
  C. **Emergency Contact**: contact name (text input), contact phone (tel input)
- Each section has its own "Save" button for independent updates
- Personal info save: PATCH /api/profile with { name, phone }
- Email change: uses Better Auth client's changeEmail method — import from @/lib/auth-client. Show message "Verification email sent to [new email]" on success. The auth client should expose `authClient.changeEmail({ newEmail })` or equivalent.
- Emergency contact save: PATCH /api/profile with { emergencyContact: { contactName, contactPhone } }
- Use existing UI components: Button, Input, Label from @/components/ui/
- Toast notifications (sonner) for success/error on each save
- Loading state while fetching initial data
- Use lucide-react icons: User, Phone, Mail, Shield (for emergency contact)

Step 2 — Create src/app/(tenant)/tenant/profile/page.tsx:
- Server Component wrapper
- Renders h1 "My Profile" heading and ProfileForm component
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    /tenant/profile shows profile form pre-populated with current user data. Tenant can update name and phone with immediate save. Tenant can update emergency contact (name + phone). Email change triggers verification email to new address. All sections have independent save buttons with toast feedback.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes
2. GET /api/profile returns name, email, phone, emergency contact
3. PATCH /api/profile updates name, phone, emergency contact
4. Emergency contact upserts correctly (create on first save, update on subsequent)
5. Email change sends verification email (configured in auth.ts)
6. /tenant/profile shows form with all fields pre-populated
7. Each section saves independently with toast feedback
</verification>

<success_criteria>
- Tenant can view and update name, phone, email, emergency contact
- Email change requires verification via emailed link
- Emergency contact stored in separate table with upsert logic
- Profile form shows current values on load
- All changes provide immediate feedback via toast
- npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-maintenance-documents-and-profiles/04-04-SUMMARY.md`
</output>
