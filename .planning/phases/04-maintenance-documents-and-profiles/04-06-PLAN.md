---
phase: 04-maintenance-documents-and-profiles
plan: 06
type: execute
wave: 3
depends_on: ["02", "03", "04", "05"]
files_modified:
  - e2e/maintenance.spec.ts
  - e2e/documents.spec.ts
  - e2e/profile.spec.ts
  - scripts/seed-phase4-test.ts
  - package.json
autonomous: false
requirements:
  - MAINT-01
  - MAINT-02
  - MAINT-03
  - DOC-01
  - DOC-02
  - TMGMT-01

must_haves:
  truths:
    - "E2E tests verify tenant can submit a maintenance request with photos"
    - "E2E tests verify tenant can check request status and view threaded comments"
    - "E2E tests verify admin kanban board loads and requests can have status updated"
    - "E2E tests verify tenant can upload a document with valid type and reject invalid file types"
    - "E2E tests verify admin can request a document and tenant can fulfill it"
    - "E2E tests verify tenant can update profile name, phone, and emergency contact"
    - "All Playwright tests pass in headless mode"
  artifacts:
    - path: "e2e/maintenance.spec.ts"
      provides: "E2E tests for MAINT-01, MAINT-02, MAINT-03"
    - path: "e2e/documents.spec.ts"
      provides: "E2E tests for DOC-01, DOC-02"
    - path: "e2e/profile.spec.ts"
      provides: "E2E tests for TMGMT-01"
    - path: "scripts/seed-phase4-test.ts"
      provides: "Seed script creating test data for Phase 4 E2E tests"
  key_links:
    - from: "e2e/maintenance.spec.ts"
      to: "/tenant/maintenance"
      via: "Playwright page.goto and form interactions"
      pattern: "tenant/maintenance"
    - from: "e2e/documents.spec.ts"
      to: "/tenant/documents"
      via: "Playwright page.goto and upload interactions"
      pattern: "tenant/documents"
    - from: "e2e/profile.spec.ts"
      to: "/tenant/profile"
      via: "Playwright page.goto and form interactions"
      pattern: "tenant/profile"
---

<objective>
Create Playwright E2E tests and test seed data for all Phase 4 features: maintenance requests, document management, and profile editing. Run all tests headless to verify the complete tenant self-service experience.

Purpose: Automated verification that all 6 Phase 4 requirements are met end-to-end. This is the final verification checkpoint before marking Phase 4 complete.

Output: 3 E2E test files, 1 seed script, all tests passing.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-maintenance-documents-and-profiles/04-RESEARCH.md
@.planning/phases/04-maintenance-documents-and-profiles/04-02-SUMMARY.md
@.planning/phases/04-maintenance-documents-and-profiles/04-03-SUMMARY.md
@.planning/phases/04-maintenance-documents-and-profiles/04-04-SUMMARY.md
@.planning/phases/04-maintenance-documents-and-profiles/04-05-SUMMARY.md

<interfaces>
<!-- Existing test patterns from the project -->

From playwright.config.ts:
```typescript
import { defineConfig } from "@playwright/test"
export default defineConfig({
  testDir: "./e2e",
  fullyParallel: false,
  retries: 0,
  use: {
    baseURL: "http://localhost:3000",
    headless: true,
  },
  timeout: 30000,
})
```

From e2e/payments.spec.ts (existing test pattern):
```typescript
import { test, expect } from "@playwright/test"
// Tests use page.goto, page.fill, page.click, expect(page.locator(...)).toBeVisible()
```

From package.json (existing scripts):
```json
"seed:payment-test": "tsx -r tsconfig-paths/register scripts/seed-payment-test.ts",
"test:e2e": "npx playwright test"
```

IMPORTANT: This project uses .env.local (NOT .env). Any script using dotenv must use config({ path: ".env.local" }).
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 4 seed script and E2E test files</name>
  <files>
    scripts/seed-phase4-test.ts
    e2e/maintenance.spec.ts
    e2e/documents.spec.ts
    e2e/profile.spec.ts
    package.json
  </files>
  <action>
Step 1 — Create scripts/seed-phase4-test.ts:
- CRITICAL: Use `import { config } from "dotenv"; config({ path: ".env.local" })` at the top — NOT `import "dotenv/config"` which loads .env instead of .env.local
- Import db, schema tables
- Ensure a test tenant user exists (reuse existing seed or create): email "tenant-test@example.com", linked to a unit
- Ensure an admin user exists
- Create a sample maintenance request (status: submitted) for the test tenant
- Create a sample document request from admin for the test tenant
- Log seed completion

Add npm script to package.json:
```json
"seed:phase4-test": "tsx -r tsconfig-paths/register scripts/seed-phase4-test.ts"
```

Step 2 — Create e2e/maintenance.spec.ts:

```typescript
import { test, expect } from "@playwright/test"

test.describe("Maintenance Requests", () => {
  test.beforeEach(async ({ page }) => {
    // Login as test tenant
    await page.goto("/auth/login")
    await page.fill('input[name="email"]', "tenant-test@example.com")
    await page.fill('input[name="password"]', "TestPassword123!")
    await page.click('button[type="submit"]')
    await page.waitForURL(/\/tenant\/dashboard/)
  })

  test("submit maintenance request", async ({ page }) => {
    await page.goto("/tenant/maintenance/new")

    // Select category
    // Fill description
    // Verify form renders with category dropdown and description field
    // Submit without photos (simpler to test)
    // Verify redirect to maintenance list
    // Verify new request appears in list
  })

  test("track request status", async ({ page }) => {
    await page.goto("/tenant/maintenance")

    // Verify request list loads
    // Click on a request
    // Verify detail page shows status, description
    // Verify comment thread area is visible
  })
})
```

Write realistic tests that:
1. Login as tenant, navigate to /tenant/maintenance/new
2. Fill the form (select category, type description)
3. Submit and verify request appears in list
4. Open a request detail and verify status display
5. Add a comment and verify it appears

Step 3 — Create e2e/documents.spec.ts:

Tests:
1. Login as tenant, navigate to /tenant/documents
2. Verify document upload form is visible
3. Test file upload with a valid file (create a small test file using Playwright's setInputFiles)
4. Verify uploaded document appears in list
5. Verify pending admin requests are shown (from seed data)

Step 4 — Create e2e/profile.spec.ts:

Tests:
1. Login as tenant, navigate to /tenant/profile
2. Verify form loads with current user data
3. Update name, verify save succeeds (toast notification)
4. Update emergency contact, verify save succeeds
5. Verify phone field is editable

Step 5 — Create a separate test block in e2e/maintenance.spec.ts for admin:

```typescript
test.describe("Admin Maintenance Queue", () => {
  test.beforeEach(async ({ page }) => {
    // Login as admin
    await page.goto("/auth/login")
    await page.fill('input[name="email"]', "admin@rentalmgmt.com")
    await page.fill('input[name="password"]', "AdminPassword123!")
    await page.click('button[type="submit"]')
    await page.waitForURL(/\/admin\/dashboard/)
  })

  test("view maintenance kanban", async ({ page }) => {
    await page.goto("/admin/maintenance")
    // Verify kanban board loads with status columns
    // Verify at least one request card is visible (from seed)
  })
})
```

IMPORTANT: Run tests headless per user preferences. Use `await page.waitForURL()` and `await page.waitForSelector()` for async navigation. Use realistic selectors (data-testid, role attributes, or visible text content).
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    Seed script creates test data for Phase 4. Three E2E test files cover all 6 requirements. Test patterns match existing project conventions. npm script added for seed:phase4-test.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 4 implementation: maintenance requests with photos and kanban board, document uploads with admin request workflow, and tenant profile editing with email change verification.

All Playwright E2E tests have been created and the test seed script is ready.
  </what-built>
  <how-to-verify>
Run the verification commands (headless):

1. Seed test data:
```bash
npm run seed:phase4-test
```

2. Start dev server (if not running):
```bash
npm run dev
```

3. Run all E2E tests:
```bash
npx playwright test e2e/maintenance.spec.ts e2e/documents.spec.ts e2e/profile.spec.ts
```

4. Expected results:
   - Maintenance tests: tenant can submit request and view status
   - Documents tests: tenant can upload document and see admin requests
   - Profile tests: tenant can update name, phone, emergency contact
   - Admin tests: kanban board loads with request cards

5. Manual spot-check (optional):
   - Visit /tenant/maintenance/new — verify photo upload with preview works
   - Visit /admin/maintenance — verify kanban drag-and-drop works
   - Visit /tenant/profile — verify form pre-populates
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes
2. `npm run seed:phase4-test` creates test data
3. All Playwright tests pass in headless mode
4. Maintenance: submit request, track status, admin kanban all verified
5. Documents: upload with validation, admin request workflow verified
6. Profile: name/phone/emergency contact update verified
</verification>

<success_criteria>
- All E2E tests pass in headless mode
- Seed script creates reproducible test data
- Tests cover all 6 Phase 4 requirements (MAINT-01, MAINT-02, MAINT-03, DOC-01, DOC-02, TMGMT-01)
- Tests follow existing project Playwright patterns
- No browser windows opened (headless only per user preference)
</success_criteria>

<output>
After completion, create `.planning/phases/04-maintenance-documents-and-profiles/04-06-SUMMARY.md`
</output>
