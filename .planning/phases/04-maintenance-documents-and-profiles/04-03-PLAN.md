---
phase: 04-maintenance-documents-and-profiles
plan: 03
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/app/api/documents/route.ts
  - src/app/api/documents/[id]/route.ts
  - src/app/api/documents/requests/route.ts
  - src/app/(tenant)/tenant/documents/page.tsx
  - src/app/(admin)/admin/documents/page.tsx
  - src/components/tenant/DocumentUpload.tsx
  - src/components/tenant/DocumentList.tsx
  - src/components/admin/DocumentRequestForm.tsx
  - src/components/admin/DocumentSubmissions.tsx
autonomous: true
requirements:
  - DOC-01
  - DOC-02

must_haves:
  truths:
    - "Tenant can upload a document with type selection and the system validates file type and size"
    - "Tenant sees unsupported file type rejected with a clear error message"
    - "Tenant can see their uploaded documents listed with type, name, and date"
    - "Admin can request a specific document from a tenant with optional message"
    - "Tenant sees pending document requests on their documents page"
    - "Admin can view document submissions and see when a requested document was fulfilled"
  artifacts:
    - path: "src/app/api/documents/route.ts"
      provides: "GET (list tenant docs) and POST (upload document)"
      exports: ["GET", "POST"]
    - path: "src/app/api/documents/[id]/route.ts"
      provides: "GET (download document file)"
      exports: ["GET"]
    - path: "src/app/api/documents/requests/route.ts"
      provides: "GET (list requests) and POST (create admin request)"
      exports: ["GET", "POST"]
    - path: "src/components/tenant/DocumentUpload.tsx"
      provides: "Upload form with document type select and file validation"
    - path: "src/components/admin/DocumentRequestForm.tsx"
      provides: "Admin form to request document from tenant"
    - path: "src/components/admin/DocumentSubmissions.tsx"
      provides: "Admin view of all document submissions with request status"
  key_links:
    - from: "src/components/tenant/DocumentUpload.tsx"
      to: "/api/documents"
      via: "fetch POST with FormData"
      pattern: "fetch.*api/documents"
    - from: "src/components/admin/DocumentRequestForm.tsx"
      to: "/api/documents/requests"
      via: "fetch POST"
      pattern: "fetch.*api/documents/requests"
    - from: "src/app/api/documents/route.ts"
      to: "documentRequests table"
      via: "update request status to submitted when fulfilling a request"
      pattern: "documentRequests"
---

<objective>
Create the document management system: tenant document uploads with type/size validation, admin document request workflow, and admin submissions view.

Purpose: This delivers DOC-01 (tenant uploads with validation) and DOC-02 (admin requests and submission tracking) — completing the document management feature.

Output: 3 API routes (upload/list, download, requests), 2 pages (tenant documents, admin documents), 4 components (upload, list, request form, submissions).
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-maintenance-documents-and-profiles/04-RESEARCH.md
@.planning/phases/04-maintenance-documents-and-profiles/04-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From src/db/schema/domain.ts (Phase 4 tables from Plan 01):
```typescript
export const documents = pgTable("documents", {
  id: uuid("id").primaryKey().defaultRandom(),
  tenantUserId: text("tenant_user_id").notNull(),
  documentType: text("document_type", { enum: ["government_id","proof_of_income_insurance","general"] }).notNull(),
  filePath: text("file_path").notNull(),
  fileName: text("file_name").notNull(),
  fileSize: integer("file_size").notNull(),
  mimeType: text("mime_type").notNull(),
  requestId: uuid("request_id"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
})

export const documentRequests = pgTable("document_requests", {
  id: uuid("id").primaryKey().defaultRandom(),
  tenantUserId: text("tenant_user_id").notNull(),
  documentType: text("document_type", { enum: ["government_id","proof_of_income_insurance","general"] }).notNull(),
  message: text("message"),
  status: text("status", { enum: ["pending","submitted"] }).default("pending").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  fulfilledAt: timestamp("fulfilled_at"),
})
```

From src/lib/uploads.ts:
```typescript
export async function saveUploadedFile(file: File, subdirectory: string): Promise<{ filePath: string; fileName: string; fileSize: number; mimeType: string }>
export const MAX_FILE_SIZE: number  // 25MB
export const ALLOWED_MIME_TYPES: Set<string>
```

From src/lib/auth.ts:
```typescript
export const auth: { api: { getSession(opts: { headers: Headers }): Promise<Session | null> } }
```

From src/db/schema/domain.ts (existing):
```typescript
export const tenantUnits = pgTable("tenant_units", {
  userId: text("user_id").notNull(),
  unitId: uuid("unit_id").references(() => units.id, { onDelete: "cascade" }).notNull(),
  isActive: boolean("is_active").default(true).notNull(),
})
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create document API routes (upload/list, download, admin requests)</name>
  <files>
    src/app/api/documents/route.ts
    src/app/api/documents/[id]/route.ts
    src/app/api/documents/requests/route.ts
  </files>
  <action>
Step 1 — Create src/app/api/documents/route.ts:

**GET handler:** Returns all documents for the authenticated tenant. If user is admin, accept optional query param `?tenantUserId=xxx` to view a specific tenant's documents. Query documents table ordered by createdAt desc. Also return any pending documentRequests for the tenant (so they can see what's been requested).

**POST handler:** Uploads a new document.
1. Auth check
2. Parse formData: get "file" (single File), "documentType" (string), optional "requestId" (string — if fulfilling an admin request)
3. Validate documentType is valid enum value
4. Call saveUploadedFile(file, "documents") from @/lib/uploads — this handles MIME type and size validation. Catch errors and return 400 with message
5. Insert into documents with tenantUserId = session.user.id, documentType, filePath, fileName, fileSize, mimeType, requestId (if provided)
6. If requestId provided: update the documentRequests row — set status to "submitted" and fulfilledAt to now()
7. Return 201 with the created document

Step 2 — Create src/app/api/documents/[id]/route.ts:

**GET handler:** Downloads/serves a document file.
1. Auth check
2. Query documents where id = params.id
3. Verify access: document belongs to authenticated user (tenantUserId = session.user.id) OR user is admin
4. Return redirect to /api/uploads/{document.filePath} — or read and serve the file directly using the same pattern as the uploads route

Step 3 — Create src/app/api/documents/requests/route.ts:

**GET handler:** Returns document requests. If admin: all requests with tenant info. If tenant: only their pending requests.

**POST handler (admin only):** Creates a new document request.
1. Auth check — verify admin role, return 403 if not admin
2. Parse JSON body: { tenantUserId, documentType, message? }
3. Validate tenantUserId exists (query user table) and documentType is valid enum
4. Insert into documentRequests
5. Return 201 with the created request

NOTE: Document request notifications (email/SMS) are deferred to Phase 5 — do NOT implement notifications here.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    POST /api/documents uploads a document with type/size validation via FormData. GET /api/documents returns tenant's documents and pending requests. GET /api/documents/[id] serves the document file with auth check. POST /api/documents/requests creates admin document request (admin only). GET /api/documents/requests returns requests list. Fulfilling a request updates documentRequests status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tenant documents page and admin documents page with components</name>
  <files>
    src/app/(tenant)/tenant/documents/page.tsx
    src/app/(admin)/admin/documents/page.tsx
    src/components/tenant/DocumentUpload.tsx
    src/components/tenant/DocumentList.tsx
    src/components/admin/DocumentRequestForm.tsx
    src/components/admin/DocumentSubmissions.tsx
  </files>
  <action>
Step 1 — Create src/components/tenant/DocumentUpload.tsx:
- "use client" component
- Props: onUploaded callback, optional requestId (when fulfilling a specific request)
- Document type select: Government ID, Proof of Income/Insurance, General/Other (if requestId is provided, type is pre-selected from the request)
- Single file input with accept attribute matching ALLOWED_MIME_TYPES: ".pdf,.jpg,.jpeg,.png,.heic,.doc,.docx"
- Client-side size check: show error if file > 25MB before even attempting upload
- Preview: show file name and size after selection
- On submit: build FormData with file, documentType, and optional requestId. POST to /api/documents
- Show toast on success/error using sonner
- Use Button, Label from @/components/ui/

Step 2 — Create src/components/tenant/DocumentList.tsx:
- "use client" component
- Fetches GET /api/documents on mount
- Shows two sections:
  A. "Requested Documents" — pending document requests from admin, each with request type, admin message, and an "Upload" button that triggers DocumentUpload with the requestId
  B. "My Documents" — list of uploaded documents as cards/rows showing: document type label, original filename, upload date, file size formatted (KB/MB)
- Each document has a "Download" link to /api/documents/[id]
- Empty state for each section
- Use FileText icon from lucide-react for document items

Step 3 — Create src/components/admin/DocumentRequestForm.tsx:
- "use client" component
- Form to request a document from a tenant: tenant select dropdown (fetches users list), document type select, optional message textarea
- POSTs to /api/documents/requests
- Toast on success
- For tenant list: fetch from Better Auth admin API or create a simple API route. Use the admin listUsers endpoint if available, or query tenantUnits joined with user info.

Step 4 — Create src/components/admin/DocumentSubmissions.tsx:
- "use client" component
- Fetches GET /api/documents/requests
- Shows all document requests as a table/list: tenant name/email, document type, request date, status (pending/submitted), fulfilled date
- For submitted requests: link to download the document
- Filter by status (All, Pending, Submitted)
- Use Badge component pattern (colored spans) for status: pending=yellow, submitted=green

Step 5 — Create the two page files:

src/app/(tenant)/tenant/documents/page.tsx — Server Component wrapper. Renders DocumentList and includes DocumentUpload component for ad-hoc uploads.

src/app/(admin)/admin/documents/page.tsx — Server Component wrapper. Renders DocumentRequestForm and DocumentSubmissions side by side (request form on top or in a dialog, submissions list below).
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    /tenant/documents shows uploaded documents and pending admin requests. DocumentUpload component validates file type/size client-side and uploads via API. Fulfilling a request auto-updates status. /admin/documents shows request form and all submissions with filter. Admin can request a document by selecting tenant + type + optional message.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes
2. Tenant can upload a document with type selection at /tenant/documents
3. Invalid file types are rejected with a clear error
4. Files over 25MB are rejected
5. Tenant can see their uploaded documents and pending requests
6. Admin can request a document from a tenant at /admin/documents
7. Tenant sees the request and can fulfill it by uploading
8. Admin sees submission status update when document is fulfilled
</verification>

<success_criteria>
- Document upload validates MIME type and 25MB size limit
- Unsupported formats show clear error message
- Admin can create document requests with type + message
- Tenant sees pending requests on their documents page
- Fulfilling a request links the upload to the request and updates status
- Admin can view all submissions with status filter
- npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-maintenance-documents-and-profiles/04-03-SUMMARY.md`
</output>
