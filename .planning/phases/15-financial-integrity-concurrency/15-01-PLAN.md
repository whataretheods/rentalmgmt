---
phase: 15-financial-integrity-concurrency
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/app/api/cron/late-fees/route.ts
  - src/lib/__tests__/late-fee-cron.test.ts
autonomous: true
requirements: [HARD-01]

must_haves:
  truths:
    - "A tenant who makes a partial payment ($1 on $1,500 balance) still receives a late fee because the cron checks actual ledger balance, not payment existence"
    - "A tenant who pays in full (balance = 0) does NOT receive a late fee"
    - "A tenant with a pending ACH payment is still skipped (no late fee while payment is in flight)"
    - "Late fee idempotency is preserved — a second cron run does not double-post fees"
  artifacts:
    - path: "src/app/api/cron/late-fees/route.ts"
      provides: "Balance-based late fee assessment"
      contains: "getTenantBalance"
    - path: "src/lib/__tests__/late-fee-cron.test.ts"
      provides: "Unit tests proving balance-based logic"
      exports: ["test cases for partial payment, full payment, pending payment, zero balance"]
  key_links:
    - from: "src/app/api/cron/late-fees/route.ts"
      to: "src/lib/ledger.ts"
      via: "getTenantBalance() import and call"
      pattern: "getTenantBalance\\("
---

<objective>
Fix the late fee cron job to assess fees based on actual tenant ledger balance instead of checking for the existence of any succeeded payment.

Purpose: Close the partial payment loophole — currently a $1 payment on a $1,500 balance suppresses the late fee because the cron checks "does any succeeded payment exist" rather than "does the tenant still owe money."

Output: Modified cron route that calls getTenantBalance() and unit tests proving the fix.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/api/cron/late-fees/route.ts
@src/lib/ledger.ts
@src/lib/late-fees.ts
@src/db/schema/domain.ts

<interfaces>
From src/lib/ledger.ts:
```typescript
export interface TenantBalanceResult {
  balanceCents: number
  pendingPaymentsCents: number
}

export async function getTenantBalance(
  tenantUserId: string,
  unitId: string
): Promise<TenantBalanceResult>
```

From src/lib/late-fees.ts:
```typescript
export interface LateFeeRule {
  feeType: "flat" | "percentage"
  feeAmountCents: number
  maxFeeAmountCents: number | null
}

export function calculateLateFee(rentAmountCents: number, rule: LateFeeRule): number
export function formatCentsAsDollars(cents: number): string
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Write failing tests for balance-based late fee assessment</name>
  <files>src/lib/__tests__/late-fee-cron.test.ts</files>
  <behavior>
    - Test: shouldAssessLateFee(balanceCents, pendingPaymentsCents) returns true when balanceCents > 0 and pendingPaymentsCents === 0
    - Test: shouldAssessLateFee(0, 0) returns false (tenant fully paid)
    - Test: shouldAssessLateFee(-500, 0) returns false (tenant has credit)
    - Test: shouldAssessLateFee(149900, 0) returns true (partial payment — paid $1 on $1,500 rent, $1,499 balance remains)
    - Test: shouldAssessLateFee(150000, 100) returns false (pending payment exists — skip regardless of balance)
    - Test: shouldAssessLateFee(150000, 0) returns true (no payment at all, full balance owed)
  </behavior>
  <action>
    Create src/lib/__tests__/late-fee-cron.test.ts. Extract the late-fee-eligibility decision into a pure function `shouldAssessLateFee(balanceCents: number, pendingPaymentsCents: number): boolean` that can be tested without mocking the database. The logic is:
    - If pendingPaymentsCents > 0 → return false (skip: payment in flight)
    - If balanceCents <= 0 → return false (tenant current or has credit)
    - Otherwise → return true (tenant owes money)

    Write this function inline in the test file first (RED phase). The function will later be defined in the cron route or a helper. Run tests — they should FAIL because the function doesn't exist in production code yet.

    Use vitest. Import pattern: `import { describe, it, expect } from "vitest"`.
  </action>
  <verify>
    <automated>npx vitest run src/lib/__tests__/late-fee-cron.test.ts 2>&1 | tail -20</automated>
  </verify>
  <done>All 6 test cases exist and define correct expectations for balance-based late fee eligibility</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Implement balance-based late fee check in cron route</name>
  <files>src/app/api/cron/late-fees/route.ts, src/lib/__tests__/late-fee-cron.test.ts</files>
  <behavior>
    - shouldAssessLateFee(balanceCents=149900, pendingPaymentsCents=0) → true (partial payment loophole closed)
    - shouldAssessLateFee(balanceCents=0, pendingPaymentsCents=0) → false (fully paid)
    - shouldAssessLateFee(balanceCents=150000, pendingPaymentsCents=100) → false (pending ACH)
  </behavior>
  <action>
    **GREEN phase:** Make tests pass by modifying the cron route.

    1. **Export the pure function** from the cron route (or create a small helper in `src/lib/late-fee-eligibility.ts` — planner's discretion, but simplest is exporting from the route file or the test file itself since the logic is trivial). The cleanest approach: define `shouldAssessLateFee` as a named export in the test file itself since it's a pure function used for test verification, AND inline the equivalent logic in the cron route.

    2. **Modify `src/app/api/cron/late-fees/route.ts`** — replace lines 85-121 (the two payment-existence queries and their if-checks) with:

    ```typescript
    // Import getTenantBalance at the top of the file
    import { getTenantBalance } from "@/lib/ledger"

    // Replace the payment-existence checks (lines 85-121) with:
    const { balanceCents, pendingPaymentsCents } = await getTenantBalance(link.userId, link.unitId)

    // Skip if pending ACH payment exists
    if (pendingPaymentsCents > 0) {
      skipped++
      continue
    }

    // Skip if tenant balance is zero or credit (fully paid or overpaid)
    if (balanceCents <= 0) {
      skipped++
      continue
    }
    ```

    3. **Remove** the two DB queries that checked `payments` table for `succeeded` and `pending` status (lines 86-121 in the original). The `getTenantBalance()` function already handles both — it computes charges minus succeeded payments and separately reports pending amounts.

    4. **Remove** the `payments` import from the top of the file since payments table is no longer directly queried.

    5. **Keep everything else** (grace period check, idempotency check for existing late_fee charge, fee calculation, notification) exactly as-is.

    Run the tests — they should now PASS.
  </action>
  <verify>
    <automated>npx vitest run src/lib/__tests__/late-fee-cron.test.ts 2>&1 | tail -20</automated>
  </verify>
  <done>Late fee cron uses getTenantBalance() instead of payment-existence queries. All tests pass. A $1 partial payment no longer suppresses late fee assessment.</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/lib/__tests__/late-fee-cron.test.ts` — all tests pass
2. `grep -n "getTenantBalance" src/app/api/cron/late-fees/route.ts` — confirms balance check is used
3. `grep -n "payments" src/app/api/cron/late-fees/route.ts` — should NOT find direct payment-existence queries (only the removed import)
4. `npx tsc --noEmit` — TypeScript compiles without errors
</verification>

<success_criteria>
- Late fee cron calls getTenantBalance() to determine fee eligibility
- No direct payment-existence query remains in the cron logic
- Partial payment scenario (balance > 0) correctly triggers late fee
- Full payment scenario (balance <= 0) correctly skips late fee
- Pending ACH scenario (pendingPaymentsCents > 0) correctly skips late fee
- Existing late fee idempotency check is preserved
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-financial-integrity-concurrency/15-01-SUMMARY.md`
</output>
