---
phase: 13-fintech-polish-edge-cases
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/lib/ledger.ts
  - src/lib/__tests__/ledger.test.ts
  - src/components/tenant/BalanceCard.tsx
  - src/app/(tenant)/tenant/dashboard/page.tsx
autonomous: true
requirements:
  - FIN-02

must_haves:
  truths:
    - "getTenantBalance returns both confirmed balanceCents and pendingPaymentsCents as separate fields"
    - "BalanceCard displays the pending payment amount (e.g., '$1,500.00 payment processing') when pending payments exist"
    - "Pending payments are NOT subtracted from the confirmed balance — they are informational only"
    - "Tenant dashboard passes pendingPaymentsCents to BalanceCard"
  artifacts:
    - path: "src/lib/ledger.ts"
      provides: "getTenantBalance returning TenantBalanceResult with pendingPaymentsCents"
      exports: ["getTenantBalance", "TenantBalanceResult", "formatBalance"]
    - path: "src/lib/__tests__/ledger.test.ts"
      provides: "Unit tests with mocked DB for balance computation"
      min_lines: 30
    - path: "src/components/tenant/BalanceCard.tsx"
      provides: "Updated BalanceCard showing pending payment amounts"
    - path: "src/app/(tenant)/tenant/dashboard/page.tsx"
      provides: "Dashboard passing pendingPaymentsCents from ledger to BalanceCard"
  key_links:
    - from: "src/app/(tenant)/tenant/dashboard/page.tsx"
      to: "src/lib/ledger.ts"
      via: "import { getTenantBalance }"
      pattern: "getTenantBalance"
    - from: "src/app/(tenant)/tenant/dashboard/page.tsx"
      to: "src/components/tenant/BalanceCard.tsx"
      via: "pendingPaymentsCents prop"
      pattern: "pendingPaymentsCents"
---

<objective>
Enhance the tenant balance system to return pending payment amounts separately from the confirmed balance, and update the BalanceCard UI to show tenants how much is currently processing.

Purpose: Currently, BalanceCard shows a boolean "Pending payment processing" message but no amount. If a tenant's $1,500 ACH payment is pending, they see their full balance with just a vague note. With this fix, they see "You owe $1,500.00" + "$1,500.00 payment processing" — making it clear the payment is in flight without misleadingly reducing the confirmed balance.

Output: Updated ledger function, BalanceCard with pending amount display, updated dashboard wiring.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/13-fintech-polish-edge-cases/13-RESEARCH.md

@src/lib/ledger.ts
@src/components/tenant/BalanceCard.tsx
@src/app/(tenant)/tenant/dashboard/page.tsx

<interfaces>
<!-- Current ledger interface (to be modified) -->

From src/lib/ledger.ts:
```typescript
export async function getTenantBalance(
  tenantUserId: string,
  unitId: string
): Promise<number>  // Currently returns just balanceCents

export function formatBalance(balanceCents: number): {
  text: string
  status: "owed" | "credit" | "current"
}
```

From src/components/tenant/BalanceCard.tsx:
```typescript
interface BalanceCardProps {
  balanceCents: number
  hasPendingPayments: boolean  // Currently boolean-only
}
```

From src/app/(tenant)/tenant/dashboard/page.tsx:
```typescript
// Current: returns number
const balanceCents = await getTenantBalance(session.user.id, link.unitId)

// Current: boolean check for any pending payment
const hasPendingPayments = !!pendingPayment
```

Target interface (from research):
```typescript
export interface TenantBalanceResult {
  balanceCents: number            // confirmed balance (charges - succeeded payments)
  pendingPaymentsCents: number    // sum of pending payment amounts
}
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Enhance getTenantBalance to return pending payments</name>
  <files>src/lib/ledger.ts, src/lib/__tests__/ledger.test.ts</files>
  <behavior>
    - getTenantBalance returns { balanceCents, pendingPaymentsCents } instead of a plain number
    - balanceCents = SUM(charges) - SUM(succeeded payments) — unchanged logic
    - pendingPaymentsCents = SUM(pending payments) — new field
    - When no pending payments exist, pendingPaymentsCents = 0
    - When no charges or payments exist, both fields = 0
    - formatBalance is unchanged (still accepts a number)
  </behavior>
  <action>
    **Step 1: RED — Write tests in src/lib/__tests__/ledger.test.ts**
    Mock the `@/db` module using `vi.mock`:
    ```typescript
    vi.mock("@/db", () => ({
      db: { execute: vi.fn() },
    }))
    ```

    Write tests:
    - Returns `{ balanceCents: 0, pendingPaymentsCents: 0 }` when no data
    - Returns correct `balanceCents` with charges and succeeded payments
    - Returns `pendingPaymentsCents` from pending payments sum
    - Both fields are numbers (not strings from SQL)

    Run `npx vitest run src/lib/__tests__/ledger.test.ts` — MUST FAIL.

    **Step 2: GREEN — Update getTenantBalance in src/lib/ledger.ts**
    1. Export new interface:
    ```typescript
    export interface TenantBalanceResult {
      balanceCents: number
      pendingPaymentsCents: number
    }
    ```

    2. Change return type from `Promise<number>` to `Promise<TenantBalanceResult>`.

    3. Add pending payments subquery to the SQL:
    ```sql
    COALESCE(
      (SELECT SUM(amount_cents) FROM payments
       WHERE tenant_user_id = $1 AND unit_id = $2
       AND status = 'pending'),
      0
    ) AS pending_payments_cents
    ```

    4. Return `{ balanceCents: Number(...), pendingPaymentsCents: Number(...) }`.

    Run `npx vitest run src/lib/__tests__/ledger.test.ts` — MUST PASS.

    **IMPORTANT:** This is a breaking change to the return type. All callers must be updated. Currently there are exactly 2 callers:
    - `src/app/(tenant)/tenant/dashboard/page.tsx` — updated in Task 2
    - `src/app/api/cron/late-fees/route.ts` — does NOT call getTenantBalance (it checks payments directly), so no change needed

    Verify no other callers: `grep -rn "getTenantBalance" src/`
  </action>
  <verify>
    <automated>npx vitest run src/lib/__tests__/ledger.test.ts --reporter=verbose</automated>
  </verify>
  <done>getTenantBalance returns TenantBalanceResult with both balanceCents and pendingPaymentsCents. Unit tests pass with mocked DB.</done>
</task>

<task type="auto">
  <name>Task 2: Update BalanceCard and dashboard to show pending amount</name>
  <files>src/components/tenant/BalanceCard.tsx, src/app/(tenant)/tenant/dashboard/page.tsx</files>
  <action>
    **Step 1: Update BalanceCard props**
    Change the interface from:
    ```typescript
    interface BalanceCardProps {
      balanceCents: number
      hasPendingPayments: boolean
    }
    ```
    To:
    ```typescript
    interface BalanceCardProps {
      balanceCents: number
      pendingPaymentsCents: number
    }
    ```

    **Step 2: Update BalanceCard rendering**
    Replace the existing `hasPendingPayments` conditional message with amount display:
    ```tsx
    {pendingPaymentsCents > 0 && (
      <p className="mt-2 text-sm text-amber-700">
        ${(pendingPaymentsCents / 100).toFixed(2)} payment processing
      </p>
    )}
    ```

    This shows in all balance states (owed, credit, current) when there are pending payments. Keep the same amber-700 color for the pending message for consistency with the "amount due" card.

    **Step 3: Update tenant dashboard page**
    In `src/app/(tenant)/tenant/dashboard/page.tsx`:

    1. Change the getTenantBalance call to destructure the new return type:
    ```typescript
    // OLD:
    const balanceCents = await getTenantBalance(session.user.id, link.unitId)
    // NEW:
    const { balanceCents, pendingPaymentsCents } = await getTenantBalance(session.user.id, link.unitId)
    ```

    2. Remove the separate pending payment query (lines 81-95) — it's now part of getTenantBalance. Remove `const hasPendingPayments = !!pendingPayment`.

    3. Update the BalanceCard usage:
    ```tsx
    <BalanceCard
      balanceCents={balanceCents}
      pendingPaymentsCents={isReadOnly ? 0 : pendingPaymentsCents}
    />
    ```

    4. Make sure the `payments` import is still used elsewhere in the file (for `lastPayment` query). If so, keep it. If the only `payments` usage was the pending query that's now removed, keep the import for the `lastPayment` query which is still there.

    **Step 4: Run tests**
    ```bash
    npx vitest run --reporter=verbose
    ```
  </action>
  <verify>
    <automated>npx vitest run --reporter=verbose</automated>
  </verify>
  <done>BalanceCard shows pending payment amounts. Dashboard wired to new getTenantBalance return type. Separate pending payment query removed (simplified). All unit tests pass.</done>
</task>

</tasks>

<verification>
1. `npx vitest run --reporter=verbose` — all unit tests pass
2. `grep -n "pendingPaymentsCents" src/lib/ledger.ts` — confirms new field exists
3. `grep -n "pendingPaymentsCents" src/components/tenant/BalanceCard.tsx` — confirms UI uses it
4. `grep -n "hasPendingPayments" src/components/tenant/BalanceCard.tsx` — should NOT match (replaced)
</verification>

<success_criteria>
- getTenantBalance returns `{ balanceCents, pendingPaymentsCents }` (not just a number)
- BalanceCard displays pending payment dollar amount (not just boolean text)
- Pending payments are informational only — NOT subtracted from confirmed balance
- Dashboard query simplified (removed separate pending payment query)
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-fintech-polish-edge-cases/13-02-SUMMARY.md`
</output>
