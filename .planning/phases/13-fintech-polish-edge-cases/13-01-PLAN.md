---
phase: 13-fintech-polish-edge-cases
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vitest.config.ts
  - package.json
  - src/lib/timezone.ts
  - src/lib/__tests__/timezone.test.ts
  - src/middleware.ts
  - src/__tests__/middleware.test.ts
autonomous: true
requirements:
  - FIN-01
  - FIN-03

must_haves:
  truths:
    - "daysSinceRentDue returns positive days when checking after month boundary (e.g., due 28th, current 2nd = +4/+5, NOT -26)"
    - "daysSinceRentDue returns 0 on the due day itself"
    - "daysSinceRentDue returns correct positive values for same-month checks"
    - "daysSinceRentDue handles February (28/29 days) and 31-day months"
    - "Middleware cookie check works with both unprefixed and __Secure- prefixed cookie names"
    - "Vitest runs and all unit tests pass via npm test"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Vitest configuration with path aliases"
    - path: "src/lib/__tests__/timezone.test.ts"
      provides: "Unit tests for daysSinceRentDue rewrite"
      min_lines: 40
    - path: "src/lib/timezone.ts"
      provides: "Fixed daysSinceRentDue with calendar-aware date math"
    - path: "src/middleware.ts"
      provides: "Cookie check using getSessionCookie from better-auth"
  key_links:
    - from: "src/app/api/cron/late-fees/route.ts"
      to: "src/lib/timezone.ts"
      via: "import { daysSinceRentDue }"
      pattern: "daysSinceRentDue"
    - from: "src/middleware.ts"
      to: "better-auth/cookies"
      via: "import { getSessionCookie }"
      pattern: "getSessionCookie"
---

<objective>
Set up Vitest unit testing infrastructure, fix the critical daysSinceRentDue month-boundary bug via TDD, and fix the middleware cookie name for production environments.

Purpose: The daysSinceRentDue bug causes late fees to never be assessed for tenants with due dates 20-28 when the cron runs after the month boundary. The middleware cookie bug causes tenant routes to redirect to login in production where Better Auth prefixes cookies with `__Secure-`. Both are silent failures that only manifest in production.

Output: Working Vitest config, passing unit tests for timezone functions, fixed date math, fixed middleware cookie detection.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-fintech-polish-edge-cases/13-RESEARCH.md

@src/lib/timezone.ts
@src/middleware.ts
@src/app/api/cron/late-fees/route.ts

<interfaces>
<!-- Key types and contracts the executor needs -->

From src/lib/timezone.ts:
```typescript
export interface LocalDate {
  year: number
  month: number  // 1-12
  day: number    // 1-31
}

export function getLocalDate(timezone: string): LocalDate
export function getLocalBillingPeriod(timezone: string): string
export function daysSinceRentDue(rentDueDay: number, timezone: string): number
```

From better-auth/cookies (node_modules):
```typescript
declare const getSessionCookie: (
  request: Request | Headers,
  config?: {
    cookiePrefix?: string;
    cookieName?: string;
    path?: string;
  } | undefined
) => string | null;
```

Existing middleware structure:
```typescript
// Tenant routes: lightweight cookie check (full validation in page components)
if (pathname.startsWith("/tenant")) {
  const sessionCookie = request.cookies.get("better-auth.session_token")  // BUG: hardcoded name
  // ...
}
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Set up Vitest and TDD-rewrite daysSinceRentDue</name>
  <files>vitest.config.ts, package.json, src/lib/timezone.ts, src/lib/__tests__/timezone.test.ts</files>
  <behavior>
    - daysSinceRentDue(28, tz) returns 0 when local day is 28
    - daysSinceRentDue(28, tz) returns 4 or 5 when local day is 2 of next month (NOT -26)
    - daysSinceRentDue(1, tz) returns 14 when local day is 15
    - daysSinceRentDue(15, tz) returns -5 when local day is 10 (rent not yet due this month -- returns days since LAST month's due date, which is positive ~25-26)
    - Actually per research: when day < rentDueDay, calculate days since LAST month's due date (positive). So daysSinceRentDue(15, tz) when day=10 should return ~25 (days since last month's 15th)
    - daysSinceRentDue(29, tz) in February clamps to 28 (or 29 for leap year)
    - daysSinceRentDue(1, tz) returns 0 on the 1st
    - getLocalDate still returns correct year/month/day (regression check)
  </behavior>
  <action>
    **Step 1: Install Vitest**
    ```bash
    npm install -D vitest @vitest/coverage-v8
    ```

    **Step 2: Create vitest.config.ts**
    ```typescript
    import { defineConfig } from "vitest/config"
    import path from "path"

    export default defineConfig({
      test: {
        globals: true,
        environment: "node",
        include: ["src/**/*.test.ts", "src/**/__tests__/**/*.test.ts"],
      },
      resolve: {
        alias: {
          "@": path.resolve(__dirname, "./src"),
        },
      },
    })
    ```

    **Step 3: Add "test" script to package.json**
    Add `"test": "vitest run"` and `"test:watch": "vitest"` to the scripts section.

    **Step 4: RED — Write failing tests in src/lib/__tests__/timezone.test.ts**
    Import `daysSinceRentDue` and `getLocalDate`. To test without mocking `new Date()`, the `daysSinceRentDue` function needs to accept an optional reference date. Modify the signature to:
    ```typescript
    export function daysSinceRentDue(
      rentDueDay: number,
      timezone: string,
      referenceDate?: Date  // NEW: for testability, defaults to new Date()
    ): number
    ```

    Write tests using explicit reference dates:
    - Same month: `daysSinceRentDue(1, "America/New_York", new Date(2026, 0, 15))` → 14
    - On due day: `daysSinceRentDue(28, "America/New_York", new Date(2026, 0, 28))` → 0
    - Month boundary: `daysSinceRentDue(28, "America/New_York", new Date(2026, 1, 2))` → 5 (Jan has 31 days, 31-28=3 remaining + 2 = 5)
    - February clamp: `daysSinceRentDue(31, "America/New_York", new Date(2026, 1, 15))` → days since Feb 28 (clamped) = previous month occurrence
    - Before due day (uses last month): `daysSinceRentDue(20, "America/New_York", new Date(2026, 1, 5))` → days since Jan 20 = 16

    Run `npx vitest run` — tests MUST FAIL (function doesn't accept referenceDate yet).

    **Step 5: GREEN — Rewrite daysSinceRentDue**
    Replace the current `day - rentDueDay` implementation with calendar-aware logic per the research:

    ```typescript
    export function daysSinceRentDue(
      rentDueDay: number,
      timezone: string,
      referenceDate?: Date
    ): number {
      const { year, month, day } = getLocalDate(timezone, referenceDate)

      // Determine the most recent due date occurrence
      let dueYear = year
      let dueMonth = month

      if (day < rentDueDay) {
        // Due date hasn't occurred this month yet -- use last month's due date
        dueMonth -= 1
        if (dueMonth < 1) {
          dueMonth = 12
          dueYear -= 1
        }
      }

      // Clamp due day to actual days in the due month
      const daysInDueMonth = new Date(dueYear, dueMonth, 0).getDate()
      const clampedDueDay = Math.min(rentDueDay, daysInDueMonth)

      // Calculate difference in milliseconds, convert to days
      const currentDate = new Date(year, month - 1, day)
      const dueDate = new Date(dueYear, dueMonth - 1, clampedDueDay)
      const diffMs = currentDate.getTime() - dueDate.getTime()

      return Math.round(diffMs / (1000 * 60 * 60 * 24))
    }
    ```

    Also update `getLocalDate` to accept an optional `referenceDate` parameter (defaulting to `new Date()`):
    ```typescript
    export function getLocalDate(timezone: string, referenceDate?: Date): LocalDate {
      const formatter = new Intl.DateTimeFormat("en-US", {
        timeZone: timezone,
        year: "numeric",
        month: "numeric",
        day: "numeric",
      })
      const parts = formatter.formatToParts(referenceDate ?? new Date())
      // ... rest unchanged
    }
    ```

    Run `npx vitest run` — all tests MUST PASS.

    **IMPORTANT:** The `referenceDate` parameter is added as optional with a default. All existing callers (late-fee cron, rent reminder cron, autopay-charge cron) pass only `(rentDueDay, timezone)` and will continue to work unchanged — they'll use `new Date()` by default.
  </action>
  <verify>
    <automated>npx vitest run src/lib/__tests__/timezone.test.ts --reporter=verbose</automated>
  </verify>
  <done>Vitest configured and running. daysSinceRentDue correctly handles month boundaries, February, and 31-day months. All existing callers unaffected (backward-compatible optional parameter). At least 6 test cases pass.</done>
</task>

<task type="auto">
  <name>Task 2: Fix middleware cookie name for production</name>
  <files>src/middleware.ts, src/__tests__/middleware.test.ts</files>
  <action>
    **Step 1: Update src/middleware.ts**
    Replace the hardcoded cookie name check in the tenant routes section:

    ```typescript
    // OLD:
    const sessionCookie = request.cookies.get("better-auth.session_token")

    // NEW:
    import { getSessionCookie } from "better-auth/cookies"
    // ...
    const sessionToken = getSessionCookie(request)
    ```

    The `getSessionCookie` function accepts `Request | Headers` and automatically handles both `better-auth.session_token` (development) and `__Secure-better-auth.session_token` (production with HTTPS). It returns `string | null`.

    Update the condition from `if (!sessionCookie)` to `if (!sessionToken)`.

    The admin route section uses `auth.api.getSession()` which handles cookies internally — no changes needed there.

    **Step 2: Create unit test src/__tests__/middleware.test.ts**
    Write a basic unit test verifying the import works and the middleware function is exported. Since Next.js middleware is hard to unit test in isolation (requires NextRequest), write a focused test that:
    - Verifies `getSessionCookie` import from `better-auth/cookies` resolves
    - Documents the expected behavior (cookie with and without prefix)

    This is a lightweight verification — the real test is that the existing E2E tests continue to pass (they test the tenant auth flow).

    **Step 3: Run full test suite to verify no regressions**
    ```bash
    npx vitest run --reporter=verbose
    ```
  </action>
  <verify>
    <automated>npx vitest run --reporter=verbose</automated>
  </verify>
  <done>Middleware uses getSessionCookie from better-auth/cookies. Cookie detection works for both development (better-auth.session_token) and production (__Secure-better-auth.session_token). All unit tests pass.</done>
</task>

</tasks>

<verification>
1. `npx vitest run --reporter=verbose` — all unit tests pass
2. `grep -n "getSessionCookie" src/middleware.ts` — confirms better-auth cookie helper is used
3. `grep -n "day - rentDueDay" src/lib/timezone.ts` — should NOT match (old bug removed)
4. `grep -n "referenceDate" src/lib/timezone.ts` — confirms testable parameter exists
</verification>

<success_criteria>
- Vitest installed and configured with path aliases
- `npm test` runs all unit tests successfully
- daysSinceRentDue returns positive values across month boundaries (verified by 6+ test cases)
- Middleware cookie detection uses getSessionCookie (handles both prefixed and unprefixed cookies)
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/13-fintech-polish-edge-cases/13-01-SUMMARY.md`
</output>
