---
phase: 13-fintech-polish-edge-cases
plan: 04
type: execute
wave: 3
depends_on: ["13-02", "13-03"]
files_modified:
  - src/lib/proration.ts
  - src/lib/__tests__/proration.test.ts
  - src/components/admin/MoveOutDialog.tsx
  - src/app/api/admin/move-out/route.ts
autonomous: true
requirements:
  - FIN-06

must_haves:
  truths:
    - "calculateProratedRent returns correct integer cents for move-in proration (charges remaining days including move-in day)"
    - "calculateProratedRent returns correct integer cents for move-out proration (charges elapsed days including move-out day)"
    - "calculateProratedRent handles February (28/29 days) and 31-day months correctly"
    - "MoveOutDialog has a 'Calculate Prorated Rent' button that pre-fills a final charge with the prorated amount"
    - "Admin can review and adjust the prorated charge before confirming move-out"
  artifacts:
    - path: "src/lib/proration.ts"
      provides: "calculateProratedRent pure function"
      exports: ["calculateProratedRent"]
      min_lines: 15
    - path: "src/lib/__tests__/proration.test.ts"
      provides: "Unit tests for proration calculations"
      min_lines: 40
    - path: "src/components/admin/MoveOutDialog.tsx"
      provides: "MoveOutDialog with proration button"
  key_links:
    - from: "src/components/admin/MoveOutDialog.tsx"
      to: "src/lib/proration.ts"
      via: "import { calculateProratedRent }"
      pattern: "calculateProratedRent"
---

<objective>
Create a prorated rent calculation utility and integrate it into the move-out dialog as a convenience feature for admins.

Purpose: When a tenant moves out mid-month, the landlord needs to calculate how much rent to charge for the partial month. Currently, the admin must manually calculate this. The proration utility automates the math based on actual days in the month, and the "Calculate Prorated Rent" button in the move-out dialog pre-fills a final charge that the admin can review and adjust.

Output: Pure proration function with comprehensive tests, MoveOutDialog with proration button.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/13-fintech-polish-edge-cases/13-RESEARCH.md

@src/components/admin/MoveOutDialog.tsx
@src/app/api/admin/move-out/route.ts

<interfaces>
<!-- Key interfaces the executor needs -->

From src/components/admin/MoveOutDialog.tsx:
```typescript
interface FinalCharge {
  description: string
  amountDollars: string
}

interface MoveOutDialogProps {
  tenant: { userId: string; name: string; email: string }
  unit: { id: string; unitNumber: string }
  onSuccess: () => void
  trigger: React.ReactNode
}

// State:
const [moveOutDate, setMoveOutDate] = useState(new Date().toISOString().split("T")[0])
const [finalCharges, setFinalCharges] = useState<FinalCharge[]>([])
```

Target proration interface (from research):
```typescript
export function calculateProratedRent(
  monthlyRentCents: number,
  moveDate: Date,
  type: "move_in" | "move_out"
): number  // returns integer cents
```

MoveOutDialog needs `rentAmountCents` prop added to calculate proration.
Currently the dialog receives `unit: { id: string; unitNumber: string }`.
The parent component (admin tenants page) already has access to unit.rentAmountCents.
Update the prop to: `unit: { id: string; unitNumber: string; rentAmountCents: number | null }`.
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Create calculateProratedRent utility with TDD</name>
  <files>src/lib/proration.ts, src/lib/__tests__/proration.test.ts</files>
  <behavior>
    - move_in on Jan 15: (31-15+1)/31 * $1500 = 17/31 * 150000 = Math.round(82258.06) = 82258 cents
    - move_out on Jan 15: 15/31 * $1500 = 15/31 * 150000 = Math.round(72580.65) = 72581 cents
    - move_in on Feb 1 (non-leap): 28/28 * rent = full month
    - move_out on Feb 28 (non-leap): 28/28 * rent = full month
    - move_in on Mar 31: 1/31 * rent (one day)
    - move_out on Mar 1: 1/31 * rent (one day)
    - move_in on Feb 1 (leap year 2028): 29/29 * rent = full month
    - Always returns integer (no floating point cents)
    - Returns 0 if monthlyRentCents is 0
  </behavior>
  <action>
    **Step 1: RED — Write tests in src/lib/__tests__/proration.test.ts**
    ```typescript
    import { describe, it, expect } from "vitest"
    import { calculateProratedRent } from "../proration"

    describe("calculateProratedRent", () => {
      const rent = 150000 // $1,500.00

      describe("move_in", () => {
        it("charges remaining days including move-in day", () => {
          // Jan 15: 17 remaining days out of 31
          expect(calculateProratedRent(rent, new Date(2026, 0, 15), "move_in"))
            .toBe(Math.round(rent * 17 / 31))
        })

        it("returns full month for move-in on 1st", () => {
          expect(calculateProratedRent(rent, new Date(2026, 0, 1), "move_in"))
            .toBe(rent)
        })

        it("returns one day for move-in on last day", () => {
          expect(calculateProratedRent(rent, new Date(2026, 0, 31), "move_in"))
            .toBe(Math.round(rent / 31))
        })

        it("handles February (28 days)", () => {
          expect(calculateProratedRent(rent, new Date(2026, 1, 1), "move_in"))
            .toBe(rent) // full month
        })
      })

      describe("move_out", () => {
        it("charges elapsed days including move-out day", () => {
          // Jan 15: 15 elapsed days out of 31
          expect(calculateProratedRent(rent, new Date(2026, 0, 15), "move_out"))
            .toBe(Math.round(rent * 15 / 31))
        })

        it("returns full month for move-out on last day", () => {
          // Jan 31: 31/31 = full
          expect(calculateProratedRent(rent, new Date(2026, 0, 31), "move_out"))
            .toBe(rent)
        })

        it("returns one day for move-out on 1st", () => {
          expect(calculateProratedRent(rent, new Date(2026, 0, 1), "move_out"))
            .toBe(Math.round(rent / 31))
        })
      })

      it("returns 0 for zero rent", () => {
        expect(calculateProratedRent(0, new Date(2026, 0, 15), "move_in")).toBe(0)
      })

      it("always returns integer", () => {
        const result = calculateProratedRent(rent, new Date(2026, 0, 15), "move_in")
        expect(Number.isInteger(result)).toBe(true)
      })
    })
    ```

    Run `npx vitest run src/lib/__tests__/proration.test.ts` — MUST FAIL (module doesn't exist).

    **Step 2: GREEN — Create src/lib/proration.ts**
    ```typescript
    /**
     * Calculate prorated rent based on actual days in the month.
     * @param monthlyRentCents - Full month's rent in cents
     * @param moveDate - Move-in or move-out date
     * @param type - "move_in" (charges remaining days) or "move_out" (charges elapsed days)
     * @returns Prorated amount in cents (integer)
     */
    export function calculateProratedRent(
      monthlyRentCents: number,
      moveDate: Date,
      type: "move_in" | "move_out"
    ): number {
      const year = moveDate.getFullYear()
      const month = moveDate.getMonth() // 0-indexed
      const day = moveDate.getDate()
      const daysInMonth = new Date(year, month + 1, 0).getDate()

      if (type === "move_in") {
        // Charge for remaining days including move-in day
        const remainingDays = daysInMonth - day + 1
        return Math.round((monthlyRentCents * remainingDays) / daysInMonth)
      } else {
        // Charge for elapsed days including move-out day
        return Math.round((monthlyRentCents * day) / daysInMonth)
      }
    }
    ```

    Run `npx vitest run src/lib/__tests__/proration.test.ts` — MUST PASS.

    **IMPORTANT per research:** Always use integer cents. Use `Math.round()` at the final step only. Use `new Date(year, month + 1, 0).getDate()` for actual days in month (handles Feb, leap years, 30/31-day months).
  </action>
  <verify>
    <automated>npx vitest run src/lib/__tests__/proration.test.ts --reporter=verbose</automated>
  </verify>
  <done>calculateProratedRent correctly handles move-in and move-out proration for all month lengths. Returns integer cents. At least 8 test cases pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add proration button to MoveOutDialog</name>
  <files>src/components/admin/MoveOutDialog.tsx</files>
  <action>
    **Step 1: Add rentAmountCents to the unit prop**
    Update the `MoveOutDialogProps` interface:
    ```typescript
    interface MoveOutDialogProps {
      tenant: { userId: string; name: string; email: string }
      unit: { id: string; unitNumber: string; rentAmountCents: number | null }  // added rentAmountCents
      onSuccess: () => void
      trigger: React.ReactNode
    }
    ```

    **Step 2: Import calculateProratedRent**
    ```typescript
    import { calculateProratedRent } from "@/lib/proration"
    ```

    **Step 3: Add "Calculate Prorated Rent" button handler**
    ```typescript
    function addProratedCharge() {
      if (!unit.rentAmountCents || !moveOutDate) return

      const moveDate = new Date(moveOutDate + "T00:00:00") // Parse YYYY-MM-DD without timezone shift
      const proratedCents = calculateProratedRent(unit.rentAmountCents, moveDate, "move_out")
      const proratedDollars = (proratedCents / 100).toFixed(2)

      // Add as a pre-filled final charge that admin can review/adjust
      setFinalCharges([
        ...finalCharges,
        {
          description: `Prorated rent through ${moveOutDate}`,
          amountDollars: proratedDollars,
        },
      ])
    }
    ```

    **Step 4: Add the button to the UI**
    Place the "Calculate Prorated Rent" button next to the "+ Add Final Charge" button in the final charges section:
    ```tsx
    <div className="flex gap-2">
      <Button
        type="button"
        variant="outline"
        size="sm"
        onClick={addCharge}
        disabled={loading}
      >
        + Add Final Charge
      </Button>
      {unit.rentAmountCents && (
        <Button
          type="button"
          variant="outline"
          size="sm"
          onClick={addProratedCharge}
          disabled={loading}
        >
          Calculate Prorated Rent
        </Button>
      )}
    </div>
    ```

    **Step 5: Update callers to pass rentAmountCents**
    Search for MoveOutDialog usage and add `rentAmountCents` to the unit prop. The caller is likely in the admin tenants/units page where unit data is already loaded.

    ```bash
    grep -rn "MoveOutDialog" src/
    ```

    Update each caller to include `rentAmountCents` in the `unit` prop. Example:
    ```tsx
    <MoveOutDialog
      tenant={...}
      unit={{
        id: unit.id,
        unitNumber: unit.unitNumber,
        rentAmountCents: unit.rentAmountCents,  // ADD THIS
      }}
      onSuccess={...}
      trigger={...}
    />
    ```

    **Step 6: Run tests**
    ```bash
    npx vitest run --reporter=verbose
    ```

    **IMPORTANT per research:** The proration button is a convenience — it pre-fills a final charge that the admin can review and adjust before confirming. It does NOT auto-submit. The admin always has final say over the amount. Parse the date with `"T00:00:00"` suffix to avoid timezone interpretation issues with date-only strings.
  </action>
  <verify>
    <automated>npx vitest run --reporter=verbose</automated>
  </verify>
  <done>MoveOutDialog has "Calculate Prorated Rent" button. Button pre-fills a final charge with prorated amount. Admin can review and adjust before confirming. All callers pass rentAmountCents. All unit tests pass.</done>
</task>

</tasks>

<verification>
1. `npx vitest run --reporter=verbose` — all unit tests pass (timezone, ledger, proration, nsf)
2. `grep -n "calculateProratedRent" src/lib/proration.ts` — confirms function exists
3. `grep -n "calculateProratedRent" src/components/admin/MoveOutDialog.tsx` — confirms integration
4. `grep -n "Prorated" src/components/admin/MoveOutDialog.tsx` — confirms button text
</verification>

<success_criteria>
- calculateProratedRent handles all month lengths and returns integer cents
- MoveOutDialog shows "Calculate Prorated Rent" button when unit has rent configured
- Button pre-fills a final charge with prorated amount and descriptive text
- Admin can modify or remove the prorated charge before submitting
- All unit tests pass (8+ proration test cases)
- All existing unit tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-fintech-polish-edge-cases/13-04-SUMMARY.md`
</output>
