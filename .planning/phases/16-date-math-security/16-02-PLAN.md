---
phase: 16-date-math-security
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/middleware.ts
  - src/__tests__/middleware.test.ts
autonomous: true
requirements: [HARD-05]

must_haves:
  truths:
    - "A tenant with a revoked or expired session is redirected to /auth/login when accessing any /tenant/* page"
    - "A suspended user (session deleted from DB) cannot see the tenant layout HTML"
    - "Admin middleware session validation behavior is unchanged"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Full session validation for tenant routes"
      contains: "auth.api.getSession"
    - path: "src/__tests__/middleware.test.ts"
      provides: "Updated middleware tests covering session validation"
      contains: "session validation"
  key_links:
    - from: "src/middleware.ts"
      to: "@/lib/auth"
      via: "auth.api.getSession import"
      pattern: "auth\\.api\\.getSession"
---

<objective>
Upgrade tenant middleware from cookie-existence check to full session validation (matching the admin route pattern), so suspended accounts, revoked sessions, and expired cookies are rejected at the middleware level.

Purpose: Currently tenant middleware only checks if a session cookie exists (line 29: `getSessionCookie(request)`), but doesn't validate it against the session store. A user whose session was revoked or account suspended would still pass middleware and see the tenant layout HTML before being caught by server component or API route auth. This closes that gap.

Output: Updated middleware.ts with full session validation for tenant routes, updated middleware tests.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

@src/middleware.ts
@src/__tests__/middleware.test.ts
</context>

<interfaces>
<!-- Current middleware structure from src/middleware.ts -->
From src/middleware.ts:
```typescript
// Admin routes: full session validation with role check
if (pathname.startsWith("/admin")) {
  const session = await auth.api.getSession({ headers: await headers() })
  // ... validates session + role
}

// Tenant routes: lightweight cookie check (full validation in page components)
if (pathname.startsWith("/tenant")) {
  const sessionToken = getSessionCookie(request)
  // ... only checks cookie existence
}
```

From src/lib/auth.ts:
```typescript
export const auth = betterAuth({ ... })
// auth.api.getSession() validates against session store, returns null if expired/revoked
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade tenant middleware to full session validation</name>
  <files>src/middleware.ts, src/__tests__/middleware.test.ts</files>
  <action>
    In src/middleware.ts, replace the tenant route block (lines 27-37) to use `auth.api.getSession()` instead of `getSessionCookie()`. The new tenant block should mirror the admin block pattern but WITHOUT the role check:

    ```typescript
    // Tenant routes: full session validation (matches admin pattern without role check)
    if (pathname.startsWith("/tenant")) {
      const session = await auth.api.getSession({ headers: await headers() })

      if (!session) {
        const loginUrl = new URL("/auth/login", request.url)
        loginUrl.searchParams.set("callbackUrl", pathname)
        return NextResponse.redirect(loginUrl)
      }

      return NextResponse.next()
    }
    ```

    Remove the `getSessionCookie` import from "better-auth/cookies" since it is no longer used anywhere in the file. Keep the `auth` import and `headers` import which are already present for admin route handling.

    For src/__tests__/middleware.test.ts: Update existing tests. The tests currently mock `getSessionCookie` -- they need to be updated to reflect that tenant routes now use `auth.api.getSession()` like admin routes. The key test cases:

    1. Tenant route with valid session: returns NextResponse.next()
    2. Tenant route with no/invalid/expired session (getSession returns null): redirects to /auth/login with callbackUrl
    3. Admin route with valid admin session: returns NextResponse.next() (unchanged)
    4. Admin route with valid non-admin session: redirects to /tenant/dashboard (unchanged)
    5. Admin route with no session: redirects to /auth/login (unchanged)
    6. Non-tenant/non-admin route: passes through (unchanged)

    Note: The middleware uses `runtime: "nodejs"` (line 45), so auth.api.getSession() works fine -- there is no edge runtime limitation. This was already proven by the admin route pattern.
  </action>
  <verify>
    <automated>npx vitest run src/__tests__/middleware.test.ts</automated>
  </verify>
  <done>
    - Tenant middleware validates session against session store via auth.api.getSession()
    - getSessionCookie import removed (no longer needed)
    - A request to /tenant/* with a revoked/expired session is redirected to /auth/login
    - All middleware tests pass
  </done>
</task>

</tasks>

<verification>
npx vitest run src/__tests__/middleware.test.ts
All middleware tests pass, confirming tenant routes now use full session validation.
</verification>

<success_criteria>
- src/middleware.ts uses auth.api.getSession() for tenant routes (not getSessionCookie)
- getSessionCookie import removed from middleware.ts
- Tenant routes redirect to /auth/login when session is null (expired/revoked/missing)
- Admin route behavior unchanged
- npx vitest run passes with 0 failures
</success_criteria>

<output>
After completion, create `.planning/phases/16-date-math-security/16-02-SUMMARY.md`
</output>
