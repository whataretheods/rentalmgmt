---
phase: 16-date-math-security
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/timezone.ts
  - src/lib/__tests__/timezone.test.ts
autonomous: true
requirements: [HARD-03, HARD-04]

must_haves:
  truths:
    - "daysSinceRentDue returns correct day count when a DST spring-forward (23-hour day) falls between the due date and current date"
    - "daysSinceRentDue returns correct day count when a DST fall-back (25-hour day) falls between the due date and current date"
    - "All existing timezone tests continue to pass unchanged"
  artifacts:
    - path: "src/lib/timezone.ts"
      provides: "DST-proof daysSinceRentDue using Date.UTC()"
      contains: "Date.UTC"
    - path: "src/lib/__tests__/timezone.test.ts"
      provides: "DST boundary test cases"
      contains: "spring-forward"
  key_links:
    - from: "src/lib/timezone.ts"
      to: "src/app/api/cron/late-fees/route.ts"
      via: "daysSinceRentDue import"
      pattern: "daysSinceRentDue"
---

<objective>
Fix daysSinceRentDue to use Date.UTC() constructors so DST transitions (23-hour or 25-hour days) never produce off-by-one day counts, with unit tests proving correctness across spring-forward and fall-back boundaries.

Purpose: A DST spring-forward produces a 23-hour gap that Math.round could round incorrectly, causing late fees to be assessed a day early or late. Date.UTC() eliminates timezone-dependent hour variations entirely.

Output: Updated timezone.ts with UTC-based date math and new DST-specific test cases.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/timezone.ts
@src/lib/__tests__/timezone.test.ts
</context>

<feature>
  <name>DST-proof daysSinceRentDue</name>
  <files>src/lib/timezone.ts, src/lib/__tests__/timezone.test.ts</files>
  <behavior>
    The bug: Lines 78-82 of timezone.ts use `new Date(year, month - 1, day)` which creates dates in the local timezone. When a DST transition occurs between the due date and current date, the millisecond difference is 23 or 25 hours per day instead of 24, potentially making Math.round produce wrong results for boundary cases.

    The fix: Replace `new Date(year, month - 1, day)` with `new Date(Date.UTC(year, month - 1, day))` on both date constructions. Since we only care about whole calendar days (year/month/day integers already extracted from getLocalDate), UTC eliminates any DST hour variation.

    Test cases to add (append to existing describe block):

    - DST spring-forward (March 2026): Due day 1, reference date March 15 2026 in America/New_York. DST springs forward March 8, 2026. daysSinceRentDue(1, "America/New_York", referenceDate) === 14. The 23-hour day on March 8 must not affect the count.

    - DST fall-back (November 2026): Due day 1, reference date November 15 2026 in America/New_York. DST falls back November 1, 2026. daysSinceRentDue(1, "America/New_York", referenceDate) === 14. The 25-hour day on November 1 must not affect the count.

    - DST boundary straddling due date (March 2026): Due day 7, reference date March 10 2026. DST springs forward March 8. daysSinceRentDue(7, "America/New_York", referenceDate) === 3. Due date is just before DST, current date is just after.

    - DST boundary straddling due date (November 2026): Due day 1, reference date November 3 2026. DST falls back November 1. daysSinceRentDue(1, "America/New_York", referenceDate) === 2.
  </behavior>
  <implementation>
    In src/lib/timezone.ts, change lines 78-79 from:
    ```
    const currentDate = new Date(year, month - 1, day)
    const dueDate = new Date(dueYear, dueMonth - 1, clampedDueDay)
    ```
    to:
    ```
    const currentDate = new Date(Date.UTC(year, month - 1, day))
    const dueDate = new Date(Date.UTC(dueYear, dueMonth - 1, clampedDueDay))
    ```

    This is a two-line change. The rest of the function is unchanged -- getLocalDate already correctly extracts calendar year/month/day using Intl.DateTimeFormat, and the Math.round on line 82 continues to work but now always divides by exactly 24-hour UTC days.

    Run `npx vitest run` to confirm all existing tests plus new DST tests pass.
  </implementation>
</feature>

<verification>
npx vitest run src/lib/__tests__/timezone.test.ts
All existing tests pass unchanged. New DST spring-forward and fall-back tests pass.
</verification>

<success_criteria>
- daysSinceRentDue uses Date.UTC() for both date constructions
- At least 4 new test cases explicitly exercise DST spring-forward and fall-back date pairs
- All existing timezone tests pass without modification
- npx vitest run passes with 0 failures
</success_criteria>

<output>
After completion, create `.planning/phases/16-date-math-security/16-01-SUMMARY.md`
</output>
