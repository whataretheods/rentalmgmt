---
phase: 12-vendor-work-order-management
plan: 05
type: execute
wave: 4
depends_on: ["12-02", "12-03", "12-04"]
files_modified:
  - e2e/vendors.spec.ts
  - e2e/work-orders.spec.ts
  - scripts/seed-phase12.ts
autonomous: true
requirements:
  - OPS-01
  - OPS-02
  - OPS-03
  - OPS-04

must_haves:
  truths:
    - "E2E test verifies admin can add, edit, and deactivate vendors"
    - "E2E test verifies admin can create a work order from a maintenance request"
    - "E2E test verifies vendor magic link page shows request details without tenant PII"
    - "E2E test verifies admin can add and view cost line items on work orders"
    - "Seed script creates test data for Phase 12 features"
  artifacts:
    - path: "e2e/vendors.spec.ts"
      provides: "E2E tests for vendor CRUD and work order assignment"
    - path: "e2e/work-orders.spec.ts"
      provides: "E2E tests for work orders, magic link, and cost tracking"
    - path: "scripts/seed-phase12.ts"
      provides: "Seed script for Phase 12 test data"
  key_links:
    - from: "e2e/vendors.spec.ts"
      to: "/admin/vendors"
      via: "Playwright browser navigation and assertions"
      pattern: "page\\.goto.*admin/vendors"
    - from: "e2e/work-orders.spec.ts"
      to: "/vendor/work-order/"
      via: "Playwright browser navigation to magic link"
      pattern: "page\\.goto.*vendor/work-order"
---

<objective>
Create E2E tests and seed data for all Phase 12 features -- vendor CRUD, work order management, magic link access, and cost tracking.

Purpose: Validates all four OPS requirements end-to-end. Seed script provides test data for development and testing.

Output: Two E2E test files covering all Phase 12 features, one seed script for test data.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-vendor-work-order-management/12-RESEARCH.md
@.planning/phases/12-vendor-work-order-management/12-02-SUMMARY.md
@.planning/phases/12-vendor-work-order-management/12-03-SUMMARY.md
@.planning/phases/12-vendor-work-order-management/12-04-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From playwright.config.ts:
```typescript
export default defineConfig({
  testDir: "./e2e",
  fullyParallel: false,
  retries: 0,
  use: {
    baseURL: "http://localhost:3000",
    headless: true,
  },
  timeout: 30000,
})
```

Existing E2E patterns (from e2e/maintenance.spec.ts and others):
- Tests use `test.describe` and `test` from @playwright/test
- Admin login via navigating to /auth/login and filling credentials
- API calls via page.request.fetch() for setup/teardown
- Assertions via expect(page.locator(...)).toBeVisible()

From e2e/check-db.ts (database check utility pattern):
- Direct database queries for setup verification
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 12 seed script for test data</name>
  <files>
    scripts/seed-phase12.ts
  </files>
  <action>
Create scripts/seed-phase12.ts that seeds the database with test data for Phase 12 features.

**CRITICAL:** Use `config({ path: ".env.local" })` for dotenv loading (per project preferences in MEMORY.md).

The script should:

1. Import necessary modules:
```typescript
import { config } from "dotenv"
config({ path: ".env.local" })

import { neon } from "@neondatabase/serverless"
import { drizzle } from "drizzle-orm/neon-http"
import * as schema from "../src/db/schema"
import { vendors, workOrders, workOrderCosts, maintenanceRequests } from "../src/db/schema"
import { eq } from "drizzle-orm"
import crypto from "crypto"
```

2. Create 3-4 sample vendors:
```typescript
const sampleVendors = [
  { companyName: "Quick Fix Plumbing", contactName: "John Smith", email: "john@quickfixplumbing.com", phone: "+15551001001", specialty: "plumbing" as const },
  { companyName: "Spark Electric", contactName: "Sarah Johnson", email: "sarah@sparkelectric.com", phone: "+15551001002", specialty: "electrical" as const },
  { companyName: "Cool Air HVAC", contactName: "Mike Brown", email: "mike@coolairhvac.com", phone: "+15551001003", specialty: "hvac" as const },
  { companyName: "All Around Maintenance", contactName: "Lisa Davis", email: "lisa@allaround.com", phone: "+15551001004", specialty: "general_maintenance" as const },
]
```

3. Find an existing maintenance request to create a sample work order (if one exists)

4. Create a sample work order with vendorAccessToken

5. Create 2-3 sample cost line items on the work order

6. Log results: created vendors, work orders, costs

Run with: `npx tsx scripts/seed-phase12.ts`

The script should be idempotent where possible -- check for existing data before inserting.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsx -e "import('./scripts/seed-phase12.ts')" 2>&1 | head -5</automated>
  </verify>
  <done>
    Seed script creates sample vendors (plumbing, electrical, HVAC, general), a sample work order linked to an existing maintenance request, and sample cost line items. Uses .env.local for dotenv config.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create E2E tests for vendor CRUD and work order management</name>
  <files>
    e2e/vendors.spec.ts
    e2e/work-orders.spec.ts
  </files>
  <action>
Look at existing E2E tests (e2e/maintenance.spec.ts, e2e/payments.spec.ts) to understand the project's E2E test patterns, then create two test files.

**File 1: e2e/vendors.spec.ts**

Tests for OPS-01 (vendor directory):

```typescript
import { test, expect } from "@playwright/test"

test.describe("Vendor Directory", () => {
  test.beforeEach(async ({ page }) => {
    // Login as admin (follow existing login pattern from other e2e tests)
  })

  test("admin can view vendor list page", async ({ page }) => {
    await page.goto("/admin/vendors")
    await expect(page.locator("h1")).toContainText("Vendor")
  })

  test("admin can add a new vendor", async ({ page }) => {
    await page.goto("/admin/vendors")
    // Click Add Vendor button
    // Fill in form: company name, contact name, email, phone, specialty
    // Submit
    // Verify vendor appears in list
  })

  test("admin can edit a vendor", async ({ page }) => {
    // Navigate to vendors, click edit on existing vendor
    // Change company name
    // Save
    // Verify updated name appears
  })

  test("admin can deactivate a vendor", async ({ page }) => {
    // Navigate to vendors, click deactivate
    // Verify status badge changes to inactive
  })
})
```

**File 2: e2e/work-orders.spec.ts**

Tests for OPS-02, OPS-03, OPS-04:

```typescript
import { test, expect } from "@playwright/test"

test.describe("Work Orders", () => {
  test.beforeEach(async ({ page }) => {
    // Login as admin
  })

  test("admin can view work order list page", async ({ page }) => {
    await page.goto("/admin/work-orders")
    await expect(page.locator("h1")).toContainText("Work Order")
  })

  test("admin can create a work order from API", async ({ page }) => {
    // Use page.request to create a work order via POST /api/admin/work-orders
    // Verify it appears in the work order list
  })

  test("vendor magic link shows request details without PII", async ({ page }) => {
    // Create work order with vendor via API to get vendorAccessToken
    // Navigate to /vendor/work-order/[token]
    // Verify maintenance request description is visible
    // Verify unit number is visible
    // Verify NO tenant name appears on page
    // Verify NO tenant email appears on page
    // Verify NO tenant phone appears on page
  })

  test("invalid magic link token shows 404", async ({ page }) => {
    await page.goto("/vendor/work-order/invalid-token-12345")
    // Verify 404 page or "not found" message
  })

  test("admin can add cost to work order", async ({ page }) => {
    // Navigate to work order detail page
    // Fill in cost form: description, amount, category
    // Submit
    // Verify cost appears in cost list
    // Verify total updates
  })

  test("admin can delete a cost from work order", async ({ page }) => {
    // Navigate to work order detail with existing cost
    // Click delete on cost
    // Confirm deletion
    // Verify cost removed from list
  })
})
```

CRITICAL TESTING NOTES:
- Use headless: true (already set in config)
- Follow the project's existing login pattern (check e2e/maintenance.spec.ts for the admin login flow)
- For the PII check in magic link test, use `expect(page.content()).resolves.not.toContain(tenantEmail)` or similar assertion
- Tests should be able to run independently (idempotent where possible)
- Use `test.describe.serial()` if tests within a group depend on each other
- Keep timeouts reasonable (30s default is fine)
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    E2E tests created: vendors.spec.ts covers vendor CRUD (OPS-01), work-orders.spec.ts covers work order creation (OPS-02), magic link PII-free view (OPS-03), and cost tracking (OPS-04). Tests follow existing E2E patterns with admin login, page navigation, and assertions.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` passes (TypeScript compiles)
2. Seed script runs without errors: `npx tsx scripts/seed-phase12.ts`
3. E2E test files exist and TypeScript-check cleanly
4. Tests cover all four OPS requirements
5. Magic link PII test explicitly checks for absence of tenant personal info
</verification>

<success_criteria>
- Seed script creates vendor, work order, and cost test data
- E2E tests cover vendor CRUD (OPS-01)
- E2E tests cover work order creation and vendor assignment (OPS-02)
- E2E tests verify magic link shows details without PII (OPS-03)
- E2E tests cover cost line item CRUD with totals (OPS-04)
- All test files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-vendor-work-order-management/12-05-SUMMARY.md`
</output>
