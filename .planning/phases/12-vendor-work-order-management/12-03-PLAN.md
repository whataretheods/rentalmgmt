---
phase: 12-vendor-work-order-management
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/app/api/admin/work-orders/route.ts
  - src/app/api/admin/work-orders/[id]/route.ts
  - src/app/(admin)/admin/work-orders/page.tsx
  - src/app/(admin)/admin/work-orders/[id]/page.tsx
  - src/app/vendor/work-order/[token]/page.tsx
  - src/app/api/vendor/photos/[token]/[photoId]/route.ts
autonomous: true
requirements:
  - OPS-02
  - OPS-03

must_haves:
  truths:
    - "Admin can create a work order from a maintenance request, optionally assigning a vendor"
    - "Admin can view a list of all work orders with status, vendor, and maintenance request info"
    - "Admin can update work order status, reassign vendor, and manage scheduled dates"
    - "When a vendor is assigned, they receive email/SMS with a magic link URL"
    - "Vendor can view maintenance request details and photos via magic link without logging in"
    - "Vendor magic link page does NOT display any tenant PII (name, email, phone, payment info)"
    - "Admin can regenerate or revoke a vendor access token"
  artifacts:
    - path: "src/app/api/admin/work-orders/route.ts"
      provides: "Work order list and creation endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/admin/work-orders/[id]/route.ts"
      provides: "Work order detail, update, and token management"
      exports: ["GET", "PATCH"]
    - path: "src/app/(admin)/admin/work-orders/page.tsx"
      provides: "Admin work order list page"
    - path: "src/app/(admin)/admin/work-orders/[id]/page.tsx"
      provides: "Admin work order detail page with vendor assignment"
    - path: "src/app/vendor/work-order/[token]/page.tsx"
      provides: "Public vendor-facing work order view (magic link)"
    - path: "src/app/api/vendor/photos/[token]/[photoId]/route.ts"
      provides: "Token-gated photo serving for vendor view"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/admin/work-orders/route.ts"
      to: "workOrders table"
      via: "Drizzle db.insert/select from workOrders"
      pattern: "db\\..*workOrders"
    - from: "src/app/api/admin/work-orders/route.ts"
      to: "notifyVendorAssignment"
      via: "import and call when vendor assigned"
      pattern: "notifyVendorAssignment"
    - from: "src/app/vendor/work-order/[token]/page.tsx"
      to: "workOrders table"
      via: "Server component queries by vendorAccessToken"
      pattern: "vendorAccessToken"
    - from: "src/app/api/vendor/photos/[token]/[photoId]/route.ts"
      to: "maintenancePhotos table"
      via: "Token validation + photo serving"
      pattern: "maintenancePhotos"
---

<objective>
Build work order creation, assignment, management, and the vendor magic link view -- the core workflow from admin creating a work order through vendor receiving and viewing it.

Purpose: OPS-02 requires admin can assign a vendor to a maintenance request. OPS-03 requires the vendor receives a notification with a magic link showing details without tenant PII. This plan delivers both.

Output: Work order API routes, admin work order pages (list + detail), public vendor magic link page, and token-gated photo serving.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-vendor-work-order-management/12-RESEARCH.md
@.planning/phases/12-vendor-work-order-management/12-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/db/schema/domain.ts (after Plan 01):
```typescript
export const vendors = pgTable("vendors", {
  id: uuid("id").primaryKey().defaultRandom(),
  companyName: text("company_name").notNull(),
  contactName: text("contact_name"),
  email: text("email"),
  phone: text("phone"),
  specialty: text("specialty", { enum: [...] }),
  notes: text("notes"),
  status: text("status", { enum: ["active", "inactive"] }).default("active").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
})

export const workOrders = pgTable("work_orders", {
  id: uuid("id").primaryKey().defaultRandom(),
  maintenanceRequestId: uuid("maintenance_request_id")
    .references(() => maintenanceRequests.id, { onDelete: "restrict" }).notNull(),
  vendorId: uuid("vendor_id")
    .references(() => vendors.id, { onDelete: "set null" }),
  assignedByUserId: text("assigned_by_user_id").notNull(),
  status: text("status", { enum: ["assigned", "scheduled", "in_progress", "completed", "cancelled"] })
    .default("assigned").notNull(),
  priority: text("priority", { enum: ["low", "medium", "high", "emergency"] })
    .default("medium").notNull(),
  scheduledDate: timestamp("scheduled_date"),
  completedDate: timestamp("completed_date"),
  notes: text("notes"),
  vendorAccessToken: text("vendor_access_token").unique(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
})
```

From src/lib/vendor-notifications.ts (Plan 01):
```typescript
export async function notifyVendorAssignment(
  vendor: { email: string | null; phone: string | null; companyName: string },
  workOrderUrl: string,
  requestSummary: string
): Promise<void>
```

From src/lib/uploads.ts:
```typescript
export const UPLOADS_DIR = path.join(process.cwd(), "uploads")
```

From src/app/api/uploads/[...path]/route.ts (existing file serving pattern):
- Auth check via session
- Path traversal protection via resolved path check
- MIME type mapping for response Content-Type
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create work order API routes (list, create, detail, update, token management)</name>
  <files>
    src/app/api/admin/work-orders/route.ts
    src/app/api/admin/work-orders/[id]/route.ts
  </files>
  <action>
**File 1: src/app/api/admin/work-orders/route.ts**

GET handler:
- Session/admin role check
- Query work orders with JOINs to get: maintenance request details (category, description, unitId), vendor details (companyName), unit details (unitNumber)
- Support optional query params: ?status=assigned, ?vendorId=xxx
- Order by createdAt desc
- Return `{ workOrders: [...] }` with joined data

POST handler (creates a work order from a maintenance request):
- Session/admin role check
- Parse JSON body: `{ maintenanceRequestId, vendorId?, priority?, notes?, scheduledDate? }`
- Validate: maintenanceRequestId is required and exists
- Validate: vendorId is valid if provided (vendor exists and is active)
- Generate vendorAccessToken: `crypto.randomUUID()` (import crypto from Node.js)
- Insert work order with assignedByUserId = session.user.id
- If vendorId is provided, fetch vendor contact info and call notifyVendorAssignment():
  ```typescript
  import { notifyVendorAssignment } from "@/lib/vendor-notifications"

  const workOrderUrl = `${process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000"}/vendor/work-order/${vendorAccessToken}`
  const requestSummary = `${maintenanceRequest.category} - Unit ${unit.unitNumber}`
  await notifyVendorAssignment(
    { email: vendor.email, phone: vendor.phone, companyName: vendor.companyName },
    workOrderUrl,
    requestSummary
  )
  ```
- Return `{ workOrder }` with status 201

**File 2: src/app/api/admin/work-orders/[id]/route.ts**

GET handler:
- Session/admin role check
- Fetch work order by ID with JOINs (maintenance request, vendor, unit, photos)
- Return 404 if not found
- Return `{ workOrder, maintenanceRequest, vendor, unit, photos }`

PATCH handler:
- Session/admin role check
- Fetch work order by ID, return 404 if not found
- Parse JSON body: partial fields (vendorId, status, priority, notes, scheduledDate, completedDate, action)
- If `action === "regenerate_token"`: generate new vendorAccessToken with crypto.randomUUID()
- If `action === "revoke_token"`: set vendorAccessToken to null
- If vendorId changed (new vendor assigned):
  - Update vendorId
  - Regenerate vendorAccessToken
  - Notify new vendor via notifyVendorAssignment()
- Update only provided fields, set updatedAt to new Date()
- If status changed to "completed", auto-set completedDate to now
- Return `{ workOrder }` with updated record

CRITICAL:
- Always use `crypto.randomUUID()` for token generation (import from Node.js built-in)
- The magic link URL format is: `/vendor/work-order/${vendorAccessToken}`
- When vendor changes, always regenerate token and notify new vendor
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    Work order API routes created. POST creates work order from maintenance request with auto-generated vendor access token. Vendor is notified via email/SMS on assignment. PATCH supports status updates, vendor reassignment (with re-notification), token regeneration, and token revocation. GET returns work order with all joined data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin work order pages (list and detail) and vendor magic link page</name>
  <files>
    src/app/(admin)/admin/work-orders/page.tsx
    src/app/(admin)/admin/work-orders/[id]/page.tsx
    src/app/vendor/work-order/[token]/page.tsx
    src/app/api/vendor/photos/[token]/[photoId]/route.ts
  </files>
  <action>
**File 1: src/app/(admin)/admin/work-orders/page.tsx**

"use client" component showing a table of all work orders:
- Columns: Maintenance Request (category + unit), Vendor, Status, Priority, Scheduled Date, Created, Actions
- Status badges with colors: assigned=blue, scheduled=purple, in_progress=orange, completed=green, cancelled=gray
- Priority badges: low=gray, medium=yellow, high=orange, emergency=red
- "View" link to /admin/work-orders/[id]
- "Create Work Order" button could link to maintenance list (work orders are created from maintenance requests)
- Fetch from GET /api/admin/work-orders
- Empty state: "No work orders yet. Create one from a maintenance request."

**File 2: src/app/(admin)/admin/work-orders/[id]/page.tsx**

"use client" component with a detail view wrapper:
```typescript
export default async function WorkOrderDetailPage({
  params,
}: { params: Promise<{ id: string }> }) {
  const { id } = await params
  return <WorkOrderDetail workOrderId={id} />
}
```

Create a WorkOrderDetail client component (can be inline or separate file -- keep inline to minimize files):
- Fetches work order detail from GET /api/admin/work-orders/[id]
- Shows: maintenance request info (category, description, unit), current vendor, status, priority, notes
- **Vendor assignment section:** Dropdown of active vendors (fetch from GET /api/admin/vendors?status=active), "Assign" button
- **Status update section:** Dropdown of valid statuses, update button
- **Magic link section:** Shows current magic link URL, "Copy Link" button, "Regenerate Link" button, "Revoke Link" button
- **Scheduled date** input
- **Notes** textarea
- Photos from maintenance request displayed (using `/api/uploads/{filePath}`)
- Back link to /admin/work-orders
- Toast feedback for all actions

**File 3: src/app/vendor/work-order/[token]/page.tsx**

Server component (NOT "use client") -- this is a public page, no auth required.

```typescript
import { db } from "@/db"
import { workOrders, maintenanceRequests, maintenancePhotos, units } from "@/db/schema"
import { eq } from "drizzle-orm"
import { notFound } from "next/navigation"

export default async function VendorWorkOrderPage({
  params,
}: { params: Promise<{ token: string }> }) {
  const { token } = await params

  // Look up work order by vendor access token
  const [workOrder] = await db
    .select({
      id: workOrders.id,
      status: workOrders.status,
      priority: workOrders.priority,
      scheduledDate: workOrders.scheduledDate,
      notes: workOrders.notes,
      createdAt: workOrders.createdAt,
    })
    .from(workOrders)
    .where(eq(workOrders.vendorAccessToken, token))

  if (!workOrder) {
    notFound()
  }

  // Fetch maintenance request details (NO tenant PII)
  // Join to maintenanceRequests and units -- DO NOT JOIN user table
  // ...fetch maintenance request by work order's maintenanceRequestId
  // ...fetch unit by maintenance request's unitId (unitNumber only)
  // ...fetch photos by maintenance request ID

  // Render a clean, public-facing page showing:
  // - Work order status and priority
  // - Maintenance request: category, description
  // - Unit number (NOT tenant name/email/phone)
  // - Photos (served via /api/vendor/photos/[token]/[photoId])
  // - Scheduled date if set
  // - Work order notes if any
}
```

CRITICAL: This page must NEVER show:
- Tenant name, email, or phone
- Any user table data
- Payment information
- Other tenants' data

The page should have a clean, professional layout suitable for a vendor:
- RentalMgmt branding header
- Work order details in a card
- Photos in a grid
- No navigation to other parts of the app

**File 4: src/app/api/vendor/photos/[token]/[photoId]/route.ts**

Public API route (NO auth required) for serving photos to vendors via magic link:

```typescript
// Validates token matches a work order
// Validates photoId belongs to the maintenance request linked to that work order
// Serves photo from local storage (or S3 after Phase 7)
// Uses the same file serving pattern as /api/uploads/[...path]/route.ts
// but without auth check -- token IS the auth
```

Steps:
1. Look up work order by vendorAccessToken = token
2. Return 404 if no work order found
3. Look up photo by id = photoId
4. Verify photo.requestId matches workOrder.maintenanceRequestId
5. Return 403 if photo doesn't belong to this work order's maintenance request
6. Read file from UPLOADS_DIR + photo.filePath
7. Return with correct Content-Type header

This prevents vendors from accessing photos from other maintenance requests by guessing photoIds.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    Admin work order list page at /admin/work-orders shows all work orders with status/priority badges. Admin work order detail page shows full work order info with vendor assignment, status updates, magic link management, and photos. Public vendor page at /vendor/work-order/[token] shows maintenance request details and photos WITHOUT any tenant PII. Token-gated photo route serves photos to vendors after validating token ownership.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes with no TypeScript errors
2. Admin can create work order from maintenance request via API
3. Vendor is notified (email/SMS) when assigned
4. Magic link URL is generated with unique token
5. Vendor page shows: category, description, unit number, photos, status
6. Vendor page does NOT show: tenant name, email, phone
7. Token-gated photo route validates token before serving
8. Admin can regenerate and revoke magic link tokens
9. Work order status transitions work correctly
</verification>

<success_criteria>
- Admin can assign a vendor to a maintenance request via work order (OPS-02)
- Vendor receives email/SMS notification with magic link (OPS-03)
- Magic link shows request details and photos without tenant PII (OPS-03)
- Admin can manage work order status, reassign vendors, and manage magic links
- npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/12-vendor-work-order-management/12-03-SUMMARY.md`
</output>
