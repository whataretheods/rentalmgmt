---
phase: 12-vendor-work-order-management
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/app/api/admin/vendors/route.ts
  - src/app/api/admin/vendors/[id]/route.ts
  - src/app/(admin)/admin/vendors/page.tsx
autonomous: true
requirements:
  - OPS-01

must_haves:
  truths:
    - "Admin can view a list of all vendors sorted by creation date"
    - "Admin can add a new vendor with company name, contact name, email, phone, and specialty"
    - "Admin can edit an existing vendor's details"
    - "Admin can deactivate (soft-delete) a vendor by setting status to inactive"
    - "Non-admin users cannot access vendor API routes"
  artifacts:
    - path: "src/app/api/admin/vendors/route.ts"
      provides: "Vendor list and creation endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/admin/vendors/[id]/route.ts"
      provides: "Vendor detail, update, and delete endpoints"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/app/(admin)/admin/vendors/page.tsx"
      provides: "Admin vendor directory page with add/edit dialog"
  key_links:
    - from: "src/app/(admin)/admin/vendors/page.tsx"
      to: "/api/admin/vendors"
      via: "fetch calls for CRUD operations"
      pattern: "fetch.*api/admin/vendors"
    - from: "src/app/api/admin/vendors/route.ts"
      to: "vendors table"
      via: "Drizzle db.select/insert from vendors"
      pattern: "db\\..*vendors"
---

<objective>
Build the vendor directory CRUD -- API routes and admin UI page for managing vendors (add, edit, list, deactivate).

Purpose: OPS-01 requires admin can manage a vendor directory with name, trade/specialty, phone, and email. This plan delivers the complete vendor CRUD feature.

Output: Two API route files (list+create, detail+update+delete) and one admin page with vendor table and add/edit dialog.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-vendor-work-order-management/12-RESEARCH.md
@.planning/phases/12-vendor-work-order-management/12-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/db/schema/domain.ts (after Plan 01):
```typescript
export const vendors = pgTable("vendors", {
  id: uuid("id").primaryKey().defaultRandom(),
  companyName: text("company_name").notNull(),
  contactName: text("contact_name"),
  email: text("email"),
  phone: text("phone"),
  specialty: text("specialty", {
    enum: ["plumbing", "electrical", "hvac", "appliance", "pest_control",
           "general_maintenance", "painting", "cleaning", "landscaping", "other"],
  }),
  notes: text("notes"),
  status: text("status", { enum: ["active", "inactive"] }).default("active").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
})
```

From src/lib/auth.ts (session check pattern used in existing admin routes):
```typescript
const session = await auth.api.getSession({ headers: await headers() })
if (!session || session.user.role !== "admin") {
  return NextResponse.json({ error: "Forbidden" }, { status: 403 })
}
```

Existing admin page pattern (from src/app/(admin)/admin/units/page.tsx):
- "use client" directive
- useState for data, loading, dialog state
- useEffect to fetch on mount
- Table with action buttons
- Dialog for add/edit forms
- toast() from sonner for feedback
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vendor API routes (list, create, detail, update, deactivate)</name>
  <files>
    src/app/api/admin/vendors/route.ts
    src/app/api/admin/vendors/[id]/route.ts
  </files>
  <action>
Create two API route files following the existing admin route pattern (see src/app/api/admin/maintenance/route.ts for reference).

**File 1: src/app/api/admin/vendors/route.ts**

GET handler:
- Session/admin role check (same pattern as existing admin routes)
- Query all vendors from db, ordered by createdAt desc
- Optionally filter by status query param (e.g., ?status=active)
- Return `{ vendors: [...] }`

POST handler:
- Session/admin role check
- Parse JSON body: `{ companyName, contactName?, email?, phone?, specialty?, notes? }`
- Validate: companyName is required and non-empty
- Validate: specialty must be one of the valid enum values if provided
- Insert into vendors table
- Return `{ vendor }` with status 201

**File 2: src/app/api/admin/vendors/[id]/route.ts**

GET handler:
- Session/admin role check
- Fetch vendor by ID
- Return 404 if not found
- Return `{ vendor }`

PATCH handler:
- Session/admin role check
- Fetch vendor by ID, return 404 if not found
- Parse JSON body: partial fields (companyName, contactName, email, phone, specialty, notes, status)
- Update only provided fields, set updatedAt to new Date()
- Return `{ vendor }` with updated record

DELETE handler:
- Session/admin role check
- Fetch vendor by ID, return 404 if not found
- Instead of hard delete, set status to "inactive" (soft delete)
- Return `{ success: true }`

CRITICAL: Follow exact import pattern from existing admin routes:
```typescript
import { NextResponse } from "next/server"
import { auth } from "@/lib/auth"
import { headers } from "next/headers"
import { db } from "@/db"
import { vendors } from "@/db/schema"
import { eq, desc } from "drizzle-orm"
```

The DELETE endpoint does a soft-delete (set status = "inactive") rather than a hard delete. This preserves work order history referencing this vendor.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    Two vendor API route files created. GET /api/admin/vendors returns vendor list with optional status filter. POST creates a new vendor with companyName validation. GET /api/admin/vendors/[id] returns single vendor. PATCH updates partial fields. DELETE soft-deletes by setting status to inactive.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin vendor directory page with table and add/edit dialog</name>
  <files>
    src/app/(admin)/admin/vendors/page.tsx
  </files>
  <action>
Create src/app/(admin)/admin/vendors/page.tsx as a "use client" component following the existing admin page pattern (see src/app/(admin)/admin/maintenance/page.tsx and src/app/(admin)/admin/units/page.tsx for reference).

Page structure:
1. **Header:** "Vendor Directory" title with an "Add Vendor" button
2. **Vendor table** showing: Company Name, Contact Name, Specialty, Phone, Email, Status, Actions
3. **Add/Edit dialog** using shadcn Dialog component with form fields:
   - Company Name (required text input)
   - Contact Name (optional text input)
   - Email (optional text input)
   - Phone (optional text input)
   - Specialty (select dropdown with all enum values)
   - Notes (optional textarea)
4. **Actions column:** Edit button, Deactivate/Activate toggle button
5. **Empty state:** "No vendors yet -- add your first vendor to get started."

State management:
- `vendors` array state, loaded via useEffect on mount
- `loading` boolean
- `dialogOpen` boolean + `editingVendor` (null for new, vendor object for edit)
- Form state for all fields

Specialty labels for display:
```typescript
const SPECIALTY_LABELS: Record<string, string> = {
  plumbing: "Plumbing",
  electrical: "Electrical",
  hvac: "HVAC",
  appliance: "Appliance",
  pest_control: "Pest Control",
  general_maintenance: "General Maintenance",
  painting: "Painting",
  cleaning: "Cleaning",
  landscaping: "Landscaping",
  other: "Other",
}
```

Status badge: active = green, inactive = gray.

Use shadcn components: Card, CardContent, CardHeader, CardTitle, Button, Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, Input, Label, Select (or native select), Textarea if available (or native textarea with Tailwind classes matching existing pattern).

Use toast() from sonner for success/error feedback (same pattern as AdminMaintenanceDetail.tsx).

Fetch pattern:
- GET /api/admin/vendors for list
- POST /api/admin/vendors for create
- PATCH /api/admin/vendors/[id] for update
- DELETE /api/admin/vendors/[id] for deactivate

CRITICAL: Check which shadcn components are available. If Dialog is not installed, use a simple conditional form section instead. The project may not have all shadcn components -- check src/components/ui/ for available components and only use what exists. If needed, install: `npx shadcn@latest add dialog label select textarea` but only components not already present.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    Admin vendor directory page created at /admin/vendors. Shows a table of vendors with Company Name, Contact, Specialty, Phone, Email, Status, Actions columns. Add Vendor button opens dialog/form for creating new vendors. Edit button updates existing vendors. Deactivate/Activate toggles vendor status. Empty state shows guidance. Toast notifications for all CRUD operations.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes with no TypeScript errors
2. GET /api/admin/vendors returns vendor list
3. POST /api/admin/vendors creates a vendor with required companyName
4. PATCH /api/admin/vendors/[id] updates vendor fields
5. DELETE /api/admin/vendors/[id] sets status to inactive (soft delete)
6. Admin vendor page renders at /admin/vendors
7. Add/edit form validates companyName required
8. Non-admin users get 403 on all vendor API routes
</verification>

<success_criteria>
- Admin can add a vendor with name, specialty, phone, email (OPS-01)
- Admin can edit an existing vendor
- Admin can deactivate a vendor (soft delete preserving work order history)
- Vendor list displays all vendors with sortable status
- npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/12-vendor-work-order-management/12-02-SUMMARY.md`
</output>
