---
phase: 12-vendor-work-order-management
plan: 04
type: execute
wave: 3
depends_on: ["12-03"]
files_modified:
  - src/app/api/admin/work-orders/[id]/costs/route.ts
  - src/app/api/admin/reports/unit-expenses/route.ts
  - src/app/(admin)/admin/work-orders/[id]/page.tsx
autonomous: true
requirements:
  - OPS-04

must_haves:
  truths:
    - "Admin can add labor and materials cost line items to a work order"
    - "Admin can view all cost line items for a work order with total"
    - "Admin can delete a cost line item"
    - "System computes total maintenance expenses per unit across all work orders"
    - "Per-unit expense rollup is accessible via API for admin dashboard/reports"
  artifacts:
    - path: "src/app/api/admin/work-orders/[id]/costs/route.ts"
      provides: "Work order cost CRUD endpoints"
      exports: ["GET", "POST", "DELETE"]
    - path: "src/app/api/admin/reports/unit-expenses/route.ts"
      provides: "Per-unit maintenance expense rollup endpoint"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/admin/work-orders/[id]/costs/route.ts"
      to: "workOrderCosts table"
      via: "Drizzle db.insert/select/delete from workOrderCosts"
      pattern: "db\\..*workOrderCosts"
    - from: "src/app/api/admin/reports/unit-expenses/route.ts"
      to: "workOrderCosts -> workOrders -> maintenanceRequests -> units"
      via: "JOIN chain for per-unit rollup"
      pattern: "innerJoin.*workOrders"
---

<objective>
Build work order cost tracking and per-unit expense rollup -- admin can record labor/materials costs and see total maintenance spend per unit.

Purpose: OPS-04 requires admin can record labor and materials costs on work orders with per-unit expense rollup. This plan delivers cost line item CRUD integrated into the work order detail page plus a per-unit expense summary API.

Output: Cost CRUD API route, per-unit expense rollup API route, and cost tracking section added to work order detail page.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-vendor-work-order-management/12-RESEARCH.md
@.planning/phases/12-vendor-work-order-management/12-01-SUMMARY.md
@.planning/phases/12-vendor-work-order-management/12-03-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/db/schema/domain.ts (after Plan 01):
```typescript
export const workOrderCosts = pgTable("work_order_costs", {
  id: uuid("id").primaryKey().defaultRandom(),
  workOrderId: uuid("work_order_id")
    .references(() => workOrders.id, { onDelete: "cascade" }).notNull(),
  description: text("description").notNull(),
  amountCents: integer("amount_cents").notNull(),
  category: text("category", {
    enum: ["labor", "materials", "permits", "other"],
  }).notNull(),
  receiptPath: text("receipt_path"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
})

export const workOrders = pgTable("work_orders", {
  id: uuid("id").primaryKey().defaultRandom(),
  maintenanceRequestId: uuid("maintenance_request_id")
    .references(() => maintenanceRequests.id, { onDelete: "restrict" }).notNull(),
  // ... other fields
})

export const maintenanceRequests = pgTable("maintenance_requests", {
  id: uuid("id").primaryKey().defaultRandom(),
  unitId: uuid("unit_id").references(() => units.id, { onDelete: "cascade" }).notNull(),
  // ... other fields
})

export const units = pgTable("units", {
  id: uuid("id").primaryKey().defaultRandom(),
  unitNumber: text("unit_number").notNull(),
  propertyId: uuid("property_id").references(() => properties.id).notNull(),
  // ... other fields
})
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create work order cost CRUD and per-unit expense rollup API routes</name>
  <files>
    src/app/api/admin/work-orders/[id]/costs/route.ts
    src/app/api/admin/reports/unit-expenses/route.ts
  </files>
  <action>
**File 1: src/app/api/admin/work-orders/[id]/costs/route.ts**

GET handler:
- Session/admin role check
- Get work order ID from params
- Verify work order exists, return 404 if not
- Query all cost line items for this work order, ordered by createdAt asc
- Compute total: SUM of all amountCents
- Return `{ costs: [...], totalCents: number }`

POST handler:
- Session/admin role check
- Get work order ID from params
- Verify work order exists, return 404 if not
- Parse JSON body: `{ description, amountCents, category, receiptPath? }`
- Validate: description is required and non-empty
- Validate: amountCents is a positive integer
- Validate: category is one of ["labor", "materials", "permits", "other"]
- Insert cost line item
- Return `{ cost }` with status 201

DELETE handler:
- Session/admin role check
- Get work order ID from params
- Parse the cost ID from URL search params: `?costId=xxx`
- Verify cost exists and belongs to this work order
- Delete the cost record
- Return `{ success: true }`

Note: For the DELETE, we use a query parameter approach since we already have the [id] param for the work order. The request URL pattern is: DELETE /api/admin/work-orders/[id]/costs?costId=xxx

**File 2: src/app/api/admin/reports/unit-expenses/route.ts**

GET handler:
- Session/admin role check
- Join chain: workOrderCosts -> workOrders -> maintenanceRequests -> units -> properties
- GROUP BY unit
- Return per-unit expense rollup:

```typescript
const expenses = await db
  .select({
    unitId: units.id,
    unitNumber: units.unitNumber,
    propertyName: properties.name,
    totalCostCents: sql<number>`COALESCE(SUM(${workOrderCosts.amountCents}), 0)`,
    laborCostCents: sql<number>`COALESCE(SUM(CASE WHEN ${workOrderCosts.category} = 'labor' THEN ${workOrderCosts.amountCents} ELSE 0 END), 0)`,
    materialsCostCents: sql<number>`COALESCE(SUM(CASE WHEN ${workOrderCosts.category} = 'materials' THEN ${workOrderCosts.amountCents} ELSE 0 END), 0)`,
    workOrderCount: sql<number>`COUNT(DISTINCT ${workOrders.id})`,
  })
  .from(workOrderCosts)
  .innerJoin(workOrders, eq(workOrderCosts.workOrderId, workOrders.id))
  .innerJoin(maintenanceRequests, eq(workOrders.maintenanceRequestId, maintenanceRequests.id))
  .innerJoin(units, eq(maintenanceRequests.unitId, units.id))
  .innerJoin(properties, eq(units.propertyId, properties.id))
  .groupBy(units.id, units.unitNumber, properties.name)
  .orderBy(desc(sql`COALESCE(SUM(${workOrderCosts.amountCents}), 0)`))
```

Return `{ expenses: [...], grandTotalCents: number }` where grandTotalCents is the sum across all units.

Import sql from drizzle-orm for the aggregate functions.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    Work order cost CRUD API at /api/admin/work-orders/[id]/costs supports GET (list with total), POST (add cost line item), DELETE (remove cost). Per-unit expense rollup API at /api/admin/reports/unit-expenses returns aggregated maintenance costs per unit with breakdowns by labor/materials and work order count.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cost tracking section to work order detail page</name>
  <files>
    src/app/(admin)/admin/work-orders/[id]/page.tsx
  </files>
  <action>
Modify the work order detail page (created in Plan 03) to add a "Costs" section below the existing content.

Add a new section/card to the WorkOrderDetail component:

**Costs Section:**
1. **Cost summary header:** Shows "Costs" title and total amount (formatted as dollars: $X,XXX.XX)
2. **Cost list table:** Columns: Description, Category, Amount, Date Added, Actions (delete button)
3. **Add cost form** (inline or in a dialog):
   - Description (required text input)
   - Amount (required number input -- user enters dollars, component converts to cents: `Math.round(parseFloat(value) * 100)`)
   - Category (select: Labor, Materials, Permits, Other)
   - Receipt (future: file upload -- for now, just a note that receipt upload will be available after Phase 7)
   - "Add Cost" button
4. **Category display labels:**
   ```typescript
   const COST_CATEGORY_LABELS: Record<string, string> = {
     labor: "Labor",
     materials: "Materials",
     permits: "Permits",
     other: "Other",
   }
   ```
5. **Dollar formatting helper:**
   ```typescript
   function formatCents(cents: number): string {
     return `$${(cents / 100).toFixed(2)}`
   }
   ```

State additions:
- `costs` array state
- `totalCents` number state
- `costForm` state: { description, amount, category }
- `addingCost` loading boolean

Fetch costs from GET /api/admin/work-orders/[id]/costs on component mount (alongside existing work order data fetch).

Add cost: POST /api/admin/work-orders/[id]/costs with form data.
Delete cost: DELETE /api/admin/work-orders/[id]/costs?costId=xxx

Use toast() for success/error feedback.

CRITICAL:
- Amount input should accept dollars (e.g., "150.00") and convert to cents before sending to API
- Display amounts should always format cents back to dollars
- Delete confirmation: use window.confirm() for simplicity (no need for a confirmation dialog)
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    Work order detail page now includes a Costs section showing all cost line items with total, add cost form (description, amount in dollars, category), and delete buttons for each cost. Dollar amounts properly converted between cents (storage) and dollars (display). Per-unit expense rollup available via API.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes with no TypeScript errors
2. POST /api/admin/work-orders/[id]/costs creates a cost line item
3. GET /api/admin/work-orders/[id]/costs returns costs with total
4. DELETE /api/admin/work-orders/[id]/costs?costId=xxx removes a cost
5. GET /api/admin/reports/unit-expenses returns per-unit expense rollup
6. Work order detail page shows costs section with add/delete functionality
7. Dollar/cent conversion is correct in both directions
</verification>

<success_criteria>
- Admin can record labor and materials costs on work orders (OPS-04)
- Per-unit expense rollup is computed and accessible (OPS-04)
- Cost amounts correctly handle dollars-to-cents conversion
- npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/12-vendor-work-order-management/12-04-SUMMARY.md`
</output>
