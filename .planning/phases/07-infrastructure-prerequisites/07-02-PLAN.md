---
phase: 07-infrastructure-prerequisites
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/db/schema/domain.ts
  - drizzle/0005_*.sql
autonomous: true
requirements: [INFRA-05, INFRA-01]

must_haves:
  truths:
    - "Attempting to delete a property that has units fails with a database constraint error instead of silently destroying units and all their associated records"
    - "Attempting to delete a unit that has payments, maintenance requests, or autopay enrollments fails with a constraint error instead of destroying financial history"
    - "Properties and units have an archivedAt column that enables soft-delete as the business-level deletion mechanism"
    - "maintenancePhotos and documents tables have storageBackend and s3Key columns to support dual-read file serving"
  artifacts:
    - path: "src/db/schema/domain.ts"
      provides: "Updated foreign keys (RESTRICT), archivedAt columns, storageBackend/s3Key columns"
      contains: "onDelete: \"restrict\""
    - path: "drizzle/0005_*.sql"
      provides: "Migration SQL for constraint changes and new columns"
  key_links:
    - from: "src/db/schema/domain.ts"
      to: "properties table"
      via: "archivedAt column added"
      pattern: "archivedAt.*timestamp"
    - from: "src/db/schema/domain.ts"
      to: "units table"
      via: "archivedAt column added"
      pattern: "archivedAt.*timestamp"
    - from: "src/db/schema/domain.ts"
      to: "maintenancePhotos table"
      via: "storageBackend column added"
      pattern: "storageBackend.*text"
---

<objective>
Apply all Phase 7 database schema changes in a single migration: change dangerous CASCADE foreign keys to RESTRICT, add soft-delete columns, and add S3 storage columns.

Purpose: CASCADE deletes on units/properties would destroy payment history, maintenance records, and autopay enrollments if an admin accidentally deleted a property or unit. RESTRICT provides database-level safety. Soft-delete (archivedAt) provides the business-level "delete" mechanism. Storage columns prepare the schema for S3 dual-read in Plan 03.

Output: Updated Drizzle schema with RESTRICT constraints + archivedAt + storageBackend/s3Key columns, and a generated+applied migration.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/07-infrastructure-prerequisites/07-RESEARCH.md
@.planning/phases/07-infrastructure-prerequisites/07-01-SUMMARY.md

<interfaces>
<!-- Current foreign key CASCADE relationships that need changing to RESTRICT -->
From src/db/schema/domain.ts (lines with onDelete: "cascade" that reference units or properties):
```typescript
// units.propertyId → properties.id (CASCADE → RESTRICT)
propertyId: uuid("property_id")
  .references(() => properties.id, { onDelete: "cascade" })
  .notNull(),

// tenantUnits.unitId → units.id (CASCADE → RESTRICT)
unitId: uuid("unit_id")
  .references(() => units.id, { onDelete: "cascade" })
  .notNull(),

// inviteTokens.unitId → units.id (CASCADE → RESTRICT)
unitId: uuid("unit_id")
  .references(() => units.id, { onDelete: "cascade" })
  .notNull(),

// payments.unitId → units.id (CASCADE → RESTRICT)
unitId: uuid("unit_id")
  .references(() => units.id, { onDelete: "cascade" })
  .notNull(),

// maintenanceRequests.unitId → units.id (CASCADE → RESTRICT)
unitId: uuid("unit_id")
  .references(() => units.id, { onDelete: "cascade" })
  .notNull(),

// autopayEnrollments.unitId → units.id (CASCADE → RESTRICT)
unitId: uuid("unit_id")
  .references(() => units.id, { onDelete: "cascade" })
  .notNull(),
```

<!-- These CASCADE relationships are SAFE to keep (parent-child with no financial data): -->
```typescript
// maintenancePhotos.requestId → maintenanceRequests.id (KEEP CASCADE)
// maintenanceComments.requestId → maintenanceRequests.id (KEEP CASCADE)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Drizzle schema — RESTRICT constraints, archivedAt, and storage columns</name>
  <files>src/db/schema/domain.ts</files>
  <action>
Edit `src/db/schema/domain.ts` with the following changes:

**1. Change CASCADE to RESTRICT for all unit/property foreign keys:**

Change these 6 foreign key references from `{ onDelete: "cascade" }` to `{ onDelete: "restrict" }`:
- `units.propertyId` → properties.id
- `tenantUnits.unitId` → units.id
- `inviteTokens.unitId` → units.id
- `payments.unitId` → units.id
- `maintenanceRequests.unitId` → units.id
- `autopayEnrollments.unitId` → units.id

**DO NOT change** these (keep CASCADE — they are true parent-child relationships with no financial data):
- `maintenancePhotos.requestId` → maintenanceRequests.id
- `maintenanceComments.requestId` → maintenanceRequests.id

**2. Add archivedAt columns to properties and units tables:**

Add to `properties` table:
```typescript
archivedAt: timestamp("archived_at"),  // null = active, non-null = archived (soft-deleted)
```

Add to `units` table:
```typescript
archivedAt: timestamp("archived_at"),  // null = active, non-null = archived (soft-deleted)
```

Place the `archivedAt` column after `updatedAt` in each table definition.

**3. Add storage columns to maintenancePhotos and documents tables:**

Add to `maintenancePhotos` table (after `mimeType`):
```typescript
storageBackend: text("storage_backend").default("local").notNull(),  // "local" or "s3"
s3Key: text("s3_key"),  // S3 object key, null for local files
```

Add to `documents` table (after `mimeType`):
```typescript
storageBackend: text("storage_backend").default("local").notNull(),  // "local" or "s3"
s3Key: text("s3_key"),  // S3 object key, null for local files
```

**Important:** The `storageBackend` column defaults to `"local"` so ALL existing records automatically get the correct value (they are all local). New S3 uploads will explicitly set `"s3"`.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && grep -c 'onDelete: "restrict"' src/db/schema/domain.ts | grep -q '^6$' && echo "PASS: 6 RESTRICT constraints" || echo "FAIL: wrong number of RESTRICT constraints"</automated>
  </verify>
  <done>Schema has 6 RESTRICT foreign keys (units/properties refs), 2 CASCADE foreign keys kept (maintenance sub-tables), archivedAt on properties + units, storageBackend + s3Key on maintenancePhotos + documents.</done>
</task>

<task type="auto">
  <name>Task 2: Generate and apply migration, verify cascade safety</name>
  <files>drizzle/0005_*.sql, e2e/infra-cascade.spec.ts</files>
  <action>
1. Generate the Drizzle migration:
   ```bash
   npx drizzle-kit generate
   ```
   This will create a new migration file in `drizzle/` (likely `0005_*.sql`). Verify it contains:
   - ALTER TABLE statements dropping CASCADE constraints and adding RESTRICT constraints
   - ALTER TABLE ADD COLUMN statements for `archived_at`, `storage_backend`, `s3_key`

2. Apply the migration to the database:
   ```bash
   npx drizzle-kit migrate
   ```

3. Verify the migration applied by checking the database schema (the dev server should still work after migration).

4. Create an E2E test `e2e/infra-cascade.spec.ts` that verifies RESTRICT protection:

   The test should verify that the application still works after the schema change. Specifically:
   - Log in as admin
   - Verify admin dashboard loads (basic query works with new schema)
   - Verify units page loads and shows existing units (the RESTRICT constraints don't affect normal SELECT queries)

   **Note:** Testing actual DELETE rejection requires a direct database operation or a future admin delete API (which doesn't exist yet). For now, verify that the application works normally with the new constraints. The RESTRICT constraint itself is database-enforced and will be properly tested when the admin CRUD API is built in Phase 10.

   Additionally, verify the new columns exist by checking that existing maintenance photos and documents still load correctly (the default "local" storageBackend should be transparent).

5. Run the test:
   ```bash
   npx playwright test e2e/infra-cascade.spec.ts
   ```
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx playwright test e2e/infra-cascade.spec.ts</automated>
  </verify>
  <done>Migration applied successfully. RESTRICT constraints active on 6 foreign keys. archivedAt columns added to properties and units. storageBackend + s3Key columns added to maintenancePhotos and documents. Application works normally — no regressions.</done>
</task>

</tasks>

<verification>
1. `grep -c 'onDelete: "restrict"' src/db/schema/domain.ts` returns 6
2. `grep -c 'onDelete: "cascade"' src/db/schema/domain.ts` returns 2 (maintenance sub-tables)
3. Migration file exists in `drizzle/` directory
4. `npx playwright test e2e/infra-cascade.spec.ts` passes
5. Dev server runs without errors
</verification>

<success_criteria>
- All 6 dangerous CASCADE foreign keys changed to RESTRICT
- 2 safe CASCADE relationships preserved (maintenancePhotos, maintenanceComments)
- Properties and units have archivedAt column for soft-delete
- maintenancePhotos and documents have storageBackend and s3Key columns
- Migration generated and applied without data integrity errors
- Existing application functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/07-infrastructure-prerequisites/07-02-SUMMARY.md`
</output>
