---
phase: 07-infrastructure-prerequisites
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/middleware.ts
  - src/app/(admin)/layout.tsx
  - src/components/ui/sidebar.tsx
  - src/components/admin/AdminSidebar.tsx
autonomous: true
requirements: [INFRA-02, AUX-01]

must_haves:
  truths:
    - "A non-admin user navigating to any /admin route is redirected to /tenant/dashboard at the middleware level before the page component loads"
    - "An unauthenticated user navigating to /admin or /tenant routes is redirected to /auth/login"
    - "Every admin page displays a persistent collapsible sidebar with navigation links"
    - "Sidebar collapse state persists across page transitions via cookie"
    - "Admin layout header includes a sidebar toggle trigger"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Node.js middleware with role-based route protection"
      exports: ["middleware", "config"]
    - path: "src/components/admin/AdminSidebar.tsx"
      provides: "Admin sidebar component with nav links and user info"
      exports: ["AdminSidebar"]
    - path: "src/components/ui/sidebar.tsx"
      provides: "shadcn/ui sidebar primitives (auto-generated)"
    - path: "src/app/(admin)/layout.tsx"
      provides: "Admin layout with SidebarProvider and AdminSidebar"
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/auth.ts"
      via: "auth.api.getSession() for role check"
      pattern: "auth\\.api\\.getSession"
    - from: "src/app/(admin)/layout.tsx"
      to: "src/components/admin/AdminSidebar.tsx"
      via: "AdminSidebar component rendered inside SidebarProvider"
      pattern: "AdminSidebar"
    - from: "src/app/(admin)/layout.tsx"
      to: "src/components/ui/sidebar.tsx"
      via: "SidebarProvider and SidebarTrigger imports"
      pattern: "SidebarProvider"
---

<objective>
Add edge-level role authorization via Next.js Node.js middleware and replace the flat admin nav bar with a collapsible sidebar using shadcn/ui.

Purpose: Currently, admin route protection only happens in the server component layout (defense-in-depth but not edge-level). Middleware provides earlier rejection. The flat horizontal nav bar doesn't scale as more admin pages are added in v2.0. A collapsible sidebar with cookie-based persistence is the standard pattern.

Output: New middleware.ts with role checking, shadcn/ui sidebar component, and refactored admin layout.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/07-infrastructure-prerequisites/07-RESEARCH.md

<interfaces>
<!-- Current admin layout being refactored -->
From src/app/(admin)/layout.tsx:
```typescript
import { auth } from "@/lib/auth"
import { headers } from "next/headers"
import { redirect } from "next/navigation"
import Link from "next/link"
import { NotificationBell } from "@/components/ui/NotificationBell"

export default async function AdminLayout({ children }: { children: React.ReactNode }) {
  const session = await auth.api.getSession({ headers: await headers() })
  if (!session) { redirect("/auth/login") }
  if (session.user.role !== "admin") { redirect("/tenant/dashboard") }

  return (
    <div className="min-h-screen bg-gray-50">
      <header>...</header>
      <nav>
        <Link href="/admin/dashboard">Dashboard</Link>
        <Link href="/admin/units">Units</Link>
        <!-- ... 7 more links ... -->
      </nav>
      <main>{children}</main>
    </div>
  )
}
```

<!-- Auth module for middleware -->
From src/lib/auth.ts:
```typescript
export const auth = betterAuth({ ... })
export type Session = typeof auth.$Infer.Session
export type User = typeof auth.$Infer.Session.user
```

<!-- Existing admin nav links to preserve in sidebar -->
Dashboard, Units, Payments, Maintenance, Documents, Users, Invites, Notifications, Broadcast
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Node.js middleware with role-based route protection</name>
  <files>src/middleware.ts</files>
  <action>
Create `src/middleware.ts` — this file does NOT currently exist.

The middleware must use **Node.js runtime** (stable in Next.js 15.5) to call `auth.api.getSession()` for full session validation with role checking.

**Implementation:**

1. Import `NextRequest`, `NextResponse` from `next/server`
2. Import `auth` from `@/lib/auth`
3. Import `headers` from `next/headers`

4. Export async `middleware(request: NextRequest)` function:

   **For `/admin` routes:**
   - Call `auth.api.getSession({ headers: await headers() })`
   - If no session: redirect to `/auth/login?callbackUrl={pathname}`
   - If session exists but `session.user.role !== "admin"`: redirect to `/tenant/dashboard`
   - If admin: `NextResponse.next()`

   **For `/tenant` routes:**
   - Check for session cookie existence: `request.cookies.get("better-auth.session_token")`
   - If no cookie: redirect to `/auth/login?callbackUrl={pathname}`
   - If cookie exists: `NextResponse.next()` (full session validation happens in page components)
   - NOTE: We do a lightweight cookie check for tenant routes (not full session validation) to avoid the latency cost. The layout already does full validation.

   **For all other routes:** `NextResponse.next()`

5. Export `config` object:
   ```typescript
   export const config = {
     runtime: "nodejs",  // Stable in Next.js 15.5 — allows auth.api.getSession()
     matcher: [
       // Match all routes EXCEPT: auth API, static files, images, favicon
       "/((?!api/auth|_next/static|_next/image|favicon.ico).*)",
     ],
   }
   ```

**CRITICAL details:**
- The `runtime: "nodejs"` is what makes this work. Edge runtime cannot call `auth.api.getSession()` because it uses Node.js APIs internally.
- Exclude `/api/auth` from the matcher — Better Auth's API routes handle their own auth and should NOT go through middleware (would cause infinite redirect loops).
- Exclude `/api/*` routes EXCEPT `/api/auth` — actually, be more targeted: exclude paths starting with `/api/auth`. Other API routes can go through middleware for the cookie check, but they already do their own auth. For simplicity and to avoid doubled latency on API routes, exclude ALL `/api` routes from the middleware. The matcher pattern `/((?!api|_next/static|_next/image|favicon.ico).*)` achieves this.

Wait — the research notes this pitfall: "Middleware runs before route handlers. If the matcher is too broad, every API request pays the session lookup cost twice." So exclude ALL API routes:

   ```typescript
   export const config = {
     runtime: "nodejs",
     matcher: [
       "/((?!api|_next/static|_next/image|favicon.ico).*)",
     ],
   }
   ```

This matches page routes only (admin/*, tenant/*, auth/*, /) but not API routes (/api/*).

**Security note:** The admin layout's existing server-component session check remains as defense-in-depth. The middleware is the primary gate; the layout is the backup. Do NOT remove the auth checks from `(admin)/layout.tsx`.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && test -f src/middleware.ts && grep -q "runtime.*nodejs" src/middleware.ts && grep -q "auth.api.getSession" src/middleware.ts && grep -q "role.*admin" src/middleware.ts && echo "PASS: middleware created with Node.js runtime and role check" || echo "FAIL: middleware missing or incomplete"</automated>
  </verify>
  <done>src/middleware.ts created with Node.js runtime, full session validation for /admin routes with role check, lightweight cookie check for /tenant routes, API routes excluded from matcher.</done>
</task>

<task type="auto">
  <name>Task 2: Install sidebar and build admin layout with collapsible navigation</name>
  <files>src/components/ui/sidebar.tsx, src/components/admin/AdminSidebar.tsx, src/app/(admin)/layout.tsx</files>
  <action>
1. **Install shadcn/ui sidebar component:**
   ```bash
   npx shadcn@latest add sidebar -y
   ```
   This generates `src/components/ui/sidebar.tsx` with SidebarProvider, Sidebar, SidebarContent, SidebarGroup, SidebarMenu, SidebarMenuItem, SidebarMenuButton, SidebarTrigger, SidebarHeader, SidebarFooter, and other composable parts.

   Note: If the command prompts for configuration or fails, check if `components.json` exists. If not, run `npx shadcn@latest init` first (select New York style, default options).

   The sidebar component may also install dependencies like `@radix-ui/react-slot` — let the installer handle that.

2. **Create `src/components/admin/AdminSidebar.tsx`:**

   Create the directory `src/components/admin/` if it doesn't exist.

   Build an AdminSidebar component that:
   - Uses shadcn/ui sidebar primitives (Sidebar, SidebarContent, SidebarGroup, SidebarMenu, SidebarMenuItem, SidebarMenuButton)
   - Includes ALL existing admin nav links (preserve all 9 links from current layout):
     - Dashboard (`/admin/dashboard`) — icon: LayoutDashboard or Home
     - Units (`/admin/units`) — icon: Building2
     - Payments (`/admin/payments`) — icon: CreditCard
     - Maintenance (`/admin/maintenance`) — icon: Wrench
     - Documents (`/admin/documents`) — icon: FileText
     - Users (`/admin/users`) — icon: Users
     - Invites (`/admin/invites`) — icon: Mail
     - Notifications (`/admin/notifications`) — icon: Bell
     - Broadcast (`/admin/broadcast`) — icon: Megaphone
   - Uses `lucide-react` icons (already a project dependency via shadcn/ui)
   - Highlights the active link based on current pathname using `usePathname()` from `next/navigation`
   - Must be a client component (`"use client"`) because it uses `usePathname()`
   - Accepts `user` prop (with at least `email` and `name`) to display in sidebar footer
   - Uses `collapsible="icon"` mode on the Sidebar component so it collapses to an icon-only rail on desktop

   **Sidebar structure:**
   ```
   SidebarHeader: "Admin Portal" text (or app name)
   SidebarContent:
     SidebarGroup: "Navigation"
       SidebarMenu:
         SidebarMenuItem for each link
   SidebarFooter: User email display
   ```

3. **Refactor `src/app/(admin)/layout.tsx`:**

   Replace the current flat header + horizontal nav with the sidebar layout:

   a. Import `cookies` from `next/headers`
   b. Import `SidebarProvider`, `SidebarTrigger`, `SidebarInset` from `@/components/ui/sidebar`
   c. Import `AdminSidebar` from `@/components/admin/AdminSidebar`

   d. Read sidebar state from cookie:
   ```typescript
   const cookieStore = await cookies()
   const defaultOpen = cookieStore.get("sidebar_state")?.value !== "false"
   ```
   (Default to open if cookie not set)

   e. New layout structure:
   ```tsx
   <SidebarProvider defaultOpen={defaultOpen}>
     <AdminSidebar user={session.user} />
     <SidebarInset>
       <header className="flex items-center gap-2 border-b px-4 py-3">
         <SidebarTrigger />
         <span className="font-semibold text-gray-900">Admin Portal</span>
         <div className="ml-auto flex items-center gap-4">
           <NotificationBell apiUrl="/api/admin/notifications" inboxUrl="/admin/notifications" />
           <span className="text-sm text-gray-500">{session.user.email}</span>
         </div>
       </header>
       <main className="container mx-auto px-6 py-8">
         {children}
       </main>
     </SidebarInset>
   </SidebarProvider>
   ```

   f. **KEEP the auth checks** at the top of the layout function (session validation + role check). These are defense-in-depth alongside middleware. Do NOT remove them.

   g. Remove the old `<nav>` element with horizontal links — the sidebar replaces it.

4. **Create the E2E tests:**

   Create `e2e/infra-edge-auth.spec.ts`:
   - Test 1: Unauthenticated user visits `/admin/dashboard` → redirected to `/auth/login`
   - Test 2: Log in as tenant user → visit `/admin/dashboard` → redirected to `/tenant/dashboard`
   - Test 3: Log in as admin → visit `/admin/dashboard` → page loads successfully

   Create `e2e/admin-sidebar.spec.ts`:
   - Test 1: Log in as admin → sidebar is visible with all 9 nav links
   - Test 2: Click sidebar toggle → sidebar collapses
   - Test 3: Navigate to a different admin page → sidebar is still visible (persists across transitions)
   - Test 4: Active page link is visually distinct (has different styling)

   Use existing E2E login patterns from the `e2e/` directory for test setup.

5. Run the E2E tests:
   ```bash
   npx playwright test e2e/infra-edge-auth.spec.ts e2e/admin-sidebar.spec.ts
   ```
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx playwright test e2e/infra-edge-auth.spec.ts e2e/admin-sidebar.spec.ts</automated>
  </verify>
  <done>Middleware rejects non-admin users from /admin routes at the edge. Admin layout uses collapsible sidebar with all 9 nav links, cookie-based persistence, and SidebarTrigger toggle. Auth checks preserved as defense-in-depth in layout. E2E tests pass for both middleware protection and sidebar behavior.</done>
</task>

</tasks>

<verification>
1. `src/middleware.ts` exists with `runtime: "nodejs"` and role-based routing
2. Sidebar component renders all 9 admin nav links
3. Sidebar collapse state persists via cookie
4. `npx playwright test e2e/infra-edge-auth.spec.ts` passes (role-based redirect)
5. `npx playwright test e2e/admin-sidebar.spec.ts` passes (sidebar visible, collapsible, persistent)
6. Admin layout still has server-component auth checks (defense-in-depth)
</verification>

<success_criteria>
- Non-admin users are rejected at middleware before page loads
- Unauthenticated users are redirected to login
- Admin sidebar displays all 9 navigation links with icons
- Sidebar is collapsible and state persists across page transitions
- API routes are excluded from middleware (no double auth cost)
- No regression in existing admin functionality
</success_criteria>

<output>
After completion, create `.planning/phases/07-infrastructure-prerequisites/07-04-SUMMARY.md`
</output>
