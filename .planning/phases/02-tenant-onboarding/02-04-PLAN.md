---
phase: 02-tenant-onboarding
plan: 04
type: execute
wave: 3
depends_on:
  - 02-02
  - 02-03
files_modified: []
autonomous: false
requirements:
  - AUTH-04

must_haves:
  truths:
    - "Admin can generate a unique per-unit invite token and download or print a QR code"
    - "Tenant scans QR code, is taken directly to account creation pre-associated with their unit"
    - "After completing account creation, tenant is linked to the correct unit automatically"
    - "The invite link becomes invalid after one use — a second scan shows an error, not a registration form"
    - "An invite link that has expired (past 30 days) shows a clear expiry message"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete tenant onboarding flow end-to-end using Playwright automation: admin generates invite, tenant scans QR/visits link, registers, gets linked to unit, and used/expired tokens show correct errors. This is the final verification plan for Phase 2.

Purpose: AUTH-04 requires the full QR-code-based onboarding flow to work from admin generation through tenant registration and unit linking. Automated testing validates all five success criteria before presenting results to the user.

Output: Verified end-to-end flow with Playwright test results. No files modified — verification only.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-tenant-onboarding/02-RESEARCH.md
@.planning/phases/02-tenant-onboarding/02-01-SUMMARY.md
@.planning/phases/02-tenant-onboarding/02-02-SUMMARY.md
@.planning/phases/02-tenant-onboarding/02-03-SUMMARY.md

<interfaces>
<!-- Full flow to verify -->

Admin flow (Plan 02):
1. Admin logs in at /auth/login with admin credentials
2. Navigates to /admin/invites
3. Clicks "Generate Invite" for a unit
4. Sees QR code + invite URL displayed
5. Can copy the invite URL

Tenant flow (Plan 03):
1. Visits /invite/[token] (the URL from the QR code)
2. Sees "Create your account" form with unit number
3. Fills in name, email, password, confirm password
4. Submits and is redirected to /tenant/dashboard
5. Is linked to the correct unit (visible in tenant_units table)

Error states:
- Visiting the same /invite/[token] again shows "already used" error
- Visiting /invite/invalid-token shows "not recognized" error
- Expired token shows "expired" error (requires DB manipulation to test)

Known credentials (from seed scripts):
- Admin: admin@rentalmgmt.com / password from seed-admin.ts
- Units exist from seed-property.ts: 1A, 1B, 2A, 2B, 3A
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run automated Playwright E2E tests for the full invite flow</name>
  <files></files>
  <action>
Use Playwright MCP tools to test the full invite flow end-to-end. The dev server must be running.

IMPORTANT: Per user preferences, run ALL Playwright tests in headless mode. Do NOT open visible browser windows.

**Pre-requisite: Ensure dev server is running**

```bash
cd /Users/odesantos/Documents/rentalmgmt && npm run dev &
sleep 3  # Wait for server to start
```

**Test Sequence:**

**Test 1: Admin generates invite for a unit**
1. Navigate to http://localhost:3000/auth/login
2. Fill email: admin@rentalmgmt.com, password: (admin password from seed)
3. Submit login form
4. Navigate to http://localhost:3000/admin/invites
5. Verify page shows units table (1A, 1B, etc.)
6. Click "Generate Invite" button for first unit
7. Verify QR code image appears
8. Verify invite URL is displayed
9. Copy the invite URL from the displayed field

**Test 2: Tenant registers via invite link**
1. Open a new browser context (no session cookies — simulates a different user)
2. Navigate to the invite URL captured in Test 1
3. Verify the page shows "Create your account" with the correct unit number
4. Fill in: name "Test Tenant", email "testtenant-{timestamp}@test.com", password "TestPass123!", confirm "TestPass123!"
5. Submit the registration form
6. Verify redirect to /tenant/dashboard
7. Verify the dashboard loads (session is active)

**Test 3: Used invite shows error**
1. Open another new browser context (no cookies)
2. Navigate to the SAME invite URL from Test 1
3. Verify the page shows "Invite already used" message (NOT a registration form)

**Test 4: Invalid token shows error**
1. Navigate to http://localhost:3000/invite/totally-invalid-token-string
2. Verify the page shows "Invalid invite link" message

**Test 5: Verify tenant-unit linkage in database**
1. Query the database to confirm the tenant_units row exists:
```bash
cd /Users/odesantos/Documents/rentalmgmt && npx tsx -r tsconfig-paths/register -e "
import { config } from 'dotenv'; config({ path: '.env.local' });
import { db } from '@/db';
import { tenantUnits, user } from '@/db/schema';
import { eq } from 'drizzle-orm';

const rows = await db.select({ userId: tenantUnits.userId, unitId: tenantUnits.unitId, isActive: tenantUnits.isActive }).from(tenantUnits);
console.log('tenant_units rows:', JSON.stringify(rows, null, 2));
process.exit(0);
"
```

**If any test fails:** Document the failure in detail (screenshot, error message, expected vs actual). The after-hook inviteToken passthrough is the most likely failure point — if the token doesn't reach the hook, verify:
1. Check the Better Auth request body logging: does `ctx.body` contain `inviteToken`?
2. If not, implement the cookie fallback: set a cookie on the invite page server component, read it in the after-hook.
  </action>
  <verify>
    <automated>curl -s http://localhost:3000/invite/nonexistent-token 2>&1 | grep -c "Invalid invite" || echo "Page check needs dev server running"</automated>
  </verify>
  <done>
    All five tests pass: admin generates invite with QR code, tenant registers via invite link and lands on dashboard, used invite shows "already used" error, invalid token shows "invalid link" error, tenant_units row exists in database confirming the linkage.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of complete tenant onboarding flow</name>
  <files></files>
  <action>
Present Playwright test results to the user for review. The automated tests in Task 1 cover:
- Admin generates invite with QR code and link at /admin/invites
- Tenant registers via invite link and lands on /tenant/dashboard
- Used invite shows "already used" error
- Invalid token shows "invalid link" error
- Database confirms tenant-unit linkage

If the user wants to verify manually:
1. Open http://localhost:3000/auth/login
2. Sign in as admin (admin@rentalmgmt.com)
3. Navigate to http://localhost:3000/admin/invites
4. Click "Generate Invite" for any unit — verify QR code and link appear
5. Copy the invite URL, open in an incognito window
6. Verify you see "Create your account" with the unit number
7. Register a new account and verify you land on /tenant/dashboard
8. Go back and paste the SAME invite URL — verify "already used" message
  </action>
  <verify>
    <automated>echo "Human verification checkpoint — no automated check"</automated>
  </verify>
  <done>
    User confirms the complete invite flow works: admin generation, tenant registration via QR link, unit linking, and error states for used/invalid tokens. Phase 2 is complete.
  </done>
</task>

</tasks>

<verification>
Phase 2 success criteria (from ROADMAP.md):
1. Admin can generate a unique per-unit invite token and download or print a QR code — verified via admin invites page
2. Tenant scans QR code, is taken directly to account creation pre-associated with their unit — verified via invite page
3. After completing account creation, tenant is linked to the correct unit automatically — verified via DB query
4. The invite link becomes invalid after one use — second visit shows "already used" error
5. An invite link that has expired (past 30 days) shows a clear expiry message — verified via expired state rendering
</verification>

<success_criteria>
- All Playwright automated tests pass
- Human verification confirms the flow works
- Database shows tenant_units row linking the new user to the correct unit
- Used invite shows "already used" error
- Invalid token shows "invalid link" error
</success_criteria>

<output>
After completion, create `.planning/phases/02-tenant-onboarding/02-04-SUMMARY.md`
</output>
