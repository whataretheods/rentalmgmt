---
phase: 08-financial-ledger-foundation
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - src/app/api/admin/charges/route.ts
  - src/app/(admin)/admin/charges/page.tsx
  - src/app/(admin)/admin/charges/loading.tsx
autonomous: true
requirements: [LEDG-03]

must_haves:
  truths:
    - Admin can navigate to a charge management page and see a form to post charges
    - Admin can post a rent charge, one-time charge, credit, or adjustment to any tenant's ledger
    - Each posted charge includes a type, description, and amount, and immediately appears in the ledger
    - Non-admin users cannot access the charge posting API
  artifacts:
    - src/app/api/admin/charges/route.ts (POST endpoint for creating charges)
    - src/app/(admin)/admin/charges/page.tsx (admin UI for posting charges)
    - src/app/(admin)/admin/charges/loading.tsx (loading skeleton)
  key_links:
    - POST /api/admin/charges validates input with zod and checks admin role
    - Charge is inserted into charges table with createdBy set to admin user ID
    - Credits use negative amountCents, charges use positive amountCents
---

<objective>
Build the admin charge management API and UI for manually posting charges, credits, and adjustments.

Purpose: Enables the admin to manually post financial entries to any tenant's ledger — rent charges, one-time fees, credits, and adjustments — with descriptions. This is LEDG-03.
Output: Admin API route for charge creation, admin page with charge posting form.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/08-financial-ledger-foundation/08-RESEARCH.md
@.planning/phases/08-financial-ledger-foundation/08-01-SUMMARY.md

<interfaces>
<!-- From Plan 01: charges table schema -->
From src/db/schema/domain.ts (after Plan 01):
```typescript
export const charges = pgTable("charges", {
  id: uuid("id").primaryKey().defaultRandom(),
  tenantUserId: text("tenant_user_id").notNull(),
  unitId: uuid("unit_id").references(() => units.id, { onDelete: "cascade" }).notNull(),
  type: text("type", { enum: ["rent", "late_fee", "one_time", "credit", "adjustment"] }).notNull(),
  description: text("description").notNull(),
  amountCents: integer("amount_cents").notNull(),
  billingPeriod: text("billing_period"),
  createdBy: text("created_by"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
})
```

<!-- Existing manual payment route pattern -->
From src/app/api/payments/manual/route.ts:
```typescript
import { auth } from "@/lib/auth"
import { headers } from "next/headers"
// Pattern: check session.user.role === "admin"
// Pattern: validate with zod schema
// Pattern: return NextResponse.json({ payment })
```

<!-- Existing admin page pattern -->
From src/app/(admin)/admin/payments/page.tsx:
```typescript
import { auth } from "@/lib/auth"
import { headers } from "next/headers"
// Pattern: auth check, fetch data server-side, render component
```

<!-- tenantUnits for looking up active tenants -->
From src/db/schema/domain.ts:
```typescript
export const tenantUnits = pgTable("tenant_units", {
  id: uuid("id").primaryKey().defaultRandom(),
  userId: text("user_id").notNull(),
  unitId: uuid("unit_id").references(() => units.id, { onDelete: "cascade" }).notNull(),
  startDate: timestamp("start_date").notNull(),
  endDate: timestamp("end_date"),
  isActive: boolean("is_active").default(true).notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
})
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin charge posting API endpoint</name>
  <files>src/app/api/admin/charges/route.ts</files>
  <action>
Create `src/app/api/admin/charges/route.ts` with a POST handler for creating charges:

**POST /api/admin/charges** — Creates a charge entry in the ledger.

Input validation (zod schema):
```typescript
const chargeSchema = z.object({
  tenantUserId: z.string().min(1),
  unitId: z.string().uuid(),
  type: z.enum(["rent", "late_fee", "one_time", "credit", "adjustment"]),
  description: z.string().min(1).max(500),
  amountCents: z.number().int().min(1).max(10000000), // Always positive — sign is determined by type
  billingPeriod: z.string().regex(/^\d{4}-\d{2}$/).optional(), // Required for rent, optional for others
})
```

Business logic:
1. Auth check: session must exist and `session.user.role === "admin"`. Return 401 otherwise.
2. Validate input with zod. Return 400 on failure.
3. Verify the tenantUserId has an active tenancy for the given unitId by querying tenantUnits. Return 400 "No active tenancy for this tenant/unit combination" if not found.
4. For types "credit" and "adjustment", store amountCents as NEGATIVE (multiply by -1) to reduce balance. For "rent", "late_fee", "one_time", store as positive.
5. For type "rent", billingPeriod is required — return 400 if missing.
6. Insert into charges table with `createdBy: session.user.id`.
7. Return the created charge as JSON with 201 status.

Also add a **GET /api/admin/charges** handler that accepts query params:
- `tenantUserId` (required) — filter charges by tenant
- `unitId` (optional) — filter by unit
- Returns charges ordered by createdAt desc, limited to 100.

Follow the pattern from `src/app/api/payments/manual/route.ts` for auth checking and response format.
  </action>
  <verify>
    <automated>npx tsc --noEmit src/app/api/admin/charges/route.ts 2>&1 | tail -5</automated>
    TypeScript compiles without errors. The file exports POST and GET handlers.
  </verify>
  <done>
    - POST /api/admin/charges creates a charge record with proper validation
    - Credits and adjustments are stored with negative amountCents
    - Rent charges require billingPeriod
    - Admin auth check prevents non-admin access
    - GET /api/admin/charges returns filtered charges for a tenant
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin charge management page</name>
  <files>src/app/(admin)/admin/charges/page.tsx, src/app/(admin)/admin/charges/loading.tsx</files>
  <action>
1. **Create src/app/(admin)/admin/charges/loading.tsx** — simple skeleton loader following the pattern from other admin loading.tsx files (e.g., `src/app/(admin)/admin/payments/loading.tsx`). Show a pulsing placeholder for the form and table area.

2. **Create src/app/(admin)/admin/charges/page.tsx** — Admin page for posting charges to tenant ledgers.

This page needs to be a client component ("use client") because it has interactive form state.

**Page structure:**
- **Header:** "Charge Management" title with description "Post charges, credits, and adjustments to tenant ledgers."
- **Tenant Selection:** Dropdown/select that lists all active tenants (fetched from `/api/admin/units` which returns unit data with tenant info, or create a simple fetch to get active tenant-unit pairs). Show tenant name, email, and unit number.
- **Charge Form** (shown after selecting a tenant):
  - Type selector: radio buttons or select for "Rent", "Late Fee", "One-Time Charge", "Credit", "Adjustment"
  - Description: text input (required)
  - Amount: dollar input field (converted to cents for API). For credits/adjustments, label as "Credit Amount" — the API handles sign conversion.
  - Billing Period: month picker (YYYY-MM format), shown only when type is "rent" or "late_fee"
  - Submit button: "Post Charge" (or "Post Credit" for credit/adjustment types)
- **Recent Charges** (below the form): Table showing recent charges for the selected tenant, fetched from `GET /api/admin/charges?tenantUserId=xxx`. Columns: Date, Type, Description, Amount (show credits as negative/green, charges as positive/red), Posted By.

**UI patterns:**
- Use shadcn/ui components (Button, Input, Select, Label, Card) — import from `@/components/ui/*`
- Use `sonner` for success/error toasts (`toast.success("Charge posted")`)
- Dollar input: let user type dollars (e.g., "50.00"), convert to cents for API (`Math.round(parseFloat(value) * 100)`)
- Show loading state on submit button
- After successful post, refetch the recent charges list and reset the form

**Styling:** Follow the existing admin page patterns — gray headings, card-based layout, Tailwind utility classes. Use the same spacing and typography as `/admin/payments`.

**Important:** The tenant list should be fetched on mount. Use the existing `/api/admin/payments-overview` endpoint (which returns unit data with tenant info) or call the admin units route. Map the response to get unique tenant-unit pairs with names and emails.
  </action>
  <verify>
    <automated>npx next build 2>&1 | tail -10</automated>
    The page builds without errors and is accessible at /admin/charges.
  </verify>
  <done>
    - Admin can navigate to /admin/charges and see the charge management page
    - Admin can select a tenant from a dropdown showing name, email, and unit
    - Admin can fill in type, description, amount, and optional billing period
    - Submitting the form posts to /api/admin/charges and shows a success toast
    - Credits/adjustments are clearly labeled in the form
    - Recent charges for the selected tenant are displayed in a table below the form
  </done>
</task>

</tasks>

<verification>
- Navigate to /admin/charges as admin — page loads with tenant selector
- Select a tenant, fill in charge form, submit — charge appears in recent charges table
- Post a credit — amount shows as negative in the table
- Attempt to access /api/admin/charges as non-admin — returns 401
- Post a rent charge without billingPeriod — returns 400 validation error
</verification>

<success_criteria>
- Admin can manually post charges, credits, and adjustments to any tenant's ledger
- Each charge includes type, description, amount, and optional billing period
- The UI provides clear feedback on success/failure
- Balance is implicitly updated (charges table has new records that getTenantBalance will compute)
</success_criteria>

<output>
After completion, create `.planning/phases/08-financial-ledger-foundation/08-02-SUMMARY.md`
</output>
