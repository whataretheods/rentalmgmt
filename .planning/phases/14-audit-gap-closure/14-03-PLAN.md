---
phase: 14-audit-gap-closure
plan: 03
type: execute
wave: 2
depends_on: ["01", "02"]
files_modified:
  - src/lib/kpi-queries.ts
autonomous: true
requirements:
  - AUX-02

must_haves:
  truths:
    - "KPI 'Total Outstanding' reflects rent plus non-rent charges minus payments"
    - "KPI 'Overdue Tenants' counts tenants who have paid less than they owe past their due day, not just zero-payment tenants"
    - "A tenant with rent $1500 + late fee $50 who paid $1500 shows as having $50 outstanding and is counted as overdue past due day"
  artifacts:
    - path: "src/lib/kpi-queries.ts"
      provides: "Corrected overdue tenant logic using totalPaid < totalOwed"
      contains: "totalPaid < totalOwed"
  key_links:
    - from: "src/lib/kpi-queries.ts"
      to: "src/db/schema (charges table)"
      via: "charges query in getCollectionMetrics"
      pattern: "charges.amountCents"
    - from: "src/app/(admin)/admin/dashboard/page.tsx"
      to: "src/lib/kpi-queries.ts"
      via: "getKpiMetrics() call"
      pattern: "getKpiMetrics"
---

<objective>
Fix KPI "Overdue Tenants" metric to account for charges (not just zero-payment check), closing the AUX-02 integration gap.

Purpose: The KPI dashboard's `totalOutstandingCents` already includes charges, but `overdueTenantsCount` uses `totalPaid === 0` which misses tenants who paid rent but have outstanding late fees or other charges. This creates an inconsistency where a tenant can show $50 outstanding in the "Total Outstanding" card but not appear in "Overdue Tenants".
Output: Corrected overdue tenant logic that considers total owed (rent + charges) vs total paid.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/14-audit-gap-closure/14-RESEARCH.md

@src/lib/kpi-queries.ts

<interfaces>
<!-- Key types and contracts the executor needs -->

From src/lib/kpi-queries.ts — current overdue logic (lines 138-141):
```typescript
// Overdue: past due day AND no payment at all
const dueDay = unit.rentDueDay ?? 1
if (currentDay > dueDay && totalPaid === 0) {
  overdueTenantsCount++
}
```

From src/lib/kpi-queries.ts — totalOwed is already computed (lines 127-128):
```typescript
const extraCharges = chargeMap.get(unit.unitId) ?? 0
const totalOwed = rentAmount + extraCharges
```

From src/lib/kpi-queries.ts — KpiMetrics interface:
```typescript
export interface KpiMetrics {
  collectionRate: number
  totalOutstandingCents: number
  occupancyRate: number
  openMaintenanceCount: number
  overdueTenantsCount: number
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix overdue tenants to use charges-aware check</name>
  <files>src/lib/kpi-queries.ts</files>
  <action>
    In `src/lib/kpi-queries.ts`, change the overdue tenant check from `totalPaid === 0` to `totalPaid < totalOwed`.

    **Current code (lines 138-141):**
    ```typescript
    // Overdue: past due day AND no payment at all
    const dueDay = unit.rentDueDay ?? 1
    if (currentDay > dueDay && totalPaid === 0) {
      overdueTenantsCount++
    }
    ```

    **Replace with:**
    ```typescript
    // Overdue: past due day AND total paid less than total owed (rent + charges)
    const dueDay = unit.rentDueDay ?? 1
    if (currentDay > dueDay && totalPaid < totalOwed) {
      overdueTenantsCount++
    }
    ```

    This is a one-line change: `totalPaid === 0` becomes `totalPaid < totalOwed`. The `totalOwed` variable is already computed above as `rentAmount + extraCharges`, so no new variables or queries are needed.

    Also update the `overdueTenantsCount` comment in the `KpiMetrics` interface to reflect the new semantics:
    ```typescript
    overdueTenantsCount: number  // count of tenants past due with outstanding balance
    ```
    (Previously: "count of tenants past due with no payment")

    Do NOT change the query structure, Promise.all pattern, or any other metric calculation. Only the overdue check condition and its comment change.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -10 && grep "totalPaid < totalOwed" src/lib/kpi-queries.ts</automated>
  </verify>
  <done>
    Overdue tenants check uses `totalPaid < totalOwed` instead of `totalPaid === 0`.
    A tenant with rent + late fee who paid only rent now correctly counts as overdue.
    KpiMetrics interface comment updated to reflect new semantics.
    No other KPI logic affected.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `grep "totalPaid < totalOwed" src/lib/kpi-queries.ts` returns the overdue check line
- `grep "totalPaid === 0" src/lib/kpi-queries.ts` returns no results (old check removed)
</verification>

<success_criteria>
1. KPI "Overdue Tenants" counts tenants with any outstanding balance past their due day
2. A tenant who paid rent but not a late fee is counted as overdue past due day
3. A tenant who paid everything (rent + charges) is NOT counted as overdue
4. Total Outstanding metric remains unchanged (already charges-aware)
</success_criteria>

<output>
After completion, create `.planning/phases/14-audit-gap-closure/14-03-SUMMARY.md`
</output>
