---
phase: 14-audit-gap-closure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(admin)/admin/work-orders/[id]/page.tsx
autonomous: true
requirements:
  - FIN-04
  - OPS-04

must_haves:
  truths:
    - "Work order cost form includes a 'Bill to Tenant' checkbox"
    - "Checking the checkbox sends billToTenant=true in the POST body to the costs API"
    - "After adding a cost, the checkbox resets to unchecked"
  artifacts:
    - path: "src/app/(admin)/admin/work-orders/[id]/page.tsx"
      provides: "billToTenant checkbox in cost form and field in POST body"
      contains: "billToTenant"
  key_links:
    - from: "src/app/(admin)/admin/work-orders/[id]/page.tsx"
      to: "/api/admin/work-orders/[id]/costs"
      via: "fetch POST with billToTenant in body"
      pattern: "billToTenant"
    - from: "/api/admin/work-orders/[id]/costs (POST)"
      to: "src/lib/chargeback.ts"
      via: "resolveAndPostChargeback called when billToTenant=true"
      pattern: "resolveAndPostChargeback"
---

<objective>
Add a "Bill to Tenant" checkbox to the work order cost form so the admin can bill work order costs to the tenant's ledger via the existing chargeback API.

Purpose: FIN-04 requires admin UI for billing work order costs to the tenant. The API already supports `billToTenant` and calls `resolveAndPostChargeback` — only the UI toggle is missing. OPS-04 cost tracking is already functional; this plan completes the chargeback integration.
Output: Work order cost form with billToTenant checkbox.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/14-audit-gap-closure/14-RESEARCH.md

@src/app/(admin)/admin/work-orders/[id]/page.tsx
@src/app/api/admin/work-orders/[id]/costs/route.ts

<interfaces>
<!-- Key types and contracts the executor needs -->

From src/app/(admin)/admin/work-orders/[id]/page.tsx — current costForm state:
```typescript
const [costForm, setCostForm] = useState({
  description: "",
  amount: "",
  category: "labor",
})
```

From src/app/(admin)/admin/work-orders/[id]/page.tsx — current handleAddCost body:
```typescript
body: JSON.stringify({
  description: costForm.description.trim(),
  amountCents: Math.round(amountDollars * 100),
  category: costForm.category,
})
```

From src/app/(admin)/admin/work-orders/[id]/page.tsx — current state reset in handleAddCost:
```typescript
setCostForm({ description: "", amount: "", category: "labor" })
```

From src/app/api/admin/work-orders/[id]/costs/route.ts (API already accepts billToTenant):
```typescript
const { description, amountCents, category, receiptPath, billToTenant } = body
// ...
if (billToTenant) {
  chargePosted = await resolveAndPostChargeback(id, description, amountCents, session.user.id)
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add billToTenant checkbox to work order cost form</name>
  <files>src/app/(admin)/admin/work-orders/[id]/page.tsx</files>
  <action>
    In `src/app/(admin)/admin/work-orders/[id]/page.tsx`, make three targeted changes:

    **Change 1 — Add billToTenant to costForm state (line ~121):**
    Update the costForm initial state to include billToTenant:
    ```typescript
    const [costForm, setCostForm] = useState({
      description: "",
      amount: "",
      category: "labor",
      billToTenant: false,
    })
    ```

    **Change 2 — Include billToTenant in POST body (in handleAddCost, line ~265-269):**
    Update the JSON.stringify body to include billToTenant:
    ```typescript
    body: JSON.stringify({
      description: costForm.description.trim(),
      amountCents: Math.round(amountDollars * 100),
      category: costForm.category,
      billToTenant: costForm.billToTenant,
    }),
    ```

    **Change 3 — Reset billToTenant in state reset (line ~274):**
    Update the setCostForm reset to include billToTenant:
    ```typescript
    setCostForm({ description: "", amount: "", category: "labor", billToTenant: false })
    ```

    **Change 4 — Add checkbox UI after the category Select and before the Add Cost button:**
    In the cost form grid (after the Select for category, before the Button), add a "Bill to Tenant" checkbox. Since this is a single boolean toggle, use a native HTML checkbox with Tailwind styling (per research anti-pattern guidance — don't install shadcn checkbox for one toggle):

    After the category Select `<div>` and before the Button `<div>`, add:
    ```tsx
    <div className="flex items-center gap-2 md:col-span-4">
      <input
        type="checkbox"
        id="billToTenant"
        checked={costForm.billToTenant}
        onChange={(e) =>
          setCostForm({ ...costForm, billToTenant: e.target.checked })
        }
        className="h-4 w-4 rounded border-gray-300"
      />
      <Label htmlFor="billToTenant" className="text-sm font-normal">
        Bill to Tenant
      </Label>
    </div>
    ```

    Note: The checkbox row spans full width (`md:col-span-4`) to appear below the inline form fields. This keeps the 4-column grid layout intact for the inputs while the checkbox sits on its own row.

    Import `Label` from `@/components/ui/label` — it's already imported at the top of the file.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20 && grep -c "billToTenant" src/app/\(admin\)/admin/work-orders/\[id\]/page.tsx</automated>
  </verify>
  <done>
    Cost form has a "Bill to Tenant" checkbox below the description/amount/category fields.
    Checking it sends billToTenant=true in the POST body to the costs API.
    After adding a cost, the checkbox resets to unchecked.
    The API already handles billToTenant by calling resolveAndPostChargeback — no backend changes needed.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no type errors
- `grep "billToTenant" src/app/\(admin\)/admin/work-orders/\[id\]/page.tsx` shows 4+ occurrences (state, body, reset, checkbox)
- Work order cost form renders checkbox
</verification>

<success_criteria>
1. Work order cost form includes a "Bill to Tenant" checkbox
2. When checked, the POST request to `/api/admin/work-orders/[id]/costs` includes `billToTenant: true`
3. After adding a cost, the checkbox resets to unchecked
4. Existing cost tracking functionality (OPS-04) remains unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/14-audit-gap-closure/14-02-SUMMARY.md`
</output>
