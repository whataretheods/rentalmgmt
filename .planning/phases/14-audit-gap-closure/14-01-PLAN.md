---
phase: 14-audit-gap-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/admin/PropertyForm.tsx
  - src/app/api/admin/properties/route.ts
  - src/app/api/admin/properties/[id]/route.ts
  - src/app/(admin)/admin/properties/page.tsx
autonomous: true
requirements:
  - INFRA-03
  - LEDG-03
  - LATE-02
  - OPS-02

must_haves:
  truths:
    - "Admin can select a timezone when creating or editing a property"
    - "Selected timezone persists to database and loads back on edit"
    - "Properties GET API returns timezone for each property"
    - "Charges link exists in sidebar (pre-verified)"
    - "Late Fees button exists on properties page (pre-verified)"
    - "Create Work Order button exists on maintenance detail (pre-verified)"
  artifacts:
    - path: "src/components/admin/PropertyForm.tsx"
      provides: "Timezone Select dropdown using US_TIMEZONES"
      contains: "US_TIMEZONES"
    - path: "src/app/api/admin/properties/route.ts"
      provides: "GET returns timezone; POST accepts timezone"
      contains: "timezone"
    - path: "src/app/api/admin/properties/[id]/route.ts"
      provides: "PUT accepts timezone field"
      contains: "timezone"
  key_links:
    - from: "src/components/admin/PropertyForm.tsx"
      to: "src/lib/timezone.ts"
      via: "import US_TIMEZONES"
      pattern: "US_TIMEZONES"
    - from: "src/components/admin/PropertyForm.tsx"
      to: "/api/admin/properties"
      via: "fetch POST/PUT with timezone in body"
      pattern: "timezone"
    - from: "src/app/(admin)/admin/properties/page.tsx"
      to: "src/components/admin/PropertyForm.tsx"
      via: "property prop includes timezone"
      pattern: "timezone"
---

<objective>
Add timezone configuration to the PropertyForm and property APIs, and verify that three previously-closed UI gaps (Charges sidebar nav, Late Fees action, Create Work Order button) remain intact.

Purpose: INFRA-03 requires admin to set property timezone from the UI. Research confirmed that LEDG-03, LATE-02, and OPS-02 UI gaps are already closed in the current codebase — this plan verifies them and implements the remaining timezone gap.
Output: PropertyForm with timezone dropdown, property APIs accepting timezone field, and verification of three pre-closed gaps.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/14-audit-gap-closure/14-RESEARCH.md

@src/components/admin/PropertyForm.tsx
@src/app/api/admin/properties/route.ts
@src/app/api/admin/properties/[id]/route.ts
@src/app/(admin)/admin/properties/page.tsx
@src/lib/timezone.ts
@src/components/admin/AdminSidebar.tsx

<interfaces>
<!-- Key types and contracts the executor needs -->

From src/lib/timezone.ts:
```typescript
export const US_TIMEZONES: { value: string; label: string }[] = [
  { value: "America/New_York", label: "Eastern Time (ET)" },
  { value: "America/Chicago", label: "Central Time (CT)" },
  { value: "America/Denver", label: "Mountain Time (MT)" },
  { value: "America/Los_Angeles", label: "Pacific Time (PT)" },
  { value: "America/Anchorage", label: "Alaska Time (AKT)" },
  { value: "Pacific/Honolulu", label: "Hawaii Time (HT)" },
]
```

From src/db/schema/domain.ts (properties table):
```typescript
timezone: text("timezone").notNull().default("America/New_York"),
```

From src/components/admin/PropertyForm.tsx:
```typescript
interface PropertyFormProps {
  mode: "create" | "edit"
  property?: { id: string; name: string; address: string }
  onSuccess: () => void
  trigger: React.ReactNode
}
```

From src/app/(admin)/admin/properties/page.tsx:
```typescript
interface Property {
  id: string
  name: string
  address: string
  unitCount: number
  createdAt: string
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timezone to property APIs and PropertyForm</name>
  <files>
    src/app/api/admin/properties/route.ts,
    src/app/api/admin/properties/[id]/route.ts,
    src/app/(admin)/admin/properties/page.tsx,
    src/components/admin/PropertyForm.tsx
  </files>
  <action>
    **Step 1 — Properties GET API (route.ts):**
    In `src/app/api/admin/properties/route.ts`, add `timezone: properties.timezone` to the `.select()` clause so the GET response includes the timezone for each property.

    **Step 2 — Properties POST API (route.ts):**
    In the same file's POST handler, update the body type to include `timezone?: string`. In the `.insert().values()` call, add `timezone: body.timezone?.trim() || undefined` (only set if provided, otherwise the DB default "America/New_York" applies). Do NOT make timezone required for POST — the schema default handles it.

    **Step 3 — Properties PUT API ([id]/route.ts):**
    In `src/app/api/admin/properties/[id]/route.ts`, update the body type to include `timezone?: string`. Add: `if (body.timezone?.trim()) updates.timezone = body.timezone.trim()` alongside the existing name/address update logic.

    **Step 4 — Properties page interface (page.tsx):**
    In `src/app/(admin)/admin/properties/page.tsx`, add `timezone?: string` to the `Property` interface. This allows the property object passed to PropertyForm to include timezone.

    **Step 5 — PropertyForm timezone dropdown:**
    In `src/components/admin/PropertyForm.tsx`:
    1. Add imports: `import { US_TIMEZONES } from "@/lib/timezone"` and `import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"`
    2. Update `PropertyFormProps.property` interface to: `{ id: string; name: string; address: string; timezone?: string }`
    3. Add state: `const [timezone, setTimezone] = useState(property?.timezone ?? "America/New_York")`
    4. Add a timezone Select dropdown AFTER the Address field (before DialogFooter), using the existing Select pattern:
       ```
       <div className="space-y-2">
         <Label htmlFor="property-timezone">Timezone</Label>
         <Select value={timezone} onValueChange={setTimezone}>
           <SelectTrigger id="property-timezone">
             <SelectValue />
           </SelectTrigger>
           <SelectContent>
             {US_TIMEZONES.map((tz) => (
               <SelectItem key={tz.value} value={tz.value}>
                 {tz.label}
               </SelectItem>
             ))}
           </SelectContent>
         </Select>
       </div>
       ```
    5. Update `handleSubmit` body to include timezone: `body: JSON.stringify({ name: name.trim(), address: address.trim(), timezone })`
    6. In the create-mode state reset (after `setOpen(false)` in the success path), add `setTimezone("America/New_York")` alongside the existing `setName("")` and `setAddress("")` resets.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    PropertyForm shows timezone dropdown with 6 US timezone options.
    Creating a property sends timezone in POST body.
    Editing a property loads saved timezone and sends it in PUT body.
    GET /api/admin/properties returns timezone for each property.
    Create-mode form resets timezone to "America/New_York" after success.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify LEDG-03, LATE-02, OPS-02 gaps are closed</name>
  <files>
    src/components/admin/AdminSidebar.tsx,
    src/app/(admin)/admin/properties/page.tsx,
    src/components/admin/AdminMaintenanceDetail.tsx
  </files>
  <action>
    These three gaps were identified as already closed during Phase 14 research. This task verifies they are present in the codebase via automated grep checks. No code changes needed.

    **Verification 1 — LEDG-03 (Charges sidebar nav):**
    Confirm `AdminSidebar.tsx` contains a nav item with `title: "Charges"` and `href: "/admin/charges"`.

    **Verification 2 — LATE-02 (Late Fees action on properties):**
    Confirm `properties/page.tsx` contains a link to `/admin/properties/${property.id}/late-fees` with text "Late Fees".

    **Verification 3 — OPS-02 (Create Work Order button):**
    Confirm `AdminMaintenanceDetail.tsx` contains a button with text "Create Work Order" that POSTs to `/api/admin/work-orders`.

    If any verification fails (unexpected codebase change), restore the feature using the patterns documented in 14-RESEARCH.md. If all pass, no changes needed — just document verification results.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && grep -q '"Charges"' src/components/admin/AdminSidebar.tsx && echo "LEDG-03 OK" && grep -q 'late-fees' src/app/\(admin\)/admin/properties/page.tsx && echo "LATE-02 OK" && grep -q 'Create Work Order' src/components/admin/AdminMaintenanceDetail.tsx && echo "OPS-02 OK"</automated>
  </verify>
  <done>
    Charges nav link confirmed in AdminSidebar.tsx.
    Late Fees button confirmed on properties page.
    Create Work Order button confirmed on maintenance detail page.
    LEDG-03, LATE-02, and OPS-02 gaps verified closed — no code changes needed.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no type errors
- PropertyForm renders timezone Select dropdown
- Properties GET API response includes `timezone` field
- AdminSidebar includes Charges nav item
- Properties page includes Late Fees button
- AdminMaintenanceDetail includes Create Work Order button
</verification>

<success_criteria>
1. Admin can select a timezone from a dropdown of 6 US timezones when creating or editing a property
2. Selected timezone is sent to the API and persists to the database
3. When editing a property, the timezone dropdown shows the previously saved timezone
4. Charges sidebar nav link, Late Fees button, and Create Work Order button all confirmed present
</success_criteria>

<output>
After completion, create `.planning/phases/14-audit-gap-closure/14-01-SUMMARY.md`
</output>
