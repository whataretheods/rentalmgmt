---
phase: 09-automated-operations
plan: 03
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - src/app/(admin)/admin/properties/[id]/late-fees/page.tsx
  - src/app/api/admin/late-fee-rules/route.ts
  - tests/late-fee-admin.spec.ts
autonomous: true
requirements: [LATE-02]
must_haves:
  truths:
    - "Admin can configure late fee rules per property — grace period days, flat or percentage fee type, and fee amount"
    - "Admin can enable and disable automatic late fees per property (defaults to OFF)"
    - "Admin can set an optional maximum fee cap for percentage-based fees"
    - "Form validates inputs (grace period >= 1, fee amount > 0)"
  artifacts:
    - path: "src/app/(admin)/admin/properties/[id]/late-fees/page.tsx"
      provides: "Admin late fee configuration UI"
      min_lines: 80
    - path: "src/app/api/admin/late-fee-rules/route.ts"
      provides: "API endpoint for late fee rule CRUD"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/app/(admin)/admin/properties/[id]/late-fees/page.tsx"
      to: "/api/admin/late-fee-rules"
      via: "fetch for GET and POST"
      pattern: "fetch.*late-fee-rules"
    - from: "src/app/api/admin/late-fee-rules/route.ts"
      to: "src/db/schema/domain.ts"
      via: "db.select/insert/update on lateFeeRules"
      pattern: "lateFeeRules"
---

<objective>
Build admin UI and API for configuring late fee rules per property

Purpose: Allow admins to configure late fee rules per property — enabling/disabling late fees, setting grace period, choosing flat vs percentage fee type, setting fee amount, and optionally capping percentage fees.

Output: Admin settings page at /admin/properties/[id]/late-fees and API endpoint for late fee rule CRUD.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-automated-operations/09-RESEARCH.md
@.planning/phases/09-automated-operations/09-01-SUMMARY.md
@src/db/schema/domain.ts
@src/app/(admin)/admin/units/page.tsx

<interfaces>
<!-- Key types from Plan 01 -->

From src/db/schema/domain.ts (lateFeeRules table):
```typescript
export const lateFeeRules = pgTable("late_fee_rules", {
  id: uuid("id").primaryKey().defaultRandom(),
  propertyId: uuid("property_id").references(() => properties.id).notNull().unique(),
  enabled: boolean("enabled").default(false).notNull(),
  gracePeriodDays: integer("grace_period_days").notNull().default(5),
  feeType: text("fee_type", { enum: ["flat", "percentage"] }).notNull().default("flat"),
  feeAmountCents: integer("fee_amount_cents").notNull().default(5000),
  maxFeeAmountCents: integer("max_fee_amount_cents"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
})
```

From src/lib/late-fees.ts:
```typescript
export function formatCentsAsDollars(cents: number): string
```

From src/lib/timezone.ts:
```typescript
export const US_TIMEZONES: { value: string; label: string }[]
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API endpoint for late fee rule CRUD</name>
  <files>src/app/api/admin/late-fee-rules/route.ts</files>
  <action>
  Create `src/app/api/admin/late-fee-rules/route.ts` with GET and POST handlers.

  **Authentication:** Both handlers must verify the user is an admin. Use the same auth pattern as other admin API routes in the project (check session, verify role === "admin").

  **GET `/api/admin/late-fee-rules?propertyId={id}`:**
  - Query lateFeeRules WHERE propertyId matches
  - Return the rule or null if none exists
  - Response: `{ rule: LateFeeRule | null }`

  **POST `/api/admin/late-fee-rules`:**
  - Accept JSON body:
    ```typescript
    {
      propertyId: string
      enabled: boolean
      gracePeriodDays: number  // >= 1
      feeType: "flat" | "percentage"
      feeAmountCents: number  // > 0
      maxFeeAmountCents?: number | null  // optional, only for percentage
    }
    ```
  - Validate with zod:
    - `propertyId`: required UUID
    - `enabled`: required boolean
    - `gracePeriodDays`: required integer >= 1
    - `feeType`: required enum ["flat", "percentage"]
    - `feeAmountCents`: required integer > 0
    - `maxFeeAmountCents`: optional integer > 0, or null
  - Upsert (insert or update on conflict of propertyId):
    - Use Drizzle's `.onConflictDoUpdate()` on the `propertyId` unique constraint
    - Set `updatedAt: new Date()` on update
  - Return: `{ rule: LateFeeRule }` with the upserted record

  **Error handling:**
  - 400 for validation errors with zod error messages
  - 401/403 for unauthenticated/unauthorized
  - 500 for database errors
  </action>
  <verify>
    <automated>npx tsx -e "console.log('API route exists:', require('fs').existsSync('./src/app/api/admin/late-fee-rules/route.ts'))"</automated>
  </verify>
  <done>API endpoint handles GET (fetch rule by propertyId) and POST (upsert rule with validation). Auth-protected for admins only. Zod validation on all inputs.</done>
</task>

<task type="auto">
  <name>Task 2: Build admin late fee configuration page</name>
  <files>src/app/(admin)/admin/properties/[id]/late-fees/page.tsx</files>
  <action>
  Create `src/app/(admin)/admin/properties/[id]/late-fees/page.tsx` — a server component page with a client form component.

  **Page layout:**
  - Title: "Late Fee Settings" with property name subtitle
  - Back link to property details (or admin dashboard)
  - Form card using shadcn/ui Card component

  **Form fields (using shadcn/ui components):**
  1. **Enable Late Fees** — Switch toggle (default OFF). When OFF, all other fields are disabled/grayed out
  2. **Grace Period (days)** — Number input, min=1, default=5. Label: "Days after due date before a late fee is assessed"
  3. **Fee Type** — Radio group or Select: "Flat Amount" or "Percentage of Rent"
  4. **Fee Amount** — Number input:
     - If flat: dollar amount input (display as $XX.XX, store as cents)
     - If percentage: percentage input (display as X%, store as basis points e.g., 500 = 5%)
  5. **Maximum Fee (optional)** — Number input, only shown when feeType="percentage". Dollar amount cap.

  **Form behavior:**
  - On page load, GET /api/admin/late-fee-rules?propertyId={id} to fetch existing rule
  - If rule exists, populate form with existing values
  - If no rule exists, show defaults (enabled=false, gracePeriod=5, flat, $50)
  - On submit, POST to /api/admin/late-fee-rules
  - Show success toast (sonner) on save
  - Show validation errors inline

  **Use react-hook-form + zod for client-side validation.** Follow the same form patterns used in other admin pages.

  **Important UX notes:**
  - When late fees are disabled (switch OFF), show a muted note: "Late fees are currently disabled for this property. Tenants will not be automatically charged late fees."
  - When enabling, show a confirmation note: "When enabled, tenants with unpaid rent will be automatically charged a late fee after the grace period."
  - Add a note about legal compliance: "Ensure late fee amounts comply with your local jurisdiction's regulations."
  </action>
  <verify>
    <automated>npx tsx -e "console.log('Admin page exists:', require('fs').existsSync('./src/app/(admin)/admin/properties/[id]/late-fees/page.tsx'))"</automated>
  </verify>
  <done>Admin late fee configuration page at /admin/properties/[id]/late-fees with enable toggle, grace period input, fee type selector, fee amount input, and optional max fee cap. Form loads existing rules and upserts on save.</done>
</task>

<task type="auto">
  <name>Task 3: Create admin late fee config E2E test</name>
  <files>tests/late-fee-admin.spec.ts</files>
  <action>
  Create `tests/late-fee-admin.spec.ts` — Playwright E2E test for the admin late fee configuration flow.

  **Test setup:** Log in as admin user (use seed data or existing admin credentials from the project's test setup).

  **Test cases:**
  1. **Admin can access late fee settings page** — Navigate to /admin/properties/{testPropertyId}/late-fees, verify page loads with "Late Fee Settings" heading
  2. **Late fees are disabled by default** — Verify the enable switch is OFF when no rule exists
  3. **Admin can enable and configure late fees** — Toggle enable ON, set grace period to 7, select "Flat Amount", enter $75, save. Verify success toast appears.
  4. **Saved settings persist on reload** — After saving, reload page, verify all values are populated correctly (enabled=true, gracePeriod=7, flat, $75)
  5. **Validation prevents invalid inputs** — Try setting grace period to 0, verify error. Try setting fee amount to 0, verify error.

  Use the same Playwright test patterns as existing tests in the project (login flow, page navigation, form interaction).

  NOTE: If a test property doesn't exist in the dev database, the test should note this and provide instructions for seeding test data. Use existing seed scripts as reference.
  </action>
  <verify>
    <automated>npx playwright test tests/late-fee-admin.spec.ts --reporter=line</automated>
  </verify>
  <done>E2E test verifies admin can access, configure, and save late fee rules. Settings persist across page loads. Validation works correctly.</done>
</task>

</tasks>

<verification>
- GET /api/admin/late-fee-rules?propertyId={id} returns existing rule or null
- POST /api/admin/late-fee-rules upserts rule with validation
- Admin page at /admin/properties/[id]/late-fees loads and displays form
- Enable toggle defaults to OFF
- Saved settings persist on reload
- Input validation prevents invalid values (grace period < 1, fee amount <= 0)
</verification>

<success_criteria>
Admin can configure late fee rules per property from the admin UI. Settings are validated, persisted, and loaded correctly. Late fees default to disabled until explicitly enabled.
</success_criteria>

<output>
After completion, create `.planning/phases/09-automated-operations/09-03-SUMMARY.md`
</output>
