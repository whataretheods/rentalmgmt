---
phase: 09-automated-operations
plan: 04
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - src/app/api/cron/rent-reminders/route.ts
  - src/app/api/cron/autopay-charge/route.ts
  - src/app/api/cron/autopay-notify/route.ts
autonomous: true
requirements: [INFRA-03]
must_haves:
  truths:
    - "Rent reminders use property-local timezone to determine due date relative to current day"
    - "Autopay charge processing uses property-local timezone to determine if today is the due day"
    - "Autopay pre-charge notification uses property-local timezone for 3-day advance notice"
    - "A tenant with rent due on the 1st is not charged late on December 31st at 7pm because the server runs in UTC"
  artifacts:
    - path: "src/app/api/cron/rent-reminders/route.ts"
      provides: "Timezone-aware rent reminders"
      contains: "getLocalDate"
    - path: "src/app/api/cron/autopay-charge/route.ts"
      provides: "Timezone-aware autopay charging"
      contains: "getLocalDate"
    - path: "src/app/api/cron/autopay-notify/route.ts"
      provides: "Timezone-aware autopay notifications"
      contains: "getLocalDate"
  key_links:
    - from: "src/app/api/cron/rent-reminders/route.ts"
      to: "src/lib/timezone.ts"
      via: "import getLocalDate, getLocalBillingPeriod"
      pattern: "import.*from.*timezone"
    - from: "src/app/api/cron/autopay-charge/route.ts"
      to: "src/lib/timezone.ts"
      via: "import getLocalDate, getLocalBillingPeriod"
      pattern: "import.*from.*timezone"
    - from: "src/app/api/cron/autopay-notify/route.ts"
      to: "src/lib/timezone.ts"
      via: "import getLocalDate"
      pattern: "import.*from.*timezone"
---

<objective>
Retrofit existing cron jobs to use property-local timezone

Purpose: INFRA-03 requires that rent reminders, late fee calculations, and autopay scheduling all use the property's configured timezone instead of UTC. This plan retrofits the three existing cron endpoints to use the timezone utility functions from Plan 01, ensuring a tenant with rent due on the 1st is not treated as late on December 31st at 7pm just because the server runs in UTC.

Output: All three existing cron endpoints updated to use property-local timezone for date calculations.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-automated-operations/09-RESEARCH.md
@.planning/phases/09-automated-operations/09-01-SUMMARY.md
@src/app/api/cron/rent-reminders/route.ts
@src/app/api/cron/autopay-charge/route.ts
@src/app/api/cron/autopay-notify/route.ts
@src/db/schema/domain.ts

<interfaces>
<!-- Key types from Plan 01 -->

From src/lib/timezone.ts:
```typescript
export function getLocalDate(timezone: string): { year: number; month: number; day: number }
export function getLocalBillingPeriod(timezone: string): string
export function daysSinceRentDue(rentDueDay: number, timezone: string): number
```

From src/db/schema/domain.ts:
```typescript
// properties table now has timezone column
export const properties = pgTable("properties", {
  // ... existing columns ...
  timezone: text("timezone").notNull().default("America/New_York"),
})
```

Current UTC-based date calculation pattern (to be replaced):
```typescript
const today = new Date()
const currentDay = today.getDate()  // UTC day — WRONG for property-local time
const currentPeriod = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}`
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Retrofit rent-reminders cron to use property timezone</name>
  <files>src/app/api/cron/rent-reminders/route.ts</files>
  <action>
  Modify `src/app/api/cron/rent-reminders/route.ts` to use property-local timezone instead of UTC.

  **Changes:**

  1. Add imports:
     ```typescript
     import { getLocalDate, getLocalBillingPeriod } from "@/lib/timezone"
     import { properties } from "@/db/schema/domain"
     ```

  2. Remove the UTC-based date calculation at the top of the function:
     ```typescript
     // REMOVE:
     const today = new Date()
     const currentDay = today.getDate()
     const currentPeriod = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}`
     ```

  3. Update the query to JOIN with properties to get timezone:
     ```typescript
     const activeLinks = await db
       .select({
         userId: tenantUnits.userId,
         unitId: tenantUnits.unitId,
         unitNumber: units.unitNumber,
         rentAmountCents: units.rentAmountCents,
         rentDueDay: units.rentDueDay,
         propertyTimezone: properties.timezone,  // NEW
       })
       .from(tenantUnits)
       .innerJoin(units, eq(units.id, tenantUnits.unitId))
       .innerJoin(properties, eq(properties.id, units.propertyId))  // NEW JOIN
       .where(eq(tenantUnits.isActive, true))
     ```

  4. Inside the loop, replace UTC date references with property-local:
     ```typescript
     const localDate = getLocalDate(link.propertyTimezone)
     const currentDay = localDate.day
     const currentPeriod = getLocalBillingPeriod(link.propertyTimezone)
     ```

  5. Update `startOfToday` for idempotency check to use property-local date:
     ```typescript
     const startOfToday = new Date(localDate.year, localDate.month - 1, localDate.day)
     ```

  6. The rest of the logic (getReminderType, payment check, notification) stays the same but now uses the property-local `currentDay` and `currentPeriod`.

  **Key behavioral change:** `daysUntilDue` is now calculated using the property's local day, not UTC. This means:
  - A property in Pacific time (UTC-8) won't see "due today" reminders at 4pm UTC (which is 8am PT and still "upcoming" not "due today" in some cases)
  - The billing period is computed in local time, preventing month-boundary mismatches
  </action>
  <verify>
    <automated>npx tsx -e "console.log('rent-reminders route contains timezone import:', require('fs').readFileSync('./src/app/api/cron/rent-reminders/route.ts', 'utf8').includes('getLocalDate'))"</automated>
  </verify>
  <done>Rent reminders cron uses property-local timezone for daysUntilDue calculation, billing period determination, and idempotency checks. No more UTC-based date math.</done>
</task>

<task type="auto">
  <name>Task 2: Retrofit autopay-charge cron to use property timezone</name>
  <files>src/app/api/cron/autopay-charge/route.ts</files>
  <action>
  Modify `src/app/api/cron/autopay-charge/route.ts` to use property-local timezone.

  **Changes:**

  1. Add imports:
     ```typescript
     import { getLocalDate, getLocalBillingPeriod } from "@/lib/timezone"
     import { properties } from "@/db/schema/domain"
     ```

  2. Remove the UTC-based date calculation at the top:
     ```typescript
     // REMOVE:
     const today = new Date()
     const currentDay = today.getDate()
     const currentPeriod = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}`
     ```

  3. Update the query to JOIN with properties:
     ```typescript
     const enrollments = await db
       .select({
         // ... existing fields ...
         propertyTimezone: properties.timezone,  // NEW
       })
       .from(autopayEnrollments)
       .innerJoin(units, eq(units.id, autopayEnrollments.unitId))
       .innerJoin(properties, eq(properties.id, units.propertyId))  // NEW JOIN
       .where(eq(autopayEnrollments.status, "active"))
     ```

  4. Inside the loop, compute local date per property:
     ```typescript
     const localDate = getLocalDate(enrollment.propertyTimezone)
     const currentDay = localDate.day
     const currentPeriod = getLocalBillingPeriod(enrollment.propertyTimezone)
     ```

  5. The `isDueDay` and `isRetryDay` checks now use property-local `currentDay`:
     ```typescript
     const isDueDay = currentDay === enrollment.rentDueDay
     const isRetryDay = currentDay === enrollment.rentDueDay + 2
     ```

  6. Update nextChargeDate calculation to use local date:
     ```typescript
     const localDate = getLocalDate(enrollment.propertyTimezone)
     const nextMonth = new Date(localDate.year, localDate.month, enrollment.rentDueDay)
     ```

  **Key behavioral change:** Autopay charges fire on the property's local due day. A property in Hawaii (UTC-10) with rent due on the 1st won't have autopay trigger at 2pm UTC on Jan 1 (which is 4am HT Jan 1 — correct timing now depends on when cron runs, but the date evaluation is correct).
  </action>
  <verify>
    <automated>npx tsx -e "console.log('autopay-charge route contains timezone import:', require('fs').readFileSync('./src/app/api/cron/autopay-charge/route.ts', 'utf8').includes('getLocalDate'))"</automated>
  </verify>
  <done>Autopay charge cron uses property-local timezone for due day detection, retry day calculation, and billing period. Next charge date computed in local time.</done>
</task>

<task type="auto">
  <name>Task 3: Retrofit autopay-notify cron to use property timezone</name>
  <files>src/app/api/cron/autopay-notify/route.ts</files>
  <action>
  Modify `src/app/api/cron/autopay-notify/route.ts` to use property-local timezone.

  **Changes:**

  1. Add imports:
     ```typescript
     import { getLocalDate } from "@/lib/timezone"
     import { properties } from "@/db/schema/domain"
     ```

  2. Remove UTC-based date calculation:
     ```typescript
     // REMOVE:
     const today = new Date()
     const currentDay = today.getDate()
     const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate())
     ```

  3. Update the query to JOIN with properties:
     ```typescript
     const enrollments = await db
       .select({
         // ... existing fields ...
         propertyTimezone: properties.timezone,  // NEW
       })
       .from(autopayEnrollments)
       .innerJoin(units, eq(units.id, autopayEnrollments.unitId))
       .innerJoin(properties, eq(properties.id, units.propertyId))  // NEW JOIN
       .where(eq(autopayEnrollments.status, "active"))
     ```

  4. Inside the loop, compute local date:
     ```typescript
     const localDate = getLocalDate(enrollment.propertyTimezone)
     const currentDay = localDate.day
     const startOfToday = new Date(localDate.year, localDate.month - 1, localDate.day)
     ```

  5. The `daysUntilDue` check now uses property-local time:
     ```typescript
     const daysUntilDue = enrollment.rentDueDay - currentDay
     if (daysUntilDue !== 3) { skipped++; continue }
     ```

  6. Update charge date display to use local date:
     ```typescript
     const chargeDate = new Date(localDate.year, localDate.month - 1, enrollment.rentDueDay)
     ```

  **Key behavioral change:** The 3-day advance notification is based on the property's local date, not UTC. A tenant in Pacific time won't get a notification a day early because UTC is already 3 days before their local due date.
  </action>
  <verify>
    <automated>npx tsx -e "console.log('autopay-notify route contains timezone import:', require('fs').readFileSync('./src/app/api/cron/autopay-notify/route.ts', 'utf8').includes('getLocalDate'))"</automated>
  </verify>
  <done>Autopay notification cron uses property-local timezone for daysUntilDue calculation and idempotency timestamp. All three cron endpoints now use property-local time consistently.</done>
</task>

</tasks>

<verification>
- All three cron files import from `@/lib/timezone`
- All three cron files JOIN with properties table to get timezone
- No cron file uses `new Date().getDate()` for business logic date comparison
- All billing period calculations use `getLocalBillingPeriod(timezone)`
- Autopay charge/notify both use property-local time for due day detection
- Build succeeds: `npm run build` passes
</verification>

<success_criteria>
All existing cron endpoints (rent-reminders, autopay-charge, autopay-notify) retrofitted to use property-local timezone. No UTC-based date comparison remains for business logic. Build passes.
</success_criteria>

<output>
After completion, create `.planning/phases/09-automated-operations/09-04-SUMMARY.md`
</output>
