---
phase: 09-automated-operations
plan: 02
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - src/app/api/cron/late-fees/route.ts
  - src/emails/LateFeeEmail.tsx
  - tests/late-fee-cron.spec.ts
  - tests/late-fee-notification.spec.ts
autonomous: true
requirements: [LATE-01, LATE-03]
must_haves:
  truths:
    - "When a tenant's rent is unpaid after the configured grace period, the system automatically posts a late fee charge to their ledger"
    - "The late fee cron is idempotent — running it multiple times in the same day does not create duplicate late fee charges"
    - "Tenants with pending ACH payments are not assessed late fees"
    - "Tenant receives email, SMS, and in-app notification when a late fee is posted"
    - "Late fees are only assessed for properties with late fees enabled"
  artifacts:
    - path: "src/app/api/cron/late-fees/route.ts"
      provides: "Daily late fee assessment cron endpoint"
      exports: ["POST"]
    - path: "src/emails/LateFeeEmail.tsx"
      provides: "Late fee notification email template"
      exports: ["renderLateFeeEmail"]
  key_links:
    - from: "src/app/api/cron/late-fees/route.ts"
      to: "src/lib/timezone.ts"
      via: "getLocalDate, getLocalBillingPeriod, daysSinceRentDue"
      pattern: "import.*from.*timezone"
    - from: "src/app/api/cron/late-fees/route.ts"
      to: "src/lib/late-fees.ts"
      via: "calculateLateFee"
      pattern: "import.*from.*late-fees"
    - from: "src/app/api/cron/late-fees/route.ts"
      to: "src/lib/notifications.ts"
      via: "sendNotification"
      pattern: "sendNotification"
    - from: "src/app/api/cron/late-fees/route.ts"
      to: "charges table (Phase 8)"
      via: "db.insert(charges) with type 'late_fee'"
      pattern: "insert.*charges"
---

<objective>
Build the late fee assessment cron endpoint and notification

Purpose: Implement the core automated operation — a daily cron job that evaluates each property's late fee rules, checks which tenants have unpaid rent past the grace period (in property-local timezone), posts late fee charges to the ledger, and notifies tenants via all channels.

Output: CRON_SECRET-protected API route at /api/cron/late-fees, late fee email template, and integration test.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-automated-operations/09-RESEARCH.md
@.planning/phases/09-automated-operations/09-01-SUMMARY.md
@src/app/api/cron/rent-reminders/route.ts
@src/app/api/cron/autopay-charge/route.ts
@src/lib/notifications.ts
@src/db/schema/domain.ts
@src/emails/RentReminderEmail.tsx

<interfaces>
<!-- Key types and contracts the executor needs. -->

From src/lib/timezone.ts (created in Plan 01):
```typescript
export function getLocalDate(timezone: string): { year: number; month: number; day: number }
export function getLocalBillingPeriod(timezone: string): string
export function daysSinceRentDue(rentDueDay: number, timezone: string): number
```

From src/lib/late-fees.ts (created in Plan 01):
```typescript
export interface LateFeeRule {
  feeType: "flat" | "percentage"
  feeAmountCents: number
  maxFeeAmountCents: number | null
}
export function calculateLateFee(rentAmountCents: number, rule: LateFeeRule): number
export function formatCentsAsDollars(cents: number): string
```

From src/lib/notifications.ts:
```typescript
export interface NotificationPayload {
  userId: string
  type: "rent_reminder" | "payment_confirmation" | "broadcast" | "maintenance_update" | "system"
  title: string
  body: string
  emailHtml?: string
  channels: ("in_app" | "email" | "sms")[]
}
export async function sendNotification(payload: NotificationPayload): Promise<NotificationRecord>
```

From src/db/schema/domain.ts (lateFeeRules from Plan 01):
```typescript
export const lateFeeRules = pgTable("late_fee_rules", {
  id: uuid("id").primaryKey().defaultRandom(),
  propertyId: uuid("property_id").references(() => properties.id).notNull().unique(),
  enabled: boolean("enabled").default(false).notNull(),
  gracePeriodDays: integer("grace_period_days").notNull().default(5),
  feeType: text("fee_type", { enum: ["flat", "percentage"] }).notNull().default("flat"),
  feeAmountCents: integer("fee_amount_cents").notNull().default(5000),
  maxFeeAmountCents: integer("max_fee_amount_cents"),
  // ...
})
```

NOTE on Phase 8 dependency: The charges table will be created by Phase 8. If Phase 8 is not yet implemented when this plan executes, use the payments table with a note/type field to record late fees, OR create a minimal charges table stub. The executor should check if a charges table exists in the schema. If it does, use it. If not, insert late fee records into the payments table with `note: "Late fee"` and `paymentMethod: "other"` as an interim approach that Phase 8 will migrate.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create late fee email template</name>
  <files>src/emails/LateFeeEmail.tsx</files>
  <action>
  Create `src/emails/LateFeeEmail.tsx` following the pattern in `src/emails/RentReminderEmail.tsx`.

  Props interface:
  ```typescript
  interface LateFeeEmailProps {
    tenantName: string
    unitNumber: string
    feeAmount: string       // formatted like "$50.00"
    rentAmount: string      // formatted like "$1,500.00"
    billingPeriod: string   // "2026-03" format
    gracePeriodDays: number
  }
  ```

  Email content:
  - Subject line (used externally): "Late Fee Posted — Unit {unitNumber}"
  - Greeting: "Hi {tenantName},"
  - Body: "A late fee of {feeAmount} has been posted to your account for Unit {unitNumber}. Your rent of {rentAmount} for {billingPeriod} was not received within the {gracePeriodDays}-day grace period."
  - CTA: "Please log in to your portal to view your updated balance and make a payment."
  - Footer: Standard RentalMgmt footer

  Export a `renderLateFeeEmail` async function that takes the props and returns the HTML string using `render()` from `@react-email/components`.

  Follow the exact same pattern as `renderRentReminderEmail` in `RentReminderEmail.tsx`.
  </action>
  <verify>
    <automated>npx tsx -e "const { renderLateFeeEmail } = require('./src/emails/LateFeeEmail'); renderLateFeeEmail({ tenantName: 'John', unitNumber: '101', feeAmount: '\$50.00', rentAmount: '\$1500.00', billingPeriod: '2026-03', gracePeriodDays: 5 }).then(html => console.log('Email rendered:', html.length, 'chars'))"</automated>
  </verify>
  <done>LateFeeEmail component renders a well-formatted late fee notification email with all required information. renderLateFeeEmail function exported and callable.</done>
</task>

<task type="auto">
  <name>Task 2: Build late fee assessment cron endpoint</name>
  <files>src/app/api/cron/late-fees/route.ts</files>
  <action>
  Create `src/app/api/cron/late-fees/route.ts` following the exact pattern of `src/app/api/cron/rent-reminders/route.ts`.

  **Authentication:** Validate `authorization` header against `Bearer ${process.env.CRON_SECRET}`. Return 401 if invalid.

  **Core logic:**

  1. Query all properties that have late fee rules enabled:
     ```
     SELECT p.id, p.timezone, r.*
     FROM properties p
     INNER JOIN late_fee_rules r ON r.property_id = p.id
     WHERE r.enabled = true
     ```

  2. For each property with enabled late fees:
     a. Get the local date using `getLocalDate(property.timezone)`
     b. Get the local billing period using `getLocalBillingPeriod(property.timezone)`
     c. Query all active tenant-unit links for this property (JOIN tenantUnits + units WHERE units.propertyId = property.id AND tenantUnits.isActive = true)
     d. For each active tenant in the property:
        - Skip if unit has no rentDueDay or rentAmountCents configured
        - Calculate `daysSince = daysSinceRentDue(unit.rentDueDay, property.timezone)`
        - Skip if `daysSince <= rule.gracePeriodDays` (still within grace period)
        - Check if rent is already paid (succeeded) OR pending (ACH settlement) for this billing period — if so, skip
        - **Idempotency check:** Check if a late fee has already been posted for this tenant + unit + billing period. Check for existing charge with type "late_fee" in charges table, OR existing payment with note containing "Late fee" in payments table (depending on whether Phase 8 charges table exists)
        - If not already assessed: calculate fee using `calculateLateFee(unit.rentAmountCents, rule)`
        - Post the late fee charge. **If charges table exists**: insert into charges with type "late_fee". **If charges table does not exist yet**: insert into payments table with `amountCents: feeAmount, paymentMethod: "other", status: "succeeded", note: "Late fee - auto-assessed", billingPeriod: currentPeriod`
        - Send notification via `sendNotification()` with:
          - type: "system"
          - title: "Late Fee Posted — Unit {unitNumber}"
          - body: "A late fee of {feeAmount} has been posted to your account for Unit {unitNumber}. Your rent for {billingPeriod} was not received within the {gracePeriodDays}-day grace period."
          - emailHtml: rendered from LateFeeEmail template
          - channels: ["in_app", "email", "sms"]

  3. Return JSON response: `{ assessed: number, skipped: number, errors: number }`

  **Key safety checks:**
  - Late fees ONLY assessed for properties with `enabled: true`
  - Pending ACH payments count as "paid" (do not assess late fee)
  - Idempotent: same fee never posted twice for same tenant + unit + period
  - Use property-local timezone for ALL date calculations
  - Notification errors should be caught and logged but not prevent the fee from being posted
  </action>
  <verify>
    <automated>npx tsx -e "console.log('Cron endpoint exists:', require('fs').existsSync('./src/app/api/cron/late-fees/route.ts'))"</automated>
  </verify>
  <done>Late fee cron endpoint at /api/cron/late-fees handles POST with CRON_SECRET auth. Evaluates each property's late fee rules using property-local timezone. Posts charges to ledger and sends multi-channel notifications. Idempotent and ACH-aware.</done>
</task>

<task type="auto">
  <name>Task 3: Create late fee cron integration test</name>
  <files>tests/late-fee-cron.spec.ts, tests/late-fee-notification.spec.ts</files>
  <action>
  Create `tests/late-fee-cron.spec.ts` — Playwright integration test for the late fee cron endpoint.

  **Test setup:** Seed test data via a test API endpoint or direct database calls:
  - Create a property with timezone "America/New_York"
  - Create a late fee rule for the property: enabled=true, gracePeriodDays=5, feeType="flat", feeAmountCents=5000
  - Create a unit with rentDueDay and rentAmountCents
  - Create an active tenant-unit link

  **Test cases:**
  1. **Unauthorized request returns 401** — POST without CRON_SECRET header
  2. **Cron endpoint responds with summary JSON** — POST with valid CRON_SECRET, verify response has `assessed`, `skipped`, `errors` fields
  3. **Late fees not assessed when disabled** — Set enabled=false, verify assessed=0

  Create `tests/late-fee-notification.spec.ts` — Test that notifications are created when late fees are posted.

  **Test cases:**
  1. **In-app notification created after late fee** — After cron runs and assesses a fee, check that a notification record exists for the tenant with type "system" and title containing "Late Fee"
  2. **Notification contains correct fee amount** — Verify the notification body includes the formatted fee amount

  NOTE: These tests may need to be adjusted based on whether the dev server is running and whether test data can be seeded. Use the same patterns as existing tests in the project. If full integration testing requires too much setup, create smoke tests that verify the endpoint exists and handles auth correctly, with TODO comments for full integration test setup.
  </action>
  <verify>
    <automated>npx playwright test tests/late-fee-cron.spec.ts tests/late-fee-notification.spec.ts --reporter=line</automated>
  </verify>
  <done>Integration tests verify late fee cron endpoint authentication, response format, and notification creation. Tests pass or have clear TODO markers for test data seeding.</done>
</task>

</tasks>

<verification>
- POST to /api/cron/late-fees without CRON_SECRET returns 401
- POST to /api/cron/late-fees with valid CRON_SECRET returns JSON with assessed/skipped/errors
- Properties with late fees disabled are skipped
- LateFeeEmail template renders correctly with all props
- sendNotification is called with channels ["in_app", "email", "sms"] after fee posting
- Idempotency: running the cron twice does not double-post fees
</verification>

<success_criteria>
Late fee cron endpoint automatically assesses fees for tenants with unpaid rent past grace period. Fees posted to ledger. Tenants notified via in-app, email, and SMS. Endpoint is idempotent and timezone-aware. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/09-automated-operations/09-02-SUMMARY.md`
</output>
