---
phase: 09-automated-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/domain.ts
  - src/lib/timezone.ts
  - src/lib/late-fees.ts
  - tests/timezone-utils.spec.ts
  - src/app/api/test/timezone/route.ts
autonomous: true
requirements: [INFRA-03, LATE-01]
must_haves:
  truths:
    - "Properties table has a timezone column with IANA timezone identifier"
    - "Late fee rules table exists with per-property configuration (grace period, fee type, amount)"
    - "Timezone utility functions correctly compute local date, billing period, and days-since-due for any IANA timezone"
    - "Late fee calculation correctly handles both flat and percentage fee types with optional cap"
  artifacts:
    - path: "src/db/schema/domain.ts"
      provides: "lateFeeRules table schema, timezone column on properties"
      contains: "lateFeeRules"
    - path: "src/lib/timezone.ts"
      provides: "Timezone-aware date utilities"
      exports: ["getLocalDate", "getLocalBillingPeriod", "daysSinceRentDue", "US_TIMEZONES"]
    - path: "src/lib/late-fees.ts"
      provides: "Late fee calculation pure functions"
      exports: ["calculateLateFee", "LateFeeRule"]
  key_links:
    - from: "src/lib/timezone.ts"
      to: "Intl.DateTimeFormat"
      via: "Built-in Node.js API for timezone conversion"
      pattern: "Intl\\.DateTimeFormat"
    - from: "src/db/schema/domain.ts"
      to: "properties"
      via: "lateFeeRules.propertyId references properties.id"
      pattern: "references.*properties\\.id"
---

<objective>
Add timezone and late fee schema + utility foundations

Purpose: Establish the data model and pure utility functions that all subsequent plans depend on — the lateFeeRules table, timezone column on properties, timezone date math utilities, and late fee calculation logic.

Output: Updated schema with migration, timezone utility module, late fee calculation module, and timezone utility tests.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-automated-operations/09-RESEARCH.md
@src/db/schema/domain.ts
@src/db/index.ts

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/db/schema/domain.ts (properties table to extend):
```typescript
export const properties = pgTable("properties", {
  id: uuid("id").primaryKey().defaultRandom(),
  name: text("name").notNull(),
  address: text("address").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
})
```

From src/db/schema/domain.ts (units table — rentDueDay and rentAmountCents used by late fee logic):
```typescript
export const units = pgTable("units", {
  id: uuid("id").primaryKey().defaultRandom(),
  propertyId: uuid("property_id").references(() => properties.id, { onDelete: "cascade" }).notNull(),
  unitNumber: text("unit_number").notNull(),
  rentAmountCents: integer("rent_amount_cents"),
  rentDueDay: integer("rent_due_day"),
  // ...
})
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timezone column and lateFeeRules table to schema</name>
  <files>src/db/schema/domain.ts</files>
  <action>
  1. Add a `timezone` column to the existing `properties` table:
     - `timezone: text("timezone").notNull().default("America/New_York")` — IANA timezone string
     - Place it after the `address` column

  2. Add a new `lateFeeRules` table after the `autopayEnrollments` table:
     ```typescript
     export const lateFeeRules = pgTable("late_fee_rules", {
       id: uuid("id").primaryKey().defaultRandom(),
       propertyId: uuid("property_id")
         .references(() => properties.id, { onDelete: "cascade" })
         .notNull()
         .unique(),  // one rule set per property
       enabled: boolean("enabled").default(false).notNull(),  // MUST default OFF
       gracePeriodDays: integer("grace_period_days").notNull().default(5),
       feeType: text("fee_type", { enum: ["flat", "percentage"] }).notNull().default("flat"),
       feeAmountCents: integer("fee_amount_cents").notNull().default(5000),  // $50 flat OR 500 = 5% for percentage
       maxFeeAmountCents: integer("max_fee_amount_cents"),  // optional cap for percentage fees
       createdAt: timestamp("created_at").defaultNow().notNull(),
       updatedAt: timestamp("updated_at").defaultNow().notNull(),
     })
     ```

  3. Add a section comment: `// ==================== Phase 9: Automated Operations ====================`

  4. Run `npm run db:push` to apply schema changes to the database.

  IMPORTANT: `enabled` MUST default to `false`. Late fees are OFF until admin explicitly enables them.
  </action>
  <verify>
    <automated>npm run db:push 2>&1 | tail -5</automated>
  </verify>
  <done>Properties table has timezone column defaulting to "America/New_York". lateFeeRules table exists with enabled defaulting to false, one rule per property (unique propertyId), grace period, fee type, amount, and optional max fee. Schema pushed to database.</done>
</task>

<task type="auto">
  <name>Task 2: Create timezone utility module and late fee calculation module</name>
  <files>src/lib/timezone.ts, src/lib/late-fees.ts</files>
  <action>
  **Create `src/lib/timezone.ts`:**

  1. `getLocalDate(timezone: string): { year: number; month: number; day: number }` — Uses `Intl.DateTimeFormat` with the given IANA timezone to get the current local date parts. Uses `formatToParts()` to extract year, month, day as numbers.

  2. `getLocalBillingPeriod(timezone: string): string` — Returns "YYYY-MM" string for the current billing period in the property's local timezone. Uses `getLocalDate` internally.

  3. `daysSinceRentDue(rentDueDay: number, timezone: string): number` — Calculates days elapsed since rent was due. Returns 0 on due day, positive after, negative before. Handle month boundary: if `rentDueDay` > current day, rent is not yet due this month (return negative). This is a simplified calculation — late fees only apply within the same month.

  4. `US_TIMEZONES` — Array of `{ value: string; label: string }` objects for US timezone dropdown:
     - America/New_York → Eastern Time (ET)
     - America/Chicago → Central Time (CT)
     - America/Denver → Mountain Time (MT)
     - America/Los_Angeles → Pacific Time (PT)
     - America/Anchorage → Alaska Time (AKT)
     - Pacific/Honolulu → Hawaii Time (HT)

  **Create `src/lib/late-fees.ts`:**

  1. Export `LateFeeRule` interface:
     ```typescript
     export interface LateFeeRule {
       feeType: "flat" | "percentage"
       feeAmountCents: number
       maxFeeAmountCents: number | null
     }
     ```

  2. `calculateLateFee(rentAmountCents: number, rule: LateFeeRule): number` — Pure function:
     - If `feeType === "flat"`: return `rule.feeAmountCents`
     - If `feeType === "percentage"`: calculate `Math.round(rentAmountCents * rule.feeAmountCents / 10000)` (feeAmountCents stores basis points, e.g., 500 = 5%). If `maxFeeAmountCents` is set, cap at that value using `Math.min`.
     - Always return an integer (cents).

  3. `formatCentsAsDollars(cents: number): string` — Returns "$X.XX" formatted string.

  Use NO external date libraries. All timezone logic uses built-in `Intl.DateTimeFormat`.
  </action>
  <verify>
    <automated>npx tsx -e "const { getLocalDate, getLocalBillingPeriod, US_TIMEZONES } = require('./src/lib/timezone'); console.log('NY:', getLocalDate('America/New_York')); console.log('LA:', getLocalDate('America/Los_Angeles')); console.log('Period:', getLocalBillingPeriod('America/New_York')); console.log('TZ count:', US_TIMEZONES.length); const { calculateLateFee } = require('./src/lib/late-fees'); console.log('Flat $50:', calculateLateFee(150000, { feeType: 'flat', feeAmountCents: 5000, maxFeeAmountCents: null })); console.log('5% of $1500:', calculateLateFee(150000, { feeType: 'percentage', feeAmountCents: 500, maxFeeAmountCents: null })); console.log('5% capped at $50:', calculateLateFee(150000, { feeType: 'percentage', feeAmountCents: 500, maxFeeAmountCents: 5000 }));"</automated>
  </verify>
  <done>timezone.ts exports getLocalDate, getLocalBillingPeriod, daysSinceRentDue, and US_TIMEZONES. late-fees.ts exports LateFeeRule interface, calculateLateFee (handles flat and percentage with cap), and formatCentsAsDollars. All functions are pure with no external dependencies.</done>
</task>

<task type="auto">
  <name>Task 3: Create timezone and late fee utility tests</name>
  <files>tests/timezone-utils.spec.ts</files>
  <action>
  Create a Playwright test file `tests/timezone-utils.spec.ts` that validates the timezone and late fee utility functions. Since these are pure functions, test them via a lightweight API endpoint or inline script execution.

  Create a test API endpoint `src/app/api/test/timezone/route.ts` (only in dev) that exercises the utility functions:
  - GET returns JSON with results from getLocalDate, daysSinceRentDue, and calculateLateFee for various inputs

  Tests to write:
  1. **getLocalDate returns different dates across timezones** — Call with "America/New_York" and "Pacific/Honolulu" and verify both return valid date objects with year, month (1-12), day (1-31)
  2. **getLocalBillingPeriod returns YYYY-MM format** — Verify format matches /^\d{4}-\d{2}$/
  3. **daysSinceRentDue returns correct values** — Test with known rentDueDay values relative to current date
  4. **calculateLateFee flat fee** — Input: 150000 cents rent, flat $50 fee → output: 5000
  5. **calculateLateFee percentage** — Input: 150000 cents rent, 5% fee → output: 7500
  6. **calculateLateFee percentage with cap** — Input: 150000 cents rent, 10% fee, max $100 → output: 10000 (capped)
  7. **US_TIMEZONES has 6 entries** — Verify all US timezone options present

  Use the test API endpoint to run the pure functions server-side and return results as JSON. The Playwright test calls the endpoint and asserts on the JSON response.

  IMPORTANT: Guard the test endpoint with `process.env.NODE_ENV !== "production"` check. In production, return 404.
  </action>
  <verify>
    <automated>npx playwright test tests/timezone-utils.spec.ts --reporter=line</automated>
  </verify>
  <done>Playwright test file validates timezone utilities and late fee calculation functions. All tests pass. Test API endpoint is dev-only and returns 404 in production.</done>
</task>

</tasks>

<verification>
- `properties` table has `timezone` column with default "America/New_York"
- `late_fee_rules` table exists with all required columns, `enabled` defaults to `false`
- `getLocalDate("America/New_York")` returns valid date parts
- `calculateLateFee(150000, { feeType: "flat", feeAmountCents: 5000, maxFeeAmountCents: null })` returns 5000
- `calculateLateFee(150000, { feeType: "percentage", feeAmountCents: 500, maxFeeAmountCents: null })` returns 7500
- All timezone utility tests pass
</verification>

<success_criteria>
Schema extended with timezone and late fee rules. Pure utility functions created and tested. No external date libraries added. Late fees default to OFF.
</success_criteria>

<output>
After completion, create `.planning/phases/09-automated-operations/09-01-SUMMARY.md`
</output>
