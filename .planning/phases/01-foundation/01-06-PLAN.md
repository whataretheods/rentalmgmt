---
phase: 01-foundation
plan: 06
type: execute
wave: 5
depends_on:
  - 01-05
files_modified: []
autonomous: false

requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-05

must_haves:
  truths:
    - "A tenant can create an account with email and password and land on their portal"
    - "A logged-in user's session persists across browser refresh and tab close/reopen"
    - "A user who forgot their password can reset it via an emailed link and regain access"
    - "Multiple admin users can each log in to the admin portal and see the same data with full access"
    - "Accessing any tenant or admin route while unauthenticated redirects to the login page"
  artifacts:
    - path: "middleware.ts"
      provides: "Route protection — unauthenticated redirect"
    - path: "src/app/(admin)/layout.tsx"
      provides: "Admin role enforcement"
    - path: "src/app/(tenant)/layout.tsx"
      provides: "Tenant session guard"
  key_links:
    - from: "/auth/register"
      to: "/tenant/dashboard"
      via: "POST /api/auth/sign-up/email → session cookie → redirect"
      pattern: "signUp.email"
    - from: "/auth/login"
      to: "/tenant/dashboard or /admin/dashboard"
      via: "POST /api/auth/sign-in/email → session cookie → redirect"
      pattern: "signIn.email"
---

<objective>
Human verification of the complete Phase 1 auth flow. All automated implementation is done — this plan confirms that the full end-to-end behavior works correctly in the browser before marking Phase 1 complete.

Purpose: Automated builds verify TypeScript compiles. This checkpoint verifies the actual user experience works: cookies set, redirects fire, role enforcement holds, password reset email arrives. These cannot be fully automated.

Output: Confirmed working auth foundation before Phase 2 begins.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-foundation/01-05-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action">
  <name>Task 1: Configure environment and run seed scripts</name>
  <what-to-do>
Before any browser testing is possible, the environment must be configured and the database seeded.

Step 1 — Fill in .env.local with real values:
```
DATABASE_URL=        # Paste your Neon connection string here
BETTER_AUTH_SECRET=  # Run: openssl rand -base64 32
BETTER_AUTH_URL=http://localhost:3000
RESEND_API_KEY=      # From https://resend.com/api-keys
ADMIN_EMAIL=         # Email for your admin account
ADMIN_PASSWORD=      # Strong password for your admin account
```

Step 2 — Apply database migrations (if not already done in Plan 02):
```bash
cd /Users/odesantos/Documents/rentalmgmt
npm run db:migrate
```

Step 3 — Seed the property and admin user:
```bash
npm run seed:property
npm run seed:admin
```

You should see output like:
- "Property created: Rental Property (id: ...)"
- "5 units created: 1A, 1B, 2A, 2B, 3A"
- "Admin user created successfully: Email: your@email.com Role: admin"
  </what-to-do>
  <resume-signal>Type "seeded" when the seed scripts complete successfully, or describe any errors</resume-signal>
</task>

<task type="checkpoint:human-verify">
  <name>Task 2: Verify complete auth flow end to end</name>
  <what-built>
Complete authentication system: tenant registration, login, session persistence, password reset, admin login with role enforcement, and route protection.
  </what-built>
  <how-to-verify>
Start the dev server: `npm run dev` (runs at http://localhost:3000)

Test 1 — Unauthenticated redirect (AUTH success criteria #5):
1. Visit http://localhost:3000/tenant/dashboard while not logged in
2. Expected: Redirected to http://localhost:3000/auth/login
3. Visit http://localhost:3000/admin/dashboard while not logged in
4. Expected: Redirected to http://localhost:3000/auth/login

Test 2 — Tenant registration (AUTH-01):
1. Visit http://localhost:3000/auth/register
2. Fill in name, email, password (8+ chars), confirm password — click "Create account"
3. Expected: Redirected to /tenant/dashboard showing "Welcome to your tenant portal"
4. Verify your email appears in the header

Test 3 — Session persistence (AUTH-02):
1. While logged in at /tenant/dashboard, press F5 (hard refresh)
2. Expected: Stay on /tenant/dashboard — NOT redirected to login
3. Close the browser tab, reopen and navigate to http://localhost:3000/tenant/dashboard
4. Expected: Still logged in — stay on dashboard (7-day session)

Test 4 — Admin login (AUTH-05):
1. Sign out first (or open a private/incognito window)
2. Visit http://localhost:3000/auth/login
3. Sign in with ADMIN_EMAIL and ADMIN_PASSWORD from .env.local
4. Expected: Redirected to /tenant/dashboard (middleware sends to tenant by default)
5. Manually navigate to http://localhost:3000/admin/dashboard
6. Expected: Admin portal loads — shows "Admin Portal" header
7. Navigate to http://localhost:3000/admin/users
8. Expected: User table shows the admin account and the tenant test account

Test 5 — Role enforcement:
1. While logged in as the TENANT user (not admin):
2. Navigate to http://localhost:3000/admin/dashboard
3. Expected: Redirected to /tenant/dashboard (not a 404, not shown admin content)

Test 6 — Password reset (AUTH-03):
1. Sign out
2. Visit http://localhost:3000/auth/forgot-password
3. Enter the tenant test email — click "Send reset link"
4. Expected: Success message appears (does not confirm or deny email exists)
5. Check the inbox for the test email — should receive "Reset your password" email from RentalMgmt
6. Click the reset link in the email
7. Expected: Lands on /auth/reset-password?token=... — shows "Set new password" form
8. Enter and confirm a new password — click "Reset password"
9. Expected: Toast "Password reset successfully" — redirected to /auth/login
10. Sign in with the new password
11. Expected: Successful login — lands on /tenant/dashboard
  </how-to-verify>
  <resume-signal>Type "approved" if all 6 tests pass. Otherwise describe which tests failed and what happened.</resume-signal>
</task>

</tasks>

<verification>
Phase 1 is complete when:
- All 6 test scenarios pass (unauthenticated redirect, registration, session persistence, admin login, role enforcement, password reset)
- No JavaScript console errors during normal auth flows
- Password reset email is received and the reset link works
</verification>

<success_criteria>
Phase 1 Foundation is complete when an observer using the running app can confirm:
1. Unauthenticated access to /tenant/* and /admin/* redirects to /auth/login
2. New tenant accounts can be created via /auth/register with email + password
3. Sessions survive browser refresh and tab close/reopen
4. Admin user can log in and access /admin/dashboard and /admin/users
5. Tenant user is blocked from /admin/* and redirected to /tenant/dashboard
6. Password reset flow works end-to-end: request link → email arrives → reset form → sign in with new password
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-06-SUMMARY.md`
</output>
