---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - src/lib/auth.ts
  - src/lib/auth-client.ts
  - src/lib/resend.ts
  - src/app/api/auth/[...all]/route.ts
  - src/db/schema/auth.ts
  - src/db/schema/index.ts
  - drizzle/
autonomous: true
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-05

must_haves:
  truths:
    - "Better Auth schema tables (user, session, account, verification) exist in the database"
    - "POST /api/auth/sign-in/email returns a session cookie on valid credentials"
    - "POST /api/auth/sign-up/email creates a user with role 'user' by default"
    - "Password reset sends an email via Resend when requested"
    - "Admin role can be assigned server-side; admin plugin is active"
    - "smsOptIn and smsOptInAt fields are on the user table via additionalFields"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "Better Auth server-side config with emailAndPassword, admin plugin, nextCookies, additionalFields"
      exports: ["auth"]
    - path: "src/lib/auth-client.ts"
      provides: "Better Auth browser client with adminClient plugin"
      exports: ["authClient"]
    - path: "src/lib/resend.ts"
      provides: "Resend client instance"
      exports: ["resend"]
    - path: "src/app/api/auth/[...all]/route.ts"
      provides: "Better Auth catch-all HTTP handler"
      exports: ["GET", "POST"]
    - path: "src/db/schema/auth.ts"
      provides: "CLI-generated Better Auth tables (user, session, account, verification)"
    - path: "drizzle/"
      provides: "Migration SQL files from drizzle-kit generate + migrate"
  key_links:
    - from: "src/lib/auth.ts"
      to: "src/db/index.ts"
      via: "drizzleAdapter(db, { provider: 'pg', schema })"
      pattern: "drizzleAdapter"
    - from: "src/app/api/auth/[...all]/route.ts"
      to: "src/lib/auth.ts"
      via: "toNextJsHandler(auth)"
      pattern: "toNextJsHandler"
    - from: "src/db/schema/index.ts"
      to: "src/db/schema/auth.ts"
      via: "export * from './auth'"
      pattern: "export.*auth"
---

<objective>
Configure Better Auth with email/password auth, the admin plugin, password reset via Resend, and the nextCookies plugin. Generate the Better Auth schema via CLI, define the full schema barrel export, and run Drizzle migrations to apply all tables to Neon. After this plan, the auth API is live and sessions can be created.

Purpose: This is the auth engine. Plan 03 (middleware) and Plan 04 (auth UI) both depend on auth.ts and auth-client.ts existing with correct exports. The database migrations must run here so later plans can create users and sessions.

Output: src/lib/auth.ts, src/lib/auth-client.ts, src/app/api/auth/[...all]/route.ts, CLI-generated src/db/schema/auth.ts, and applied Neon migrations.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

<interfaces>
<!-- Key types and exports from Plan 01 that this plan builds on -->

From src/db/index.ts:
```typescript
export const db: DrizzleDb  // Neon HTTP Drizzle client
export type DB = typeof db
```

From src/db/schema/domain.ts:
```typescript
export const properties: PgTable
export const units: PgTable
export const tenantUnits: PgTable
// Note: tenantUnits.userId is text(), not uuid()
```

From src/db/schema/index.ts (current state — auth export is commented out):
```typescript
// export * from "./auth"   // ← uncomment this in Task 1
export * from "./domain"
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate Better Auth schema and run database migrations</name>
  <files>
    src/db/schema/auth.ts
    src/db/schema/index.ts
    drizzle/
  </files>
  <action>
Step 1 — Configure the Better Auth CLI to output to the correct path. Create a temporary auth config skeleton that the CLI can read. The CLI needs to find your auth config to know which plugins you're using and therefore which tables to generate.

First, create src/lib/auth.ts with just enough config for the CLI to parse (full config comes in Task 2, but the CLI needs the file to exist):
```typescript
// Temporary skeleton for CLI schema generation — will be replaced in Task 2
import { betterAuth } from "better-auth"
import { drizzleAdapter } from "better-auth/adapters/drizzle"
import { admin, nextCookies } from "better-auth/plugins"
import { db } from "@/db"
import * as schema from "@/db/schema"

export const auth = betterAuth({
  database: drizzleAdapter(db, {
    provider: "pg",
    schema,
  }),
  emailAndPassword: { enabled: true },
  plugins: [
    admin({ defaultRole: "user", adminRoles: ["admin"] }),
    nextCookies(),
  ],
  user: {
    additionalFields: {
      smsOptIn: { type: "boolean", required: false, defaultValue: false, input: false },
      smsOptInAt: { type: "string", required: false, defaultValue: null, input: false },
    },
  },
})
```

Step 2 — Run the Better Auth CLI to generate the auth schema:
```bash
cd /Users/odesantos/Documents/rentalmgmt && npx @better-auth/cli@latest generate --output src/db/schema/auth.ts
```

This generates src/db/schema/auth.ts containing the user, session, account, and verification tables. The CLI reads your auth.ts config and generates the correct columns including the `role` field from the admin plugin and `smsOptIn`/`smsOptInAt` from additionalFields.

IMPORTANT: Do NOT manually edit the generated auth.ts file. It is owned by the CLI.

Step 3 — Update src/db/schema/index.ts to uncomment the auth export:
```typescript
export * from "./auth"    // Better Auth generated tables (user, session, account, verification)
export * from "./domain"  // Property, Unit, TenantUnit
```

Step 4 — Generate Drizzle migration files:
```bash
cd /Users/odesantos/Documents/rentalmgmt && npx drizzle-kit generate
```

This creates SQL files in ./drizzle/ covering both the auth tables and domain tables.

Step 5 — Apply migrations to Neon:
```bash
cd /Users/odesantos/Documents/rentalmgmt && npx drizzle-kit migrate
```

PREREQUISITE: DATABASE_URL in .env.local must be set to a valid Neon connection string before running this step. If DATABASE_URL is not set, migrations will fail with a connection error — this is expected and means the developer needs to configure Neon first (see user_setup below).

If drizzle-kit migrate succeeds, all tables now exist in Neon.

For development without a live DATABASE_URL, use push instead:
```bash
npx drizzle-kit push
```
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && ls src/db/schema/auth.ts && grep -c "pgTable" src/db/schema/auth.ts</automated>
  </verify>
  <done>
    src/db/schema/auth.ts exists and contains multiple pgTable definitions (user, session, account, verification at minimum). src/db/schema/index.ts exports both auth and domain tables. drizzle/ directory contains generated .sql migration files. Neon database has all tables applied (if DATABASE_URL was configured).
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Better Auth server instance, Resend client, auth-client, and API route</name>
  <files>
    src/lib/auth.ts
    src/lib/auth-client.ts
    src/lib/resend.ts
    src/app/api/auth/[...all]/route.ts
  </files>
  <action>
Replace the temporary auth.ts skeleton from Task 1 with the complete production config.

Create src/lib/resend.ts — Resend client singleton:
```typescript
import { Resend } from "resend"

export const resend = new Resend(process.env.RESEND_API_KEY)
```

Create src/lib/auth.ts — full Better Auth server config:
```typescript
import { betterAuth } from "better-auth"
import { drizzleAdapter } from "better-auth/adapters/drizzle"
import { admin, nextCookies } from "better-auth/plugins"
import { db } from "@/db"
import * as schema from "@/db/schema"
import { resend } from "@/lib/resend"

export const auth = betterAuth({
  database: drizzleAdapter(db, {
    provider: "pg",
    schema,
  }),
  emailAndPassword: {
    enabled: true,
    minPasswordLength: 8,
    sendResetPassword: async ({ user, url }) => {
      // Do NOT await — Better Auth docs warn against awaiting to prevent timing attacks
      void resend.emails.send({
        from: "RentalMgmt <noreply@rentalmgmt.com>",
        to: user.email,
        subject: "Reset your password",
        html: `<p>Reset your password: <a href="${url}">${url}</a></p><p>This link expires in 1 hour.</p>`,
      })
    },
    resetPasswordTokenExpiresIn: 3600, // 1 hour in seconds
  },
  plugins: [
    admin({
      defaultRole: "user",     // all new sign-ups get "user" (tenant) role
      adminRoles: ["admin"],   // "admin" role grants admin portal access
    }),
    nextCookies(),             // REQUIRED: without this, Server Actions cannot set auth cookies
  ],
  user: {
    additionalFields: {
      smsOptIn: {
        type: "boolean",
        required: false,
        defaultValue: false,
        input: false,          // cannot be set by user at signup
      },
      smsOptInAt: {
        type: "string",        // ISO timestamp string
        required: false,
        defaultValue: null,
        input: false,
      },
    },
  },
})

export type Session = typeof auth.$Infer.Session
export type User = typeof auth.$Infer.Session.user
```

Create src/lib/auth-client.ts — browser-side auth client for Client Components:
```typescript
import { createAuthClient } from "better-auth/react"
import { adminClient } from "better-auth/client/plugins"

export const authClient = createAuthClient({
  plugins: [adminClient()],
})

// Convenience re-exports for common operations
export const { signIn, signUp, signOut, useSession, forgetPassword, resetPassword } = authClient
```

Create src/app/api/auth/[...all]/route.ts — Better Auth catch-all handler:
```typescript
import { auth } from "@/lib/auth"
import { toNextJsHandler } from "better-auth/next-js"

export const { GET, POST } = toNextJsHandler(auth)
```

Note: This single file handles ALL auth HTTP traffic — sign-in, sign-up, sign-out, password reset request, password reset confirmation, session refresh. Do not add any custom logic here; Better Auth handles all routing internally.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | grep -E "error|Error|compiled" | head -20</automated>
  </verify>
  <done>
    npm run build compiles without TypeScript errors. src/lib/auth.ts exports auth with drizzleAdapter, emailAndPassword with sendResetPassword, admin plugin, nextCookies plugin, and additionalFields for smsOptIn/smsOptInAt. src/lib/auth-client.ts exports authClient with adminClient plugin. src/lib/resend.ts exports resend instance. src/app/api/auth/[...all]/route.ts exports GET and POST via toNextJsHandler.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes with zero TypeScript errors
2. `ls src/db/schema/auth.ts` — file exists
3. `grep "export" src/db/schema/index.ts` — shows both `export * from "./auth"` and `export * from "./domain"`
4. `ls drizzle/*.sql 2>/dev/null` — migration SQL files exist
5. `grep "nextCookies" src/lib/auth.ts` — present (required for Server Actions)
6. `grep "additionalFields" src/lib/auth.ts` — present (smsOptIn/smsOptInAt for Phase 5)
7. `grep "toNextJsHandler" src/app/api/auth/\[...all\]/route.ts` — present
</verification>

<success_criteria>
- Better Auth schema tables generated by CLI into src/db/schema/auth.ts
- Drizzle migrations applied to Neon (or generated if DATABASE_URL not yet configured)
- src/lib/auth.ts has full config: emailAndPassword, password reset wired to Resend, admin plugin, nextCookies, smsOptIn additionalFields
- src/lib/auth-client.ts exports authClient with adminClient plugin
- API route at /api/auth/[...all] wired to Better Auth handler
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
