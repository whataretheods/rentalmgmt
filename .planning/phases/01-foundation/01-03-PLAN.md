---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on:
  - 01-02
files_modified:
  - middleware.ts
  - src/app/(tenant)/layout.tsx
  - src/app/(tenant)/dashboard/page.tsx
  - src/app/(admin)/layout.tsx
  - src/app/(admin)/dashboard/page.tsx
autonomous: true
requirements:
  - AUTH-02
  - AUTH-05

must_haves:
  truths:
    - "Unauthenticated requests to /tenant/* redirect to /auth/login"
    - "Unauthenticated requests to /admin/* redirect to /auth/login"
    - "Authenticated non-admin users accessing /admin/* are redirected to /tenant/dashboard"
    - "Authenticated admin users can access /admin/dashboard"
    - "Authenticated tenant users can access /tenant/dashboard"
    - "Session persists across browser refresh (cookie-based, set by Better Auth)"
  artifacts:
    - path: "middleware.ts"
      provides: "Edge-safe cookie existence check — redirects unauthenticated users to /auth/login"
    - path: "src/app/(tenant)/layout.tsx"
      provides: "Tenant layout — full server-side session validation, redirects if no session"
    - path: "src/app/(admin)/layout.tsx"
      provides: "Admin layout — full server-side session + role === 'admin' check, redirects if not admin"
    - path: "src/app/(tenant)/dashboard/page.tsx"
      provides: "Tenant dashboard placeholder — confirms routing works"
    - path: "src/app/(admin)/dashboard/page.tsx"
      provides: "Admin dashboard placeholder — confirms admin access works"
  key_links:
    - from: "middleware.ts"
      to: "better-auth/cookies"
      via: "getSessionCookie(request) — Edge-safe, cookie existence only"
      pattern: "getSessionCookie"
    - from: "src/app/(admin)/layout.tsx"
      to: "src/lib/auth.ts"
      via: "auth.api.getSession({ headers: await headers() }) — full validation with role check"
      pattern: "getSession"
    - from: "src/app/(tenant)/layout.tsx"
      to: "src/lib/auth.ts"
      via: "auth.api.getSession({ headers: await headers() }) — full validation"
      pattern: "getSession"
---

<objective>
Implement route protection across the entire application: middleware for fast cookie-existence checks, and full server-side session validation with role enforcement in each route group layout. After this plan, unauthenticated and unauthorized access to protected routes is impossible.

Purpose: AUTH-02 (session persistence) requires sessions survive refresh — the layouts verify this server-side on every request. AUTH-05 (admin role enforcement) requires the admin layout reject non-admin users. This plan creates both.

Output: middleware.ts, (tenant)/layout.tsx with session guard, (admin)/layout.tsx with session + role guard, and placeholder dashboard pages in each route group.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

<interfaces>
<!-- Key exports from Plan 02 that this plan uses -->

From src/lib/auth.ts:
```typescript
export const auth: BetterAuth  // server-side auth instance

// Session retrieval in Server Components / Layouts:
const session = await auth.api.getSession({ headers: await headers() })
// session is null if not authenticated
// session.user.role === "admin" for admin users
// session.user.role === "user" for tenant users
```

From better-auth/cookies (Edge-safe — for middleware ONLY):
```typescript
import { getSessionCookie } from "better-auth/cookies"
// const sessionCookie = getSessionCookie(request)
// Returns cookie value string if present, null/undefined if not
// Does NOT validate session — only confirms cookie exists
// Use auth.api.getSession() in layouts for real validation
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create middleware for Edge-safe route protection</name>
  <files>
    middleware.ts
  </files>
  <action>
Create middleware.ts at the project root (NOT inside src/). This must be at the project root for Next.js to pick it up.

CRITICAL runtime decision: Use the default Edge runtime with getSessionCookie() (cookie existence check only). Do NOT call auth.api.getSession() in middleware — this requires Node.js APIs and will throw on Edge runtime. Full session validation (including role checks) is handled in each layout.

```typescript
// middleware.ts (project root — NOT src/middleware.ts)
import { NextRequest, NextResponse } from "next/server"
import { getSessionCookie } from "better-auth/cookies"

export async function middleware(request: NextRequest) {
  const sessionCookie = getSessionCookie(request)
  const { pathname } = request.nextUrl

  // Redirect unauthenticated users away from protected routes
  if (!sessionCookie) {
    const isProtectedRoute =
      pathname.startsWith("/tenant") ||
      pathname.startsWith("/admin")

    if (isProtectedRoute) {
      const loginUrl = new URL("/auth/login", request.url)
      loginUrl.searchParams.set("callbackUrl", pathname)
      return NextResponse.redirect(loginUrl)
    }
  }

  // Authenticated users visiting /auth/login or /auth/register → redirect to their dashboard
  // (prevents re-login when already logged in)
  if (sessionCookie) {
    if (pathname === "/auth/login" || pathname === "/auth/register") {
      // Can't check role here (Edge runtime) — redirect to tenant by default
      // The tenant layout handles further routing if needed
      return NextResponse.redirect(new URL("/tenant/dashboard", request.url))
    }
  }

  return NextResponse.next()
}

export const config = {
  // Match all routes except API auth routes, Next.js internals, and static files
  matcher: [
    "/((?!api/auth|_next/static|_next/image|favicon.ico).*)",
  ],
}
```
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | grep -E "error TS|compiled" | head -10</automated>
  </verify>
  <done>
    middleware.ts exists at project root. Build passes. File imports getSessionCookie from better-auth/cookies (NOT auth.api.getSession — that would fail on Edge). Matcher excludes /api/auth/* routes so Better Auth's own endpoints are never intercepted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create route group layouts with full server-side session validation</name>
  <files>
    src/app/(tenant)/layout.tsx
    src/app/(tenant)/dashboard/page.tsx
    src/app/(admin)/layout.tsx
    src/app/(admin)/dashboard/page.tsx
  </files>
  <action>
IMPORTANT: Route groups use parentheses in folder names: (tenant) and (admin). These folders do NOT appear in the URL path — they only affect layout grouping. The actual routes are /tenant/dashboard and /admin/dashboard (without parentheses in the URL).

Create src/app/(tenant)/layout.tsx — full session validation (Node.js runtime, not Edge):
```typescript
import { auth } from "@/lib/auth"
import { headers } from "next/headers"
import { redirect } from "next/navigation"

export default async function TenantLayout({
  children,
}: {
  children: React.ReactNode
}) {
  // Full server-side session validation — not just cookie existence
  // This runs in Node.js runtime (Server Component), not Edge
  const session = await auth.api.getSession({ headers: await headers() })

  if (!session) {
    redirect("/auth/login")
  }

  // Tenants have role "user" — admins should use the admin portal
  // If an admin navigates to /tenant/dashboard, let them in (they have a session)
  // The admin layout enforces admin-only access for /admin/* routes

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white border-b px-6 py-4 flex items-center justify-between">
        <span className="font-semibold text-gray-900">Tenant Portal</span>
        <span className="text-sm text-gray-500">{session.user.email}</span>
      </header>
      <main className="container mx-auto px-6 py-8">
        {children}
      </main>
    </div>
  )
}
```

Create src/app/(tenant)/dashboard/page.tsx — placeholder (Phase 2 fills this out):
```typescript
export default function TenantDashboard() {
  return (
    <div>
      <h1 className="text-2xl font-bold text-gray-900">Dashboard</h1>
      <p className="mt-2 text-gray-600">
        Welcome to your tenant portal. Your dashboard is coming in Phase 2.
      </p>
    </div>
  )
}
```

Create src/app/(admin)/layout.tsx — full session + role validation:
```typescript
import { auth } from "@/lib/auth"
import { headers } from "next/headers"
import { redirect } from "next/navigation"

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode
}) {
  // Full server-side session validation — catches expired/invalidated sessions
  const session = await auth.api.getSession({ headers: await headers() })

  // Not authenticated → login
  if (!session) {
    redirect("/auth/login")
  }

  // Authenticated but not admin → tenant dashboard
  // CRITICAL: check role from session, never from client-passed params
  if (session.user.role !== "admin") {
    redirect("/tenant/dashboard")
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white border-b px-6 py-4 flex items-center justify-between">
        <span className="font-semibold text-gray-900">Admin Portal</span>
        <span className="text-sm text-gray-500">{session.user.email}</span>
      </header>
      <main className="container mx-auto px-6 py-8">
        {children}
      </main>
    </div>
  )
}
```

Create src/app/(admin)/dashboard/page.tsx — barebones admin landing (Phase 3 adds the payment dashboard):
```typescript
export default function AdminDashboard() {
  return (
    <div>
      <h1 className="text-2xl font-bold text-gray-900">Admin Dashboard</h1>
      <p className="mt-2 text-gray-600">
        Admin portal is active. Payment dashboard and tenant management arrive in Phase 3.
      </p>
    </div>
  )
}
```
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | grep -E "error TS|compiled successfully" | head -10</automated>
  </verify>
  <done>
    Both route group directories exist: src/app/(tenant)/ and src/app/(admin)/. Both layouts use auth.api.getSession() (NOT getSessionCookie) — full validation. Admin layout checks session.user.role === "admin" and redirects non-admins. Both dashboard page.tsx files exist as placeholders. Build passes with no TypeScript errors.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes — no TypeScript errors
2. `ls middleware.ts` — exists at project root
3. `grep "getSessionCookie" middleware.ts` — middleware uses cookie-only check (Edge-safe)
4. `grep "getSession" src/app/\(admin\)/layout.tsx` — admin layout uses full session check
5. `grep "role.*admin" src/app/\(admin\)/layout.tsx` — admin layout checks role
6. `ls src/app/\(tenant\)/dashboard/page.tsx src/app/\(admin\)/dashboard/page.tsx` — both exist
</verification>

<success_criteria>
- Middleware redirects unauthenticated requests to protected routes to /auth/login
- Middleware does NOT call auth.api.getSession (would break Edge runtime)
- (tenant)/layout.tsx validates full session server-side
- (admin)/layout.tsx validates session AND role === "admin"
- Both dashboard placeholder pages exist
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
