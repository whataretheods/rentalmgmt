---
phase: 03-payments
plan: 06
type: execute
wave: 4
depends_on: [02, 04, 05]
files_modified:
  - e2e/payments.spec.ts
  - e2e/admin-payments.spec.ts
  - scripts/seed-payment-test.ts
  - package.json
autonomous: false
requirements:
  - PAY-01
  - PAY-02
  - PAY-03
  - PAY-04
  - PAY-05
  - NOTIF-02

must_haves:
  truths:
    - "Playwright is installed and configured"
    - "E2E test confirms admin can configure rent for a unit"
    - "E2E test confirms tenant dashboard shows payment summary (rent amount, due date)"
    - "E2E test confirms tenant can click Pay Rent and be redirected to Stripe Checkout"
    - "E2E test confirms admin payment dashboard shows unit payment status"
    - "E2E test confirms tenant can view payment history page"
    - "All automated E2E tests pass"
  artifacts:
    - path: "e2e/payments.spec.ts"
      provides: "Playwright tests for tenant payment flows (PAY-01, PAY-02, PAY-03)"
    - path: "e2e/admin-payments.spec.ts"
      provides: "Playwright tests for admin payment flows (PAY-04, PAY-05)"
    - path: "scripts/seed-payment-test.ts"
      provides: "Seed script creating test payment data for E2E verification"
    - path: "playwright.config.ts"
      provides: "Playwright configuration"
  key_links:
    - from: "e2e/payments.spec.ts"
      to: "src/app/(tenant)/tenant/dashboard/page.tsx"
      via: "Navigates to tenant dashboard and verifies payment summary content"
      pattern: "tenant/dashboard"
    - from: "e2e/admin-payments.spec.ts"
      to: "src/app/(admin)/admin/payments/page.tsx"
      via: "Navigates to admin payments page and verifies status table"
      pattern: "admin/payments"
---

<objective>
Install Playwright, create E2E tests verifying the complete payment flow from both tenant and admin perspectives, and perform human verification of the Stripe Checkout redirect.

Purpose: This is the final verification plan ensuring all Phase 3 success criteria are met. Automated tests cover admin rent configuration, tenant dashboard, payment history, and admin payment dashboard. Manual verification covers the Stripe Checkout redirect (external domain).

Output: Playwright test suite, seed script for test data, human verification of Stripe integration.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-payments/03-RESEARCH.md
@.planning/phases/03-payments/03-02-SUMMARY.md
@.planning/phases/03-payments/03-04-SUMMARY.md
@.planning/phases/03-payments/03-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Playwright, create config, seed script, and E2E tests</name>
  <files>
    package.json
    playwright.config.ts
    scripts/seed-payment-test.ts
    e2e/payments.spec.ts
    e2e/admin-payments.spec.ts
  </files>
  <action>
Step 1 — Install Playwright:
```bash
cd /Users/odesantos/Documents/rentalmgmt
npm install -D @playwright/test
npx playwright install chromium
```

Step 2 — Create playwright.config.ts:

```typescript
import { defineConfig } from "@playwright/test"

export default defineConfig({
  testDir: "./e2e",
  fullyParallel: false,
  retries: 0,
  use: {
    baseURL: "http://localhost:3000",
    headless: true,
  },
  timeout: 30000,
})
```

Step 3 — Add test script to package.json:
```json
{
  "scripts": {
    "test:e2e": "npx playwright test",
    "seed:payment-test": "tsx -r tsconfig-paths/register scripts/seed-payment-test.ts"
  }
}
```

Step 4 — Create scripts/seed-payment-test.ts — seeds a test payment for the existing test tenant:

```typescript
import { config } from "dotenv"
config({ path: ".env.local" })

import { neon } from "@neondatabase/serverless"
import { drizzle } from "drizzle-orm/neon-http"
import * as schema from "../src/db/schema"
import { eq, and } from "drizzle-orm"

async function main() {
  const sql = neon(process.env.DATABASE_URL!)
  const db = drizzle({ client: sql, schema })

  // Find an active tenant-unit link
  const [link] = await db
    .select()
    .from(schema.tenantUnits)
    .where(eq(schema.tenantUnits.isActive, true))
    .limit(1)

  if (!link) {
    console.log("No active tenant-unit links found. Run invite flow first.")
    process.exit(1)
  }

  // Find the unit and configure rent if not already set
  const [unit] = await db
    .select()
    .from(schema.units)
    .where(eq(schema.units.id, link.unitId))

  if (!unit?.rentAmountCents) {
    await db.update(schema.units).set({
      rentAmountCents: 150000,  // $1,500.00
      rentDueDay: 1,
      updatedAt: new Date(),
    }).where(eq(schema.units.id, link.unitId))
    console.log("Configured rent for unit:", unit?.unitNumber, "-> $1,500.00 due day 1")
  }

  // Insert a test payment
  const billingPeriod = new Date().toISOString().slice(0, 7)
  const [existing] = await db
    .select()
    .from(schema.payments)
    .where(and(
      eq(schema.payments.tenantUserId, link.userId),
      eq(schema.payments.billingPeriod, billingPeriod),
    ))
    .limit(1)

  if (!existing) {
    await db.insert(schema.payments).values({
      tenantUserId: link.userId,
      unitId: link.unitId,
      amountCents: 150000,
      paymentMethod: "card",
      status: "succeeded",
      billingPeriod,
      paidAt: new Date(),
    })
    console.log("Inserted test payment: $1,500.00 for period", billingPeriod)
  } else {
    console.log("Test payment already exists for period", billingPeriod)
  }

  console.log("Payment test data seeded successfully.")
}

main().catch((err) => {
  console.error("Seed failed:", err)
  process.exit(1)
})
```

CRITICAL: Uses `config({ path: ".env.local" })` per project convention — NOT `import "dotenv/config"`.

Step 5 — Create e2e/payments.spec.ts:

```typescript
import { test, expect } from "@playwright/test"

const BASE_URL = "http://localhost:3000"
// These match the seeded test tenant from Phase 2
// Adjust if your test tenant credentials are different
const TENANT_EMAIL = process.env.TEST_TENANT_EMAIL || "testtenant@test.com"
const TENANT_PASSWORD = process.env.TEST_TENANT_PASSWORD || "TestPass123!"

test.describe("Tenant Payment Flows", () => {
  test.beforeEach(async ({ page }) => {
    // Login as tenant
    await page.goto(`${BASE_URL}/auth/login`)
    await page.waitForLoadState("networkidle")
    await page.fill('input[type="email"]', TENANT_EMAIL)
    await page.fill('input[type="password"]', TENANT_PASSWORD)
    await page.click('button[type="submit"]')
    await page.waitForURL("**/tenant/dashboard", { timeout: 15000 })
  })

  test("@smoke tenant dashboard shows payment summary", async ({ page }) => {
    // Verify rent amount is displayed
    await expect(page.locator("text=$1,500.00").first()).toBeVisible({ timeout: 10000 })

    // Verify due date section exists
    await expect(page.locator("text=Next Due Date").first()).toBeVisible()

    // Verify last payment section exists
    await expect(page.locator("text=Last Payment").first()).toBeVisible()
  })

  test("@smoke tenant can see Pay Rent button", async ({ page }) => {
    const payButton = page.locator('button:has-text("Pay Rent")')
    await expect(payButton).toBeVisible({ timeout: 10000 })
  })

  test("Pay Rent redirects to Stripe Checkout", async ({ page }) => {
    // Click Pay Rent
    const payButton = page.locator('button:has-text("Pay Rent")')
    await payButton.click()

    // Should redirect to Stripe Checkout (external domain)
    // We verify the URL starts with checkout.stripe.com
    await page.waitForURL(/checkout\.stripe\.com/, { timeout: 15000 })
    const url = page.url()
    expect(url).toContain("checkout.stripe.com")
  })

  test("@smoke tenant can view payment history", async ({ page }) => {
    await page.goto(`${BASE_URL}/tenant/payments`)
    await page.waitForLoadState("networkidle")

    // Verify history page loads
    await expect(page.locator("text=Payment History")).toBeVisible()

    // Verify at least one payment row exists (from seed data)
    await expect(page.locator("table tbody tr").first()).toBeVisible({ timeout: 10000 })
  })

  test("tenant can view payment detail", async ({ page }) => {
    await page.goto(`${BASE_URL}/tenant/payments`)
    await page.waitForLoadState("networkidle")

    // Click on first payment link
    const firstPaymentLink = page.locator("table tbody tr a").first()
    await firstPaymentLink.click()

    // Verify detail page loads
    await expect(page.locator("text=Payment Details")).toBeVisible({ timeout: 10000 })
    await expect(page.locator("text=$1,500.00")).toBeVisible()

    // Verify receipt download link exists
    await expect(page.locator('a:has-text("Download Receipt")').or(page.locator('a[download]'))).toBeVisible()
  })
})
```

Step 6 — Create e2e/admin-payments.spec.ts:

```typescript
import { test, expect } from "@playwright/test"

const BASE_URL = "http://localhost:3000"
const ADMIN_EMAIL = process.env.ADMIN_EMAIL || "odesantos2@gmail.com"
const ADMIN_PASSWORD = process.env.ADMIN_PASSWORD || "123Pormi!@#123"

test.describe("Admin Payment Flows", () => {
  test.beforeEach(async ({ page }) => {
    // Login as admin
    await page.goto(`${BASE_URL}/auth/login`)
    await page.waitForLoadState("networkidle")
    await page.fill('input[type="email"]', ADMIN_EMAIL)
    await page.fill('input[type="password"]', ADMIN_PASSWORD)
    await page.click('button[type="submit"]')
    await page.waitForURL("**/tenant/dashboard", { timeout: 15000 })
  })

  test("@smoke admin can configure rent for a unit", async ({ page }) => {
    await page.goto(`${BASE_URL}/admin/units`)
    await page.waitForLoadState("networkidle")

    // Verify units table is visible
    await expect(page.locator("text=Units & Rent Configuration")).toBeVisible()
    await expect(page.locator("table")).toBeVisible({ timeout: 10000 })

    // Verify at least one unit row exists
    await expect(page.locator("table tbody tr").first()).toBeVisible()

    // Verify input fields exist for rent configuration
    await expect(page.locator('input[type="number"]').first()).toBeVisible()
  })

  test("@smoke admin can view payment dashboard", async ({ page }) => {
    await page.goto(`${BASE_URL}/admin/payments`)
    await page.waitForLoadState("networkidle")

    // Verify payment dashboard page loads
    await expect(page.locator("text=Payment Dashboard")).toBeVisible()

    // Verify status table exists
    await expect(page.locator("table")).toBeVisible({ timeout: 10000 })

    // Verify month navigation exists
    await expect(page.locator('button:has-text("Previous")')).toBeVisible()
    await expect(page.locator('button:has-text("Next")')).toBeVisible()
  })

  test("admin payment dashboard shows unit status", async ({ page }) => {
    await page.goto(`${BASE_URL}/admin/payments`)
    await page.waitForLoadState("networkidle")

    // Verify at least one unit row
    await expect(page.locator("table tbody tr").first()).toBeVisible({ timeout: 10000 })

    // Verify status badge is present (Paid, Unpaid, Partial, or Pending)
    const statusBadge = page.locator(".rounded-full").first()
    await expect(statusBadge).toBeVisible()
  })

  test("admin can record manual payment", async ({ page }) => {
    await page.goto(`${BASE_URL}/admin/payments`)
    await page.waitForLoadState("networkidle")

    // Click Record Payment button for first unit
    const recordBtn = page.locator('button:has-text("Record Payment")').first()
    if (await recordBtn.isVisible()) {
      await recordBtn.click()

      // Fill manual payment form
      await page.fill('input[placeholder="1500.00"]', "500.00")

      // Click Save
      const saveBtn = page.locator('button:has-text("Save")').first()
      await saveBtn.click()

      // Verify success toast
      await expect(page.locator("text=Manual payment recorded")).toBeVisible({ timeout: 5000 })
    }
  })
})
```
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    Playwright installed with chromium browser. playwright.config.ts configured. Seed script creates test payment data. E2E tests cover: tenant dashboard summary (PAY-03), Pay Rent button redirect to Stripe (PAY-01), payment history (PAY-02), payment detail with receipt link (PAY-02), admin rent configuration (PAY-04), admin payment dashboard (PAY-05), manual payment recording. npm run build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 3 payment system:
1. Stripe Checkout integration with card + ACH payment methods
2. Webhook-first payment confirmation (never trusts redirect)
3. Tenant dashboard with payment summary, Pay Rent button, payment history, PDF receipts
4. Admin units page with inline rent configuration
5. Admin payment dashboard with per-unit paid/unpaid status and manual payment recording
6. Email confirmation on successful payment
7. E2E Playwright tests for all flows
  </what-built>
  <how-to-verify>
Prerequisites:
- Ensure STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, and NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY are set in .env.local
- Run: npm run dev
- In another terminal: stripe listen --forward-to localhost:3000/api/webhooks/stripe
- Run: npm run seed:payment-test

Verify these flows:

1. ADMIN: Configure rent
   - Go to http://localhost:3000/auth/login -> login as admin
   - Navigate to /admin/units
   - Set rent amount to $1,500 and due day to 1 for a unit
   - Click Save -> verify toast "Rent configuration saved"

2. TENANT: Pay rent
   - Login as tenant
   - Verify dashboard shows: rent amount ($1,500), next due date, last payment
   - Click "Pay Rent" button
   - Verify redirect to Stripe Checkout page
   - Use test card 4242 4242 4242 4242 (any future expiry, any CVC)
   - Complete payment
   - Verify redirect to success page
   - Check Stripe CLI terminal for webhook received

3. TENANT: View history and receipt
   - Navigate to /tenant/payments
   - Verify payment appears in history with "Paid" badge
   - Click the payment -> verify detail page
   - Click "Download Receipt" -> verify PDF downloads

4. ADMIN: Payment dashboard
   - Navigate to /admin/payments
   - Verify the unit shows "Paid" status (green badge)
   - Click "Record Payment" for another unit (if exists)
   - Record a $500 cash payment
   - Verify status updates

5. EMAIL: Check Resend dashboard for payment confirmation email

6. Run E2E tests:
   npx playwright test
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Playwright installed and tests pass
2. Admin can configure rent per unit
3. Tenant dashboard shows payment summary with Pay Rent button
4. Stripe Checkout redirects correctly with card + ACH
5. Webhook processes payments and records in database
6. Payment history displays correctly
7. PDF receipt downloads for succeeded payments
8. Admin payment dashboard shows per-unit status
9. Manual payment recording works
10. Email confirmation sent on successful payment
</verification>

<success_criteria>
All Phase 3 success criteria verified:
1. Tenant can pay rent via Stripe using ACH or card and receive a payment confirmation
2. Tenant can view their full payment history and download a receipt for any past payment
3. Tenant's portal shows their current balance, next due date, and most recent payment
4. Admin can set a different rent amount and due date for each unit individually
5. Admin's payment dashboard shows per-unit paid/unpaid status for the current period at a glance
6. Tenant receives an email confirmation immediately after a successful payment
</success_criteria>

<output>
After completion, create `.planning/phases/03-payments/03-06-SUMMARY.md`
</output>
