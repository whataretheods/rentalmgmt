---
phase: 03-payments
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(admin)/admin/units/page.tsx
  - src/app/api/units/[unitId]/rent-config/route.ts
  - src/components/admin/RentConfigForm.tsx
autonomous: true
requirements:
  - PAY-04

must_haves:
  truths:
    - "Admin can see a list of all units with their current rent amount and due day"
    - "Admin can edit rent amount and due day inline for any unit"
    - "Saving rent config updates the units table in the database"
    - "Rent amount is displayed in dollars but stored in cents"
  artifacts:
    - path: "src/app/(admin)/admin/units/page.tsx"
      provides: "Admin units page showing all units with inline rent configuration"
    - path: "src/app/api/units/[unitId]/rent-config/route.ts"
      provides: "PATCH endpoint to update unit rent amount and due day"
      exports: ["PATCH"]
    - path: "src/components/admin/RentConfigForm.tsx"
      provides: "Inline form for editing rent amount (dollars) and due day (1-28)"
  key_links:
    - from: "src/components/admin/RentConfigForm.tsx"
      to: "/api/units/[unitId]/rent-config"
      via: "fetch PATCH request"
      pattern: "fetch.*rent-config"
    - from: "src/app/api/units/[unitId]/rent-config/route.ts"
      to: "src/db/schema/domain.ts"
      via: "db.update(units) setting rentAmountCents and rentDueDay"
      pattern: "update.*units"
---

<objective>
Build the admin units page with inline rent configuration, allowing the admin to set a different rent amount and due date for each unit individually.

Purpose: PAY-04 requires per-unit rent configuration. Tenants need this configured before they can pay rent (Plan 03 reads rentAmountCents to pre-fill the Checkout amount). Building this in Wave 1 means rent can be configured while Plan 01 handles the schema.

Output: Admin units page at /admin/units with inline editing for rent amount and due day, backed by a PATCH API endpoint.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-payments/03-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/db/schema/domain.ts:
```typescript
export const units = pgTable("units", {
  id: uuid("id").primaryKey().defaultRandom(),
  propertyId: uuid("property_id").references(() => properties.id, { onDelete: "cascade" }).notNull(),
  unitNumber: text("unit_number").notNull(),
  rentAmountCents: integer("rent_amount_cents"),  // nullable — this plan sets it
  rentDueDay: integer("rent_due_day"),             // day of month 1-28, nullable — this plan sets it
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
})

export const properties = pgTable("properties", {
  id: uuid("id").primaryKey().defaultRandom(),
  name: text("name").notNull(),
  address: text("address").notNull(),
  // ...
})
```

From src/lib/auth.ts:
```typescript
export const auth = betterAuth({ ... })
export type Session = typeof auth.$Infer.Session
```

From src/app/(admin)/layout.tsx:
```typescript
// Validates admin role, redirects non-admins
const session = await auth.api.getSession({ headers: await headers() })
if (session.user.role !== "admin") { redirect("/tenant/dashboard") }
```

Existing admin pages follow pattern:
- src/app/(admin)/admin/users/page.tsx
- src/app/(admin)/admin/invites/page.tsx
- src/app/(admin)/admin/dashboard/page.tsx
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rent config API endpoint</name>
  <files>
    src/app/api/units/[unitId]/rent-config/route.ts
  </files>
  <action>
Create src/app/api/units/[unitId]/rent-config/route.ts — PATCH endpoint for updating rent amount and due day:

```typescript
import { NextResponse } from "next/server"
import { auth } from "@/lib/auth"
import { headers } from "next/headers"
import { db } from "@/db"
import { units } from "@/db/schema"
import { eq } from "drizzle-orm"
import { z } from "zod"

const rentConfigSchema = z.object({
  rentAmountCents: z.number().int().min(0).max(10000000),  // max $100,000
  rentDueDay: z.number().int().min(1).max(28),              // 1-28 to avoid month-end issues
})

export async function PATCH(
  req: Request,
  { params }: { params: Promise<{ unitId: string }> }
) {
  // Auth check — admin only
  const session = await auth.api.getSession({ headers: await headers() })
  if (!session || session.user.role !== "admin") {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }

  const { unitId } = await params

  // Validate request body
  const body = await req.json()
  const parsed = rentConfigSchema.safeParse(body)
  if (!parsed.success) {
    return NextResponse.json({ error: "Invalid input", details: parsed.error.flatten() }, { status: 400 })
  }

  // Update unit
  const [updated] = await db
    .update(units)
    .set({
      rentAmountCents: parsed.data.rentAmountCents,
      rentDueDay: parsed.data.rentDueDay,
      updatedAt: new Date(),
    })
    .where(eq(units.id, unitId))
    .returning()

  if (!updated) {
    return NextResponse.json({ error: "Unit not found" }, { status: 404 })
  }

  return NextResponse.json({ unit: updated })
}
```

CRITICAL: rentDueDay max is 28 (not 31) to avoid issues with months that have fewer days (Feb has 28/29).
CRITICAL: Use z.number().int() validation — amounts must be whole cents.
CRITICAL: params is a Promise in Next.js 15 — must await it.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    PATCH /api/units/[unitId]/rent-config endpoint exists. Validates admin session. Validates rentAmountCents (int, 0-10000000) and rentDueDay (int, 1-28) with Zod. Updates units table. Returns updated unit. Returns 401 for non-admins, 400 for invalid input, 404 for missing unit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin units page with inline rent configuration</name>
  <files>
    src/app/(admin)/admin/units/page.tsx
    src/components/admin/RentConfigForm.tsx
  </files>
  <action>
Step 1 — Create src/components/admin/RentConfigForm.tsx — client component for inline rent editing:

```typescript
"use client"

import { useState } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { toast } from "sonner"

interface RentConfigFormProps {
  unitId: string
  initialAmountCents: number | null
  initialDueDay: number | null
}

export function RentConfigForm({ unitId, initialAmountCents, initialDueDay }: RentConfigFormProps) {
  const [amountDollars, setAmountDollars] = useState(
    initialAmountCents != null ? (initialAmountCents / 100).toFixed(2) : ""
  )
  const [dueDay, setDueDay] = useState(initialDueDay?.toString() ?? "1")
  const [saving, setSaving] = useState(false)

  async function handleSave() {
    const cents = Math.round(parseFloat(amountDollars) * 100)
    const day = parseInt(dueDay, 10)

    if (isNaN(cents) || cents <= 0) {
      toast.error("Enter a valid rent amount")
      return
    }
    if (isNaN(day) || day < 1 || day > 28) {
      toast.error("Due day must be between 1 and 28")
      return
    }

    setSaving(true)
    try {
      const res = await fetch(`/api/units/${unitId}/rent-config`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rentAmountCents: cents, rentDueDay: day }),
      })

      if (!res.ok) {
        const data = await res.json()
        toast.error(data.error || "Failed to save")
        return
      }

      toast.success("Rent configuration saved")
    } catch {
      toast.error("Failed to save rent configuration")
    } finally {
      setSaving(false)
    }
  }

  return (
    <div className="flex items-center gap-2">
      <div className="flex items-center gap-1">
        <span className="text-sm text-gray-500">$</span>
        <Input
          type="number"
          step="0.01"
          min="0"
          value={amountDollars}
          onChange={(e) => setAmountDollars(e.target.value)}
          className="w-28"
          placeholder="1500.00"
        />
      </div>
      <div className="flex items-center gap-1">
        <span className="text-sm text-gray-500">Day</span>
        <Input
          type="number"
          min="1"
          max="28"
          value={dueDay}
          onChange={(e) => setDueDay(e.target.value)}
          className="w-16"
          placeholder="1"
        />
      </div>
      <Button size="sm" onClick={handleSave} disabled={saving}>
        {saving ? "Saving..." : "Save"}
      </Button>
    </div>
  )
}
```

Step 2 — Create src/app/(admin)/admin/units/page.tsx — server component listing all units with inline rent config:

```typescript
import { db } from "@/db"
import { units, properties } from "@/db/schema"
import { eq } from "drizzle-orm"
import { RentConfigForm } from "@/components/admin/RentConfigForm"

export default async function AdminUnitsPage() {
  // Fetch all units with their property info
  const allUnits = await db
    .select({
      id: units.id,
      unitNumber: units.unitNumber,
      rentAmountCents: units.rentAmountCents,
      rentDueDay: units.rentDueDay,
      propertyName: properties.name,
      propertyAddress: properties.address,
    })
    .from(units)
    .innerJoin(properties, eq(units.propertyId, properties.id))
    .orderBy(units.unitNumber)

  return (
    <div>
      <h1 className="text-2xl font-bold text-gray-900">Units & Rent Configuration</h1>
      <p className="mt-2 text-gray-600">
        Set the rent amount and due date for each unit. Tenants will see this amount when paying rent.
      </p>

      <div className="mt-6">
        <table className="w-full border-collapse">
          <thead>
            <tr className="border-b text-left text-sm font-medium text-gray-500">
              <th className="pb-3 pr-4">Unit</th>
              <th className="pb-3 pr-4">Property</th>
              <th className="pb-3 pr-4">Current Rent</th>
              <th className="pb-3">Configuration</th>
            </tr>
          </thead>
          <tbody>
            {allUnits.map((unit) => (
              <tr key={unit.id} className="border-b">
                <td className="py-4 pr-4 font-medium">{unit.unitNumber}</td>
                <td className="py-4 pr-4 text-gray-600">{unit.propertyName}</td>
                <td className="py-4 pr-4">
                  {unit.rentAmountCents != null ? (
                    <span className="text-gray-900">
                      ${(unit.rentAmountCents / 100).toFixed(2)} / due day {unit.rentDueDay}
                    </span>
                  ) : (
                    <span className="text-amber-600 text-sm">Not configured</span>
                  )}
                </td>
                <td className="py-4">
                  <RentConfigForm
                    unitId={unit.id}
                    initialAmountCents={unit.rentAmountCents}
                    initialDueDay={unit.rentDueDay}
                  />
                </td>
              </tr>
            ))}
            {allUnits.length === 0 && (
              <tr>
                <td colSpan={4} className="py-8 text-center text-gray-500">
                  No units found. Add properties and units first.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  )
}
```

Step 3 — Add a navigation link from the admin dashboard to the units page. Edit src/app/(admin)/admin/dashboard/page.tsx to add a link:

After the existing "View Users" link, add:
```tsx
<Link
  href="/admin/units"
  className="inline-flex items-center rounded-md bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200"
>
  Manage Units
</Link>
```

The admin layout already handles auth (session check + admin role guard), so the units page inherits protection automatically.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    Admin units page at /admin/units shows all units with property info. Each unit row has inline RentConfigForm with dollar amount input and due day input (1-28). Save button calls PATCH /api/units/[unitId]/rent-config. Success shows toast. Admin dashboard has navigation link to /admin/units.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes with no TypeScript errors
2. /admin/units page renders with unit list (requires running dev server and being logged in as admin)
3. PATCH /api/units/[unitId]/rent-config validates input and updates database
4. Dollar/cents conversion is correct: UI shows $1,500.00, DB stores 150000
5. Due day input constrained to 1-28
</verification>

<success_criteria>
- Admin can see all units with their current rent configuration
- Admin can set rent amount (in dollars, stored as cents) and due day (1-28) per unit
- Changes persist to the database
- Input validation prevents invalid amounts and days
- Toast feedback on save success/failure
</success_criteria>

<output>
After completion, create `.planning/phases/03-payments/03-02-SUMMARY.md`
</output>
