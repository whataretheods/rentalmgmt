---
phase: 03-payments
plan: 04
type: execute
wave: 3
depends_on: [01, 03]
files_modified:
  - src/app/(tenant)/tenant/dashboard/page.tsx
  - src/app/(tenant)/tenant/payments/page.tsx
  - src/app/(tenant)/tenant/payments/[id]/page.tsx
  - src/app/api/payments/receipt/[paymentId]/route.ts
  - src/lib/pdf/receipt.tsx
  - src/components/tenant/PayRentButton.tsx
  - src/components/tenant/PaymentSummaryCard.tsx
  - src/components/tenant/PaymentHistoryTable.tsx
autonomous: true
requirements:
  - PAY-01
  - PAY-02
  - PAY-03

must_haves:
  truths:
    - "Tenant dashboard shows current balance owed, next due date, and most recent payment summary"
    - "Tenant dashboard has a prominent Pay Rent button that starts Stripe Checkout"
    - "Tenant can view a chronological list of all their payments (most recent first)"
    - "Tenant can view payment details for any individual payment"
    - "Tenant can download a PDF receipt for any succeeded payment"
    - "ACH pending payments show 'Payment processing' badge"
  artifacts:
    - path: "src/app/(tenant)/tenant/dashboard/page.tsx"
      provides: "Enhanced dashboard with payment summary card and Pay Rent button"
    - path: "src/app/(tenant)/tenant/payments/page.tsx"
      provides: "Payment history page with chronological list"
    - path: "src/app/(tenant)/tenant/payments/[id]/page.tsx"
      provides: "Individual payment detail view"
    - path: "src/app/api/payments/receipt/[paymentId]/route.ts"
      provides: "GET endpoint generating PDF receipt"
      exports: ["GET"]
    - path: "src/lib/pdf/receipt.tsx"
      provides: "React-PDF receipt document component"
    - path: "src/components/tenant/PayRentButton.tsx"
      provides: "Button that creates checkout session and redirects to Stripe"
    - path: "src/components/tenant/PaymentSummaryCard.tsx"
      provides: "Dashboard card showing balance, due date, last payment"
    - path: "src/components/tenant/PaymentHistoryTable.tsx"
      provides: "Table component rendering payment history"
  key_links:
    - from: "src/components/tenant/PayRentButton.tsx"
      to: "/api/payments/create-checkout"
      via: "fetch POST to create Stripe Checkout Session, then window.location redirect"
      pattern: "create-checkout"
    - from: "src/app/api/payments/receipt/[paymentId]/route.ts"
      to: "src/lib/pdf/receipt.tsx"
      via: "Renders ReceiptDocument to PDF buffer and returns as application/pdf"
      pattern: "renderToBuffer|ReceiptDocument"
---

<objective>
Build the complete tenant-facing payment experience: enhanced dashboard with payment summary and Pay Rent button, payment history page, individual payment detail view, and downloadable PDF receipts.

Purpose: PAY-01 (pay button), PAY-02 (history + receipts), and PAY-03 (dashboard summary) complete the tenant payment experience. This is the UI that makes the Stripe integration (Plan 03) accessible to tenants.

Output: Tenant dashboard with payment summary card + Pay Rent button, /tenant/payments history page, /tenant/payments/[id] detail page, PDF receipt download endpoint.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-payments/03-RESEARCH.md
@.planning/phases/03-payments/03-01-SUMMARY.md
@.planning/phases/03-payments/03-03-SUMMARY.md

<interfaces>
<!-- Key types from Plan 01 and Plan 03 -->

From src/db/schema/domain.ts:
```typescript
export const payments = pgTable("payments", {
  id: uuid("id").primaryKey().defaultRandom(),
  tenantUserId: text("tenant_user_id").notNull(),
  unitId: uuid("unit_id").references(() => units.id).notNull(),
  amountCents: integer("amount_cents").notNull(),
  stripeSessionId: text("stripe_session_id").unique(),
  stripePaymentIntentId: text("stripe_payment_intent_id"),
  paymentMethod: text("payment_method", { enum: ["card", "ach", "cash", "check", "venmo", "other"] }).notNull(),
  status: text("status", { enum: ["pending", "succeeded", "failed"] }).notNull(),
  billingPeriod: text("billing_period").notNull(),
  note: text("note"),
  paidAt: timestamp("paid_at"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
})

export const units = pgTable("units", {
  id: uuid("id").primaryKey().defaultRandom(),
  unitNumber: text("unit_number").notNull(),
  rentAmountCents: integer("rent_amount_cents"),
  rentDueDay: integer("rent_due_day"),
  // ...
})

export const tenantUnits = pgTable("tenant_units", {
  userId: text("user_id").notNull(),
  unitId: uuid("unit_id").references(() => units.id).notNull(),
  isActive: boolean("is_active").default(true).notNull(),
  // ...
})
```

From src/app/api/payments/create-checkout/route.ts (Plan 03):
```typescript
// POST body: { unitId: string, amountCents: number }
// Returns: { url: string } — Stripe Checkout URL
```

From src/app/(tenant)/layout.tsx:
```typescript
// Session validated, user available
const session = await auth.api.getSession({ headers: await headers() })
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tenant components — PayRentButton, PaymentSummaryCard, PaymentHistoryTable</name>
  <files>
    src/components/tenant/PayRentButton.tsx
    src/components/tenant/PaymentSummaryCard.tsx
    src/components/tenant/PaymentHistoryTable.tsx
  </files>
  <action>
Step 1 — Create src/components/tenant/PayRentButton.tsx (client component):

```typescript
"use client"

import { useState } from "react"
import { Button } from "@/components/ui/button"
import { toast } from "sonner"

interface PayRentButtonProps {
  unitId: string
  rentAmountCents: number | null
}

export function PayRentButton({ unitId, rentAmountCents }: PayRentButtonProps) {
  const [loading, setLoading] = useState(false)

  async function handlePayRent() {
    if (!rentAmountCents) {
      toast.error("Rent amount not configured. Contact your landlord.")
      return
    }

    setLoading(true)
    try {
      const res = await fetch("/api/payments/create-checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ unitId, amountCents: rentAmountCents }),
      })

      if (!res.ok) {
        const data = await res.json()
        toast.error(data.error || "Failed to start payment")
        return
      }

      const { url } = await res.json()
      // Redirect to Stripe Checkout
      window.location.href = url
    } catch {
      toast.error("Failed to start payment. Please try again.")
    } finally {
      setLoading(false)
    }
  }

  return (
    <Button
      size="lg"
      onClick={handlePayRent}
      disabled={loading || !rentAmountCents}
      className="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold text-lg px-8 py-3"
    >
      {loading ? "Starting Payment..." : rentAmountCents
        ? `Pay Rent — $${(rentAmountCents / 100).toFixed(2)}`
        : "Rent Not Configured"}
    </Button>
  )
}
```

NOTE: Button pre-fills the admin-set rent amount per user decision. Tenant can still adjust amount on the Stripe Checkout page if they need to make a partial payment — Stripe Checkout allows line item quantity adjustments.

Step 2 — Create src/components/tenant/PaymentSummaryCard.tsx (server component):

```typescript
interface PaymentSummaryCardProps {
  rentAmountCents: number | null
  rentDueDay: number | null
  lastPayment: {
    amountCents: number
    status: string
    paidAt: Date | null
    paymentMethod: string
  } | null
}

export function PaymentSummaryCard({ rentAmountCents, rentDueDay, lastPayment }: PaymentSummaryCardProps) {
  // Calculate next due date
  const now = new Date()
  let nextDueDate: string = "Not set"
  if (rentDueDay) {
    const dueThisMonth = new Date(now.getFullYear(), now.getMonth(), rentDueDay)
    const dueDate = dueThisMonth > now
      ? dueThisMonth
      : new Date(now.getFullYear(), now.getMonth() + 1, rentDueDay)
    nextDueDate = dueDate.toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" })
  }

  return (
    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
      {/* Current Balance */}
      <div className="rounded-lg border bg-white p-4">
        <p className="text-sm text-gray-500">Rent Amount</p>
        <p className="mt-1 text-2xl font-bold text-gray-900">
          {rentAmountCents != null
            ? `$${(rentAmountCents / 100).toFixed(2)}`
            : "Not set"}
        </p>
      </div>

      {/* Next Due Date */}
      <div className="rounded-lg border bg-white p-4">
        <p className="text-sm text-gray-500">Next Due Date</p>
        <p className="mt-1 text-2xl font-bold text-gray-900">{nextDueDate}</p>
      </div>

      {/* Last Payment */}
      <div className="rounded-lg border bg-white p-4">
        <p className="text-sm text-gray-500">Last Payment</p>
        {lastPayment ? (
          <div>
            <p className="mt-1 text-2xl font-bold text-gray-900">
              ${(lastPayment.amountCents / 100).toFixed(2)}
            </p>
            <div className="flex items-center gap-2 mt-1">
              <StatusBadge status={lastPayment.status} />
              <span className="text-xs text-gray-500">
                {lastPayment.paidAt
                  ? new Date(lastPayment.paidAt).toLocaleDateString()
                  : "Processing"}
              </span>
            </div>
          </div>
        ) : (
          <p className="mt-1 text-lg text-gray-400">No payments yet</p>
        )}
      </div>
    </div>
  )
}

function StatusBadge({ status }: { status: string }) {
  const styles: Record<string, string> = {
    succeeded: "bg-green-100 text-green-800",
    pending: "bg-yellow-100 text-yellow-800",
    failed: "bg-red-100 text-red-800",
  }
  const labels: Record<string, string> = {
    succeeded: "Paid",
    pending: "Processing",
    failed: "Failed",
  }

  return (
    <span className={`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${styles[status] || "bg-gray-100 text-gray-800"}`}>
      {labels[status] || status}
    </span>
  )
}
```

Step 3 — Create src/components/tenant/PaymentHistoryTable.tsx (server component):

```typescript
import Link from "next/link"

interface Payment {
  id: string
  amountCents: number
  paymentMethod: string
  status: string
  billingPeriod: string
  paidAt: Date | null
  createdAt: Date
}

interface PaymentHistoryTableProps {
  payments: Payment[]
}

export function PaymentHistoryTable({ payments }: PaymentHistoryTableProps) {
  if (payments.length === 0) {
    return (
      <div className="text-center py-12 text-gray-500">
        No payments yet. Pay your first rent to see it here.
      </div>
    )
  }

  return (
    <table className="w-full border-collapse">
      <thead>
        <tr className="border-b text-left text-sm font-medium text-gray-500">
          <th className="pb-3 pr-4">Date</th>
          <th className="pb-3 pr-4">Amount</th>
          <th className="pb-3 pr-4">Method</th>
          <th className="pb-3 pr-4">Status</th>
          <th className="pb-3">Period</th>
        </tr>
      </thead>
      <tbody>
        {payments.map((payment) => (
          <tr key={payment.id} className="border-b hover:bg-gray-50">
            <td className="py-3 pr-4">
              <Link href={`/tenant/payments/${payment.id}`} className="text-blue-600 hover:underline">
                {payment.paidAt
                  ? new Date(payment.paidAt).toLocaleDateString()
                  : new Date(payment.createdAt).toLocaleDateString()}
              </Link>
            </td>
            <td className="py-3 pr-4 font-medium">
              ${(payment.amountCents / 100).toFixed(2)}
            </td>
            <td className="py-3 pr-4 text-gray-600 capitalize">
              {payment.paymentMethod === "ach" ? "ACH Bank Transfer" : payment.paymentMethod}
            </td>
            <td className="py-3 pr-4">
              <PaymentStatusBadge status={payment.status} />
            </td>
            <td className="py-3 text-gray-600">{payment.billingPeriod}</td>
          </tr>
        ))}
      </tbody>
    </table>
  )
}

function PaymentStatusBadge({ status }: { status: string }) {
  const styles: Record<string, string> = {
    succeeded: "bg-green-100 text-green-800",
    pending: "bg-yellow-100 text-yellow-800",
    failed: "bg-red-100 text-red-800",
  }
  const labels: Record<string, string> = {
    succeeded: "Paid",
    pending: "Processing",
    failed: "Failed",
  }

  return (
    <span className={`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${styles[status] || "bg-gray-100 text-gray-800"}`}>
      {labels[status] || status}
    </span>
  )
}
```
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    PayRentButton client component calls create-checkout and redirects to Stripe. PaymentSummaryCard shows rent amount, next due date, last payment with status badge. PaymentHistoryTable renders chronological list with links to detail view. All components handle null/empty states.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tenant dashboard, payment history page, detail page, and PDF receipt endpoint</name>
  <files>
    src/app/(tenant)/tenant/dashboard/page.tsx
    src/app/(tenant)/tenant/payments/page.tsx
    src/app/(tenant)/tenant/payments/[id]/page.tsx
    src/app/api/payments/receipt/[paymentId]/route.ts
    src/lib/pdf/receipt.tsx
  </files>
  <action>
Step 1 — Replace src/app/(tenant)/tenant/dashboard/page.tsx entirely:

```typescript
import { auth } from "@/lib/auth"
import { headers } from "next/headers"
import { db } from "@/db"
import { units, tenantUnits, payments } from "@/db/schema"
import { eq, and, desc } from "drizzle-orm"
import { PayRentButton } from "@/components/tenant/PayRentButton"
import { PaymentSummaryCard } from "@/components/tenant/PaymentSummaryCard"
import Link from "next/link"

export default async function TenantDashboard() {
  const session = await auth.api.getSession({ headers: await headers() })
  if (!session) return null  // layout handles redirect

  // Get tenant's active unit link
  const [link] = await db
    .select()
    .from(tenantUnits)
    .where(and(eq(tenantUnits.userId, session.user.id), eq(tenantUnits.isActive, true)))

  if (!link) {
    return (
      <div>
        <h1 className="text-2xl font-bold text-gray-900">Dashboard</h1>
        <p className="mt-2 text-gray-600">
          Your account is not linked to a unit yet. Please contact your landlord for an invite.
        </p>
      </div>
    )
  }

  // Get unit details
  const [unit] = await db.select().from(units).where(eq(units.id, link.unitId))

  // Get most recent payment
  const [lastPayment] = await db
    .select()
    .from(payments)
    .where(and(eq(payments.tenantUserId, session.user.id), eq(payments.unitId, link.unitId)))
    .orderBy(desc(payments.createdAt))
    .limit(1)

  return (
    <div className="space-y-8">
      <div>
        <h1 className="text-2xl font-bold text-gray-900">Dashboard</h1>
        <p className="mt-1 text-gray-600">Unit {unit?.unitNumber}</p>
      </div>

      {/* Payment Summary Cards */}
      <PaymentSummaryCard
        rentAmountCents={unit?.rentAmountCents ?? null}
        rentDueDay={unit?.rentDueDay ?? null}
        lastPayment={lastPayment ? {
          amountCents: lastPayment.amountCents,
          status: lastPayment.status,
          paidAt: lastPayment.paidAt,
          paymentMethod: lastPayment.paymentMethod,
        } : null}
      />

      {/* Pay Rent Button */}
      <div>
        <PayRentButton
          unitId={link.unitId}
          rentAmountCents={unit?.rentAmountCents ?? null}
        />
      </div>

      {/* Quick Links */}
      <div>
        <Link
          href="/tenant/payments"
          className="text-sm text-blue-600 hover:underline"
        >
          View Payment History
        </Link>
      </div>
    </div>
  )
}
```

Step 2 — Create src/app/(tenant)/tenant/payments/page.tsx:

```typescript
import { auth } from "@/lib/auth"
import { headers } from "next/headers"
import { db } from "@/db"
import { payments, tenantUnits } from "@/db/schema"
import { eq, and, desc } from "drizzle-orm"
import { PaymentHistoryTable } from "@/components/tenant/PaymentHistoryTable"
import Link from "next/link"

export default async function PaymentHistoryPage() {
  const session = await auth.api.getSession({ headers: await headers() })
  if (!session) return null

  // Get tenant's active unit
  const [link] = await db
    .select()
    .from(tenantUnits)
    .where(and(eq(tenantUnits.userId, session.user.id), eq(tenantUnits.isActive, true)))

  if (!link) {
    return (
      <div>
        <h1 className="text-2xl font-bold text-gray-900">Payment History</h1>
        <p className="mt-2 text-gray-600">Your account is not linked to a unit.</p>
      </div>
    )
  }

  // Fetch all payments for this tenant+unit, most recent first
  const allPayments = await db
    .select()
    .from(payments)
    .where(and(eq(payments.tenantUserId, session.user.id), eq(payments.unitId, link.unitId)))
    .orderBy(desc(payments.createdAt))

  return (
    <div>
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold text-gray-900">Payment History</h1>
        <Link
          href="/tenant/dashboard"
          className="text-sm text-gray-500 hover:text-gray-700"
        >
          Back to Dashboard
        </Link>
      </div>
      <div className="mt-6">
        <PaymentHistoryTable payments={allPayments} />
      </div>
    </div>
  )
}
```

Step 3 — Create src/app/(tenant)/tenant/payments/[id]/page.tsx:

```typescript
import { auth } from "@/lib/auth"
import { headers } from "next/headers"
import { db } from "@/db"
import { payments, units } from "@/db/schema"
import { eq, and } from "drizzle-orm"
import { notFound } from "next/navigation"
import Link from "next/link"

export default async function PaymentDetailPage({
  params,
}: {
  params: Promise<{ id: string }>
}) {
  const session = await auth.api.getSession({ headers: await headers() })
  if (!session) return null

  const { id } = await params

  // Fetch payment — must belong to the logged-in tenant
  const [payment] = await db
    .select()
    .from(payments)
    .where(and(eq(payments.id, id), eq(payments.tenantUserId, session.user.id)))

  if (!payment) {
    notFound()
  }

  // Fetch unit info
  const [unit] = await db.select().from(units).where(eq(units.id, payment.unitId))

  const amount = `$${(payment.amountCents / 100).toFixed(2)}`

  const statusStyles: Record<string, string> = {
    succeeded: "bg-green-100 text-green-800",
    pending: "bg-yellow-100 text-yellow-800",
    failed: "bg-red-100 text-red-800",
  }
  const statusLabels: Record<string, string> = {
    succeeded: "Paid",
    pending: "Processing",
    failed: "Failed",
  }

  return (
    <div className="max-w-lg">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold text-gray-900">Payment Details</h1>
        <Link
          href="/tenant/payments"
          className="text-sm text-gray-500 hover:text-gray-700"
        >
          Back to History
        </Link>
      </div>

      <div className="rounded-lg border bg-white p-6 space-y-4">
        <div className="flex justify-between items-center">
          <span className="text-gray-500">Amount</span>
          <span className="text-xl font-bold">{amount}</span>
        </div>
        <div className="flex justify-between items-center">
          <span className="text-gray-500">Status</span>
          <span className={`inline-flex items-center rounded-full px-3 py-1 text-sm font-medium ${statusStyles[payment.status] || "bg-gray-100"}`}>
            {statusLabels[payment.status] || payment.status}
          </span>
        </div>
        <div className="flex justify-between">
          <span className="text-gray-500">Unit</span>
          <span>{unit?.unitNumber || "Unknown"}</span>
        </div>
        <div className="flex justify-between">
          <span className="text-gray-500">Payment Method</span>
          <span className="capitalize">{payment.paymentMethod === "ach" ? "ACH Bank Transfer" : payment.paymentMethod}</span>
        </div>
        <div className="flex justify-between">
          <span className="text-gray-500">Billing Period</span>
          <span>{payment.billingPeriod}</span>
        </div>
        <div className="flex justify-between">
          <span className="text-gray-500">Date</span>
          <span>{payment.paidAt ? new Date(payment.paidAt).toLocaleDateString() : new Date(payment.createdAt).toLocaleDateString()}</span>
        </div>
        {payment.note && (
          <div className="flex justify-between">
            <span className="text-gray-500">Note</span>
            <span>{payment.note}</span>
          </div>
        )}
      </div>

      {payment.status === "succeeded" && (
        <div className="mt-4">
          <a
            href={`/api/payments/receipt/${payment.id}`}
            className="inline-flex items-center rounded-md bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200"
            download
          >
            Download Receipt (PDF)
          </a>
        </div>
      )}
    </div>
  )
}
```

NOTE: params is a Promise in Next.js 15.
NOTE: Receipt download link only shown for succeeded payments.

Step 4 — Create src/lib/pdf/receipt.tsx:

```typescript
import { Document, Page, Text, View, StyleSheet } from "@react-pdf/renderer"

const styles = StyleSheet.create({
  page: { padding: 40, fontFamily: "Helvetica", fontSize: 12 },
  header: { fontSize: 22, marginBottom: 4, fontWeight: "bold" },
  subtitle: { fontSize: 10, color: "#999", marginBottom: 24 },
  row: { flexDirection: "row", justifyContent: "space-between", marginBottom: 10, paddingBottom: 8, borderBottom: "1 solid #f0f0f0" },
  label: { color: "#666", fontSize: 11 },
  value: { fontWeight: "bold", fontSize: 11 },
  divider: { borderBottom: "2 solid #eee", marginVertical: 16 },
  footer: { marginTop: 40, fontSize: 9, color: "#aaa", textAlign: "center" },
})

interface ReceiptProps {
  receiptId: string
  unitNumber: string
  amount: string
  paymentMethod: string
  billingPeriod: string
  date: string
  status: string
}

export function ReceiptDocument({
  receiptId,
  unitNumber,
  amount,
  paymentMethod,
  billingPeriod,
  date,
  status,
}: ReceiptProps) {
  return (
    <Document>
      <Page size="A4" style={styles.page}>
        <Text style={styles.header}>Payment Receipt</Text>
        <Text style={styles.subtitle}>RentalMgmt</Text>
        <View style={styles.divider} />
        <View style={styles.row}>
          <Text style={styles.label}>Receipt #</Text>
          <Text style={styles.value}>{receiptId.slice(0, 8).toUpperCase()}</Text>
        </View>
        <View style={styles.row}>
          <Text style={styles.label}>Unit</Text>
          <Text style={styles.value}>{unitNumber}</Text>
        </View>
        <View style={styles.row}>
          <Text style={styles.label}>Amount</Text>
          <Text style={styles.value}>{amount}</Text>
        </View>
        <View style={styles.row}>
          <Text style={styles.label}>Payment Method</Text>
          <Text style={styles.value}>{paymentMethod}</Text>
        </View>
        <View style={styles.row}>
          <Text style={styles.label}>Billing Period</Text>
          <Text style={styles.value}>{billingPeriod}</Text>
        </View>
        <View style={styles.row}>
          <Text style={styles.label}>Date</Text>
          <Text style={styles.value}>{date}</Text>
        </View>
        <View style={styles.row}>
          <Text style={styles.label}>Status</Text>
          <Text style={styles.value}>{status}</Text>
        </View>
        <View style={styles.divider} />
        <Text style={styles.footer}>
          This receipt was generated by RentalMgmt. Keep for your records.
        </Text>
      </Page>
    </Document>
  )
}
```

Step 5 — Create src/app/api/payments/receipt/[paymentId]/route.ts:

```typescript
import { NextResponse } from "next/server"
import { auth } from "@/lib/auth"
import { headers } from "next/headers"
import { db } from "@/db"
import { payments, units } from "@/db/schema"
import { eq, and } from "drizzle-orm"
import { renderToBuffer } from "@react-pdf/renderer"
import { ReceiptDocument } from "@/lib/pdf/receipt"

export async function GET(
  req: Request,
  { params }: { params: Promise<{ paymentId: string }> }
) {
  const session = await auth.api.getSession({ headers: await headers() })
  if (!session) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  }

  const { paymentId } = await params

  // Fetch payment — must belong to the logged-in tenant
  const [payment] = await db
    .select()
    .from(payments)
    .where(and(eq(payments.id, paymentId), eq(payments.tenantUserId, session.user.id)))

  if (!payment) {
    return NextResponse.json({ error: "Payment not found" }, { status: 404 })
  }

  if (payment.status !== "succeeded") {
    return NextResponse.json({ error: "Receipt only available for completed payments" }, { status: 400 })
  }

  // Fetch unit info
  const [unit] = await db.select().from(units).where(eq(units.id, payment.unitId))

  // Generate PDF
  const pdfBuffer = await renderToBuffer(
    ReceiptDocument({
      receiptId: payment.id,
      unitNumber: unit?.unitNumber || "Unknown",
      amount: `$${(payment.amountCents / 100).toFixed(2)}`,
      paymentMethod: payment.paymentMethod === "ach" ? "ACH Bank Transfer" : payment.paymentMethod.charAt(0).toUpperCase() + payment.paymentMethod.slice(1),
      billingPeriod: payment.billingPeriod,
      date: payment.paidAt ? new Date(payment.paidAt).toLocaleDateString() : new Date(payment.createdAt).toLocaleDateString(),
      status: "Paid",
    })
  )

  return new NextResponse(pdfBuffer, {
    status: 200,
    headers: {
      "Content-Type": "application/pdf",
      "Content-Disposition": `attachment; filename="receipt-${payment.id.slice(0, 8)}.pdf"`,
    },
  })
}
```

CRITICAL: renderToBuffer is the correct server-side method from @react-pdf/renderer.
CRITICAL: Receipt only generated for succeeded payments (status check).
CRITICAL: Content-Disposition: attachment forces download rather than inline display.
CRITICAL: Auth check ensures tenants can only download their own receipts.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    Tenant dashboard shows payment summary card (rent amount, next due date, last payment) and prominent Pay Rent button. /tenant/payments shows chronological history. /tenant/payments/[id] shows detail view with receipt download link for succeeded payments. /api/payments/receipt/[paymentId] generates PDF receipt using @react-pdf/renderer. All pages auth-protected via layout. npm run build passes.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes
2. Tenant dashboard shows 3 summary cards and Pay Rent button
3. Pay Rent button calls create-checkout and redirects to Stripe
4. /tenant/payments shows chronological payment history
5. /tenant/payments/[id] shows individual payment details
6. Download Receipt link generates a PDF file
7. ACH pending payments show "Processing" badge
8. Tenants can only view their own payments
</verification>

<success_criteria>
- Tenant dashboard shows current balance owed, next due date, and most recent payment
- Prominent Pay Rent button triggers Stripe Checkout
- Payment history is a simple chronological list, most recent first
- History columns: date, amount, payment method, status, billing period
- Individual payment detail view shows all payment information
- PDF receipt downloadable for succeeded payments
- ACH pending payments display "Processing" badge
</success_criteria>

<output>
After completion, create `.planning/phases/03-payments/03-04-SUMMARY.md`
</output>
