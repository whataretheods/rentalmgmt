---
phase: 06-autopay-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/domain.ts
  - package.json
  - src/app/api/cron/rent-reminders/route.ts
autonomous: true
requirements:
  - PAY-06

must_haves:
  truths:
    - "autopayEnrollments table exists in database schema with all required columns"
    - "@stripe/stripe-js and @stripe/react-stripe-js are installed"
    - "Rent reminder cron skips tenants with active autopay enrollment"
  artifacts:
    - path: "src/db/schema/domain.ts"
      provides: "autopayEnrollments table schema"
      contains: "autopayEnrollments"
    - path: "package.json"
      provides: "Stripe client-side packages installed"
      contains: "@stripe/react-stripe-js"
    - path: "src/app/api/cron/rent-reminders/route.ts"
      provides: "Rent reminder cron that skips autopay-enrolled tenants"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/cron/rent-reminders/route.ts"
      to: "src/db/schema/domain.ts"
      via: "queries autopayEnrollments to check active enrollment"
      pattern: "autopayEnrollments"
---

<objective>
Add the autopayEnrollments database table, install Stripe client-side packages, and modify the existing rent reminder cron to skip autopay-enrolled tenants.

Purpose: All autopay features depend on the enrollment table schema. The Stripe React packages are needed for the PaymentElement enrollment form. The rent reminder cron must be autopay-aware to avoid duplicate notifications (tenants with active autopay get pre-charge notifications instead, not rent reminders).

Output: autopayEnrollments table in schema, Stripe React packages installed, rent reminder cron autopay-aware.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-autopay-and-polish/06-RESEARCH.md
@.planning/phases/06-autopay-and-polish/06-CONTEXT.md

@src/db/schema/domain.ts
@src/app/api/cron/rent-reminders/route.ts
@package.json

<interfaces>
From src/db/schema/domain.ts (existing patterns):
```typescript
import { pgTable, text, integer, boolean, timestamp, uuid } from "drizzle-orm/pg-core"

export const units = pgTable("units", {
  id: uuid("id").primaryKey().defaultRandom(),
  // ...
})

export const payments = pgTable("payments", {
  tenantUserId: text("tenant_user_id").notNull(),
  unitId: uuid("unit_id").references(() => units.id, { onDelete: "cascade" }).notNull(),
  billingPeriod: text("billing_period").notNull(),
  status: text("status", { enum: ["pending", "succeeded", "failed"] }).notNull(),
  // ...
})
```

From src/app/api/cron/rent-reminders/route.ts:
```typescript
// Existing loop iterates activeLinks and sends reminders
// Must add autopay enrollment check inside the loop
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add autopayEnrollments schema and install Stripe React packages</name>
  <files>src/db/schema/domain.ts, package.json</files>
  <action>
1. Add the autopayEnrollments table to src/db/schema/domain.ts at the bottom, after the Phase 5 section. Add a Phase 6 section comment header matching the existing pattern:

```typescript
// ==================== Phase 6: Autopay and Polish ====================

export const autopayEnrollments = pgTable("autopay_enrollments", {
  id: uuid("id").primaryKey().defaultRandom(),
  tenantUserId: text("tenant_user_id").notNull().unique(), // one enrollment per tenant
  unitId: uuid("unit_id")
    .references(() => units.id, { onDelete: "cascade" })
    .notNull(),
  stripeCustomerId: text("stripe_customer_id").notNull(),
  stripePaymentMethodId: text("stripe_payment_method_id").notNull(),
  paymentMethodType: text("payment_method_type", {
    enum: ["card", "us_bank_account"],
  }).notNull(),
  paymentMethodLast4: text("payment_method_last4").notNull(),
  paymentMethodBrand: text("payment_method_brand"), // "visa", "mastercard", null for ACH
  status: text("status", {
    enum: ["active", "paused", "payment_failed", "cancelled"],
  }).default("active").notNull(),
  enrolledAt: timestamp("enrolled_at").defaultNow().notNull(),
  cancelledAt: timestamp("cancelled_at"),
  lastChargeAt: timestamp("last_charge_at"),
  nextChargeDate: text("next_charge_date"),  // "2026-03-01" ISO date string for display
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
})
```

2. Install Stripe client-side packages:
```bash
cd /Users/odesantos/Documents/rentalmgmt && npm install @stripe/stripe-js @stripe/react-stripe-js
```

3. Push the schema to the database:
```bash
cd /Users/odesantos/Documents/rentalmgmt && npx drizzle-kit push
```

Important: The `tenantUserId` field has a `.unique()` constraint because each tenant can have only one autopay enrollment at a time. Re-enrollment reuses the same row.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx drizzle-kit push 2>&1 | tail -5 && node -e "const s = require('fs').readFileSync('src/db/schema/domain.ts','utf8'); if(!s.includes('autopayEnrollments')) { process.exit(1) } else { console.log('autopayEnrollments table found') }" && node -e "const p = require('./package.json'); if(!p.dependencies['@stripe/react-stripe-js']) { process.exit(1) } else { console.log('Stripe React packages installed') }"</automated>
  </verify>
  <done>autopayEnrollments table exists in domain.ts and is pushed to database. @stripe/stripe-js and @stripe/react-stripe-js are installed.</done>
</task>

<task type="auto">
  <name>Task 2: Modify rent reminder cron to skip autopay-enrolled tenants</name>
  <files>src/app/api/cron/rent-reminders/route.ts</files>
  <action>
Modify the existing rent reminder cron at src/app/api/cron/rent-reminders/route.ts to skip tenants who have active autopay enrollment:

1. Add import for autopayEnrollments:
```typescript
import { tenantUnits, units, payments, notifications, autopayEnrollments } from "@/db/schema/domain"
```

2. Inside the `for (const link of activeLinks)` loop, AFTER the rent configuration check and BEFORE the daysUntilDue calculation, add an autopay enrollment check:

```typescript
// Skip tenants with active autopay â€” they get pre-charge notifications instead
const [autopayActive] = await db
  .select({ id: autopayEnrollments.id })
  .from(autopayEnrollments)
  .where(
    and(
      eq(autopayEnrollments.tenantUserId, link.userId),
      eq(autopayEnrollments.status, "active"),
    )
  )
  .limit(1)

if (autopayActive) {
  skipped++
  continue
}
```

3. This check should be placed AFTER the `if (!link.rentDueDay || !link.rentAmountCents)` check but BEFORE `const daysUntilDue = link.rentDueDay - currentDay`.

Important: Only skip tenants with status "active". Tenants with "cancelled", "paused", or "payment_failed" should still receive rent reminders since their autopay is not functioning.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>Rent reminder cron now checks autopayEnrollments table and skips tenants with active autopay enrollment. Tenants with cancelled/paused/failed enrollment still receive rent reminders.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- autopayEnrollments table exists in database (drizzle-kit push succeeded)
- @stripe/stripe-js and @stripe/react-stripe-js are in package.json dependencies
- Rent reminder cron imports and queries autopayEnrollments
- Only "active" status enrollments cause reminder skip
</verification>

<success_criteria>
- autopayEnrollments schema is in domain.ts with correct columns and constraints
- Schema pushed to Neon database successfully
- Stripe React packages installed
- Rent reminder cron skips only actively-enrolled autopay tenants
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/06-autopay-and-polish/06-01-SUMMARY.md`
</output>
