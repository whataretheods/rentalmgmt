---
phase: 06-autopay-and-polish
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/app/api/autopay/enroll/route.ts
  - src/app/api/autopay/cancel/route.ts
  - src/app/api/autopay/re-enroll/route.ts
  - src/app/api/autopay/status/route.ts
  - src/app/api/autopay/setup-complete/route.ts
  - src/app/(tenant)/tenant/autopay/page.tsx
  - src/app/(tenant)/tenant/autopay/setup-complete/page.tsx
  - src/components/tenant/AutopayEnrollForm.tsx
  - src/lib/autopay-fees.ts
autonomous: true
requirements:
  - PAY-06

must_haves:
  truths:
    - "Tenant can create a SetupIntent and save a payment method for autopay"
    - "Tenant can cancel their autopay enrollment immediately"
    - "Tenant can re-enroll using their saved payment method without re-entering details"
    - "Processing fees are shown transparently before enrollment confirmation"
    - "Enrollment creates a Stripe Customer if one doesn't exist"
    - "Both card and ACH (us_bank_account) are supported"
  artifacts:
    - path: "src/app/api/autopay/enroll/route.ts"
      provides: "SetupIntent creation endpoint"
      exports: ["POST"]
    - path: "src/app/api/autopay/cancel/route.ts"
      provides: "Immediate autopay cancellation endpoint"
      exports: ["POST"]
    - path: "src/app/api/autopay/re-enroll/route.ts"
      provides: "One-click re-enrollment using saved payment method"
      exports: ["POST"]
    - path: "src/app/api/autopay/status/route.ts"
      provides: "Enrollment status query endpoint"
      exports: ["GET"]
    - path: "src/app/api/autopay/setup-complete/route.ts"
      provides: "SetupIntent completion handler that saves enrollment to DB"
      exports: ["POST"]
    - path: "src/app/(tenant)/tenant/autopay/page.tsx"
      provides: "Autopay setup page with Stripe PaymentElement"
    - path: "src/components/tenant/AutopayEnrollForm.tsx"
      provides: "Client-side Stripe Elements enrollment form component"
    - path: "src/lib/autopay-fees.ts"
      provides: "Fee calculation utilities for card and ACH"
      exports: ["calculateCardFee", "calculateAchFee", "formatFee"]
  key_links:
    - from: "src/app/api/autopay/enroll/route.ts"
      to: "src/lib/stripe.ts"
      via: "stripe.setupIntents.create and stripe.customers.create"
      pattern: "stripe\\.(setupIntents|customers)\\.create"
    - from: "src/app/api/autopay/setup-complete/route.ts"
      to: "src/db/schema/domain.ts"
      via: "db.insert(autopayEnrollments) or db.update"
      pattern: "autopayEnrollments"
    - from: "src/components/tenant/AutopayEnrollForm.tsx"
      to: "@stripe/react-stripe-js"
      via: "Elements, PaymentElement, useStripe, useElements"
      pattern: "PaymentElement"
---

<objective>
Build the complete autopay enrollment, cancellation, and re-enrollment flow: API routes, Stripe SetupIntent integration, tenant-facing autopay page with PaymentElement, and fee calculation utilities.

Purpose: This is the core of PAY-06. Tenants need a dedicated /tenant/autopay page to save a payment method (card or ACH) via Stripe SetupIntent, see transparent fee disclosure, and manage their enrollment (cancel, re-enable). This plan creates all the API infrastructure and UI for the enrollment lifecycle.

Output: 5 API routes (enroll, cancel, re-enroll, status, setup-complete), tenant autopay page with Stripe Elements form, fee calculation library.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-autopay-and-polish/06-RESEARCH.md
@.planning/phases/06-autopay-and-polish/06-CONTEXT.md
@.planning/phases/06-autopay-and-polish/06-01-SUMMARY.md

@src/db/schema/domain.ts
@src/lib/stripe.ts
@src/lib/auth.ts
@src/app/api/payments/create-checkout/route.ts
@src/components/tenant/PayRentButton.tsx

<interfaces>
From src/db/schema/domain.ts (after Plan 01):
```typescript
export const autopayEnrollments = pgTable("autopay_enrollments", {
  id: uuid("id").primaryKey().defaultRandom(),
  tenantUserId: text("tenant_user_id").notNull().unique(),
  unitId: uuid("unit_id").references(() => units.id, { onDelete: "cascade" }).notNull(),
  stripeCustomerId: text("stripe_customer_id").notNull(),
  stripePaymentMethodId: text("stripe_payment_method_id").notNull(),
  paymentMethodType: text("payment_method_type", { enum: ["card", "us_bank_account"] }).notNull(),
  paymentMethodLast4: text("payment_method_last4").notNull(),
  paymentMethodBrand: text("payment_method_brand"),
  status: text("status", { enum: ["active", "paused", "payment_failed", "cancelled"] }).default("active").notNull(),
  enrolledAt: timestamp("enrolled_at").defaultNow().notNull(),
  cancelledAt: timestamp("cancelled_at"),
  lastChargeAt: timestamp("last_charge_at"),
  nextChargeDate: text("next_charge_date"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
})
```

From src/lib/stripe.ts:
```typescript
export const stripe = new Proxy({} as Stripe, { /* lazy init */ })
export function getStripe(): Stripe { /* ... */ }
```

Auth pattern from existing routes:
```typescript
const session = await auth.api.getSession({ headers: await headers() })
if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create autopay API routes and fee calculation library</name>
  <files>src/app/api/autopay/enroll/route.ts, src/app/api/autopay/cancel/route.ts, src/app/api/autopay/re-enroll/route.ts, src/app/api/autopay/status/route.ts, src/app/api/autopay/setup-complete/route.ts, src/lib/autopay-fees.ts</files>
  <action>
1. Create src/lib/autopay-fees.ts with fee calculation utilities:

```typescript
// Card: 2.9% + $0.30
export function calculateCardFee(amountCents: number): number {
  const totalCents = Math.ceil((amountCents + 30) / (1 - 0.029))
  return totalCents - amountCents
}

// ACH: 0.8%, capped at $5.00
export function calculateAchFee(amountCents: number): number {
  const fee = Math.ceil(amountCents * 0.008)
  return Math.min(fee, 500)
}

export function formatCents(cents: number): string {
  return `$${(cents / 100).toFixed(2)}`
}

export function getPaymentMethodLabel(type: string, brand: string | null, last4: string): string {
  if (type === "us_bank_account") return `Bank account ****${last4}`
  return `${brand ? brand.charAt(0).toUpperCase() + brand.slice(1) : "Card"} ****${last4}`
}
```

2. Create POST /api/autopay/enroll — creates a Stripe Customer (if needed) and SetupIntent:
- Auth check (tenant must be logged in)
- Verify tenant has an active unit link via tenantUnits
- Check for existing enrollment: if one exists with status "active", return error "Already enrolled"
- If existing enrollment has stripeCustomerId (cancelled/failed), reuse it
- Otherwise, create a new Stripe Customer: `stripe.customers.create({ email, name, metadata: { tenantUserId } })`
- Create SetupIntent: `stripe.setupIntents.create({ customer: stripeCustomerId, payment_method_types: ["card", "us_bank_account"] })`
- Return: `{ clientSecret: setupIntent.client_secret, stripeCustomerId }`

3. Create POST /api/autopay/setup-complete — called after Stripe confirms the SetupIntent:
- Auth check
- Request body: `{ setupIntentId: string }`
- Retrieve SetupIntent from Stripe: `stripe.setupIntents.retrieve(setupIntentId)`
- Verify SetupIntent status is "succeeded"
- Retrieve PaymentMethod: `stripe.paymentMethods.retrieve(setupIntent.payment_method)`
- Extract: type ("card" or "us_bank_account"), last4, brand (for cards)
  - For cards: `paymentMethod.card.last4`, `paymentMethod.card.brand`
  - For ACH: `paymentMethod.us_bank_account.last4`, brand = null
- Calculate next charge date (the upcoming rent due day for the tenant's unit)
- Upsert into autopayEnrollments (use onConflictDoUpdate on tenantUserId):
  ```typescript
  await db.insert(autopayEnrollments).values({
    tenantUserId: session.user.id,
    unitId: link.unitId,
    stripeCustomerId: setupIntent.customer,
    stripePaymentMethodId: setupIntent.payment_method,
    paymentMethodType: type,
    paymentMethodLast4: last4,
    paymentMethodBrand: brand,
    status: "active",
    enrolledAt: new Date(),
    cancelledAt: null,
    nextChargeDate: nextChargeDateStr,
  }).onConflictDoUpdate({
    target: autopayEnrollments.tenantUserId,
    set: {
      stripePaymentMethodId: setupIntent.payment_method,
      paymentMethodType: type,
      paymentMethodLast4: last4,
      paymentMethodBrand: brand,
      status: "active",
      enrolledAt: new Date(),
      cancelledAt: null,
      nextChargeDate: nextChargeDateStr,
      updatedAt: new Date(),
    },
  })
  ```
- Send admin notification (in-app only) via sendNotification: "Tenant {name} enrolled in autopay for Unit {unitNumber}"
- Return: `{ success: true, enrollment details }`

4. Create GET /api/autopay/status — returns current enrollment status:
- Auth check
- Query autopayEnrollments for current user
- If no enrollment: return `{ enrolled: false }`
- If enrollment exists: return `{ enrolled: true, status, paymentMethodType, paymentMethodLast4, paymentMethodBrand, nextChargeDate, enrolledAt }`
- Also include fee estimates based on unit rent amount and payment method type

5. Create POST /api/autopay/cancel — immediate cancellation:
- Auth check
- Find active enrollment for user
- If no active enrollment: return error
- Update enrollment: set status = "cancelled", cancelledAt = new Date()
- Do NOT detach the Stripe PaymentMethod (needed for re-enrollment)
- Send admin notification (in-app only): "Tenant {name} cancelled autopay for Unit {unitNumber}"
- Return: `{ success: true }`

6. Create POST /api/autopay/re-enroll — one-click re-enable with saved method:
- Auth check
- Find existing enrollment with status "cancelled" or "payment_failed" for user
- If no previous enrollment or no saved payment method: return error suggesting full enrollment
- Verify the saved PaymentMethod still exists on Stripe: `stripe.paymentMethods.retrieve(enrollment.stripePaymentMethodId)`
- If PaymentMethod is invalid/detached, return error suggesting full enrollment
- Update enrollment: set status = "active", cancelledAt = null, enrolledAt = new Date(), recalculate nextChargeDate
- Send admin notification (in-app only): "Tenant {name} re-enrolled in autopay for Unit {unitNumber}"
- Return: `{ success: true }`

Important: All admin notifications use sendNotification with channels: ["in_app"] only (not email/SMS per user decision). Find admin users by querying user table where role = "admin" (check Better Auth admin plugin for the correct approach -- the admin listUsers endpoint or a direct query on user table for admin role).

Important: For next charge date calculation: get the unit's rentDueDay, then find the next occurrence of that day (this month if not passed, otherwise next month). Format as "YYYY-MM-DD" string.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>All 5 autopay API routes created and type-check. Fee calculation library exported. Enrollment creates Stripe Customer + SetupIntent, setup-complete saves enrollment to DB, cancel/re-enroll manage lifecycle, status returns current state.</done>
</task>

<task type="auto">
  <name>Task 2: Create tenant autopay page with Stripe PaymentElement</name>
  <files>src/app/(tenant)/tenant/autopay/page.tsx, src/app/(tenant)/tenant/autopay/setup-complete/page.tsx, src/components/tenant/AutopayEnrollForm.tsx</files>
  <action>
1. Create src/components/tenant/AutopayEnrollForm.tsx as a "use client" component:

```typescript
"use client"

import { useState } from "react"
import { loadStripe } from "@stripe/stripe-js"
import { Elements, PaymentElement, useStripe, useElements } from "@stripe/react-stripe-js"
import { Button } from "@/components/ui/button"
import { toast } from "sonner"

const stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!)
```

The component should:
- Accept props: `rentAmountCents: number`, `unitNumber: string`
- Have an "Enroll in Autopay" button that calls POST /api/autopay/enroll to get clientSecret
- Once clientSecret is received, render `<Elements>` provider with the clientSecret and `<PaymentElement />`
- Display fee information: show both card fee and ACH fee estimates so tenant sees the cost before confirming
  - "Card: {rent} + {cardFee} processing fee = {total}"
  - "ACH: {rent} + {achFee} processing fee = {total}"
- On form submit: call `stripe.confirmSetup({ elements, confirmParams: { return_url } })`
- return_url should be `${window.location.origin}/tenant/autopay/setup-complete`
- Include a "Cancel" button to go back to dashboard
- Show loading states while API calls are in progress
- Handle errors with toast notifications

Important: The PaymentElement appearance should use a clean, minimal theme. Use Stripe's `appearance` option:
```typescript
const appearance = {
  theme: "stripe" as const,
  variables: { colorPrimary: "#16a34a" }, // green-600 to match existing Pay Rent button
}
```

2. Create src/app/(tenant)/tenant/autopay/page.tsx:
- Server component that checks auth session
- Queries tenant's active unit link and unit details (for rent amount)
- Queries existing autopay enrollment status
- If enrolled (status "active"):
  - Show enrollment details card: payment method (last4, brand/type), next charge date, amount + fees
  - Show "Cancel Autopay" button with confirmation dialog: "Are you sure? You'll need to pay rent manually each month."
  - Cancel button calls POST /api/autopay/cancel, then refreshes
- If previously enrolled (status "cancelled" or "payment_failed"):
  - Show previous method info
  - Show "Re-enable Autopay" button (one-click, calls POST /api/autopay/re-enroll)
  - Also show "Set Up New Method" button for full re-enrollment
- If never enrolled:
  - Show explanation: "Set up automatic rent payments so you never have to remember to pay."
  - Show fee transparency: card vs ACH fee comparison
  - Render `<AutopayEnrollForm>` component
- Use card-based UI consistent with existing pages (rounded-lg border bg-white p-4/p-6 pattern)

3. Create src/app/(tenant)/tenant/autopay/setup-complete/page.tsx:
- "use client" component that checks Stripe SetupIntent status on mount
- Reads `setup_intent` and `setup_intent_client_secret` from URL search params
- Calls POST /api/autopay/setup-complete with the setupIntentId to save enrollment
- On success: show success message with confetti-free confirmation, redirect to /tenant/autopay after 2 seconds
- On processing (ACH bank verification pending): show "Bank verification in progress" message
- On failure: show error, link back to try again
- Uses `stripe.retrieveSetupIntent()` to check client-side status as well

Important: The page must include `<Elements>` wrapper to use `useStripe()`. Pass the client_secret from URL as the Elements options.

Important: Add NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY to the environment. The executor should note in the summary that this env var must be set in .env.local.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>Tenant autopay page renders enrollment form with PaymentElement for new enrollees, shows status/cancel for active enrollees, and offers re-enrollment for cancelled enrollees. Setup-complete page handles Stripe redirect and saves enrollment to database.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- POST /api/autopay/enroll creates SetupIntent and returns clientSecret
- POST /api/autopay/setup-complete saves enrollment to autopayEnrollments table
- POST /api/autopay/cancel sets status to "cancelled" immediately
- POST /api/autopay/re-enroll reactivates with saved payment method
- GET /api/autopay/status returns enrollment details with fee estimates
- Autopay page shows correct UI state for enrolled/cancelled/never-enrolled tenants
- Fee transparency shown before enrollment
</verification>

<success_criteria>
- Complete autopay enrollment flow: enroll -> PaymentElement -> confirm -> setup-complete -> saved
- Cancellation is immediate with confirmation dialog
- Re-enrollment works with saved payment method (one-click)
- Processing fees are transparently displayed
- Admin receives in-app notification for enrollment/cancellation changes
- All routes are auth-protected
</success_criteria>

<output>
After completion, create `.planning/phases/06-autopay-and-polish/06-02-SUMMARY.md`
</output>
