---
phase: 06-autopay-and-polish
plan: 04
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/app/(tenant)/tenant/dashboard/page.tsx
  - src/components/tenant/AutopayStatusCard.tsx
  - src/components/tenant/PaymentSummaryCard.tsx
  - src/components/tenant/DashboardNotifications.tsx
  - src/components/tenant/DashboardMaintenance.tsx
autonomous: true
requirements:
  - PAY-06

must_haves:
  truths:
    - "Dashboard has payment-first layout: top is payment status + autopay card"
    - "Dashboard shows 'Autopay Active' badge with last4, next charge date, amount, manage link"
    - "Dashboard middle section shows recent maintenance + document requests"
    - "Dashboard bottom section shows recent notifications"
    - "Dashboard is a consolidated home base, not a navigation hub"
  artifacts:
    - path: "src/app/(tenant)/tenant/dashboard/page.tsx"
      provides: "Consolidated payment-first tenant dashboard"
    - path: "src/components/tenant/AutopayStatusCard.tsx"
      provides: "Autopay badge and details card for dashboard"
    - path: "src/components/tenant/DashboardNotifications.tsx"
      provides: "Recent notifications widget for dashboard"
    - path: "src/components/tenant/DashboardMaintenance.tsx"
      provides: "Recent maintenance + document requests widget for dashboard"
  key_links:
    - from: "src/app/(tenant)/tenant/dashboard/page.tsx"
      to: "src/db/schema/domain.ts"
      via: "queries autopayEnrollments, maintenanceRequests, documentRequests, notifications"
      pattern: "(autopayEnrollments|maintenanceRequests|documentRequests|notifications)"
    - from: "src/components/tenant/AutopayStatusCard.tsx"
      to: "src/lib/autopay-fees.ts"
      via: "fee display using calculateCardFee/calculateAchFee"
      pattern: "calculate(Card|Ach)Fee"
---

<objective>
Consolidate the tenant dashboard into a payment-first layout with autopay status card, recent maintenance/documents section, and recent notifications section.

Purpose: The dashboard is the tenant's home base. The current layout is minimal (payment summary + pay button + link). This plan transforms it into a comprehensive dashboard showing autopay enrollment status prominently, recent activity across all features, and quick actions — all in a payment-first hierarchy.

Output: Rebuilt dashboard page with 3 sections (payment+autopay at top, maintenance+docs in middle, notifications at bottom), plus supporting widget components.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-autopay-and-polish/06-RESEARCH.md
@.planning/phases/06-autopay-and-polish/06-CONTEXT.md
@.planning/phases/06-autopay-and-polish/06-02-SUMMARY.md

@src/app/(tenant)/tenant/dashboard/page.tsx
@src/components/tenant/PaymentSummaryCard.tsx
@src/components/tenant/PayRentButton.tsx
@src/db/schema/domain.ts
@src/lib/autopay-fees.ts
@src/lib/notifications.ts

<interfaces>
From existing dashboard (src/app/(tenant)/tenant/dashboard/page.tsx):
```typescript
// Current: PaymentSummaryCard + PayRentButton + link to payment history
// Needs: Full consolidated layout
```

From src/db/schema/domain.ts:
```typescript
export const autopayEnrollments = pgTable("autopay_enrollments", { /* ... */ })
export const maintenanceRequests = pgTable("maintenance_requests", { /* ... */ })
export const documentRequests = pgTable("document_requests", { /* ... */ })
export const notifications = pgTable("notifications", { /* ... */ })
```

From src/lib/autopay-fees.ts:
```typescript
export function calculateCardFee(amountCents: number): number
export function calculateAchFee(amountCents: number): number
export function formatCents(cents: number): string
export function getPaymentMethodLabel(type: string, brand: string | null, last4: string): string
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard widget components</name>
  <files>src/components/tenant/AutopayStatusCard.tsx, src/components/tenant/DashboardMaintenance.tsx, src/components/tenant/DashboardNotifications.tsx</files>
  <action>
1. Create src/components/tenant/AutopayStatusCard.tsx:
- Server component (no "use client" — receives data as props)
- Props:
  ```typescript
  interface AutopayStatusCardProps {
    enrollment: {
      status: string
      paymentMethodType: string
      paymentMethodLast4: string
      paymentMethodBrand: string | null
      nextChargeDate: string | null
      enrolledAt: Date
    } | null
    rentAmountCents: number | null
  }
  ```
- If enrollment is active:
  - Green "Autopay Active" badge (bg-green-100 text-green-800 rounded-full px-3 py-1 text-sm font-medium)
  - Payment method: display using getPaymentMethodLabel (Visa ****1234 or Bank account ****5678)
  - Next charge: formatted date
  - Amount: rent + fee estimate = total
  - "Manage Autopay" link to /tenant/autopay
- If enrollment is cancelled/failed or null:
  - Gray "Autopay Not Active" state
  - "Set Up Autopay" link to /tenant/autopay
  - Brief benefit message: "Never miss a payment — enroll in automatic rent payments"
- Card styling: consistent with existing cards (rounded-lg border bg-white p-4)

2. Create src/components/tenant/DashboardMaintenance.tsx:
- Server component
- Props:
  ```typescript
  interface DashboardMaintenanceProps {
    recentRequests: Array<{
      id: string
      category: string
      description: string
      status: string
      createdAt: Date
    }>
    pendingDocumentRequests: number
  }
  ```
- Shows up to 3 most recent maintenance requests with status badges
- Shows pending document request count with link to /tenant/documents
- "View All" link to /tenant/maintenance
- If no requests: "No maintenance requests" empty state
- Compact card layout

3. Create src/components/tenant/DashboardNotifications.tsx:
- Server component
- Props:
  ```typescript
  interface DashboardNotificationsProps {
    recentNotifications: Array<{
      id: string
      title: string
      body: string
      type: string
      readAt: Date | null
      createdAt: Date
    }>
    unreadCount: number
  }
  ```
- Shows up to 5 most recent in-app notifications
- Unread notifications have a blue dot indicator
- "View All" link to /tenant/notifications
- If no notifications: "No notifications yet" empty state
- Compact list layout within a card
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>AutopayStatusCard shows enrollment badge and details or setup CTA. DashboardMaintenance shows recent requests and pending docs. DashboardNotifications shows recent notifications with unread indicators. All components type-check.</done>
</task>

<task type="auto">
  <name>Task 2: Rebuild tenant dashboard with payment-first consolidated layout</name>
  <files>src/app/(tenant)/tenant/dashboard/page.tsx, src/components/tenant/PaymentSummaryCard.tsx</files>
  <action>
1. Update src/components/tenant/PaymentSummaryCard.tsx to be more compact for the new layout:
- Keep the same props interface
- Add an optional `compact?: boolean` prop (default false for backward compatibility)
- When compact=true: display as a single row instead of 3-column grid (rent amount, next due, last payment all inline)
- This allows the dashboard to use a denser layout

2. Rewrite src/app/(tenant)/tenant/dashboard/page.tsx with the consolidated payment-first layout:

The page is a server component. It needs these data queries:
```typescript
// 1. Session + unit (existing)
const session = await auth.api.getSession({ headers: await headers() })
const [link] = await db.select()... // active tenant-unit link
const [unit] = await db.select()... // unit details

// 2. Last payment (existing)
const [lastPayment] = await db.select()... // most recent payment

// 3. Autopay enrollment (NEW)
const [enrollment] = await db.select().from(autopayEnrollments)
  .where(eq(autopayEnrollments.tenantUserId, session.user.id))

// 4. Recent maintenance requests (NEW — limit 3)
const recentMaintenance = await db.select({
  id: maintenanceRequests.id,
  category: maintenanceRequests.category,
  description: maintenanceRequests.description,
  status: maintenanceRequests.status,
  createdAt: maintenanceRequests.createdAt,
}).from(maintenanceRequests)
  .where(eq(maintenanceRequests.tenantUserId, session.user.id))
  .orderBy(desc(maintenanceRequests.createdAt))
  .limit(3)

// 5. Pending document requests count (NEW)
const [docReqCount] = await db.select({ value: count() })
  .from(documentRequests)
  .where(and(
    eq(documentRequests.tenantUserId, session.user.id),
    eq(documentRequests.status, "pending"),
  ))

// 6. Recent notifications (NEW — limit 5)
const recentNotifications = await db.select()
  .from(notifications)
  .where(and(
    eq(notifications.userId, session.user.id),
    eq(notifications.channel, "in_app"),
  ))
  .orderBy(desc(notifications.createdAt))
  .limit(5)

// 7. Unread count
const [unread] = await db.select({ value: count() })
  .from(notifications)
  .where(and(
    eq(notifications.userId, session.user.id),
    eq(notifications.channel, "in_app"),
    isNull(notifications.readAt),
  ))
```

3. Render the consolidated layout:

```tsx
<div className="space-y-6">
  {/* Header */}
  <div>
    <h1 className="text-2xl font-bold text-gray-900">Dashboard</h1>
    <p className="mt-1 text-gray-600">Unit {unit?.unitNumber}</p>
  </div>

  {/* TOP SECTION: Payment Status + Autopay */}
  <div className="space-y-4">
    <PaymentSummaryCard
      rentAmountCents={unit?.rentAmountCents ?? null}
      rentDueDay={unit?.rentDueDay ?? null}
      lastPayment={lastPayment ? { ... } : null}
    />
    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <AutopayStatusCard
        enrollment={enrollment ?? null}
        rentAmountCents={unit?.rentAmountCents ?? null}
      />
      <div>
        <PayRentButton
          unitId={link.unitId}
          rentAmountCents={unit?.rentAmountCents ?? null}
        />
      </div>
    </div>
  </div>

  {/* MIDDLE SECTION: Maintenance + Documents */}
  <DashboardMaintenance
    recentRequests={recentMaintenance}
    pendingDocumentRequests={docReqCount?.value ?? 0}
  />

  {/* BOTTOM SECTION: Notifications */}
  <DashboardNotifications
    recentNotifications={recentNotifications}
    unreadCount={unread?.value ?? 0}
  />
</div>
```

4. Add the necessary imports at the top of the dashboard page:
```typescript
import { autopayEnrollments, maintenanceRequests, documentRequests, notifications } from "@/db/schema"
import { AutopayStatusCard } from "@/components/tenant/AutopayStatusCard"
import { DashboardMaintenance } from "@/components/tenant/DashboardMaintenance"
import { DashboardNotifications } from "@/components/tenant/DashboardNotifications"
import { count, isNull } from "drizzle-orm"
```

Important: Maintain the existing "no unit linked" fallback UI for tenants who aren't linked to a unit yet.

Important: The dashboard should feel like a home base — each section has a clear header and quick-action links but doesn't require navigation to understand what's happening.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>Tenant dashboard rebuilt with payment-first layout: PaymentSummaryCard + AutopayStatusCard at top, maintenance/documents in middle, notifications at bottom. All data queries work and components render correctly.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Dashboard shows autopay status (active badge or setup CTA)
- Dashboard shows payment summary and pay rent button
- Dashboard shows up to 3 recent maintenance requests
- Dashboard shows pending document request count
- Dashboard shows up to 5 recent notifications with unread indicators
- Layout follows payment-first hierarchy
</verification>

<success_criteria>
- Dashboard is a consolidated home base with three clear sections
- Autopay Active badge prominently shown with method details, next charge, manage link
- Non-enrolled tenants see "Set Up Autopay" CTA
- Maintenance, documents, and notification sections provide at-a-glance status
- All quick links point to correct pages
- Layout works on both desktop and mobile viewports
</success_criteria>

<output>
After completion, create `.planning/phases/06-autopay-and-polish/06-04-SUMMARY.md`
</output>
