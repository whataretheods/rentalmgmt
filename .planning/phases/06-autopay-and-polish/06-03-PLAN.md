---
phase: 06-autopay-and-polish
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/app/api/cron/autopay-notify/route.ts
  - src/app/api/cron/autopay-charge/route.ts
  - src/emails/AutopayChargeEmail.tsx
  - src/app/api/webhooks/stripe/route.ts
autonomous: true
requirements:
  - PAY-06

must_haves:
  truths:
    - "Pre-charge notification cron sends email/SMS/in-app 3 days before charge"
    - "Autopay charge cron creates off-session PaymentIntent on due day"
    - "Cron auto-skips if tenant already paid for current period"
    - "On charge failure: retry once after 2 days, then mark failed and notify admin"
    - "Processing fees (card 2.9%+$0.30, ACH 0.8% cap $5) are added to charge amount"
    - "Stripe webhook handles payment_intent.succeeded for autopay payments"
  artifacts:
    - path: "src/app/api/cron/autopay-notify/route.ts"
      provides: "Pre-charge notification cron (3 days before due)"
      exports: ["POST"]
    - path: "src/app/api/cron/autopay-charge/route.ts"
      provides: "Autopay charge cron with skip-if-paid and retry logic"
      exports: ["POST"]
    - path: "src/emails/AutopayChargeEmail.tsx"
      provides: "Styled email template for pre-charge notifications"
    - path: "src/app/api/webhooks/stripe/route.ts"
      provides: "Updated webhook handling autopay PaymentIntent events"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/cron/autopay-charge/route.ts"
      to: "src/lib/stripe.ts"
      via: "stripe.paymentIntents.create with off_session: true"
      pattern: "paymentIntents\\.create"
    - from: "src/app/api/cron/autopay-charge/route.ts"
      to: "src/lib/autopay-fees.ts"
      via: "calculateCardFee/calculateAchFee for fee passthrough"
      pattern: "calculate(Card|Ach)Fee"
    - from: "src/app/api/cron/autopay-notify/route.ts"
      to: "src/lib/notifications.ts"
      via: "sendNotification for pre-charge alerts"
      pattern: "sendNotification"
---

<objective>
Create the two autopay cron jobs (pre-charge notification and charge execution) and update the Stripe webhook to handle autopay PaymentIntent events.

Purpose: The pre-charge notification cron runs daily and alerts tenants 3 days before their autopay charge fires. The charge cron runs daily on due days and creates off-session PaymentIntents for enrolled tenants. On failure, it retries once after 2 days. The Stripe webhook needs to handle payment_intent.succeeded/failed for autopay charges (currently only handles checkout.session events).

Output: Two cron API routes, pre-charge email template, updated Stripe webhook.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-autopay-and-polish/06-RESEARCH.md
@.planning/phases/06-autopay-and-polish/06-CONTEXT.md
@.planning/phases/06-autopay-and-polish/06-01-SUMMARY.md

@src/db/schema/domain.ts
@src/lib/stripe.ts
@src/lib/notifications.ts
@src/lib/autopay-fees.ts
@src/app/api/cron/rent-reminders/route.ts
@src/app/api/webhooks/stripe/route.ts
@src/emails/RentReminderEmail.tsx

<interfaces>
From src/db/schema/domain.ts (after Plan 01):
```typescript
export const autopayEnrollments = pgTable("autopay_enrollments", {
  tenantUserId: text("tenant_user_id").notNull().unique(),
  unitId: uuid("unit_id").references(() => units.id, { onDelete: "cascade" }).notNull(),
  stripeCustomerId: text("stripe_customer_id").notNull(),
  stripePaymentMethodId: text("stripe_payment_method_id").notNull(),
  paymentMethodType: text("payment_method_type", { enum: ["card", "us_bank_account"] }).notNull(),
  status: text("status", { enum: ["active", "paused", "payment_failed", "cancelled"] }).notNull(),
  lastChargeAt: timestamp("last_charge_at"),
  nextChargeDate: text("next_charge_date"),
  // ...
})
```

From src/lib/autopay-fees.ts (from Plan 02):
```typescript
export function calculateCardFee(amountCents: number): number
export function calculateAchFee(amountCents: number): number
export function formatCents(cents: number): string
```

From src/lib/notifications.ts:
```typescript
export async function sendNotification(payload: NotificationPayload): Promise<NotificationRecord>
```

Existing webhook pattern from src/app/api/webhooks/stripe/route.ts:
```typescript
switch (event.type) {
  case "checkout.session.completed": { /* existing */ }
  case "checkout.session.async_payment_succeeded": { /* existing */ }
  case "checkout.session.async_payment_failed": { /* existing */ }
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create autopay cron jobs (notify + charge)</name>
  <files>src/app/api/cron/autopay-notify/route.ts, src/app/api/cron/autopay-charge/route.ts, src/emails/AutopayChargeEmail.tsx</files>
  <action>
1. Create src/emails/AutopayChargeEmail.tsx — pre-charge notification email template:
- Check the existing RentReminderEmail.tsx in src/emails/ for the pattern and import style
- Props: `{ tenantName: string, unitNumber: string, rentAmount: string, feeAmount: string, totalAmount: string, chargeDate: string, paymentMethodLabel: string }`
- Content: "Your autopay charge of {totalAmount} ({rentAmount} rent + {feeAmount} processing fee) for Unit {unitNumber} will be processed on {chargeDate} using {paymentMethodLabel}."
- Include a note: "If you need to cancel autopay, visit your autopay settings before the charge date."
- Link to `/tenant/autopay` for managing settings
- Export both the component and a `renderAutopayChargeEmail(props)` function

2. Create POST /api/cron/autopay-notify — pre-charge notification cron:
- CRON_SECRET bearer token validation (same pattern as rent-reminders)
- Query all active autopay enrollments joined with units and tenantUnits:
  ```typescript
  const enrollments = await db
    .select({
      tenantUserId: autopayEnrollments.tenantUserId,
      unitId: autopayEnrollments.unitId,
      paymentMethodType: autopayEnrollments.paymentMethodType,
      paymentMethodLast4: autopayEnrollments.paymentMethodLast4,
      paymentMethodBrand: autopayEnrollments.paymentMethodBrand,
      unitNumber: units.unitNumber,
      rentAmountCents: units.rentAmountCents,
      rentDueDay: units.rentDueDay,
    })
    .from(autopayEnrollments)
    .innerJoin(units, eq(units.id, autopayEnrollments.unitId))
    .where(eq(autopayEnrollments.status, "active"))
  ```
- For each enrollment:
  a. Calculate days until due: `rentDueDay - today.getDate()`
  b. If daysUntilDue !== 3, skip (only notify exactly 3 days before)
  c. Idempotency: check if a notification with type "system" and title containing "Autopay charge" was already sent today for this user
  d. Calculate fee based on paymentMethodType using calculateCardFee/calculateAchFee
  e. Send notification via sendNotification:
     - type: "system" (or add "autopay_precharge" to the notification type enum if preferred — but "system" works fine)
     - title: "Autopay charge in 3 days"
     - body: "Your autopay charge of {total} ({rent} + {fee} fee) for Unit {unitNumber} will process on {chargeDate}."
     - channels: ["in_app", "email", "sms"]
     - emailHtml: render AutopayChargeEmail template
- Return: `{ notified: number, skipped: number, errors: number }`

3. Create POST /api/cron/autopay-charge — autopay charge cron:
- CRON_SECRET bearer token validation
- Query all active autopay enrollments joined with units:
  ```typescript
  const enrollments = await db
    .select({
      enrollmentId: autopayEnrollments.id,
      tenantUserId: autopayEnrollments.tenantUserId,
      unitId: autopayEnrollments.unitId,
      stripeCustomerId: autopayEnrollments.stripeCustomerId,
      stripePaymentMethodId: autopayEnrollments.stripePaymentMethodId,
      paymentMethodType: autopayEnrollments.paymentMethodType,
      status: autopayEnrollments.status,
      unitNumber: units.unitNumber,
      rentAmountCents: units.rentAmountCents,
      rentDueDay: units.rentDueDay,
    })
    .from(autopayEnrollments)
    .innerJoin(units, eq(units.id, autopayEnrollments.unitId))
    .where(eq(autopayEnrollments.status, "active"))
  ```
- For each enrollment:
  a. Check if today is the rent due day: `today.getDate() === enrollment.rentDueDay`. If not, skip.
  b. Skip if rent not configured: `if (!enrollment.rentAmountCents || !enrollment.rentDueDay) skip`
  c. **Auto-skip if already paid**: Check payments table for existing succeeded payment in current billing period:
     ```typescript
     const currentPeriod = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}`
     const [alreadyPaid] = await db.select({ id: payments.id }).from(payments)
       .where(and(
         eq(payments.tenantUserId, enrollment.tenantUserId),
         eq(payments.unitId, enrollment.unitId),
         eq(payments.billingPeriod, currentPeriod),
         eq(payments.status, "succeeded"),
       )).limit(1)
     if (alreadyPaid) { skipped++; continue }
     ```
  d. Calculate total with fees:
     ```typescript
     const feeCents = enrollment.paymentMethodType === "card"
       ? calculateCardFee(enrollment.rentAmountCents)
       : calculateAchFee(enrollment.rentAmountCents)
     const totalCents = enrollment.rentAmountCents + feeCents
     ```
  e. Create PaymentIntent (off-session):
     ```typescript
     const paymentIntent = await stripe.paymentIntents.create({
       amount: totalCents,
       currency: "usd",
       customer: enrollment.stripeCustomerId,
       payment_method: enrollment.stripePaymentMethodId,
       off_session: true,
       confirm: true,
       metadata: {
         tenantUserId: enrollment.tenantUserId,
         unitId: enrollment.unitId,
         billingPeriod: currentPeriod,
         autopay: "true",
         feeCents: String(feeCents),
       },
     })
     ```
  f. On success (paymentIntent.status === "succeeded"):
     - Insert payment record with status "succeeded", paymentMethod from enrollment type, paidAt = new Date()
     - Update enrollment: lastChargeAt = new Date(), recalculate nextChargeDate
     - charged++
  g. On requires_action or requires_payment_method (charge failed):
     - Insert payment record with status "failed"
     - Notify tenant: "Your autopay charge failed. We'll retry in 2 days. You can also pay manually."
     - Do NOT immediately mark enrollment as failed — the retry cron will handle that
     - For retry tracking: store a note in the payment record or use the enrollment's status
     - On the SECOND failure (check if there's already a failed autopay payment in this period):
       - Update enrollment status to "payment_failed"
       - Notify admin (in-app only): "Autopay charge failed twice for Tenant {name}, Unit {unitNumber}"
       - Notify tenant: "Your autopay has been paused due to payment failure. Please update your payment method or pay manually."
     - failed++
  h. Wrap each enrollment processing in try/catch
- Return: `{ charged: number, skipped: number, failed: number, errors: number }`

Important: The retry logic works by the cron running daily. On the due day, it charges. If it fails, the payment record has status "failed" with billingPeriod and metadata autopay: "true". Two days later (dueDay + 2), the cron should also check for pending retries. Add logic: if today is NOT the due day, check if today is dueDay + 2 and there's a failed autopay payment from this period — if so, retry.

Important: Use an idempotency key for Stripe PaymentIntent creation to prevent duplicate charges if cron runs twice: `idempotency_key: \`autopay-${enrollment.tenantUserId}-${currentPeriod}\`` (and for retry: `\`autopay-retry-${enrollment.tenantUserId}-${currentPeriod}\``).
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>Autopay notification cron sends 3-day pre-charge alerts via all channels. Autopay charge cron creates off-session PaymentIntents, skips already-paid tenants, handles failures with 2-day retry, and marks enrollment as failed after second failure. Email template renders pre-charge notification.</done>
</task>

<task type="auto">
  <name>Task 2: Update Stripe webhook for autopay PaymentIntent events</name>
  <files>src/app/api/webhooks/stripe/route.ts</files>
  <action>
Update the existing Stripe webhook at src/app/api/webhooks/stripe/route.ts to handle PaymentIntent events from autopay charges:

1. Add new cases to the switch statement for PaymentIntent events:

```typescript
case "payment_intent.succeeded": {
  const paymentIntent = event.data.object as Stripe.PaymentIntent
  const { tenantUserId, unitId, billingPeriod, autopay } = paymentIntent.metadata || {}

  // Only handle autopay payments (one-time payments use checkout.session events)
  if (autopay !== "true") break
  if (!tenantUserId || !unitId || !billingPeriod) break

  // Update payment record from "pending" to "succeeded" if it exists
  // (The cron may have already recorded it as succeeded for instant card payments,
  //  but ACH payments arrive async)
  await db.update(payments)
    .set({
      status: "succeeded",
      paidAt: new Date(),
      stripePaymentIntentId: paymentIntent.id,
      updatedAt: new Date(),
    })
    .where(and(
      eq(payments.tenantUserId, tenantUserId),
      eq(payments.unitId, unitId),
      eq(payments.billingPeriod, billingPeriod),
      eq(payments.status, "pending"),
    ))

  // Send payment confirmation
  await sendPaymentConfirmation(tenantUserId, unitId, paymentIntent.amount, billingPeriod)
  break
}

case "payment_intent.payment_failed": {
  const paymentIntent = event.data.object as Stripe.PaymentIntent
  const { tenantUserId, unitId, billingPeriod, autopay } = paymentIntent.metadata || {}

  if (autopay !== "true") break
  if (!tenantUserId || !unitId || !billingPeriod) break

  // Update payment record to "failed"
  await db.update(payments)
    .set({ status: "failed", updatedAt: new Date() })
    .where(and(
      eq(payments.tenantUserId, tenantUserId),
      eq(payments.unitId, unitId),
      eq(payments.billingPeriod, billingPeriod),
      eq(payments.status, "pending"),
    ))
  break
}
```

2. Add the necessary imports at the top:
- Import `sendNotification` from `@/lib/notifications` (if not already imported)
- Import `autopayEnrollments` from `@/db/schema/domain` (if needed for updates)
- The `payments` and `user` imports should already exist

3. Make sure the existing `sendPaymentConfirmation` helper function is called for autopay succeeded events too, so tenants get email confirmation.

Important: The webhook should return 200 even on handler errors (existing pattern) to prevent Stripe retries. The existing try/catch pattern handles this — just add the new cases inside the existing switch.

Important: Check for `autopay: "true"` in metadata to distinguish autopay PaymentIntents from any future one-time PaymentIntents. Current one-time payments use Checkout Sessions (different event types), so there's no collision risk, but the metadata check is defensive.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>Stripe webhook handles payment_intent.succeeded and payment_intent.payment_failed for autopay charges. Payment records updated, confirmation emails sent. Existing checkout.session handling unchanged.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- POST /api/cron/autopay-notify sends 3-day pre-charge notifications
- POST /api/cron/autopay-charge creates off-session PaymentIntents
- Autopay charge skips tenants who already paid
- Retry logic: first failure notifies tenant, second failure marks enrollment as "payment_failed" and notifies admin
- Fee passthrough: card fees (2.9%+$0.30) and ACH fees (0.8%, $5 cap) added to charge
- Stripe webhook handles payment_intent.succeeded/failed for autopay metadata
- Idempotency keys prevent duplicate charges
</verification>

<success_criteria>
- Pre-charge notifications sent exactly 3 days before due date via all channels
- Charges fire on due day with correct fee calculation
- Already-paid tenants are auto-skipped
- Failed charges trigger one retry after 2 days
- Second failure marks enrollment as "payment_failed" and alerts admin
- Stripe webhook correctly processes async autopay payment results
- All cron routes protected by CRON_SECRET
</success_criteria>

<output>
After completion, create `.planning/phases/06-autopay-and-polish/06-03-SUMMARY.md`
</output>
