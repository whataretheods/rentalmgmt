---
phase: 05-notifications-and-messaging
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/tenant/ProfileForm.tsx
  - src/app/api/profile/route.ts
  - src/app/api/webhooks/twilio/route.ts
autonomous: true
requirements:
  - NOTIF-03

must_haves:
  truths:
    - "Tenant can toggle SMS opt-in on their profile page with TCPA disclosure text visible"
    - "TCPA consent timestamp is recorded when tenant opts in"
    - "Twilio STOP webhook updates user smsOptIn to false"
    - "Twilio START webhook updates user smsOptIn to true with new timestamp"
    - "Webhook validates Twilio request signature before processing"
  artifacts:
    - path: "src/components/tenant/ProfileForm.tsx"
      provides: "SMS opt-in checkbox with TCPA disclosure"
      contains: "smsOptIn"
    - path: "src/app/api/profile/route.ts"
      provides: "Extended profile API returning and accepting smsOptIn field"
      contains: "smsOptIn"
    - path: "src/app/api/webhooks/twilio/route.ts"
      provides: "Twilio inbound SMS webhook for STOP/START handling"
      exports: ["POST"]
  key_links:
    - from: "src/components/tenant/ProfileForm.tsx"
      to: "/api/profile"
      via: "PATCH request with smsOptIn field"
      pattern: "smsOptIn"
    - from: "src/app/api/webhooks/twilio/route.ts"
      to: "src/db/schema/auth.ts"
      via: "db.update(user) on STOP/START"
      pattern: "db\\.update\\(user\\)"
---

<objective>
Add SMS opt-in capability to the tenant profile page and create the Twilio inbound webhook for STOP/START keyword handling.

Purpose: TCPA compliance requires documented opt-in consent before sending SMS. The opt-in toggle with disclosure text provides the consent mechanism, and the Twilio webhook ensures STOP/START keywords sync to the database.

Output: SMS opt-in section on profile page, extended profile API, Twilio webhook endpoint.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-notifications-and-messaging/05-RESEARCH.md
@.planning/phases/05-notifications-and-messaging/05-01-SUMMARY.md

@src/components/tenant/ProfileForm.tsx
@src/app/api/profile/route.ts
@src/db/schema/auth.ts

<interfaces>
From src/db/schema/auth.ts:
```typescript
export const user = pgTable("user", {
  id: text("id").primaryKey(),
  phone: text("phone"),
  smsOptIn: boolean("sms_opt_in").default(false),
  smsOptInAt: text("sms_opt_in_at"),
  // ... other fields
})
```

From src/app/api/profile/route.ts:
```typescript
// GET returns: { name, email, phone, emergencyContact }
// PATCH accepts: { name?, phone?, emergencyContact? }
// Both validate session via auth.api.getSession
```

From src/components/tenant/ProfileForm.tsx:
```typescript
interface ProfileData {
  name: string
  email: string
  phone: string | null
  emergencyContact: { contactName: string; contactPhone: string } | null
}
// Three card sections: Personal Information, Email Address, Emergency Contact
// Uses: useState, useEffect, fetch to /api/profile
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SMS opt-in to profile page and API</name>
  <files>src/components/tenant/ProfileForm.tsx, src/app/api/profile/route.ts</files>
  <action>
1. Extend the profile API (src/app/api/profile/route.ts):
   - GET: Add `smsOptIn` and `phone` to the returned data. `smsOptIn` comes from `userTable.smsOptIn`. Return `smsOptIn: userData?.smsOptIn ?? false`.
   - PATCH: Accept a new optional field `smsOptIn: boolean`. When `smsOptIn` is true AND it was previously false (or first time), also set `smsOptInAt` to `new Date().toISOString()`. When `smsOptIn` is false, set `smsOptIn` to false but do NOT clear `smsOptInAt` (keep the historical record). Add `smsOptIn` to the response as well.
   - Important: smsOptIn can only be set to true if the user has a phone number. If `smsOptIn: true` is sent but user has no phone, return 400 with "Phone number required for SMS opt-in".

2. Extend ProfileForm.tsx (src/components/tenant/ProfileForm.tsx):
   - Update the ProfileData interface to include `smsOptIn: boolean`.
   - Add a new Card section AFTER the Personal Information card titled "SMS Notifications" with a MessageSquare icon from lucide-react.
   - The card contains:
     a. A checkbox (use a standard HTML `<input type="checkbox">` styled with Tailwind, or a shadcn Switch component if available) for SMS opt-in.
     b. TCPA disclosure text below the checkbox: "By enabling SMS notifications, you agree to receive text messages from RentalMgmt about rent reminders and property announcements. Message and data rates may apply. Reply STOP to any message to opt out at any time."
     c. A note that says "You must have a phone number on file to enable SMS notifications." if phone is empty.
     d. The checkbox is disabled if phone is null/empty.
     e. When toggled, immediately PATCH to /api/profile with `{ smsOptIn: newValue }`. Show toast on success/error.
   - Initialize smsOptIn state from fetched profile data.
   - The checkbox label should be: "Enable SMS notifications"
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>Profile page shows SMS opt-in card with TCPA disclosure. Toggling the checkbox saves smsOptIn via profile API. smsOptInAt timestamp is recorded on opt-in. Checkbox is disabled when no phone number is set.</done>
</task>

<task type="auto">
  <name>Task 2: Create Twilio inbound SMS webhook for STOP/START</name>
  <files>src/app/api/webhooks/twilio/route.ts</files>
  <action>
Create src/app/api/webhooks/twilio/route.ts that handles Twilio inbound SMS webhooks:

1. Export a POST handler.

2. Validate the Twilio request signature:
   - Import `Twilio` from "twilio" (the SDK provides `Twilio.validateRequest` as a static method -- actually import `{ validateRequest } from "twilio"` or use `import twilio from "twilio"` and call `twilio.validateRequest()`).
   - Get the `x-twilio-signature` header.
   - Build the webhook URL from `process.env.NEXT_PUBLIC_APP_URL + "/api/webhooks/twilio"`.
   - Parse the form-encoded body with `req.formData()`, then convert to a Record<string, string> for validation.
   - Call `validateRequest(process.env.TWILIO_AUTH_TOKEN!, signature, url, params)`.
   - If invalid, return 403 `{ error: "Invalid signature" }`.

3. Check `params.OptOutType`:
   - If "STOP": update user where `user.phone = params.From`, set `smsOptIn = false`.
   - If "START": update user where `user.phone = params.From`, set `smsOptIn = true, smsOptInAt = new Date().toISOString()`.
   - If "HELP" or other: no-op (Twilio handles the HELP response automatically).

4. Return an empty TwiML response:
   ```typescript
   return new Response(
     '<?xml version="1.0" encoding="UTF-8"?><Response></Response>',
     { headers: { "Content-Type": "text/xml" } }
   )
   ```

5. Important: The phone number from Twilio is in E.164 format (+1XXXXXXXXXX). The user.phone field may be stored in various formats. Use a normalized comparison -- match on the phone field directly (the profile form should store in a consistent format, and the webhook uses the E.164 from Twilio).

6. Update the middleware.ts matcher to also exclude `/api/webhooks/twilio` from auth checks. The current matcher `"/((?!api/auth|_next/static|_next/image|favicon.ico).*)"` needs to be updated to: `"/((?!api/auth|api/webhooks|_next/static|_next/image|favicon.ico).*)"`. This also future-proofs for any other webhook routes.

WAIT -- check the middleware first. The current matcher already excludes `api/auth` but the Twilio webhook is at `api/webhooks/twilio`. The Stripe webhook is at `api/webhooks/stripe` and must already work. Let me check -- the middleware only does cookie-based redirect for `/tenant/*` and `/admin/*` routes. The `/api/webhooks/*` routes are not in the protected route check (`pathname.startsWith("/tenant") || pathname.startsWith("/admin")`), so they already pass through middleware without redirect. No middleware change needed.

However, the API route itself must NOT call `auth.api.getSession()` -- it uses Twilio signature validation instead. This is correct as designed.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>Twilio webhook at /api/webhooks/twilio validates request signatures and syncs STOP/START opt-out state to the user table. Returns empty TwiML response.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Profile page renders SMS opt-in card with TCPA disclosure text
- Twilio webhook route exists and type-checks
- Profile API returns and accepts smsOptIn field
</verification>

<success_criteria>
- Tenant profile page has SMS opt-in checkbox with TCPA disclosure
- Checkbox disabled when no phone number is on file
- Toggling checkbox persists smsOptIn and records smsOptInAt timestamp
- Twilio webhook validates signatures and updates smsOptIn on STOP/START
- Webhook returns valid TwiML response
</success_criteria>

<output>
After completion, create `.planning/phases/05-notifications-and-messaging/05-02-SUMMARY.md`
</output>
