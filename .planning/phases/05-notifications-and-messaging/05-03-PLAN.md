---
phase: 05-notifications-and-messaging
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/api/notifications/route.ts
  - src/app/api/notifications/[id]/read/route.ts
  - src/app/api/admin/notifications/route.ts
  - src/app/(tenant)/tenant/notifications/page.tsx
  - src/app/(admin)/admin/notifications/page.tsx
  - src/components/ui/NotificationBell.tsx
  - src/app/(tenant)/layout.tsx
  - src/app/(admin)/layout.tsx
autonomous: true
requirements:
  - NOTIF-04

must_haves:
  truths:
    - "Tenant can view a chronological list of their notifications"
    - "Admin can view a chronological list of their notifications"
    - "Tenant and admin see an unread count badge on a bell icon in the header"
    - "Tenant can mark a notification as read"
    - "Unread count updates after marking notifications as read"
  artifacts:
    - path: "src/app/api/notifications/route.ts"
      provides: "GET endpoint for tenant notifications (paginated)"
      exports: ["GET"]
    - path: "src/app/api/notifications/[id]/read/route.ts"
      provides: "PATCH endpoint to mark notification as read"
      exports: ["PATCH"]
    - path: "src/app/api/admin/notifications/route.ts"
      provides: "GET endpoint for admin notifications (paginated)"
      exports: ["GET"]
    - path: "src/app/(tenant)/tenant/notifications/page.tsx"
      provides: "Tenant notification inbox page"
    - path: "src/app/(admin)/admin/notifications/page.tsx"
      provides: "Admin notification inbox page"
    - path: "src/components/ui/NotificationBell.tsx"
      provides: "Bell icon with unread count badge"
    - path: "src/app/(tenant)/layout.tsx"
      provides: "Updated tenant layout with notification bell"
    - path: "src/app/(admin)/layout.tsx"
      provides: "Updated admin layout with notification bell"
  key_links:
    - from: "src/app/api/notifications/route.ts"
      to: "src/lib/notifications.ts"
      via: "getNotificationsForUser helper"
      pattern: "getNotificationsForUser"
    - from: "src/components/ui/NotificationBell.tsx"
      to: "/api/notifications"
      via: "fetch for unread count"
      pattern: "fetch.*notifications"
    - from: "src/app/(tenant)/layout.tsx"
      to: "src/components/ui/NotificationBell.tsx"
      via: "Bell component in header"
      pattern: "NotificationBell"
---

<objective>
Build the in-app notification inbox for both tenant and admin portals, with notification API routes and a bell icon showing unread count in layout headers.

Purpose: NOTIF-04 requires that both tenant and admin can view a chronological notification inbox. This is the primary way users discover notifications they have received via the system.

Output: Notification inbox pages, API routes, bell component, updated layouts.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-notifications-and-messaging/05-RESEARCH.md
@.planning/phases/05-notifications-and-messaging/05-01-SUMMARY.md

@src/app/(tenant)/layout.tsx
@src/app/(admin)/layout.tsx
@src/lib/notifications.ts

<interfaces>
From src/lib/notifications.ts (created in Plan 01):
```typescript
export interface NotificationPayload {
  userId: string
  type: "rent_reminder" | "payment_confirmation" | "broadcast" | "maintenance_update" | "system"
  title: string
  body: string
  emailHtml?: string
  channels: ("in_app" | "email" | "sms")[]
}

export async function sendNotification(payload: NotificationPayload): Promise<NotificationRecord>
export async function getNotificationsForUser(userId: string, options?: { unreadOnly?: boolean, limit?: number, offset?: number }): Promise<NotificationRecord[]>
export async function markNotificationRead(notificationId: string, userId: string): Promise<void>
export async function getUnreadCount(userId: string): Promise<number>
```

From src/app/(tenant)/layout.tsx:
```typescript
// Server Component layout with session validation
// Header: <span>Tenant Portal</span> ... <span>{session.user.email}</span>
// Must add NotificationBell to header between portal name and email
```

From src/app/(admin)/layout.tsx:
```typescript
// Server Component layout with session + admin role validation
// Header: <span>Admin Portal</span> ... <span>{session.user.email}</span>
// Must add NotificationBell to header between portal name and email
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification API routes</name>
  <files>src/app/api/notifications/route.ts, src/app/api/notifications/[id]/read/route.ts, src/app/api/admin/notifications/route.ts</files>
  <action>
1. Create GET /api/notifications (src/app/api/notifications/route.ts):
   - Validate session via `auth.api.getSession({ headers: await headers() })`. Return 401 if not authenticated.
   - Parse optional query params: `unreadOnly` (boolean, default false), `limit` (number, default 20, max 50), `offset` (number, default 0).
   - Call `getNotificationsForUser(session.user.id, { unreadOnly, limit, offset })`.
   - Also call `getUnreadCount(session.user.id)`.
   - Return JSON: `{ notifications: [...], unreadCount: number }`.

2. Create PATCH /api/notifications/[id]/read (src/app/api/notifications/[id]/read/route.ts):
   - Validate session. Return 401 if not authenticated.
   - Extract notification `id` from the route params.
   - Call `markNotificationRead(id, session.user.id)`.
   - Return 200 `{ success: true }`.

3. Create GET /api/admin/notifications (src/app/api/admin/notifications/route.ts):
   - Validate session AND role === "admin". Return 401/403 if not.
   - Same query param handling as the tenant route.
   - Call `getNotificationsForUser(session.user.id, { unreadOnly, limit, offset })`.
   - Also call `getUnreadCount(session.user.id)`.
   - Return JSON: `{ notifications: [...], unreadCount: number }`.
   - Note: Admin notifications are just the admin user's own notifications (broadcast confirmations, system events). This uses the same helper since notifications are per-userId.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>Three API routes exist: GET /api/notifications (tenant), PATCH /api/notifications/[id]/read, GET /api/admin/notifications. All validate auth and return paginated notifications with unread count.</done>
</task>

<task type="auto">
  <name>Task 2: Create notification inbox pages, bell component, and update layouts</name>
  <files>src/components/ui/NotificationBell.tsx, src/app/(tenant)/tenant/notifications/page.tsx, src/app/(admin)/admin/notifications/page.tsx, src/app/(tenant)/layout.tsx, src/app/(admin)/layout.tsx</files>
  <action>
1. Create NotificationBell component (src/components/ui/NotificationBell.tsx):
   - "use client" component.
   - Props: `apiUrl: string` (either "/api/notifications" or "/api/admin/notifications"), `inboxUrl: string` (either "/tenant/notifications" or "/admin/notifications").
   - On mount, fetch `GET {apiUrl}?unreadOnly=true&limit=1` to get just the unreadCount.
   - Display a Bell icon from lucide-react.
   - If unreadCount > 0, show a small red badge with the count (positioned absolute, top-right of the bell icon). Cap display at "9+" for counts over 9.
   - The bell is wrapped in a Link to the inboxUrl.
   - Refetch on visibility change (when user tabs back) using `document.addEventListener("visibilitychange")`. Clean up listener on unmount.
   - Style: `relative inline-flex items-center` for the wrapper. Badge: `absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center`.

2. Create tenant notifications page (src/app/(tenant)/tenant/notifications/page.tsx):
   - "use client" page.
   - Fetch GET /api/notifications on mount (limit 20).
   - Display chronological list of notifications in Card components.
   - Each notification card shows: title (bold), body (gray text), type badge (small colored pill), timestamp (relative time like "2 hours ago" or formatted date), and read/unread indicator (blue dot for unread).
   - Clicking an unread notification calls PATCH /api/notifications/[id]/read and updates local state (remove the blue dot).
   - "Load more" button at bottom if there are more notifications (offset-based pagination).
   - Empty state: "No notifications yet" with a Bell icon.
   - Add a "Mark all as read" button at the top that iterates over unread notifications and marks them read. Use Promise.all for the PATCH calls.
   - Include a back link to /tenant/dashboard.

3. Create admin notifications page (src/app/(admin)/admin/notifications/page.tsx):
   - Same structure as tenant notifications page but fetches from /api/admin/notifications.
   - Include a back link to /admin/dashboard.

4. Update tenant layout (src/app/(tenant)/layout.tsx):
   - Add NotificationBell to the header between the "Tenant Portal" text and the user email.
   - The layout is a Server Component, so wrap the bell in a client boundary. Import NotificationBell and render it with `apiUrl="/api/notifications" inboxUrl="/tenant/notifications"`.
   - Also add navigation links to the header for: Dashboard, Payments, Maintenance, Documents, Profile, Notifications. Use a simple horizontal nav below the header bar, or integrate into the existing header as inline links. Keep it minimal -- a `<nav>` element with Links styled as `text-sm text-gray-600 hover:text-gray-900`.

5. Update admin layout (src/app/(admin)/layout.tsx):
   - Same bell addition with `apiUrl="/api/admin/notifications" inboxUrl="/admin/notifications"`.
   - Add navigation links for: Dashboard, Units, Payments, Maintenance, Documents, Users, Invites, Notifications, Broadcast.

Important: The layouts are Server Components. NotificationBell is a Client Component. This is fine in Next.js -- Server Components can render Client Components as children. Just import and use directly.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>Tenant and admin have notification inbox pages at /tenant/notifications and /admin/notifications. Bell icon with unread badge is visible in both layout headers. Notifications can be marked as read individually or all at once. Navigation links added to both layouts.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Tenant layout header shows bell icon
- Admin layout header shows bell icon
- /tenant/notifications page renders notification list
- /admin/notifications page renders notification list
</verification>

<success_criteria>
- Both tenant and admin see a bell icon with unread count in their portal header
- Clicking the bell navigates to the notifications inbox
- Inbox shows chronological notifications with type, title, body, timestamp
- Unread notifications have a visual indicator (blue dot)
- Clicking an unread notification marks it as read
- "Mark all as read" button works
- Pagination via "Load more" button
</success_criteria>

<output>
After completion, create `.planning/phases/05-notifications-and-messaging/05-03-SUMMARY.md`
</output>
