---
phase: 05-notifications-and-messaging
plan: 05
type: execute
wave: 3
depends_on: ["05-01", "05-03"]
files_modified:
  - src/app/api/admin/broadcast/route.ts
  - src/app/(admin)/admin/broadcast/page.tsx
  - src/components/admin/BroadcastForm.tsx
  - src/emails/BroadcastEmail.tsx
  - e2e/notifications.spec.ts
  - scripts/seed-notifications-test.ts
autonomous: true
requirements:
  - NOTIF-05
  - NOTIF-01
  - NOTIF-03
  - NOTIF-04

must_haves:
  truths:
    - "Admin can compose a message with subject, body, and recipient filter (all tenants or specific units)"
    - "Admin can select channels for broadcast (email, SMS, or both)"
    - "Broadcast creates notification records for each recipient"
    - "Broadcast sends email via Resend batch API"
    - "Broadcast sends SMS only to tenants with smsOptIn and phone number"
    - "E2E tests verify core notification flows"
  artifacts:
    - path: "src/app/api/admin/broadcast/route.ts"
      provides: "POST endpoint for admin bulk messaging"
      exports: ["POST"]
    - path: "src/app/(admin)/admin/broadcast/page.tsx"
      provides: "Admin broadcast compose page"
    - path: "src/components/admin/BroadcastForm.tsx"
      provides: "Broadcast compose form with recipient and channel selection"
    - path: "src/emails/BroadcastEmail.tsx"
      provides: "Styled email template for broadcast messages"
    - path: "e2e/notifications.spec.ts"
      provides: "E2E test suite for Phase 5 notification features"
    - path: "scripts/seed-notifications-test.ts"
      provides: "Seed script for notification test data"
  key_links:
    - from: "src/app/api/admin/broadcast/route.ts"
      to: "src/lib/notifications.ts"
      via: "sendNotification per recipient"
      pattern: "sendNotification"
    - from: "src/app/api/admin/broadcast/route.ts"
      to: "src/lib/resend.ts"
      via: "resend.batch.send for email delivery"
      pattern: "batch\\.send"
    - from: "src/components/admin/BroadcastForm.tsx"
      to: "/api/admin/broadcast"
      via: "POST request on form submit"
      pattern: "fetch.*broadcast"
---

<objective>
Build the admin broadcast messaging feature and create the E2E test suite verifying all Phase 5 notification features.

Purpose: NOTIF-05 requires admin bulk messaging capability. The E2E tests verify all four notification requirements (NOTIF-01, NOTIF-03, NOTIF-04, NOTIF-05) to complete the phase.

Output: Admin broadcast page and API, E2E test suite with seed data.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-notifications-and-messaging/05-RESEARCH.md
@.planning/phases/05-notifications-and-messaging/05-01-SUMMARY.md
@.planning/phases/05-notifications-and-messaging/05-03-SUMMARY.md

@src/lib/notifications.ts
@src/lib/resend.ts
@src/lib/twilio.ts
@e2e/payments.spec.ts

<interfaces>
From src/lib/notifications.ts:
```typescript
export async function sendNotification(payload: NotificationPayload): Promise<NotificationRecord>
export async function getNotificationsForUser(userId: string, options?): Promise<NotificationRecord[]>
```

From src/lib/resend.ts:
```typescript
export const resend = new Proxy({} as Resend, { ... })
// resend.batch.send([...]) sends up to 100 emails per call
```

From e2e/payments.spec.ts (test pattern):
```typescript
const BASE_URL = "http://localhost:3000"
const TENANT_EMAIL = process.env.TEST_TENANT_EMAIL || "testtenant@test.com"
const TENANT_PASSWORD = process.env.TEST_TENANT_PASSWORD || "TestPass123!"
// beforeEach: login via form fill, wait for dashboard redirect
```

From src/db/schema/domain.ts:
```typescript
export const tenantUnits = pgTable("tenant_units", { ... })
export const units = pgTable("units", { ... })
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin broadcast API route and page</name>
  <files>src/app/api/admin/broadcast/route.ts, src/app/(admin)/admin/broadcast/page.tsx, src/components/admin/BroadcastForm.tsx, src/emails/BroadcastEmail.tsx</files>
  <action>
1. Create POST /api/admin/broadcast (src/app/api/admin/broadcast/route.ts):
   - Validate session + admin role. Return 401/403 if not authorized.
   - Accept JSON body: `{ subject: string, body: string, recipients: "all" | string[], channels: ("email" | "sms")[] }`.
     - `recipients`: "all" sends to all active tenants. Array of unit IDs sends to tenants in those specific units.
     - `channels`: which external channels to use. In-app notification is ALWAYS created regardless.
   - Validate with zod: subject required (1-200 chars), body required (1-2000 chars), channels non-empty array, recipients is "all" or string array.
   - Resolve recipient user IDs:
     - If "all": query all active tenantUnits, get unique userIds.
     - If unit IDs array: query tenantUnits where unitId IN array and isActive = true.
   - For each recipient, call `sendNotification({ userId, type: "broadcast", title: subject, body, channels: ["in_app", ...channels] })`.
   - For email efficiency: instead of N individual emails via sendNotification, use `resend.batch.send()` directly for the email portion. Collect all recipient emails, batch them (up to 100 per call). Still create individual sendNotification calls for in_app + SMS channels.
   - Actually, simpler approach for 5 tenants: just loop sendNotification for each user. The batch optimization is unnecessary for this scale. sendNotification handles email fire-and-forget internally.
   - Also create a notification for the admin user themselves as a "broadcast sent" confirmation (type: "system", title: "Broadcast Sent", body: `Sent "${subject}" to ${count} recipients`).
   - Return JSON: `{ sent: number, recipients: string[] }`.

2. Create BroadcastEmail template (src/emails/BroadcastEmail.tsx):
   - Uses @react-email/components: Html, Head, Body, Container, Section, Text, Hr, Preview.
   - Props: `{ subject: string, body: string, fromName: string }`.
   - Simple layout: header with "Message from your landlord", body text, footer with "This message was sent via RentalMgmt."
   - Export default component and a `renderBroadcastEmail(props)` function.

3. Create BroadcastForm component (src/components/admin/BroadcastForm.tsx):
   - "use client" component.
   - Form fields:
     a. Subject: text input, required.
     b. Body: textarea, required.
     c. Recipients: radio group -- "All Tenants" (default) or "Specific Units". If "Specific Units", show a multi-select of available units (fetch from GET /api/admin/units on mount).
     d. Channels: checkbox group -- "Email" (default checked), "SMS" (unchecked by default, with note: "SMS will only be sent to tenants who have opted in").
   - Submit button: "Send Broadcast". Show loading state while sending.
   - On submit: POST to /api/admin/broadcast. Show success toast with recipient count. Reset form on success.
   - Show error toast on failure.

4. Create admin broadcast page (src/app/(admin)/admin/broadcast/page.tsx):
   - Simple page with title "Send Broadcast Message", description "Send a message to all tenants or specific units via email and SMS."
   - Render BroadcastForm component.
   - Back link to /admin/dashboard.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>Admin broadcast page at /admin/broadcast with compose form. POST /api/admin/broadcast sends notifications to selected recipients via chosen channels. Admin receives confirmation notification. BroadcastEmail template renders styled HTML.</done>
</task>

<task type="auto">
  <name>Task 2: Create E2E test suite and seed script</name>
  <files>scripts/seed-notifications-test.ts, e2e/notifications.spec.ts</files>
  <action>
1. Create seed script (scripts/seed-notifications-test.ts):
   - Follow the existing seed script pattern: use `import { config } from "dotenv"; config({ path: ".env.local" })` at the top, then import db and schema.
   - Seed test data:
     a. Ensure the test tenant (from TEST_TENANT_EMAIL or "testtenant@test.com") has a phone number and smsOptIn = true with smsOptInAt set.
     b. Create 3 sample notifications for the test tenant: one rent_reminder (unread), one broadcast (read), one system (unread). Use `db.insert(notifications)`.
     c. Create 1 sample notification for an admin user (find admin by role): a system notification.
   - Use idempotent inserts (check before insert or use onConflictDoNothing where possible).
   - Add npm script `"seed:phase5-test"` in package.json: `"tsx -r tsconfig-paths/register scripts/seed-notifications-test.ts"`.

2. Create E2E test suite (e2e/notifications.spec.ts):
   - Follow the existing E2E pattern from e2e/payments.spec.ts: BASE_URL, env var credentials, beforeEach login.
   - Test groups:

   **a. Notification Inbox (NOTIF-04):**
   - "tenant can view notification inbox": Navigate to /tenant/notifications, verify at least one notification is visible (from seed data), check that title and body text are rendered.
   - "tenant can see unread indicator": Verify the unread notification has a visual indicator (blue dot or similar data attribute).
   - "tenant notification bell shows unread count": On any tenant page (e.g., dashboard), verify the NotificationBell component shows a badge with count > 0.

   **b. SMS Opt-In (NOTIF-03):**
   - "tenant can see SMS opt-in on profile": Navigate to /tenant/profile, verify SMS Notifications card is visible with TCPA disclosure text.
   - "tenant SMS opt-in checkbox reflects current state": Verify the checkbox state matches the seeded smsOptIn value.

   **c. Rent Reminders (NOTIF-01):**
   - "cron endpoint rejects unauthorized requests": Call POST /api/cron/rent-reminders without bearer token, expect 401.
   - "cron endpoint accepts authorized requests": Call POST /api/cron/rent-reminders with correct CRON_SECRET bearer token, expect 200. Verify response has `sent` field.

   **d. Admin Broadcast (NOTIF-05):**
   - Test requires admin login. Create a separate describe block with admin login in beforeEach.
   - "admin can view broadcast page": Navigate to /admin/broadcast, verify compose form is visible with subject, body, recipients, and channels fields.
   - "admin can send broadcast": Fill in subject and body, select "All Tenants" and "Email" channel, submit. Verify success toast appears.
   - "admin notification inbox shows broadcast confirmation": Navigate to /admin/notifications, verify a "Broadcast Sent" system notification exists.

   Important: Use `page.waitForLoadState("networkidle")` after navigation per project pattern. Use `[data-slot='card-title']` selectors for shadcn/ui Card components per Phase 4 convention.

   Important: For the cron endpoint test, use `page.request.post()` (Playwright's API request context) rather than navigating to the page. Alternatively, use `fetch` in a test helper. Actually, use Playwright's `request` fixture:
   ```typescript
   test("cron endpoint rejects unauthorized requests", async ({ request }) => {
     const response = await request.post(`${BASE_URL}/api/cron/rent-reminders`)
     expect(response.status()).toBe(401)
   })
   ```

   Important: The CRON_SECRET env var must be set in the test environment. Read from process.env.CRON_SECRET. If not set, skip the authorized cron test with `test.skip(!process.env.CRON_SECRET, "CRON_SECRET not set")`.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx playwright test e2e/notifications.spec.ts --list 2>&1 | head -30</automated>
  </verify>
  <done>Seed script creates test notification data. E2E test suite covers NOTIF-01 (cron auth), NOTIF-03 (SMS opt-in UI), NOTIF-04 (inbox viewing, unread indicators, bell badge), NOTIF-05 (admin broadcast compose and send). Tests listed by Playwright without errors.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npx playwright test e2e/notifications.spec.ts --list` lists all test cases
- After running seed: `npm run seed:phase5-test` exits cleanly
- After running tests: `npx playwright test e2e/notifications.spec.ts` all pass
</verification>

<success_criteria>
- Admin broadcast page allows composing and sending messages to all tenants or specific units
- Broadcast creates notification records for each recipient
- Admin receives confirmation notification after sending
- E2E tests pass for all four notification requirements
- Seed script creates reproducible test data
</success_criteria>

<output>
After completion, create `.planning/phases/05-notifications-and-messaging/05-05-SUMMARY.md`
</output>
