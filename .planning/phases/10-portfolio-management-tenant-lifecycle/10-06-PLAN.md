---
phase: 10-portfolio-management-tenant-lifecycle
plan: 06
type: execute
wave: 4
depends_on: ["10-03", "10-04", "10-05"]
files_modified:
  - src/app/(admin)/admin/units/page.tsx
  - e2e/portfolio-management.spec.ts
  - scripts/seed-portfolio.ts
autonomous: true
requirements:
  - PORT-01
  - PORT-02
  - PORT-03
  - PORT-04
  - TUX-01

must_haves:
  truths:
    - "Admin units page includes move-out button for units with active tenants"
    - "E2E tests verify property CRUD, unit CRUD, move-out workflow, past-tenant access, and invite token entry"
    - "Seed script creates test data for portfolio management scenarios"
    - "All existing admin pages filter out archived properties/units in their queries"
  artifacts:
    - path: "src/app/(admin)/admin/units/page.tsx"
      provides: "Units page with move-out integration"
    - path: "e2e/portfolio-management.spec.ts"
      provides: "E2E tests covering all PORT and TUX requirements"
    - path: "scripts/seed-portfolio.ts"
      provides: "Test seed data for portfolio scenarios"
  key_links:
    - from: "src/app/(admin)/admin/units/page.tsx"
      to: "src/components/admin/MoveOutDialog.tsx"
      via: "renders MoveOutDialog for active tenants"
      pattern: "MoveOutDialog"
    - from: "e2e/portfolio-management.spec.ts"
      to: "src/app/api/admin/properties/route.ts"
      via: "tests property CRUD via UI"
      pattern: "properties"
---

<objective>
Integrate the move-out dialog into the admin units page, update existing admin queries to filter archived entities, create E2E tests, and add a seed script for testing.

Purpose: This is the integration and verification plan that ties together all Phase 10 components. The units page needs move-out integration, existing admin pages need archived entity filtering, and E2E tests validate all success criteria.

Output: Move-out in units page, updated admin queries, E2E test suite, seed script.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-portfolio-management-tenant-lifecycle/10-RESEARCH.md
@.planning/phases/10-portfolio-management-tenant-lifecycle/10-03-PLAN.md
@.planning/phases/10-portfolio-management-tenant-lifecycle/10-04-PLAN.md
@.planning/phases/10-portfolio-management-tenant-lifecycle/10-05-PLAN.md

@src/app/(admin)/admin/units/page.tsx
@src/app/(admin)/admin/payments/page.tsx
@src/app/(admin)/admin/invites/page.tsx
@e2e/dashboard.spec.ts

<interfaces>
From Plan 03 (units page is now "use client" with CRUD):
```typescript
// The units page fetches from GET /api/admin/units which returns:
// [{id, unitNumber, propertyId, propertyName, rentAmountCents, rentDueDay, currentTenantName, currentTenantEmail}]
```

From Plan 04 (MoveOutDialog component):
```typescript
import { MoveOutDialog } from "@/components/admin/MoveOutDialog"
// Props: tenant: {userId, name, email}, unit: {id, unitNumber}, onSuccess, trigger
```

Existing E2E test pattern from e2e/dashboard.spec.ts:
```typescript
import { test, expect } from "@playwright/test"

test.describe("Dashboard", () => {
  test("shows tenant dashboard", async ({ page }) => {
    // ... test implementation
  })
})
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate move-out into units page and update existing admin queries</name>
  <files>src/app/(admin)/admin/units/page.tsx, src/app/(admin)/admin/payments/page.tsx, src/app/(admin)/admin/invites/page.tsx, src/app/api/admin/payments-overview/route.ts</files>
  <action>
1. In the units page (src/app/(admin)/admin/units/page.tsx), which was already converted to "use client" in Plan 03:

Add a "Move Out" button for each unit that has a current tenant. The button should open the MoveOutDialog component:

```typescript
import { MoveOutDialog } from "@/components/admin/MoveOutDialog"

// In the unit row, after the edit and archive buttons:
{unit.currentTenantName && (
  <MoveOutDialog
    tenant={{
      userId: unit.currentTenantUserId,
      name: unit.currentTenantName,
      email: unit.currentTenantEmail,
    }}
    unit={{
      id: unit.id,
      unitNumber: unit.unitNumber,
    }}
    onSuccess={fetchUnits}
    trigger={
      <Button variant="outline" size="sm" className="text-red-600 hover:text-red-700">
        Move Out
      </Button>
    }
  />
)}
```

To support this, the GET /api/admin/units response must also include `currentTenantUserId`. Go back to src/app/api/admin/units/route.ts and add the userId to the select:

```typescript
// In the GET handler's select, add:
currentTenantUserId: tenantUnits.userId,
```

2. Update existing admin pages to filter out archived properties/units:

Check the following existing admin pages and ensure they filter `WHERE archivedAt IS NULL`:

**src/app/(admin)/admin/payments/page.tsx** -- If this page queries units or properties, add archivedAt filter. If it only queries payments (which don't have archivedAt), no change needed.

**src/app/(admin)/admin/invites/page.tsx** -- If this page shows unit names for invites, ensure it joins through non-archived units.

**src/app/api/admin/payments-overview/route.ts** -- If this API queries units, add archivedAt filter.

For each file, check if it queries properties or units tables. If it does, add `isNull(table.archivedAt)` to the WHERE clause. If it only queries other tables (payments, inviteTokens, etc.), no change needed.

Important: The existing admin/units page from Plan 03 already filters archived units in the API layer (GET /api/admin/units filters isNull(units.archivedAt)). This task ensures OTHER admin pages that reference units/properties also respect the archivedAt filter.

Important: The move-out button should only appear for units with current tenants. Vacant units show nothing (or "Vacant" text). Archived units are already hidden by the API filter.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>Move-out dialog integrated into units page for occupied units. Existing admin queries updated to filter archived entities. currentTenantUserId added to units API response.</done>
</task>

<task type="auto">
  <name>Task 2: Create E2E tests and seed script for portfolio management</name>
  <files>e2e/portfolio-management.spec.ts, scripts/seed-portfolio.ts</files>
  <action>
1. Create scripts/seed-portfolio.ts -- a seed script that creates test data for portfolio management:

```typescript
import { config } from "dotenv"
config({ path: ".env.local" })

// This script creates:
// - A test property "Test Property"
// - Two units under it: "101" (with tenant) and "102" (vacant)
// - A test tenant linked to unit 101
// - An invite token for unit 102

// Use the existing database connection pattern
// Run with: npx tsx scripts/seed-portfolio.ts
```

The seed script should:
- Create (or find existing) test property
- Create (or find existing) units 101 and 102
- Create (or find existing) a test tenant user via Better Auth sign-up
- Create a tenantUnit linking test tenant to unit 101
- Generate and insert an invite token for unit 102
- Output the test data IDs and invite token for use in E2E tests

Important: Use `config({ path: ".env.local" })` per project convention (from MEMORY.md).

2. Create e2e/portfolio-management.spec.ts with E2E tests:

The tests should cover the core success criteria. Since these tests require authenticated admin and tenant sessions, they need the login flow from the existing E2E test patterns.

```typescript
import { test, expect } from "@playwright/test"

test.describe("Portfolio Management", () => {
  // PORT-01: Property CRUD
  test.describe("Property Management", () => {
    test("admin can create a property", async ({ page }) => {
      // Login as admin
      // Navigate to /admin/properties
      // Click "Add Property"
      // Fill in name and address
      // Submit
      // Verify property appears in list
    })

    test("admin can edit a property", async ({ page }) => {
      // Login as admin
      // Navigate to /admin/properties
      // Click Edit on existing property
      // Change name
      // Submit
      // Verify updated name appears
    })

    test("admin can archive a property", async ({ page }) => {
      // Login as admin
      // Create a vacant property (no active tenants)
      // Click Archive
      // Confirm in dialog
      // Verify property disappears from list
    })
  })

  // PORT-02: Unit CRUD
  test.describe("Unit Management", () => {
    test("admin can create a unit with rent config", async ({ page }) => {
      // Login as admin
      // Navigate to /admin/units
      // Click "Add Unit"
      // Select property, enter unit number, set rent and due day
      // Submit
      // Verify unit appears in list with correct rent
    })

    test("admin can edit unit rent amount", async ({ page }) => {
      // Login as admin
      // Navigate to /admin/units
      // Click Edit on existing unit
      // Change rent amount
      // Submit
      // Verify updated amount
    })
  })

  // PORT-03: Move-out workflow (API test since full flow requires tenant setup)
  test.describe("Move-Out Workflow", () => {
    test("move-out API validates required fields", async ({ request }) => {
      // POST /api/admin/move-out with missing fields
      // Verify 400 response
    })

    test("move-out API rejects non-admin", async ({ request }) => {
      // POST /api/admin/move-out without admin session
      // Verify 401 response
    })
  })

  // PORT-04: Past tenant read-only access
  test.describe("Past Tenant Access", () => {
    test("moved-out tenant sees read-only banner", async ({ page }) => {
      // Login as moved-out tenant
      // Navigate to /tenant/dashboard
      // Verify "Read-only access" banner is visible
      // Verify Pay Rent button is NOT visible
      // Verify payment history IS visible
    })
  })

  // TUX-01: Invite token self-service
  test.describe("Invite Token Entry", () => {
    test("unlinked tenant sees invite entry form", async ({ page }) => {
      // Login as tenant with no unit
      // Navigate to /tenant/dashboard
      // Verify "Enter invite code" form is visible
    })

    test("invite token consumption works", async ({ page }) => {
      // Login as tenant with no unit
      // Enter valid invite token
      // Submit
      // Verify success toast and dashboard refreshes with unit info
    })
  })
})
```

Note: The E2E tests use Playwright's test runner. Some tests may need to be API-level tests (`request` fixture) rather than full browser tests, especially for move-out which requires pre-existing tenant state. Focus on testing the happy paths and key error cases.

Important: E2E tests should be self-contained and not depend on specific database state beyond what the seed script creates. Use the `test.beforeAll` hook to ensure test data exists.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>E2E tests created covering all PORT and TUX requirements. Seed script generates test data for portfolio management scenarios. Move-out integrated into units page.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- Units page shows Move Out button for occupied units
- Existing admin pages filter archived entities
- E2E tests cover property CRUD, unit CRUD, move-out, past-tenant access, invite entry
- Seed script creates necessary test data
</verification>

<success_criteria>
- All 5 success criteria from the roadmap are covered by tests
- Move-out is accessible from the admin units page
- Archived properties/units hidden across all admin views
- Tests can run with `npx playwright test e2e/portfolio-management.spec.ts`
</success_criteria>

<output>
After completion, create `.planning/phases/10-portfolio-management-tenant-lifecycle/10-06-SUMMARY.md`
</output>
