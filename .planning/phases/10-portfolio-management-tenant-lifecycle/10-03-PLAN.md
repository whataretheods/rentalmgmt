---
phase: 10-portfolio-management-tenant-lifecycle
plan: 03
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - src/app/(admin)/admin/properties/page.tsx
  - src/components/admin/PropertyForm.tsx
  - src/app/(admin)/admin/units/page.tsx
  - src/components/admin/UnitForm.tsx
  - src/app/(admin)/layout.tsx
autonomous: true
requirements:
  - PORT-01
  - PORT-02

must_haves:
  truths:
    - "Admin properties page shows a list of active properties with create, edit, and archive actions"
    - "Admin units page shows units grouped or filterable by property with create, edit, and archive actions"
    - "PropertyForm dialog handles both create and edit modes"
    - "UnitForm dialog handles both create and edit modes with rent configuration"
    - "Archive actions show confirmation dialog before proceeding"
    - "Admin sidebar/nav includes Properties link"
  artifacts:
    - path: "src/app/(admin)/admin/properties/page.tsx"
      provides: "Admin property management page"
    - path: "src/components/admin/PropertyForm.tsx"
      provides: "Create/edit property dialog component"
    - path: "src/app/(admin)/admin/units/page.tsx"
      provides: "Enhanced admin unit management page with CRUD"
    - path: "src/components/admin/UnitForm.tsx"
      provides: "Create/edit unit dialog component with rent config"
    - path: "src/app/(admin)/layout.tsx"
      provides: "Admin layout with Properties nav link"
  key_links:
    - from: "src/app/(admin)/admin/properties/page.tsx"
      to: "src/app/api/admin/properties/route.ts"
      via: "fetches property list and creates properties"
      pattern: "/api/admin/properties"
    - from: "src/app/(admin)/admin/units/page.tsx"
      to: "src/app/api/admin/units/route.ts"
      via: "fetches unit list and creates units"
      pattern: "/api/admin/units"
---

<objective>
Build admin UI pages for property and unit management with create, edit, and archive dialogs.

Purpose: PORT-01 and PORT-02 require admin to manage properties and units from the dashboard. The API routes exist from Plans 01 and 02. This plan creates the frontend pages and form components that use those APIs.

Output: Admin properties page, admin units page (enhanced), PropertyForm and UnitForm dialog components, updated admin navigation.
</objective>

<execution_context>
@/Users/odesantos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/odesantos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-portfolio-management-tenant-lifecycle/10-RESEARCH.md
@.planning/phases/10-portfolio-management-tenant-lifecycle/10-01-PLAN.md
@.planning/phases/10-portfolio-management-tenant-lifecycle/10-02-PLAN.md

@src/app/(admin)/admin/units/page.tsx
@src/app/(admin)/layout.tsx
@src/components/admin/RentConfigForm.tsx

<interfaces>
API routes from Plans 01 and 02:
```
GET  /api/admin/properties          -- returns [{id, name, address, unitCount, createdAt}]
POST /api/admin/properties          -- body: {name, address} -> returns property
PUT  /api/admin/properties/[id]     -- body: {name?, address?} -> returns property
DELETE /api/admin/properties/[id]   -- archives property (409 if active tenants)

GET  /api/admin/units               -- returns [{id, unitNumber, propertyId, propertyName, rentAmountCents, rentDueDay, currentTenantName}]
GET  /api/admin/units?propertyId=x  -- filtered by property
POST /api/admin/units               -- body: {propertyId, unitNumber, rentAmountCents?, rentDueDay?} -> returns unit
PUT  /api/admin/units/[id]          -- body: {unitNumber?, rentAmountCents?, rentDueDay?} -> returns unit
DELETE /api/admin/units/[id]        -- archives unit (409 if active tenant)
```

Existing admin layout nav links pattern:
```typescript
<Link href="/admin/dashboard" className="text-sm text-gray-600 hover:text-gray-900">Dashboard</Link>
<Link href="/admin/units" className="text-sm text-gray-600 hover:text-gray-900">Units</Link>
```

shadcn/ui components available: Button, Card, Dialog, Input, Label, Select, AlertDialog, Table
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin properties page and PropertyForm component</name>
  <files>src/app/(admin)/admin/properties/page.tsx, src/components/admin/PropertyForm.tsx, src/app/(admin)/layout.tsx</files>
  <action>
1. Create src/components/admin/PropertyForm.tsx as a "use client" component:

This is a dialog-based form that handles both create and edit modes:
- Props: `mode: "create" | "edit"`, `property?: { id, name, address }` (for edit mode), `onSuccess: () => void`
- Uses shadcn/ui Dialog, Input, Label, Button
- On submit: calls POST /api/admin/properties (create) or PUT /api/admin/properties/[id] (edit)
- Shows loading state during API call
- Shows toast on success/error via sonner
- Calls onSuccess callback to refresh the list

```typescript
"use client"

import { useState } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog"
import { toast } from "sonner"

interface PropertyFormProps {
  mode: "create" | "edit"
  property?: { id: string; name: string; address: string }
  onSuccess: () => void
  trigger: React.ReactNode
}

export function PropertyForm({ mode, property, onSuccess, trigger }: PropertyFormProps) {
  const [open, setOpen] = useState(false)
  const [name, setName] = useState(property?.name ?? "")
  const [address, setAddress] = useState(property?.address ?? "")
  const [loading, setLoading] = useState(false)

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    if (!name.trim() || !address.trim()) {
      toast.error("Name and address are required")
      return
    }

    setLoading(true)
    try {
      const url = mode === "create"
        ? "/api/admin/properties"
        : `/api/admin/properties/${property!.id}`
      const method = mode === "create" ? "POST" : "PUT"

      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: name.trim(), address: address.trim() }),
      })

      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.error || "Failed to save property")
      }

      toast.success(mode === "create" ? "Property created" : "Property updated")
      setOpen(false)
      if (mode === "create") {
        setName("")
        setAddress("")
      }
      onSuccess()
    } catch (err: any) {
      toast.error(err.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>{trigger}</DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{mode === "create" ? "Add Property" : "Edit Property"}</DialogTitle>
          <DialogDescription>
            {mode === "create"
              ? "Add a new property to your portfolio."
              : "Update property details."}
          </DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="property-name">Property Name</Label>
            <Input
              id="property-name"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="e.g., Oak Street Apartments"
              disabled={loading}
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="property-address">Address</Label>
            <Input
              id="property-address"
              value={address}
              onChange={(e) => setAddress(e.target.value)}
              placeholder="e.g., 123 Oak Street, City, ST 12345"
              disabled={loading}
            />
          </div>
          <DialogFooter>
            <Button type="submit" disabled={loading}>
              {loading ? "Saving..." : mode === "create" ? "Create Property" : "Save Changes"}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

2. Create src/app/(admin)/admin/properties/page.tsx:

This is a "use client" page that displays a list of properties with CRUD actions:
- Fetches properties from GET /api/admin/properties on mount and after mutations
- Shows a table with columns: Name, Address, Units, Actions
- "Add Property" button at top opens PropertyForm in create mode
- Each row has "Edit" button (opens PropertyForm in edit mode) and "Archive" button
- Archive button shows an AlertDialog confirmation: "Are you sure you want to archive {name}? Units under this property will remain but the property will be hidden from active lists."
- Archive calls DELETE /api/admin/properties/[id]
- Handle 409 error (active tenants) with a clear error toast
- Empty state: "No properties yet. Add your first property to get started."

```typescript
"use client"

import { useState, useEffect, useCallback } from "react"
import { Button } from "@/components/ui/button"
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog"
import { toast } from "sonner"
import { PropertyForm } from "@/components/admin/PropertyForm"

interface Property {
  id: string
  name: string
  address: string
  unitCount: number
  createdAt: string
}

export default function AdminPropertiesPage() {
  const [properties, setProperties] = useState<Property[]>([])
  const [loading, setLoading] = useState(true)

  const fetchProperties = useCallback(async () => {
    try {
      const res = await fetch("/api/admin/properties")
      if (!res.ok) throw new Error("Failed to fetch properties")
      const data = await res.json()
      setProperties(data)
    } catch (err: any) {
      toast.error(err.message)
    } finally {
      setLoading(false)
    }
  }, [])

  useEffect(() => { fetchProperties() }, [fetchProperties])

  async function handleArchive(id: string, name: string) {
    try {
      const res = await fetch(`/api/admin/properties/${id}`, { method: "DELETE" })
      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.error || "Failed to archive property")
      }
      toast.success(`${name} archived`)
      fetchProperties()
    } catch (err: any) {
      toast.error(err.message)
    }
  }

  // ... render table with PropertyForm dialogs and AlertDialog for archive
}
```

3. Update src/app/(admin)/layout.tsx to add "Properties" link in the navigation:

Add a new Link after the existing "Dashboard" link:
```typescript
<Link href="/admin/properties" className="text-sm text-gray-600 hover:text-gray-900">Properties</Link>
```

Place it before the "Units" link so the navigation reads: Dashboard, Properties, Units, Payments, ...

Important: Use shadcn/ui AlertDialog (not window.confirm) for the archive confirmation. If AlertDialog is not yet installed, install it with: `npx shadcn@latest add alert-dialog`. Check if Dialog is installed too: `npx shadcn@latest add dialog`.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>Admin properties page created with create/edit/archive functionality. PropertyForm dialog component handles create and edit modes. Admin nav updated with Properties link.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance admin units page with full CRUD</name>
  <files>src/app/(admin)/admin/units/page.tsx, src/components/admin/UnitForm.tsx</files>
  <action>
1. Create src/components/admin/UnitForm.tsx as a "use client" dialog component:

This handles both create and edit modes for units:
- Props: `mode: "create" | "edit"`, `unit?: { id, unitNumber, propertyId, rentAmountCents, rentDueDay }`, `properties: { id, name }[]` (for property dropdown in create mode), `onSuccess: () => void`, `trigger: React.ReactNode`
- Fields: Unit Number (text), Property (select dropdown, only in create mode), Rent Amount (number input in dollars, converted to cents), Due Day (number input 1-28)
- On submit: calls POST /api/admin/units (create) or PUT /api/admin/units/[id] (edit)
- Dollar-to-cents conversion: the form shows dollars (e.g., "1500.00") but the API expects cents (150000). Convert on submit: `Math.round(parseFloat(dollarAmount) * 100)`
- Due day validation: must be 1-28
- Shows loading state, toast feedback

2. Replace src/app/(admin)/admin/units/page.tsx:

Convert from server component to "use client" page:
- Fetches units from GET /api/admin/units on mount
- Fetches properties from GET /api/admin/properties (for property dropdown in create dialog)
- Shows table with columns: Unit Number, Property, Rent Amount, Due Day, Current Tenant, Actions
- "Add Unit" button at top opens UnitForm in create mode
- Each row has "Edit" button (opens UnitForm in edit mode) and "Archive" button
- Archive button shows AlertDialog confirmation
- Archive calls DELETE /api/admin/units/[id]
- Handle 409 error (active tenant) with clear error toast
- Empty state: "No units found. Add your first property, then create units."
- Rent display format: "$1,500.00 / due day 5" (matching existing pattern)
- Current tenant column shows tenant name and email if linked, "Vacant" if not

Important: The existing RentConfigForm component in the current units page can be replaced by the new UnitForm edit dialog, which handles rent config as part of the full unit edit flow. The inline rent config was appropriate for v1 but the full CRUD edit dialog is the v2 approach.

Important: When showing rent amounts, format as dollars: `(rentAmountCents / 100).toFixed(2)`. When accepting rent input, parse as dollars and convert to cents for the API.
  </action>
  <verify>
    <automated>cd /Users/odesantos/Documents/rentalmgmt && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>Admin units page enhanced with full CRUD: create units with property assignment and rent config, edit unit details, archive with tenant guard. UnitForm dialog handles create/edit modes.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- Admin properties page displays property list with CRUD actions
- PropertyForm dialog works for both create and edit modes
- Admin units page displays units with property info and tenant status
- UnitForm dialog handles create (with property select) and edit modes
- Archive confirmations use AlertDialog
- Admin navigation includes Properties link
- Dollar/cents conversion works correctly in forms
</verification>

<success_criteria>
- Admin can create properties from the properties page
- Admin can edit property name and address inline
- Admin can archive properties (with active tenant guard)
- Admin can create units under any active property
- Admin can edit unit number, rent amount, and due day
- Admin can archive units (with active tenant guard)
- Navigation updated with Properties link
</success_criteria>

<output>
After completion, create `.planning/phases/10-portfolio-management-tenant-lifecycle/10-03-SUMMARY.md`
</output>
