---
milestone: v2.1
audited: 2026-02-28T15:35:00Z
status: gaps_found
scores:
  requirements: 2/5
  phases: 1/2
  integration: 4/4
  flows: 2/2
gaps:
  requirements:
    - id: "HARD-03"
      status: "unsatisfied"
      phase: "Phase 16"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 16 directory does not exist — no plans created, no execution, no verification"
    - id: "HARD-04"
      status: "unsatisfied"
      phase: "Phase 16"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 16 directory does not exist — no plans created, no execution, no verification"
    - id: "HARD-05"
      status: "unsatisfied"
      phase: "Phase 16"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 16 directory does not exist — no plans created, no execution, no verification"
  integration: []
  flows: []
tech_debt:
  - phase: 13-fintech-polish-edge-cases
    items:
      - "TypeScript error in postNsfFee call signature — Drizzle PgTransaction type mismatch with hand-rolled structural type in src/lib/nsf.ts"
  - phase: 09-automated-operations
    items:
      - "No vercel.json cron schedule entry for /api/cron/late-fees — requires external scheduler or manual invocation in production"
---

# Milestone v2.1: Production Hardening — Audit Report

**Audited:** 2026-02-28
**Status:** GAPS FOUND
**Score:** 2/5 requirements satisfied

---

## Requirements Coverage

### 3-Source Cross-Reference

| REQ-ID | Description | Phase | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Final Status |
|--------|-------------|-------|-----------------|---------------------|-----------------|--------------|
| HARD-01 | Balance-based late fee assessment | 15 | SATISFIED | listed (15-01) | `[x]` Complete | **satisfied** |
| HARD-02 | UPSERT webhook handlers for ACH | 15 | SATISFIED | listed (15-02) | `[x]` Complete | **satisfied** |
| HARD-03 | Date.UTC() for DST-immune day math | 16 | missing | missing | `[ ]` Pending | **unsatisfied** |
| HARD-04 | DST spring-forward/fall-back tests | 16 | missing | missing | `[ ]` Pending | **unsatisfied** |
| HARD-05 | Tenant middleware session validation | 16 | missing | missing | `[ ]` Pending | **unsatisfied** |

### Satisfied (2/5)

- **HARD-01**: `getTenantBalance()` replaces payment-existence queries in late fee cron. 6 unit tests cover all eligibility paths. Verified in Phase 15 VERIFICATION.md.
- **HARD-02**: Both `async_payment_succeeded` and `async_payment_failed` use `INSERT ... ON CONFLICT DO UPDATE`. 6 unit tests cover all delivery ordering scenarios. Verified in Phase 15 VERIFICATION.md.

### Unsatisfied (3/5)

All 3 unsatisfied requirements are assigned to **Phase 16: Date Math & Security**, which has not been planned or executed. Phase 16 directory does not exist.

- **HARD-03**: `daysSinceRentDue` still uses local `Date()` constructors — vulnerable to DST boundary errors.
- **HARD-04**: No DST-specific unit tests exist for spring-forward/fall-back transitions.
- **HARD-05**: Tenant middleware has not been hardened to validate sessions (vs. cookie existence only).

### Orphaned Requirements

None — all 5 v2.1 requirements are assigned to phases in the traceability table.

---

## Phase Verification Summary

| Phase | Name | Status | Score | Requirements |
|-------|------|--------|-------|--------------|
| 15 | Financial Integrity & Concurrency | PASSED | 8/8 | HARD-01, HARD-02 |
| 16 | Date Math & Security | NOT STARTED | 0/0 | HARD-03, HARD-04, HARD-05 |

---

## Cross-Phase Integration

### Phase 15 Integration (verified by integration checker)

| From | To | Via | Status |
|------|----|-----|--------|
| Phase 8 (`getTenantBalance` in `src/lib/ledger.ts`) | Phase 15 cron route | import at line 14, call at line 86 | WIRED |
| Phase 3 (`stripeSessionId` UNIQUE in schema) | Phase 15 webhook UPSERT | ON CONFLICT target at lines 131, 167 | WIRED |
| Phase 8 (`stripeEvents` table) | Phase 15 webhook dedup | INSERT ON CONFLICT DO NOTHING at lines 37-46 | WIRED |
| Phase 15 (`buildAchPaymentUpsert`) | Test file only | Intentional test-fixture pattern | WIRED (by design) |

### Phase 16 Integration

Not applicable — phase not started.

---

## E2E Flow Verification

| Flow | Status | Detail |
|------|--------|--------|
| Late fee assessment (cron → ledger → charge → notification) | COMPLETE | 12-step flow verified end-to-end |
| ACH webhook processing (Stripe → dedup → UPSERT → ledger) | COMPLETE | 7-step flow verified end-to-end |

No broken flows.

---

## Tech Debt (Pre-existing, Not Introduced by v2.1)

### Phase 13: FinTech Polish & Edge Cases
- **TypeScript error in `postNsfFee` call signature** — `src/lib/nsf.ts` uses hand-rolled structural type for `tx` parameter that doesn't match Drizzle's `PgTransaction` type. Runtime behavior is correct; type inference mismatch only. Origin: commit `ef659b7`.

### Phase 9: Automated Operations
- **No `vercel.json` cron schedule entry** — `/api/cron/late-fees` route exists but no platform-level schedule is configured. Requires external scheduler or manual invocation in production.

---

## Conclusion

Phase 15 is fully delivered and verified — both financial integrity fixes (HARD-01, HARD-02) are implemented, tested, and integrated with upstream phases. No new tech debt introduced.

Phase 16 remains unplanned. 3 requirements (HARD-03, HARD-04, HARD-05) covering date math DST immunity and tenant session security are unsatisfied. The milestone cannot be completed until Phase 16 is planned and executed.

---

_Audited: 2026-02-28_
_Auditor: Claude (gsd-audit-milestone)_
